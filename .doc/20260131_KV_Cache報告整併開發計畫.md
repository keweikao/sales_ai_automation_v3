# KV Cache 報告整併開發計畫

## 概述

將系統中所有報告的資料來源整併至 KV Cache，減少即時 SQL 查詢，提升效能與資料一致性。

**目標：減少 ~80% 的即時 SQL 查詢**

---

## 現況分析

### Slack 定時報告 (Queue Worker)

| 報告 | 觸發時間 | SQL 查詢數 | 狀態 |
|------|----------|------------|------|
| 每日健康報告 | 08:00 UTC+8 | 9 | ❌ 未快取 |
| 業務週報 | 週一 09:00 UTC+8 | 9 | ❌ 未快取 |
| 每日 Todo 提醒 | 09:00 UTC+8 | 2 | ❌ 未快取 |
| 待跟進提醒 | 09:00 UTC+8 | 1 | ❌ 未快取 |

### 前端報告 (Web App)

| 頁面 | API | 狀態 |
|------|-----|------|
| 首頁 Dashboard | `analytics.dashboard` | ⚠️ 部分快取 |
| 個人報告 | `analytics.repPerformance` | ✅ 已快取 |
| 團隊報告 | `analytics.teamPerformance` | ✅ 已快取 |
| MTD 上傳列表 | `analytics.mtdUploads` | ❌ 未快取 |

### 現有 KV Cache 結構

```
report:rep:{userId}           # 個人報告
report:team:{department}      # 團隊報告
report:upload-ranking:weekly  # 週上傳排名
report:upload-ranking:monthly # 月上傳排名
```

---

## 新增 KV Cache 結構

### 1. SystemHealthData

**KV Key:** `report:system-health`

**更新頻率:** 每 15 分鐘

**使用場景:**
- 每日健康報告 (Slack)
- 業務週報 (Slack)
- 前端 Dashboard (未來)

```typescript
interface SystemHealthData {
  generatedAt: string; // ISO timestamp

  // === 處理統計 (Daily Health Report) ===
  processing: {
    last24h: {
      completed: number;
      failed: number;
      inProgress: number;
      avgProcessingTime: number; // seconds
    };
    // 按錯誤代碼分組
    errorsByCode: Record<string, {
      count: number;
      stage: string; // 'audio' | 'download' | 'transcription' | 'analysis' | 'database'
      cases: Array<{
        caseNumber: string;
        companyName: string;
        errorMessage?: string;
      }>;
    }>;
    // 卡住的案件 (pending/transcribing/analyzing > 1hr)
    stuckCases: Array<{
      caseNumber: string;
      companyName: string;
      status: string;
      hoursStuck: number;
    }>;
  };

  // === 週比較 (Weekly Report) ===
  weeklyComparison: {
    thisWeek: {
      uploads: number;
      avgMeddic: number;
    };
    lastWeek: {
      uploads: number;
      avgMeddic: number;
    };
    change: {
      uploadsPercent: number; // e.g., 12 means +12%
      meddicDiff: number;     // e.g., 3 means +3 points
    };
  };
}
```

### 2. CloseCaseData

**KV Key:** `report:close-cases`

**更新頻率:** 資料變更時 (opportunity won/lost)

**使用場景:**
- 業務週報 (Slack)
- 前端 Dashboard (未來)

```typescript
interface CloseCaseData {
  generatedAt: string;

  // 本週 Close Case
  thisWeek: {
    won: Array<{
      customerNumber: string;
      companyName: string;
      userName: string;
      wonAt: string;
    }>;
    lost: Array<{
      customerNumber: string;
      companyName: string;
      userName: string;
      lostAt: string;
      rejectionReason?: string;
      selectedCompetitor?: string;
    }>;
    wonCount: number;
    lostCount: number;
    winRate: number; // 0-100
  };

  // MTD 累計
  mtd: {
    wonCount: number;
    lostCount: number;
    winRate: number;
  };
}
```

### 3. AttentionNeededData

**KV Key:** `report:attention-needed`

**更新頻率:** 每 15 分鐘

**使用場景:**
- 業務週報 (Slack)
- 前端 Dashboard (未來)

```typescript
interface AttentionNeededData {
  generatedAt: string;

  // 高分但 > 7 天未跟進的機會
  staleHighScore: Array<{
    customerNumber: string;
    companyName: string;
    userName: string;
    meddicScore: number;
    daysSinceContact: number;
  }>;

  // 無待辦的進行中機會 (建立 > 7 天)
  noTodos: Array<{
    customerNumber: string;
    companyName: string;
    userName: string;
    daysSinceCreated: number;
  }>;

  // 本週未上傳的業務
  inactiveReps: Array<{
    userId: string;
    userName: string;
  }>;
}
```

### 4. TodoStatsData

**KV Key:** `report:todo-stats`

**更新頻率:** 每 15 分鐘 + 資料變更時

**使用場景:**
- 業務週報 (Slack)
- 每日 Todo 提醒 (Slack)
- 前端團隊待辦頁面

```typescript
interface TodoStatsData {
  generatedAt: string;

  // 逾期待辦
  overdue: {
    total: number;
    byUser: Record<string, {
      count: number;
      userName: string;
    }>;
  };

  // 今日待辦 (用於提醒)
  dueToday: {
    total: number;
    byUser: Record<string, Array<{
      id: string;
      title: string;
      dueDate: string;
      opportunityId?: string;
      companyName?: string;
    }>>;
  };

  // 待跟進 (pending follow-ups)
  pendingFollowUps: Array<{
    id: string;
    opportunityId: string;
    companyName: string;
    userId: string;
    userName: string;
    scheduledDate: string;
    purpose?: string;
  }>;
}
```

### 5. TeamPerformanceData (擴充現有)

**KV Key:** `report:team-performance`

**更新頻率:** 每 15 分鐘

**使用場景:**
- 業務週報 (Slack)
- 前端團隊報告

```typescript
interface TeamPerformanceData {
  generatedAt: string;

  // === 新增欄位 ===

  // 各業務本週表現
  weeklyPerformance: Array<{
    userId: string;
    userName: string;
    weekUploads: number;
    avgMeddic: number | null;
    weekWon: number;
  }>;

  // 保留現有欄位...
  memberRankings: MemberRankingItem[];
  uploadRankings: {
    weekly: UploadRankingItem[];
    monthly: UploadRankingItem[];
  };
}
```

### 6. MtdUploadsData

**KV Key:** `report:mtd-uploads:{year}-{month}`

**更新頻率:** 資料變更時 (conversation 新增)

**使用場景:**
- 前端 MTD 上傳列表頁面

```typescript
interface MtdUploadsData {
  generatedAt: string;
  year: number;
  month: number;

  // 上傳記錄
  uploads: Array<{
    id: string;
    caseNumber: string;
    customerNumber: string;
    companyName: string;
    userName: string;
    status: string;
    createdAt: string;
    meddicScore?: number;
  }>;

  // 摘要統計
  summary: {
    total: number;
    byUser: Record<string, number>;
    byStatus: Record<string, number>;
  };
}
```

---

## 實作計畫

### Phase 1: 核心資料結構 (Day 1)

**目標:** 建立基礎架構

**檔案變更:**

1. `packages/services/src/report/types.ts` (新增)
   - 定義所有新增的 TypeScript 介面

2. `packages/services/src/report/precompute.ts` (擴充)
   - 新增 `computeSystemHealth()`
   - 新增 `computeCloseCases()`
   - 新增 `computeAttentionNeeded()`
   - 新增 `computeTodoStats()`

3. `packages/services/src/report/index.ts` (擴充)
   - 匯出新增的函數和型別

### Phase 2: 預計算整合 (Day 1-2)

**目標:** 將預計算整合至現有 cron

**檔案變更:**

1. `apps/server/src/index.ts`
   - 更新 `precomputeReports()` 函數
   - 新增 SystemHealth、AttentionNeeded、TodoStats 預計算

2. `apps/queue-worker/src/index.ts`
   - 新增 CloseCases 預計算 (在 conversation 完成時觸發)
   - 新增 MtdUploads 更新 (在 conversation 新增時觸發)

### Phase 3: 報告讀取整合 (Day 2)

**目標:** 修改報告從 KV 讀取

**檔案變更:**

1. `apps/queue-worker/src/index.ts`
   - `handleDailyHealthReport()` - 從 KV 讀取 SystemHealthData
   - `handleWeeklyReport()` - 從 KV 讀取多個資料源
   - `handleDailyTodoReminder()` - 從 KV 讀取 TodoStatsData
   - `handlePendingFollowUpReminder()` - 從 KV 讀取 TodoStatsData

### Phase 4: 前端 API 整合 (Day 2-3)

**目標:** 前端 API 改用 KV

**檔案變更:**

1. `apps/server/src/index.ts`
   - `analytics.mtdUploads` - 從 KV 讀取 MtdUploadsData
   - `analytics.dashboard` - 整合 SystemHealthData

---

## 預計算時機

| 資料 | KV Key | 觸發時機 | 實作位置 |
|------|--------|----------|----------|
| SystemHealth | `report:system-health` | 每 15 分鐘 cron | server |
| CloseCases | `report:close-cases` | opportunity 更新 + 每 15 分鐘 | server |
| AttentionNeeded | `report:attention-needed` | 每 15 分鐘 cron | server |
| TodoStats | `report:todo-stats` | 每 15 分鐘 cron | server |
| TeamPerformance | `report:team:{dept}` | 每 15 分鐘 cron (現有) | server |
| MtdUploads | `report:mtd-uploads:*` | conversation 變更 | queue-worker |

---

## KV TTL 設定

| 資料類型 | TTL | 理由 |
|----------|-----|------|
| SystemHealth | 1 小時 | 每 15 分鐘更新，但保留 buffer |
| CloseCases | 24 小時 | 每日變化不大 |
| AttentionNeeded | 1 小時 | 每 15 分鐘更新 |
| TodoStats | 1 小時 | 每 15 分鐘更新 |
| MtdUploads | 24 小時 | 按月儲存，每日更新 |

---

## 測試計畫

### 單元測試

1. `packages/services/src/report/__tests__/precompute.test.ts`
   - 測試各 compute 函數的輸出格式
   - 測試邊界條件 (空資料、大量資料)

### 整合測試

1. 預計算流程測試
   - 模擬 cron 觸發
   - 驗證 KV 寫入內容

2. 報告讀取測試
   - 模擬 KV 資料
   - 驗證報告輸出格式

### 手動測試

1. 在 staging 環境執行預計算
2. 觸發各報告，驗證內容正確
3. 比較 KV 版本與 SQL 版本的結果

---

## 回滾計畫

每個報告函數保留 fallback 邏輯：

```typescript
async function handleDailyHealthReport(env: Env) {
  // 嘗試從 KV 讀取
  const cached = await env.CACHE_KV.get('report:system-health', 'json');

  if (cached && isValidCache(cached)) {
    // 使用快取資料
    return generateReportFromCache(cached);
  }

  // Fallback: 直接 SQL 查詢 (現有邏輯)
  console.warn('[Report] KV cache miss, falling back to SQL');
  return generateReportFromSQL(env);
}
```

---

## 效益預估

### Before

| 報告 | SQL 查詢數 | 執行時間 (估計) |
|------|------------|-----------------|
| 每日健康報告 | 9 | ~2s |
| 業務週報 | 9 | ~3s |
| Todo 提醒 | 2 | ~1s |
| MTD 上傳 | 1 (大量資料) | ~5s |

### After

| 報告 | KV 讀取數 | 執行時間 (估計) |
|------|-----------|-----------------|
| 每日健康報告 | 1 | ~50ms |
| 業務週報 | 3 | ~100ms |
| Todo 提醒 | 1 | ~50ms |
| MTD 上傳 | 1 | ~50ms |

**預計效能提升: 10-50x**

---

## 開發順序

```
1. [ ] 建立 types.ts 定義介面
2. [ ] 實作 computeSystemHealth()
3. [ ] 實作 computeCloseCases()
4. [ ] 實作 computeAttentionNeeded()
5. [ ] 實作 computeTodoStats()
6. [ ] 更新 server precomputeReports()
7. [ ] 修改 handleDailyHealthReport() 讀取 KV
8. [ ] 修改 handleWeeklyReport() 讀取 KV
9. [ ] 修改 handleDailyTodoReminder() 讀取 KV
10. [ ] 修改 analytics.mtdUploads 讀取 KV
11. [ ] 部署 staging 測試
12. [ ] 部署 production
```

---

## 關鍵檔案

| 檔案 | 用途 |
|------|------|
| `packages/services/src/report/types.ts` | 型別定義 |
| `packages/services/src/report/precompute.ts` | 預計算邏輯 |
| `apps/server/src/index.ts` | Server precompute cron |
| `apps/queue-worker/src/index.ts` | 報告生成 & MtdUploads 更新 |

---

## 風險與緩解

| 風險 | 緩解措施 |
|------|----------|
| KV 資料過期或遺失 | 保留 SQL fallback |
| 預計算時間過長 | 分批處理，限制查詢範圍 |
| 資料不一致 | 設定合理 TTL，保持更新頻率 |
| 部署失敗 | 逐步部署，先 staging 後 production |
