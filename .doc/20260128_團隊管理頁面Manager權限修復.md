# 團隊管理頁面 Manager 權限修復

**日期**: 2026-01-28
**類型**: Bug 修復 + 功能增強
**影響範圍**: API、Web 前端

---

## 問題描述

### 原始問題
Manager 角色訪問 `/admin/team` 頁面時看不到任何資料。

### 根本原因分析

| 問題點 | 檔案位置 | 說明 |
|--------|---------|------|
| API 權限過於嚴格 | `packages/api/src/routers/team.ts:36-38` | `listUsers()` 只允許 `role === "admin"` 訪問 |
| 前端缺少路由保護 | `apps/web/src/routes/admin/team.tsx:37-39` | 無 `beforeLoad` 檢查，任何用戶都能進入 |
| 導航菜單無條件顯示 | `apps/web/src/components/header.tsx:29` | 「團隊管理」連結對所有用戶可見 |

---

## 解決方案

### 權限設計

| 功能 | Admin | Manager | Sales Rep |
|------|-------|---------|-----------|
| 看到「團隊管理」連結 | ✓ | ✓ | ✗ |
| 訪問 `/admin/team` | ✓ | ✓ | ✗ (顯示錯誤) |
| 查看用戶列表 | 全部用戶 | 同部門業務（唯讀） | - |
| 修改用戶角色 | ✓ | ✗ | - |
| 修改用戶部門 | ✓ | ✗ | - |
| 刪除用戶 | ✓ | ✗ | - |

---

## 修改內容

### 1. API 層修改

#### 檔案: `packages/api/src/routers/team.ts`

**修改 `listUsers()` 函數** (第 21-91 行)

```typescript
/**
 * 列出用戶及其團隊資訊 (admin 或 manager)
 * - Admin: 看到全部用戶
 * - Manager: 只看到同部門的業務 (sales_rep)
 */
const listUsers = protectedProcedure.handler(async ({ context }) => {
  const currentUserId = context.session?.user.id;

  if (!currentUserId) {
    throw new ORPCError("UNAUTHORIZED");
  }

  // 取得當前用戶的角色和部門
  const currentUserProfile = await db.query.userProfiles.findFirst({
    where: eq(userProfiles.userId, currentUserId),
  });

  const currentRole = currentUserProfile?.role;
  const currentDepartment = currentUserProfile?.department;

  // 檢查是否為 admin 或 manager
  if (currentRole !== "admin" && currentRole !== "manager") {
    throw new ORPCError("FORBIDDEN", {
      message: "只有管理員或經理可以查看團隊",
    });
  }

  const isAdmin = currentRole === "admin";

  // 查詢所有用戶及其 profile
  const allUsers = await db.query.user.findMany({...});
  const profiles = await db.query.userProfiles.findMany();

  // 組合資料
  const usersWithProfiles = allUsers.map((u) => {...});

  // 根據角色過濾用戶列表
  let filteredUsers = usersWithProfiles;

  if (!isAdmin) {
    // Manager 只看到同部門的業務 (sales_rep)
    filteredUsers = usersWithProfiles.filter(
      (u) => u.role === "sales_rep" && u.department === currentDepartment
    );
  }

  return {
    users: filteredUsers,
    currentUserRole: currentRole,  // 新增：讓前端判斷顯示邏輯
  };
});
```

**新增 `getCurrentUserProfile()` 函數** (第 363-384 行)

```typescript
/**
 * 取得當前用戶的 profile（角色和部門）
 * 用於前端條件顯示（如導航菜單）
 */
const getCurrentUserProfile = protectedProcedure.handler(
  async ({ context }) => {
    const currentUserId = context.session?.user.id;

    if (!currentUserId) {
      throw new ORPCError("UNAUTHORIZED");
    }

    const profile = await db.query.userProfiles.findFirst({
      where: eq(userProfiles.userId, currentUserId),
    });

    return {
      role: profile?.role || "sales_rep",
      department: profile?.department || null,
    };
  }
);
```

**更新 router 匯出**

```typescript
export const teamRouter = {
  listUsers,
  updateUserRole,
  deleteUser,
  getViewableUsers,
  getCurrentUserProfile,  // 新增
};
```

---

### 2. 前端導航菜單修改

#### 檔案: `apps/web/src/components/header.tsx`

**新增 imports**

```typescript
import { useQuery } from "@tanstack/react-query";
import { authClient } from "@/lib/auth-client";
import { client } from "@/utils/orpc";
```

**新增角色查詢邏輯**

```typescript
export default function Header() {
  const matchRoute = useMatchRoute();
  const { data: session } = authClient.useSession();

  // 獲取當前用戶角色（只在登入時查詢）
  const { data: userProfile } = useQuery({
    queryKey: ["user", "profile"],
    queryFn: () => client.team.getCurrentUserProfile(),
    enabled: !!session,
    staleTime: 5 * 60 * 1000, // 5 分鐘快取
  });

  const userRole = userProfile?.role;
  const canAccessTeamManagement =
    userRole === "admin" || userRole === "manager";

  const baseLinks = [
    { to: "/", label: "首頁", icon: Home },
    { to: "/opportunities", label: "機會", icon: Building2 },
    { to: "/reports", label: "報告", icon: FileText },
    { to: "/todos", label: "待辦", icon: CheckSquare },
  ] as const;

  // 只有 admin 和 manager 可看到團隊管理
  const links = canAccessTeamManagement
    ? ([
        ...baseLinks,
        { to: "/admin/team", label: "團隊管理", icon: Shield },
      ] as const)
    : baseLinks;

  // ... rest of component
}
```

---

### 3. 前端頁面修改

#### 檔案: `apps/web/src/routes/admin/team.tsx`

**新增路由保護**

```typescript
export const Route = createFileRoute("/admin/team")({
  component: TeamManagementPage,
  beforeLoad: async () => {
    // 檢查是否已登入
    const session = await authClient.getSession();
    if (!session.data) {
      redirect({
        to: "/login",
        throw: true,
      });
    }
    return { session };
  },
});
```

**新增權限判斷變數**

```typescript
const users = usersQuery.data?.users || [];
const currentUserRole = usersQuery.data?.currentUserRole;
const isAdmin = currentUserRole === "admin";
```

**新增錯誤處理**

```typescript
// 處理無權限錯誤
if (usersQuery.isError) {
  return (
    <main className="container mx-auto p-6">
      <Card className="border-destructive/50 bg-destructive/10">
        <CardContent className="flex items-center gap-4 pt-6">
          <AlertCircle className="h-8 w-8 text-destructive" />
          <div>
            <h2 className="font-semibold text-lg">無權限訪問</h2>
            <p className="text-muted-foreground">
              只有管理員或經理可以查看團隊管理頁面
            </p>
          </div>
        </CardContent>
      </Card>
    </main>
  );
}
```

**標題顯示唯讀模式**

```tsx
<h1 className="flex items-center gap-2 font-bold text-3xl">
  <Shield className="h-8 w-8" />
  團隊管理
  {!isAdmin && (
    <Badge className="ml-2 font-normal text-sm" variant="secondary">
      唯讀模式
    </Badge>
  )}
</h1>
```

**條件渲染表格欄位**

```tsx
// 表頭：Admin 才顯示操作欄
{isAdmin && <TableHead className="w-[100px]">操作</TableHead>}

// 角色欄位
<TableCell>
  {isAdmin ? (
    <Select ...>  {/* 下拉選單 */}
  ) : (
    <Badge ...>  {/* 純文字 Badge */}
  )}
</TableCell>

// 部門欄位
<TableCell>
  {isAdmin ? (
    <Select ...>  {/* 下拉選單 */}
  ) : (
    <Badge variant="outline">  {/* 純文字 Badge */}
  )}
</TableCell>

// 操作欄位：Admin 才顯示刪除按鈕
{isAdmin && (
  <TableCell>
    <Button ...>
      <Trash2 className="h-4 w-4 text-destructive" />
    </Button>
  </TableCell>
)}
```

---

## 資料流程圖

```
┌─────────────────────────────────────────────────────────────────┐
│                         用戶登入                                 │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  Header 組件載入                                                 │
│  └─ 呼叫 team.getCurrentUserProfile()                           │
│     └─ 返回 { role, department }                                │
│        └─ 判斷是否顯示「團隊管理」連結                            │
└──────────────────────────┬──────────────────────────────────────┘
                           │
          ┌────────────────┼────────────────┐
          │                │                │
          ▼                ▼                ▼
    ┌──────────┐    ┌──────────┐    ┌──────────┐
    │  Admin   │    │  Manager │    │ Sales Rep│
    │ 顯示連結  │    │ 顯示連結  │    │ 隱藏連結  │
    └────┬─────┘    └────┬─────┘    └──────────┘
         │               │
         │  點擊「團隊管理」
         ▼               ▼
┌─────────────────────────────────────────────────────────────────┐
│  /admin/team 頁面載入                                            │
│  └─ beforeLoad: 檢查 session（未登入 → 重導向 /login）            │
│  └─ 呼叫 team.listUsers()                                       │
└──────────────────────────┬──────────────────────────────────────┘
                           │
          ┌────────────────┼────────────────┐
          │                │                │
          ▼                ▼                ▼
    ┌──────────┐    ┌──────────┐    ┌──────────┐
    │  Admin   │    │  Manager │    │ Sales Rep│
    │ 全部用戶  │    │ 同部門業務│    │ FORBIDDEN│
    │ 完整功能  │    │ 唯讀模式  │    │ 錯誤頁面  │
    └──────────┘    └──────────┘    └──────────┘
```

---

## 測試驗證

### 測試案例 1: Admin 登入

1. 登入 Admin 帳號
2. 確認導航列顯示「團隊管理」連結
3. 進入 `/admin/team` 頁面
4. 確認可看到所有用戶
5. 確認可修改角色（下拉選單）
6. 確認可修改部門（下拉選單）
7. 確認可看到刪除按鈕

### 測試案例 2: Manager 登入

1. 登入 Manager 帳號（例如 department = "ichef"）
2. 確認導航列顯示「團隊管理」連結
3. 進入 `/admin/team` 頁面
4. 確認標題顯示「唯讀模式」Badge
5. 確認只看到同部門（ichef）的業務（sales_rep）
6. 確認角色欄位為純文字 Badge（非下拉選單）
7. 確認部門欄位為純文字 Badge（非下拉選單）
8. 確認沒有刪除按鈕

### 測試案例 3: Sales Rep 登入

1. 登入 Sales Rep 帳號
2. 確認導航列**不顯示**「團隊管理」連結
3. 直接訪問 `/admin/team` URL
4. 確認顯示「無權限訪問」錯誤訊息

---

## 相關檔案

| 檔案路徑 | 修改類型 | 說明 |
|---------|---------|------|
| `packages/api/src/routers/team.ts` | 修改 | 修改 `listUsers()` 權限邏輯，新增 `getCurrentUserProfile()` |
| `apps/web/src/components/header.tsx` | 修改 | 根據角色條件顯示導航連結 |
| `apps/web/src/routes/admin/team.tsx` | 修改 | 新增 `beforeLoad` 保護，實作 Manager 唯讀模式 |

---

## 部署記錄

- **部署時間**: 2026-01-28
- **部署應用**: server, web, slack-bot, queue-worker
- **健康檢查**: 全部通過 (HTTP 200)
