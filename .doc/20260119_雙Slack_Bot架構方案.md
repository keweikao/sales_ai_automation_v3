# é›™ Slack Bot æ¶æ§‹æ–¹æ¡ˆ

> **ä½¿ç”¨æƒ…å¢ƒ**: æ¥­å‹™é€é DM èˆ‡ Bot äº’å‹•,éœ€å€åˆ† iCHEF å’Œç¾æ¥­ç”¢å“ç·š
> **è§£æ±ºæ–¹æ¡ˆ**: å…©å€‹ç¨ç«‹ Slack App + å…©å€‹ Cloudflare Workers

---

## ğŸ¯ æ¶æ§‹è¨­è¨ˆ

### ç‚ºä»€éº¼éœ€è¦å…©å€‹ Slack Bot?

**åŸå› **:
1. æ¥­å‹™é€é **DM (Direct Message)** èˆ‡ Bot äº’å‹•
2. DM ä¸­**ç„¡ Channel ID**,ç„¡æ³•ç”¨ Channel åˆ¤æ–·ç”¢å“ç·š
3. éœ€è¦æ˜ç¢ºå€åˆ† iCHEF å’Œç¾æ¥­æ¥­å‹™

**è§£æ±ºæ–¹æ¡ˆ**:
- âœ… å»ºç«‹å…©å€‹ Slack App (å„è‡ªæœ‰ç¨ç«‹çš„ Bot Token)
- âœ… éƒ¨ç½²å…©å€‹ Cloudflare Workers (å„è‡ªé…ç½®ä¸åŒç”¢å“ç·š)
- âœ… iCHEF æ¥­å‹™ä½¿ç”¨ "iCHEF Sales Bot"
- âœ… ç¾æ¥­æ¥­å‹™ä½¿ç”¨ "Beauty Sales Bot"

---

## ğŸ—ï¸ æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Slack Workspace                         â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ iCHEF æ¥­å‹™ DM   â”‚          â”‚ ç¾æ¥­æ¥­å‹™ DM      â”‚        â”‚
â”‚  â”‚   @iCHEF Bot    â”‚          â”‚   @Beauty Bot   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                            â”‚
            â”‚ Token 1                    â”‚ Token 2
            â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ iCHEF Slack Worker  â”‚      â”‚ Beauty Slack Worker â”‚
â”‚ (Cloudflare)        â”‚      â”‚ (Cloudflare)        â”‚
â”‚                     â”‚      â”‚                     â”‚
â”‚ productLine='ichef' â”‚      â”‚ productLine='beauty'â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                            â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Shared Queue Worker  â”‚
            â”‚  (è™•ç†å…©ç¨®ç”¢å“ç·š)      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  PostgreSQL Database  â”‚
            â”‚  (product_line æ¬„ä½)  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ å¯¦ä½œæ–¹æ¡ˆ

### Option 1: å…©å€‹ç¨ç«‹ Worker (æ¨è–¦)

**å„ªé»**:
- âœ… å®Œå…¨éš”é›¢,æ˜“æ–¼ç®¡ç†
- âœ… å„è‡ªç¨ç«‹é…ç½®
- âœ… å‡ºå•é¡Œæ™‚ä¸æœƒäº’ç›¸å½±éŸ¿

**ç¼ºé»**:
- âš ï¸ éœ€è¦ç¶­è­·å…©å€‹ Worker
- âš ï¸ ç¨‹å¼ç¢¼é‡è¤‡(ä½†å¯å…±ç”¨ packages)

#### ç›®éŒ„çµæ§‹

```
apps/
â”œâ”€â”€ slack-bot/              # iCHEF Slack Bot
â”‚   â”œâ”€â”€ src/index.ts
â”‚   â””â”€â”€ wrangler.toml
â”‚
â””â”€â”€ slack-bot-beauty/       # Beauty Slack Bot (æ–°å»º)
    â”œâ”€â”€ src/index.ts        # è¤‡è£½è‡ª slack-bot
    â””â”€â”€ wrangler.toml       # é…ç½® productLine = 'beauty'
```

#### å¯¦ä½œæ­¥é©Ÿ

**Step 1: å»ºç«‹ Beauty Slack Bot Worker**

```bash
# è¤‡è£½ç¾æœ‰ Slack Bot
cp -r apps/slack-bot apps/slack-bot-beauty

# ä¿®æ”¹ wrangler.toml
cd apps/slack-bot-beauty
```

**ä¿®æ”¹ `apps/slack-bot-beauty/wrangler.toml`**:
```toml
name = "sales-ai-slack-bot-beauty"  # æ”¹å
main = "src/index.ts"
compatibility_date = "2024-12-01"

[vars]
ENVIRONMENT = "production"
PRODUCT_LINE = "beauty"  # æ–°å¢: å›ºå®šç‚º beauty
```

**Step 2: ä¿®æ”¹ç¨‹å¼ç¢¼**

**`apps/slack-bot-beauty/src/index.ts`**:
```typescript
import { Env } from './types';

export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    // å›ºå®šä½¿ç”¨ beauty ç”¢å“ç·š
    const productLine = 'beauty';

    // ... å…¶ä»–é‚è¼¯èˆ‡åŸ slack-bot ç›¸åŒ
    // ä½†æ‰€æœ‰åœ°æ–¹éƒ½ä½¿ç”¨ productLine = 'beauty'
  }
};
```

**Step 3: éƒ¨ç½²å…©å€‹ Worker**

```bash
# éƒ¨ç½² iCHEF Slack Bot
cd apps/slack-bot
wrangler deploy

# éƒ¨ç½² Beauty Slack Bot
cd apps/slack-bot-beauty
wrangler deploy
```

**Step 4: å»ºç«‹å…©å€‹ Slack App**

1. **åœ¨ Slack å»ºç«‹ "iCHEF Sales Bot"**
   - å–å¾— `SLACK_BOT_TOKEN_ICHEF`
   - å–å¾— `SLACK_SIGNING_SECRET_ICHEF`

2. **åœ¨ Slack å»ºç«‹ "Beauty Sales Bot"**
   - å–å¾— `SLACK_BOT_TOKEN_BEAUTY`
   - å–å¾— `SLACK_SIGNING_SECRET_BEAUTY`

**Step 5: è¨­å®šç’°å¢ƒè®Šæ•¸**

```bash
# iCHEF Slack Bot
cd apps/slack-bot
wrangler secret put SLACK_BOT_TOKEN
# è¼¸å…¥: xoxb-...(iCHEF Bot Token)

wrangler secret put SLACK_SIGNING_SECRET
# è¼¸å…¥: ...(iCHEF Signing Secret)

# Beauty Slack Bot
cd apps/slack-bot-beauty
wrangler secret put SLACK_BOT_TOKEN
# è¼¸å…¥: xoxb-...(Beauty Bot Token)

wrangler secret put SLACK_SIGNING_SECRET
# è¼¸å…¥: ...(Beauty Signing Secret)
```

---

### Option 2: å–®ä¸€ Worker + Bot User ID åˆ¤æ–·

**å„ªé»**:
- âœ… åªéœ€ç¶­è­·ä¸€å€‹ Worker
- âœ… ç¨‹å¼ç¢¼çµ±ä¸€

**ç¼ºé»**:
- âš ï¸ éœ€è¦ç¶­è­· Bot User ID å°æ‡‰è¡¨
- âš ï¸ é…ç½®è¼ƒè¤‡é›œ

#### å¯¦ä½œæ–¹å¼

**ç’°å¢ƒè®Šæ•¸**:
```bash
# Slack Bot Token (ç”¨é€—è™Ÿåˆ†éš”)
SLACK_BOT_TOKENS=xoxb-ichef-token,xoxb-beauty-token

# Bot User ID å°æ‡‰ (JSON)
BOT_PRODUCT_LINE_MAP={"U123ICHEF":"ichef","U456BEAUTY":"beauty"}
```

**ç¨‹å¼ç¢¼**:
```typescript
function resolveProductLine(botUserId: string, env: Env): ProductLine {
  const botMap = JSON.parse(env.BOT_PRODUCT_LINE_MAP);
  return botMap[botUserId] || 'ichef';
}
```

**ä¸æ¨è–¦åŸå› **:
- âŒ éœ€è¦å¾ Slack Event ä¸­å–å¾— Bot User ID (è¤‡é›œ)
- âŒ é…ç½®å®¹æ˜“å‡ºéŒ¯
- âŒ ä¸å¦‚å…©å€‹ Worker æ¸…æ™°

---

## ğŸ¯ æ¨è–¦æ–¹æ¡ˆ: Option 1 (å…©å€‹ Worker)

### ç‚ºä»€éº¼æ¨è–¦?

1. **æ¸…æ™°ç°¡å–®**
   - iCHEF Bot â†’ iCHEF Worker â†’ productLine = 'ichef'
   - Beauty Bot â†’ Beauty Worker â†’ productLine = 'beauty'

2. **æ˜“æ–¼ç¶­è­·**
   - å„è‡ªç¨ç«‹é…ç½®
   - å‡ºå•é¡Œæ™‚å®¹æ˜“å®šä½

3. **æ“´å±•æ€§å¥½**
   - æœªä¾†æ–°å¢ç¬¬ä¸‰å€‹ç”¢å“ç·š,åªéœ€è¤‡è£½ Worker

4. **å…±ç”¨åº•å±¤é‚è¼¯**
   - å…©å€‹ Worker å…±ç”¨ `packages/*` ä¸­çš„ç¨‹å¼ç¢¼
   - åªæœ‰å…¥å£é»å’Œé…ç½®ä¸åŒ

---

## ğŸ“‹ å¯¦ä½œæª¢æŸ¥æ¸…å–®

### Step 1: å»ºç«‹ç¬¬äºŒå€‹ Worker

- [ ] è¤‡è£½ `apps/slack-bot` ç‚º `apps/slack-bot-beauty`
- [ ] ä¿®æ”¹ `wrangler.toml` åç¨±å’Œé…ç½®
- [ ] ä¿®æ”¹ `src/index.ts` å›ºå®š productLine
- [ ] æ¸¬è©¦ç·¨è­¯: `bun run build`

### Step 2: å»ºç«‹ç¬¬äºŒå€‹ Slack App

- [ ] åœ¨ Slack å»ºç«‹ "Beauty Sales Bot"
- [ ] é…ç½® OAuth Scopes (èˆ‡ iCHEF Bot ç›¸åŒ)
- [ ] å®‰è£åˆ° Workspace
- [ ] å–å¾— Bot Token å’Œ Signing Secret

### Step 3: éƒ¨ç½²èˆ‡è¨­å®š

- [ ] éƒ¨ç½² Beauty Worker: `wrangler deploy`
- [ ] è¨­å®šç’°å¢ƒè®Šæ•¸: Bot Token, Signing Secret
- [ ] è¨­å®š Slack Event Subscriptions URL
- [ ] æ¸¬è©¦ DM äº’å‹•

### Step 4: æ¸¬è©¦é©—è­‰

- [ ] iCHEF æ¥­å‹™ DM @iCHEF Bot ä¸Šå‚³éŸ³æª”
- [ ] ç¢ºèªå½ˆå‡º iCHEF è¡¨å–®
- [ ] ç¾æ¥­æ¥­å‹™ DM @Beauty Bot ä¸Šå‚³éŸ³æª”
- [ ] ç¢ºèªå½ˆå‡ºç¾æ¥­è¡¨å–®
- [ ] æª¢æŸ¥è³‡æ–™åº« product_line æ¬„ä½

---

## ğŸ”§ è©³ç´°å¯¦ä½œæŒ‡ä»¤

### å»ºç«‹ Beauty Worker

```bash
cd /Users/stephen/Desktop/sales_ai_automation_v3

# è¤‡è£½ slack-bot
cp -r apps/slack-bot apps/slack-bot-beauty

cd apps/slack-bot-beauty

# ä¿®æ”¹ wrangler.toml
# å°‡ name æ”¹ç‚º "sales-ai-slack-bot-beauty"
# æ–°å¢ PRODUCT_LINE = "beauty"

# æ¸¬è©¦ç·¨è­¯
bun install
bun run build
```

### éƒ¨ç½²

```bash
# ç¢ºä¿åœ¨ apps/slack-bot-beauty ç›®éŒ„
wrangler deploy

# è¨­å®š Secrets
wrangler secret put SLACK_BOT_TOKEN
wrangler secret put SLACK_SIGNING_SECRET
wrangler secret put API_BASE_URL
wrangler secret put API_TOKEN
```

---

## ğŸ“Š æˆæœ¬åˆ†æ

### Cloudflare Workers è²»ç”¨

**å…è²»æ–¹æ¡ˆ**:
- 100,000 requests/day (æ¯å€‹ Worker)
- å…©å€‹ Worker = 200,000 requests/day
- å°æ–¼æ¥­å‹™ä½¿ç”¨,ç¶½ç¶½æœ‰é¤˜

**å¦‚æœè¶…é**:
- $5/month (Bundled Plan)
- 10,000,000 requests/month

### Slack App è²»ç”¨

- âœ… **å…è²»** (Slack App æœ¬èº«å…è²»)
- âœ… åªéœ€è¦åŸºæœ¬ Bot åŠŸèƒ½

**ç¸½æˆæœ¬**: $0/month (å…è²»æ–¹æ¡ˆå…§)

---

## ğŸ†š æ–¹æ¡ˆæ¯”è¼ƒ

| é …ç›® | å–®ä¸€ Bot + Channel ID | å–®ä¸€ Bot + User ID | å…©å€‹ Bot + å…©å€‹ Worker |
|------|---------------------|-------------------|---------------------|
| **é©ç”¨å ´æ™¯** | å…¬é–‹ Channel | DM (è¤‡é›œ) | **DM (æ¨è–¦)** âœ… |
| **å¯¦ä½œè¤‡é›œåº¦** | ç°¡å–® | ä¸­ç­‰ | **ç°¡å–®** âœ… |
| **ç¶­è­·æˆæœ¬** | ä½ | ä¸­ | **ä¸­** |
| **éš”é›¢æ€§** | ä½ | ä½ | **é«˜** âœ… |
| **æ“´å±•æ€§** | é«˜ | ä¸­ | **é«˜** âœ… |
| **æˆæœ¬** | å…è²» | å…è²» | **å…è²»** âœ… |

**çµè«–**: å…©å€‹ Bot + å…©å€‹ Worker æœ€é©åˆæ‚¨çš„ä½¿ç”¨å ´æ™¯

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

æƒ³è¦ç«‹å³å¯¦ä½œå—?æˆ‘å¯ä»¥å¹«æ‚¨:

1. **å»ºç«‹ `apps/slack-bot-beauty` ç›®éŒ„å’Œæª”æ¡ˆ**
2. **ä¿®æ”¹é…ç½®æª”æ¡ˆ**
3. **æä¾›éƒ¨ç½²æŒ‡ä»¤**
4. **å»ºç«‹ Slack App è¨­å®šæŒ‡å—**

è«‹å‘Šè¨´æˆ‘æ˜¯å¦è¦é–‹å§‹å¯¦ä½œ!

---

**æ–‡ä»¶ç‰ˆæœ¬**: v1.0
**å»ºç«‹æ™‚é–“**: 2026-01-19
**é©ç”¨å ´æ™¯**: DM äº’å‹•æ¨¡å¼
