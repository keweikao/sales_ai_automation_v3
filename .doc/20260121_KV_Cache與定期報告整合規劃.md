# KV Cache 與定期報告整合規劃

> 建立時間：2026-01-21

## 1. 架構總覽

```
                    ┌─────────────────────┐
                    │   Cloud Scheduler    │
                    └──────────┬──────────┘
                               │
              ┌────────────────┼────────────────┐
              ▼                ▼                ▼
     ┌────────────────┐ ┌────────────────┐ ┌────────────────┐
     │ 每日健康報告   │ │ 週報預運算     │ │ KV 快取更新    │
     │ Daily 8:00    │ │ Mon 8:00      │ │ 每 5 分鐘      │
     └───────┬────────┘ └───────┬────────┘ └───────┬────────┘
             │                  │                  │
             ▼                  ▼                  ▼
     ┌─────────────────────────────────────────────────────┐
     │                    KV Storage                        │
     │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │
     │  │ 健康報告    │ │ 週報資料    │ │ 統計快取    │   │
     │  │ report:     │ │ report:     │ │ stats:      │   │
     │  │ health:     │ │ weekly:     │ │ analytics   │   │
     │  └─────────────┘ └─────────────┘ └─────────────┘   │
     └─────────────────────────────────────────────────────┘
             │                  │                  │
             ▼                  ▼                  ▼
     ┌────────────────┐ ┌────────────────┐ ┌────────────────┐
     │  Slack 推播    │ │ Slack 推播    │ │ /report 指令   │
     │  #ops-alerts   │ │ DM / Channel  │ │ Web 前端      │
     └────────────────┘ └────────────────┘ └────────────────┘
```

---

## 2. KV Key 設計

### A. 統計快取（即時查詢用）

| Key 格式 | 說明 | TTL | 更新時機 |
|----------|------|-----|----------|
| `stats:opportunity:global` | 全域商機統計 | 5 min | 排程 / 資料變更 |
| `stats:meddic:trends` | MEDDIC 趨勢 | 1 hr | 排程 |
| `user:{userId}:dashboard` | 個人儀表板 | 5 min | 資料變更 |
| `user:{userId}:repPerformance` | 個人表現 | 15 min | 資料變更 |
| `team:{dept}:performance` | 團隊表現 | 15 min | 排程 |
| `user:{userId}:conversations:list` | 對話列表 | 1 hr | ✅ 已實作 |
| `user:{userId}:opportunities:list` | 商機列表 | 30 min | 新增商機 |

### B. 預運算報告（定期推播用）

| Key 格式 | 說明 | TTL | 生成時機 |
|----------|------|-----|----------|
| `report:health:daily:{date}` | 每日健康報告 | 7 days | 08:00 |
| `report:weekly:rep:{userId}:{week}` | 個人週報 | 14 days | Mon 08:00 |
| `report:weekly:team:{dept}:{week}` | 團隊週報 | 14 days | Mon 08:00 |

---

## 3. 排程任務設計

| 任務 | Cron 表達式 | 動作 |
|------|-------------|------|
| Stats Refresh | `*/5 * * * *` | 更新 `stats:*` |
| Daily Health | `0 8 * * *` | 生成 + 推播 Slack |
| Weekly Precompute | `0 8 * * 1` | 預運算週報 |
| Weekly Push (Rep) | `0 9 * * 1` | 推播個人 DM |
| Weekly Push (Manager) | `30 8 * * 1` | 推播主管頻道 |

---

## 4. 預運算資料結構

### Daily 健康報告

```typescript
interface DailyHealthReport {
  date: string;
  processing: {
    audioUploaded: number;
    compressed: number;
    transcribed: number;
    analyzed: number;
    successRate: number;
  };
  failures: Array<{
    caseNumber: string;
    reason: string;
  }>;
  apiStatus: {
    slack: "healthy" | "degraded" | "critical";
    gemini: "healthy" | "degraded" | "critical";
    database: "healthy" | "degraded" | "critical";
    r2: "healthy" | "degraded" | "critical";
  };
  trends: {
    avgProcessingTime: number;
    weeklySuccessRate: number;
  };
}
```

### Weekly 個人報告

```typescript
interface WeeklyRepReport {
  userId: string;
  userName: string;
  period: { start: Date; end: Date };
  mtd: {
    uploadCount: number;
    analysisCount: number;
  };
  weekly: {
    uploadCount: number;
    analysisCount: number;
    avgMeddicScore: number;
  };
  dimensions: {
    strongest: string;
    weakest: string;
  };
  opportunities: Array<{
    caseNumber: string;
    reason: string;
  }>;
}
```

---

## 5. 快取失效策略

```typescript
// 當新對話分析完成時
async function onAnalysisComplete(userId: string) {
  await cacheService.deleteMultiple([
    `user:${userId}:dashboard`,
    `user:${userId}:repPerformance`,
    `user:${userId}:conversations:list`,
    `stats:opportunity:global`,
  ]);
}
```

---

## 6. 實作優先順序

### Phase 1：Analytics KV 快取 ✅

- [x] `getOpportunityStats` 加入 KV (5 分鐘 TTL)
- [x] `getDashboard` 加入 KV (5 分鐘 TTL，僅無日期參數時)
- [x] 快取失效機制整合至 queue-worker

### Phase 2：排程基礎設施 ✅

- [x] 建立 Cron Triggers（wrangler.toml）
- [x] 每日健康報告（08:00 UTC+8）
- [x] 週報摘要（週一 08:00 UTC+8）

### Phase 3：Weekly 報告（進行中）

- [x] 基本週報格式
- [ ] 進階週報預運算（個人報告）
- [ ] Slack DM 推播

---

## 7. 預估效益

| 指標 | 優化前 | 優化後 |
|------|--------|--------|
| `/report` 回應時間 | 1-3s | < 100ms |
| DB 查詢次數 | 每次請求 | 快取命中時為 0 |
| 前端 Dashboard 載入 | 2-5s | < 500ms |
| 週報生成時間 | N/A (無) | 預運算完成 |
