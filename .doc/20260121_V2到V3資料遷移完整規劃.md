# V2 â†’ V3 è³‡æ–™é·ç§»å®Œæ•´è¦åŠƒèˆ‡åŸ·è¡ŒæŒ‡å—

**å»ºç«‹æ—¥æœŸ:** 2026-01-21
**ç‹€æ…‹:** æº–å‚™åŸ·è¡Œ
**è³‡æ–™è¦æ¨¡:** 271 ç­† Firestore cases

---

## ğŸ“‹ ç›®éŒ„

1. [åŸ·è¡Œæ‘˜è¦](#åŸ·è¡Œæ‘˜è¦)
2. [è³‡æ–™çµæ§‹ç¢ºèª](#è³‡æ–™çµæ§‹ç¢ºèª)
3. [ä½¿ç”¨è€…æ±ºç­–è¨˜éŒ„](#ä½¿ç”¨è€…æ±ºç­–è¨˜éŒ„)
4. [æ¥­å‹™äººå“¡è³‡è¨Šè™•ç†ç­–ç•¥](#æ¥­å‹™äººå“¡è³‡è¨Šè™•ç†ç­–ç•¥)
5. [è©³ç´°æ¬„ä½æ˜ å°„](#è©³ç´°æ¬„ä½æ˜ å°„)
6. [å·²ä¿®æ”¹çš„æª”æ¡ˆ](#å·²ä¿®æ”¹çš„æª”æ¡ˆ)
7. [é·ç§»åŸ·è¡Œæ­¥é©Ÿ](#é·ç§»åŸ·è¡Œæ­¥é©Ÿ)
8. [é©—è­‰èˆ‡æª¢æŸ¥æ¸…å–®](#é©—è­‰èˆ‡æª¢æŸ¥æ¸…å–®)
9. [é¢¨éšªè©•ä¼°èˆ‡å›æ»¾](#é¢¨éšªè©•ä¼°èˆ‡å›æ»¾)
10. [å¿«é€Ÿåƒè€ƒ](#å¿«é€Ÿåƒè€ƒ)

---

## ğŸ“‹ åŸ·è¡Œæ‘˜è¦

### é·ç§»ç›®æ¨™

å¾ Google Firestore (V2 ç³»çµ±) é·ç§»éŠ·å”®å°è©±è³‡æ–™è‡³ PostgreSQL (V3 ç³»çµ±),ä¿ç•™å®Œæ•´çš„æ¥­å‹™è² è²¬äººè³‡è¨Šå’Œå°è©±è¨˜éŒ„,ç‚ºå¾ŒçºŒ MEDDIC åˆ†æå¥ å®šåŸºç¤ã€‚

### æ ¸å¿ƒç­–ç•¥

1. **åˆ†å…©éšæ®µé·ç§»**: ç¬¬ä¸€éšæ®µé·ç§»æ–‡å­—è³‡æ–™,ç¬¬äºŒéšæ®µç¨ç«‹é·ç§»å£“ç¸®éŸ³æª”
2. **æ¥­å‹™è³‡è¨Šå®Œæ•´ä¿ç•™**: åœ¨ conversations è¡¨ä¿ç•™ Slack IDã€Usernameã€**Email** (æ–°å¢æ¬„ä½)
3. **ç”¨æˆ¶æ˜ å°„ç­–ç•¥**: å„ªå…ˆæŸ¥è©¢ç¾æœ‰ç”¨æˆ¶,æ‰¾ä¸åˆ°å‰‡ä½¿ç”¨ service-account å‚™ç”¨å¸³è™Ÿ
4. **æ¸¬è©¦è³‡æ–™éæ¿¾**: æ ¹æ“š customerName é—œéµå­—éæ¿¾æ¸¬è©¦è³‡æ–™
5. **MEDDIC é‡æ–°åˆ†æ**: ä¿ç•™æ–‡å­—ç¨¿,ä¸é·ç§» V2 åˆ†æçµæœ,ç”± V3 ç³»çµ±é‡æ–°åˆ†æ

### ç¸½é«”æ¶æ§‹

```
Firestore V2 (271 cases)
â”œâ”€> PostgreSQL opportunities (~50-100 ç­†,æŒ‰ customerId å»é‡)
â”œâ”€> PostgreSQL conversations (~250-260 ç­†,éæ¿¾æ¸¬è©¦è³‡æ–™å¾Œ)
â””â”€> PostgreSQL meddic_analyses (0 ç­†,ç”± V3 é‡æ–°åˆ†æ)
```

---

## ğŸ“Š è³‡æ–™çµæ§‹ç¢ºèª

### V2 Firestore æ¬„ä½æ ¼å¼

| æ¬„ä½ | æ ¼å¼ç¯„ä¾‹ | èªªæ˜ |
|------|----------|------|
| **Document ID** | `202511-IC004` | Firestore æ–‡æª” ID (æ¡ˆä»¶å±¤ç´š,å”¯ä¸€) |
| **data.caseId** | `202511-IC004` | ç­‰åŒæ–¼ Document ID |
| **data.customerId** | `202511-122188` | **å®¢æˆ¶å±¤ç´š ID (å¯é‡è¤‡)** âš ï¸ é—œéµç™¼ç¾ |
| **data.customerName** | `å†°` | å®¢æˆ¶åç¨± |

### âš ï¸ é—œéµç™¼ç¾: customerId â‰  caseId

**é‡è¦èªçŸ¥ä¿®æ­£:**
- `customerId` æ˜¯**å®¢æˆ¶å±¤ç´š**çš„å”¯ä¸€è­˜åˆ¥ç¢¼
- `caseId` æ˜¯**æ¡ˆä»¶å±¤ç´š**çš„å”¯ä¸€è­˜åˆ¥ç¢¼
- ä¸€å€‹å®¢æˆ¶ (customerId) å¯ä»¥æœ‰å¤šå€‹æ¡ˆä»¶ (caseId)

**å¯¦éš›ç¯„ä¾‹:**

```
å®¢æˆ¶ "å†°" (customerId: 202511-122188):
  â”œâ”€ æ¡ˆä»¶ 1: 202511-IC001
  â”œâ”€ æ¡ˆä»¶ 2: 202511-IC003
  â””â”€ æ¡ˆä»¶ 3: 202511-IC004

å®¢æˆ¶ "éº»è¾£ç‡™" (customerId: 202511-122162):
  â”œâ”€ æ¡ˆä»¶ 1: 202511-IC002
  â”œâ”€ æ¡ˆä»¶ 2: 202511-IC005
  â”œâ”€ æ¡ˆä»¶ 3: 202511-IC006
  â””â”€ æ¡ˆä»¶ 4: 202511-IC007
```

**æ˜ å°„å½±éŸ¿:**
- `opportunities.customerNumber` = V2 çš„ `customerId` (å®¢æˆ¶å±¤ç´šå»é‡)
- `conversations.caseNumber` = V2 çš„ `caseId` (æ¡ˆä»¶å±¤ç´š,æ¯ç­†éƒ½æœ‰)

---

## âœ… ä½¿ç”¨è€…æ±ºç­–è¨˜éŒ„

### æ±ºç­– 1: customerNumber æ˜ å°„ç­–ç•¥

**å•é¡Œ:** å¦‚ä½•ç”Ÿæˆ V3 çš„ `opportunities.customerNumber`?

**æ±ºå®š:** âœ… **ç›´æ¥ä½¿ç”¨ V2 customerId**

**ä¿®æ”¹å‰ (éŒ¯èª¤æ–¹æ¡ˆ):**
```typescript
// åŸºæ–¼ customerName hash ç”Ÿæˆ
customerNumber: generateCustomerNumber(caseDoc.customerName, createdAt)
```

**ä¿®æ”¹å¾Œ (æ­£ç¢ºæ–¹æ¡ˆ):**
```typescript
// ç›´æ¥ä½¿ç”¨ V2 customerId
customerNumber: caseDoc.customerId
```

**å„ªé»:**
- ä¿ç•™åŸå§‹å®¢æˆ¶ ID,ä¾¿æ–¼è¿½æº¯
- åŒä¸€å€‹ customerId çš„å¤šå€‹ cases æœƒæ­£ç¢ºé—œè¯åˆ°åŒä¸€å€‹ Opportunity
- é‚è¼¯ç°¡å–®,ä¸éœ€è¦è¤‡é›œçš„ hash ç”Ÿæˆ

---

### æ±ºç­– 2: User æ˜ å°„ç­–ç•¥

**å•é¡Œ:** V2 æ¥­å‹™äººå“¡å¦‚ä½•æ˜ å°„åˆ° V3 ç”¨æˆ¶?

**æ±ºå®š:** âœ… **å„ªå…ˆæŸ¥è©¢ user_profiles + å®Œæ•´ä¿ç•™æ¥­å‹™è³‡è¨Š**

**æ˜ å°„é‚è¼¯:**
```typescript
async function resolveUserId(slackUserId: string): Promise<string> {
  // 1. æŸ¥è©¢ user_profiles.slackUserId
  const profile = await db.query.userProfiles.findFirst({
    where: eq(userProfiles.slackUserId, slackUserId)
  });

  // 2. æ‰¾åˆ°å‰‡è¿”å› userId
  if (profile) return profile.userId;

  // 3. æ‰¾ä¸åˆ°å‰‡ä½¿ç”¨ service-account (åœ˜éšŠå…±äº«å¸³è™Ÿ)
  return "service-account";
}
```

**é¡å¤–éœ€æ±‚ (ä½¿ç”¨è€…è¦æ±‚):**
- ç¢ºä¿å…¶ä»–é é¢å¯è®€å–æ¥­å‹™ email å’Œ username

**å¯¦ä½œæ–¹å¼:**
- `salesRepName` â†’ `conversations.slackUsername` âœ…
- `salesRepEmail` â†’ `conversations.slackUserEmail` âœ… **æ–°å¢æ¬„ä½**
- `salesRepSlackId` â†’ `conversations.slackUserId` âœ…

**èªªæ˜:**
- ä¸é‡è¤‡å„²å­˜åœ¨ `user` è¡¨,è€Œæ˜¯å®Œæ•´ä¿ç•™åœ¨ `conversations` è¡¨
- æœªä¾†æ¥­å‹™è¨»å†Šå¾Œ,å¯é€é email æˆ– slackId æŸ¥è©¢ä¸¦é‡æ–°æ­¸å±¬è³‡æ–™

---

### æ±ºç­– 3: æ¸¬è©¦è³‡æ–™éæ¿¾

**å•é¡Œ:** demoMeta æ˜¯å¦ç‚ºæ¸¬è©¦è³‡æ–™?

**é‡æ¸…:** âŒ `demoMeta` ä¸æ˜¯ demo data,æ˜¯ Demo æœƒè­°çš„ metadata

**æ±ºå®š:** âœ… éæ¿¾åŒ…å«æ¸¬è©¦é—œéµå­—çš„ `customerName`

**éæ¿¾è¦å‰‡:**
```typescript
const testKeywords = [
  'æ¸¬è©¦', 'æµ‹è¯•', 'test', 'demo', 'sample',
  'ç¯„ä¾‹', 'èŒƒä¾‹', 'æ¨£æœ¬', 'æ ·æœ¬', 'testing',
  'ãƒ‡ãƒ¢', 'ãƒ†ã‚¹ãƒˆ' // æ—¥æ–‡æ¸¬è©¦é—œéµå­—
];

export function isTestData(customerName: string): boolean {
  if (!customerName) return false;

  const lowerName = customerName.toLowerCase();
  return testKeywords.some(keyword =>
    lowerName.includes(keyword.toLowerCase())
  );
}
```

**é·ç§»æµç¨‹:**
1. è®€å–æ‰€æœ‰ 271 ç­† Firestore cases
2. éæ¿¾æ‰ `isTestData(customerName) === true` çš„ cases
3. åƒ…é·ç§»æ­£å¼è³‡æ–™

**é æœŸçµæœ:**
- éæ¿¾ ~10-20 ç­†æ¸¬è©¦è³‡æ–™
- å‰©é¤˜ ~250-260 ç­†æ­£å¼è³‡æ–™

---

### æ±ºç­– 4: MEDDIC åˆ†æç­–ç•¥

**å•é¡Œ:** æ˜¯å¦é·ç§» V2 çš„åˆ†æçµæœ?

**ä½¿ç”¨è€…æ„è¦‹:**
> "æˆ‘èªç‚º,ç‚ºäº†ç¢ºä¿åˆ†æçµ±ä¸€,åªæˆªèˆ‰æ–‡å­—ç¨¿,å°±è³‡æ–™çš„ MEDDIC æ¬„ä½å…§å®¹å…¨éƒ¨é‡æ–°åˆ†æå¾Œå¡«å…¥,ä½ èªç‚ºå‘¢?"

**æ±ºå®š:** âœ… **é‡æ–°åˆ†æ** (ä¸é·ç§» V2 åˆ†æè³‡æ–™)

**ç†ç”±:**
1. V2 åƒ…æœ‰ 4 å€‹ Agent (agent1: Context, agent2: Buyer, agent3: Seller, agent4: Summary)
2. V3 éœ€è¦å®Œæ•´ 6 ç¶­åº¦ MEDDIC åˆ†æ
3. ä¿ç•™æ–‡å­—ç¨¿å¾Œé‡æ–°åˆ†æ,ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§

**å¯¦ä½œä¿®æ”¹:**
```typescript
// Phase 4: è·³éå»ºç«‹ meddic_analyses
console.log("ğŸ“Š Phase 4: MEDDIC Analyses - è·³é (å°‡ç”± V3 ç³»çµ±é‡æ–°åˆ†æ)");
stats.meddicAnalyses.skipped = casesWithAnalysis.length;
```

**è³‡æ–™ä¿ç•™:**
- âœ… `conversations.transcript` - å®Œæ•´é€å­—ç¨¿ (JSONB)
- âœ… `conversations.meddicAnalysis` - ç°¡åŒ–ç‰ˆåƒè€ƒè³‡æ–™ (JSONB,å« V2 çš„ 4 å€‹ agent è¼¸å‡º)
- âŒ `meddic_analyses` è¡¨ - ä¸å»ºç«‹,ç”± V3 ç³»çµ±é‡æ–°åŸ·è¡Œ 6 ç¶­åº¦åˆ†æ

---

### æ±ºç­– 5: éŸ³æª”é·ç§»æ™‚æ©Ÿ

**å•é¡Œ:** éŸ³æª”ä½•æ™‚é·ç§»?

**æ±ºå®š:** âœ… **å£“ç¸®å¾Œç¨ç«‹é·ç§»**

**æµç¨‹:**

**ç¬¬ä¸€éšæ®µ (ç›®å‰):** é·ç§»æ–‡å­—è³‡æ–™
- `audioUrl = null`
- åƒ…é·ç§» transcriptã€metadata ç­‰

**ç¬¬äºŒéšæ®µ (å¾…å¯¦ä½œ):**
1. å¾ GCS ä¸‹è¼‰éŸ³æª”
2. **ä½¿ç”¨ ffmpeg å£“ç¸®** (æ¸›å°‘å„²å­˜æˆæœ¬ 50-70%)
3. ä¸Šå‚³è‡³ Cloudflare R2
4. æ›´æ–° `conversations.audioUrl`

**å¾…å»ºç«‹è…³æœ¬:** `scripts/migration/migrate-v3-audio-compressed.ts`

**é è¨ˆè€—æ™‚:** 1-3 å°æ™‚ (å–æ±ºæ–¼ç¶²è·¯é€Ÿåº¦å’ŒéŸ³æª”æ•¸é‡)

---

## ğŸ”‘ æ¥­å‹™äººå“¡è³‡è¨Šè™•ç†ç­–ç•¥

### æ ¸å¿ƒå•é¡Œ

**ä½¿ç”¨è€…ç–‘å•:**
> "v3 æ¯å€‹ä½¿ç”¨è€…æœƒæœ‰ id, v2è³‡æ–™çš„æ¥­å‹™è½‰ç§»éä¾†å¾Œæœƒè‡ªå‹•å»ºç«‹å—?é‚„æ˜¯ç•¶ä»–å€‘åœ¨ç¶²é ä¸Šè¨»å†Šæ™‚,å°±æœƒè‡ªå‹• mapping email ç¶å®š?"

### è§£æ±ºæ–¹æ¡ˆ: å®Œæ•´ä¿ç•™æ¥­å‹™è³‡è¨Š

**V2 æ¥­å‹™è­˜åˆ¥è³‡è¨Š:**
- `salesRepSlackId`: Slack User ID (å¦‚ U01ABC123)
- `salesRepEmail`: æ¥­å‹™ Email (å¦‚ stephen.kao@ichef.com.tw)
- `salesRepName`: æ¥­å‹™åç¨± (å¦‚ Stephen Kao)

**V3 ç”¨æˆ¶ç³»çµ±:**
- `user.id`: UUID (ä¸»éµ)
- `user.email`: Email (å”¯ä¸€,ç”¨æ–¼ç™»å…¥)
- `user_profiles.slackUserId`: Slack ID (å¯é¸,ç”¨æ–¼æ˜ å°„)

### å¯¦ä½œç­–ç•¥

#### 1. Schema ä¿®æ”¹ (âœ… å·²å®Œæˆ)

**æª”æ¡ˆ:** `packages/db/src/schema/conversation.ts`

```typescript
// Slack integration
slackChannelId: text("slack_channel_id"),
slackThreadTs: text("slack_thread_ts"),
slackUserId: text("slack_user_id"),       // æ¥­å‹™çš„ Slack User ID
slackUsername: text("slack_username"),     // æ¥­å‹™çš„ Slack Username
slackUserEmail: text("slack_user_email"),  // æ¥­å‹™çš„ Email (æ–°å¢)
```

#### 2. é·ç§»æ™‚å®Œæ•´ä¿ç•™

**æª”æ¡ˆ:** `scripts/migration/mappers/v3-cases-mapper.ts`

```typescript
export function mapCaseToConversation(
  caseDoc: FirestoreV3Case,
  opportunityId: string
): NewConversation {
  return {
    // ... å…¶ä»–æ¬„ä½
    slackUserId: caseDoc.salesRepSlackId || null,    // U01ABC123
    slackUsername: caseDoc.salesRepName || null,      // Stephen Kao
    slackUserEmail: caseDoc.salesRepEmail || null,    // stephen.kao@ichef.com.tw (æ–°å¢)
    // ...
  };
}
```

#### 3. opportunities.userId æ˜ å°„

**é·ç§»æ™‚:**
- æŸ¥è©¢ `user_profiles.slackUserId` â†’ æ‰¾åˆ°å‰‡ç”¨è©² userId
- æ‰¾ä¸åˆ° â†’ ä½¿ç”¨ `"service-account"`

**é æœŸçµæœ (å‡è¨­ç›®å‰åƒ… 5 å€‹è¨»å†Šç”¨æˆ¶):**
- æ˜ å°„æˆåŠŸ (userId = çœŸå¯¦ UUID): ~10-20%
- æ˜ å°„å¤±æ•— (userId = service-account): ~80-90%

**å„ªé»:**
- âœ… é·ç§»æ™‚ä¸éœ€é å…ˆå»ºç«‹ user å¸³è™Ÿ
- âœ… æ¥­å‹™è³‡è¨Šå®Œæ•´ä¿ç•™,ä¸æœƒéºå¤±
- âœ… å¯é€é Slack IDã€Emailã€Username æŸ¥è©¢
- âœ… æœªä¾†å¯å½ˆæ€§è½‰ç§»è³‡æ–™æ­¸å±¬

### æ¥­å‹™è¨»å†Šå¾Œçš„è³‡æ–™è½‰ç§»

**å ´æ™¯:** æ¥­å‹™é€é Google OAuth æˆ– Email è¨»å†Š V3 ç³»çµ±

#### æ­¥é©Ÿ 1: å»ºç«‹ user_profiles ä¸¦ç¶å®š

```sql
-- æ¥­å‹™è¨»å†Šå¾Œ,ç¶å®š Slack ID
INSERT INTO user_profiles (user_id, slack_user_id)
VALUES ('æ–°è¨»å†Šçš„UUID', 'V2çš„slackUserId');
```

#### æ­¥é©Ÿ 2: å°‡ opportunities é‡æ–°æ­¸å±¬

```sql
-- å°‡åŸæœ¬ service-account çš„è³‡æ–™è½‰ç§»çµ¦æ¥­å‹™
UPDATE opportunities
SET user_id = 'æ–°è¨»å†Šçš„UUID'
WHERE user_id = 'service-account'
  AND id IN (
    SELECT DISTINCT opportunity_id
    FROM conversations
    WHERE slack_user_id = 'V2çš„slackUserId'
  );
```

#### æ­¥é©Ÿ 3: é©—è­‰è½‰ç§»çµæœ

```sql
-- æŸ¥çœ‹æ¥­å‹™è² è²¬çš„æ¡ˆä»¶æ•¸
SELECT
  o.id,
  o.company_name,
  o.customer_number,
  c.slack_username,
  c.slack_user_email
FROM opportunities o
JOIN conversations c ON c.opportunity_id = o.id
WHERE o.user_id = 'æ–°è¨»å†Šçš„UUID';
```

---

## ğŸ—ºï¸ è©³ç´°æ¬„ä½æ˜ å°„

### A. Firestore cases â†’ PostgreSQL opportunities

| V2 æ¬„ä½ | V3 æ¬„ä½ | æ˜ å°„é‚è¼¯ | å‚™è¨» |
|---------|---------|---------|------|
| **`customerId`** | **`customerNumber`** | ç›´æ¥ä½¿ç”¨ | UNIQUE ç´„æŸ,å®¢æˆ¶å±¤ç´šå»é‡ âœ… |
| `customerName` | `companyName` | ç›´æ¥æ˜ å°„ | - |
| `customerPhone` | `contactPhone` | ç›´æ¥æ˜ å°„ | - |
| `salesRepSlackId` | `userId` | **é€é user_profiles æŸ¥è©¢** | æ‰¾ä¸åˆ°å‰‡ç”¨ service-account |
| `unit` | `productLine` | æ˜ å°„å‡½æ•¸ | ICâ†’ichef, OCâ†’outchef |
| `demoMeta.storeType` | `storeType` | ç›´æ¥æ˜ å°„ | åƒ… 6% æœ‰æ­¤è³‡æ–™ |
| `demoMeta.serviceType` | `serviceType` | ç›´æ¥æ˜ å°„ | åƒ… 6% æœ‰æ­¤è³‡æ–™ |
| `demoMeta.currentPos` | `currentSystem` | ç›´æ¥æ˜ å°„ | åƒ… 6% æœ‰æ­¤è³‡æ–™ |
| `demoMeta.decisionMakerOnsite` | `decisionMakerPresent` | å¸ƒæ—â†’æ–‡å­— | yes/no/unknown |
| - | `contactName` | NULL | Firestore ç„¡æ­¤æ¬„ä½ |
| - | `contactEmail` | NULL | Firestore ç„¡æ­¤æ¬„ä½ |
| - | `source` | å›ºå®šå€¼ `"import"` | æ¨™è¨˜ç‚ºé·ç§»è³‡æ–™ |
| - | `status` | å›ºå®šå€¼ `"contacted"` | é è¨­å·²è¯çµ¡ |
| `createdAt` | `createdAt` | Timestamp è½‰æ› | - |
| `updatedAt` | `updatedAt` | Timestamp è½‰æ› | - |

**å»é‡é‚è¼¯:**
```typescript
// æŒ‰ customerId åˆ†çµ„
const customerGroups = new Map<string, FirestoreV3Case[]>();
for (const caseDoc of caseDocs) {
  const customerId = caseDoc.customerId;
  if (!customerGroups.has(customerId)) {
    customerGroups.set(customerId, []);
  }
  customerGroups.get(customerId)!.push(caseDoc);
}

// æ¯å€‹ customerId åƒ…å»ºç«‹ä¸€å€‹ Opportunity
for (const [customerId, cases] of customerGroups.entries()) {
  const representativeCase = cases[0]; // ä½¿ç”¨ç¬¬ä¸€å€‹ case
  const newOpp = mapCaseToOpportunity(representativeCase, userId);
  // ...
}
```

### B. Firestore cases â†’ PostgreSQL conversations

| V2 æ¬„ä½ | V3 æ¬„ä½ | æ˜ å°„é‚è¼¯ | å‚™è¨» |
|---------|---------|---------|------|
| **Document ID** | **`id`** | å®Œå…¨æ²¿ç”¨ | ä¿ç•™åŸå§‹ case ID âœ… |
| `caseId` | `caseNumber` | å®Œå…¨æ²¿ç”¨ | æ ¼å¼: 202511-IC004 âœ… |
| `customerId` | `opportunityId` | æŸ¥è©¢æ˜ å°„ | FK é—œè¯åˆ° opportunities.id |
| `customerName` | `title` | ç›´æ¥æ˜ å°„ | å°è©±æ¨™é¡Œ |
| `customerName` | `storeName` | ç›´æ¥æ˜ å°„ | - |
| `status` | `status` | æ˜ å°„å‡½æ•¸ | è©³è¦‹ä¸‹è¡¨ |
| `unit` | `productLine` | æ˜ å°„å‡½æ•¸ | ICâ†’ichef, OCâ†’outchef |
| `transcription` | `transcript` | JSONB è½‰æ› | çµæ§‹åŒ–è½‰æ› |
| `audio.duration` | `duration` | ç›´æ¥æ˜ å°„ | ç§’æ•¸ |
| `audio.gcsPath` | `audioUrl` | **ç¬¬ä¸€éšæ®µ NULL** | ç¬¬äºŒéšæ®µé·ç§» â³ |
| `analysis.agents.agent4.data.summary` | `summary` | æå–æ‘˜è¦ | - |
| `analysis.agents` | `meddicAnalysis` | JSONB ç°¡åŒ– | åƒ…ä¿ç•™åƒè€ƒ |
| `notification.slackChannelId` | `slackChannelId` | ç›´æ¥æ˜ å°„ | - |
| `notification.slackThreadTs` | `slackThreadTs` | ç›´æ¥æ˜ å°„ | - |
| **`salesRepSlackId`** | **`slackUserId`** | **ç›´æ¥ä¿ç•™** | â­ æ¥­å‹™ Slack ID |
| **`salesRepName`** | **`slackUsername`** | **ç›´æ¥ä¿ç•™** | â­ æ¥­å‹™åç¨± |
| **`salesRepEmail`** | **`slackUserEmail`** | **ç›´æ¥ä¿ç•™** | â­ æ¥­å‹™ Email (æ–°å¢) |
| - | `type` | å›ºå®šå€¼ `"demo"` | é è¨­ç‚º Demo |
| - | `progressScore` | NULL | V2 æ¬„ä½,V3 ç„¡ |
| - | `coachingNotes` | NULL | V2 æ¬„ä½,V3 ç„¡ |
| - | `urgencyLevel` | NULL | V2 æ¬„ä½,V3 ç„¡ |
| `createdAt` | `conversationDate` | Timestamp è½‰æ› | - |
| `createdAt` | `createdAt` | Timestamp è½‰æ› | - |
| `updatedAt` | `updatedAt` | Timestamp è½‰æ› | - |

**ç‹€æ…‹æ˜ å°„è¡¨:**

| V2 Status | V3 Status |
|-----------|-----------|
| pending | pending |
| transcribing | transcribing |
| transcribed | analyzing |
| completed | completed |
| failed | failed |

**Transcript JSONB çµæ§‹:**

```typescript
{
  segments: [
    {
      speaker: "æ¥­å‹™/å®¢æˆ¶",
      text: "å°è©±å…§å®¹",
      start: 0,   // ç§’
      end: 10     // ç§’
    }
  ],
  fullText: "å®Œæ•´æ–‡å­—ç¨¿",
  language: "zh-TW"
}
```

### C. MEDDIC Analyses

**ç­–ç•¥:** âŒ **ä¸é·ç§»**

**åŸå› :**
- V2 åƒ… 4 å€‹ Agent,V3 éœ€è¦ 6 ç¶­åº¦ MEDDIC
- ç‚ºç¢ºä¿åˆ†æä¸€è‡´æ€§,ç”± V3 é‡æ–°åˆ†æ

**ä¿ç•™å…§å®¹:**
- âœ… `conversations.transcript` - å®Œæ•´é€å­—ç¨¿
- âœ… `conversations.meddicAnalysis` (JSONB) - ç°¡åŒ–ç‰ˆåƒè€ƒè³‡æ–™
  ```typescript
  {
    status: "completed",
    agent1Context: { ... },
    agent2BuyerScore: 75,
    agent3SellerScore: 80,
    agent4Summary: "æ‘˜è¦å…§å®¹"
  }
  ```
- âŒ `meddic_analyses` è¡¨ - ä¸å»ºç«‹

---

## ğŸ”§ å·²ä¿®æ”¹çš„æª”æ¡ˆ

### 1. Schema ä¿®æ”¹

**æª”æ¡ˆ:** `packages/db/src/schema/conversation.ts`

**ä¿®æ”¹å…§å®¹:**
```typescript
// æ–°å¢æ¬„ä½ (line 70)
slackUserEmail: text("slack_user_email"), // æ¥­å‹™çš„ Email (å¾ V2 salesRepEmail ä¿ç•™)
```

**éœ€åŸ·è¡Œ Migration:**
```bash
cd packages/db
bun run db:generate
bun run db:migrate
```

### 2. Mapper ä¿®æ”¹

**æª”æ¡ˆ:** `scripts/migration/mappers/v3-cases-mapper.ts`

**A. æ–°å¢æ¸¬è©¦è³‡æ–™æª¢æŸ¥å‡½æ•¸:**
```typescript
export function isTestData(customerName: string): boolean {
  if (!customerName) return false;

  const testKeywords = [
    'æ¸¬è©¦', 'æµ‹è¯•', 'test', 'demo', 'sample',
    'ç¯„ä¾‹', 'èŒƒä¾‹', 'æ¨£æœ¬', 'æ ·æœ¬', 'testing',
    'ãƒ‡ãƒ¢', 'ãƒ†ã‚¹ãƒˆ'
  ];

  const lowerName = customerName.toLowerCase();
  return testKeywords.some(keyword =>
    lowerName.includes(keyword.toLowerCase())
  );
}
```

**B. Opportunity æ˜ å°„ä¿®æ”¹:**
```typescript
// ä½¿ç”¨ V2 customerId è€Œéç”Ÿæˆæ–°çš„ customerNumber (line 102)
customerNumber: caseDoc.customerId
```

**C. Conversation æ˜ å°„æ–°å¢ Email:**
```typescript
// ä¿ç•™æ¥­å‹™ Email (line 179)
slackUserEmail: caseDoc.salesRepEmail || null
```

### 3. é·ç§»ä¸»è…³æœ¬ä¿®æ”¹

**æª”æ¡ˆ:** `scripts/migration/migrate-v3-cases.ts`

**A. Phase 1: æ¸¬è©¦è³‡æ–™éæ¿¾**
```typescript
// éæ¿¾æ¸¬è©¦è³‡æ–™
const caseDocs = allCaseDocs.filter((caseDoc) => {
  if (isTestData(caseDoc.customerName)) {
    console.log(`â­ï¸  è·³éæ¸¬è©¦è³‡æ–™: ${caseDoc.caseId} (${caseDoc.customerName})`);
    return false;
  }
  return true;
});

const filteredCount = allCaseDocs.length - caseDocs.length;
console.log(`ğŸ“Š éæ¿¾æ‰ ${filteredCount} ç­†æ¸¬è©¦è³‡æ–™,å‰©é¤˜ ${caseDocs.length} ç­†æ­£å¼è³‡æ–™`);
```

**B. Phase 2: æŒ‰ customerId å»é‡**
```typescript
// æ”¹ç”¨ customerId è€Œé customerName
const customerGroups = new Map<string, FirestoreV3Case[]>();
for (const caseDoc of caseDocs) {
  const customerId = caseDoc.customerId;
  if (!customerId) {
    console.log(`âš ï¸  è·³éç„¡ customerId çš„ case: ${caseDoc.caseId}`);
    continue;
  }
  if (!customerGroups.has(customerId)) {
    customerGroups.set(customerId, []);
  }
  customerGroups.get(customerId)!.push(caseDoc);
}

stats.opportunities.total = customerGroups.size;
console.log(`ğŸ“Š ç™¼ç¾ ${customerGroups.size} å€‹ä¸é‡è¤‡å®¢æˆ¶ (customerId)`);
```

**C. Phase 4: è·³é MEDDIC å»ºç«‹**
```typescript
console.log("ğŸ“Š Phase 4: MEDDIC Analyses - è·³é (å°‡ç”± V3 ç³»çµ±é‡æ–°åˆ†æ)");
console.log("-".repeat(80));

const casesWithAnalysis = caseDocs.filter((c) => c.analysis?.agents);
stats.meddicAnalyses.total = casesWithAnalysis.length;
stats.meddicAnalyses.skipped = casesWithAnalysis.length;

console.log(`ğŸ“Š ç™¼ç¾ ${casesWithAnalysis.length} å€‹æœ‰ V2 åˆ†æè³‡æ–™çš„ cases`);
console.log(`â­ï¸  è·³éå»ºç«‹ MEDDIC Analyses,transcript å·²ä¿ç•™åœ¨ conversations ä¸­`);
console.log(`ğŸ“  V3 ç³»çµ±å°‡åœ¨å¾ŒçºŒé‡æ–°åŸ·è¡Œ MEDDIC åˆ†æ`);
```

### 4. æ–‡æª”

**å·²å»ºç«‹æ–‡æª”:**
- `.doc/20260121_V2åˆ°V3è³‡æ–™é·ç§»å®Œæ•´è¦åŠƒ.md` - æœ¬æ–‡ä»¶

---

## ğŸ“¦ é·ç§»åŸ·è¡Œæ­¥é©Ÿ

### éšæ®µä¸€: æ–‡å­—è³‡æ–™é·ç§» (ç›®å‰éšæ®µ)

#### æ­¥é©Ÿ 0: ç’°å¢ƒæª¢æŸ¥

```bash
# ç¢ºèªç’°å¢ƒè®Šæ•¸å·²è¨­å®š (apps/server/.env)
cat apps/server/.env | grep -E "(DATABASE_URL|FIREBASE)"
```

**å¿…è¦ç’°å¢ƒè®Šæ•¸:**
```bash
DATABASE_URL=postgresql://...
# Firebase ç’°å¢ƒè®Šæ•¸æ‡‰è©²å·²åœ¨ config.ts ä¸­è¨­å®š
```

#### æ­¥é©Ÿ 1: Schema Migration âš ï¸ å¿…é ˆåŸ·è¡Œ

```bash
# ç”¢ç”Ÿä¸¦åŸ·è¡Œ migration (æ–°å¢ conversations.slackUserEmail æ¬„ä½)
cd packages/db
bun run db:generate
bun run db:migrate
```

**é æœŸè¼¸å‡º:**
```
Migrations folder created at ...
[âœ“] Your SQL migration file âœ packages/db/drizzle/0001_add_slack_user_email.sql ğŸš€
```

#### æ­¥é©Ÿ 2: æ¸…ç† V3 è³‡æ–™åº«æ¸¬è©¦è³‡æ–™ (å¯é¸)

```bash
# å…ˆæª¢æŸ¥ç›®å‰è³‡æ–™é‡ (Dry Run)
DRY_RUN=true bun run scripts/migration/cleanup-v3-database.ts

# ç¢ºèªå¾Œæ­£å¼æ¸…ç†
FORCE_CLEANUP=true bun run scripts/migration/cleanup-v3-database.ts
```

**é æœŸçµæœ:**
- åˆªé™¤ 26 ç­†æ¸¬è©¦è³‡æ–™ (opportunities, conversations, meddic_analyses)

#### æ­¥é©Ÿ 3: Dry Run æ¸¬è©¦

```bash
# æ¸¬è©¦é·ç§»é‚è¼¯,ä¸å¯¦éš›å¯«å…¥è³‡æ–™
DRY_RUN=true bun run scripts/migration/migrate-v3-cases.ts
```

**é æœŸè¼¸å‡ºç¯„ä¾‹:**
```
ğŸš€ é–‹å§‹ Firestore Cases â†’ PostgreSQL V3 é·ç§»
ğŸ“Š æ¨¡å¼: DRY RUN (æ¸¬è©¦æ¨¡å¼)
================================================================================

ğŸ“¦ Phase 0: é è¼‰ç”¨æˆ¶æ˜ å°„
âœ… é è¼‰ 5 å€‹ç”¨æˆ¶æ˜ å°„

ğŸ“– Phase 1: è®€å– Firestore cases
âœ… è®€å– 271 ç­† cases
â­ï¸  è·³éæ¸¬è©¦è³‡æ–™: 202511-IC010 (æ¸¬è©¦å®¢æˆ¶)
â­ï¸  è·³éæ¸¬è©¦è³‡æ–™: 202511-IC015 (Demo Sample)
ğŸ“Š éæ¿¾æ‰ 15 ç­†æ¸¬è©¦è³‡æ–™,å‰©é¤˜ 256 ç­†æ­£å¼è³‡æ–™

ğŸ¯ Phase 2: å»ºç«‹ Opportunities (æŒ‰ customerId å»é‡)
--------------------------------------------------------------------------------
ğŸ“Š ç™¼ç¾ 85 å€‹ä¸é‡è¤‡å®¢æˆ¶ (customerId)
[DRY RUN] å»ºç«‹: 202511-122188 (å†°) â†’ User abc123
[DRY RUN] å»ºç«‹: 202511-122162 (éº»è¾£ç‡™) â†’ User service-account
...

ğŸ’¬ Phase 3: å»ºç«‹ Conversations
--------------------------------------------------------------------------------
[DRY RUN] å»ºç«‹: 202511-IC001 â†’ dry-run-202511-122188
[DRY RUN] å»ºç«‹: 202511-IC002 â†’ dry-run-202511-122162
...

ğŸ“Š Phase 4: MEDDIC Analyses - è·³é (å°‡ç”± V3 ç³»çµ±é‡æ–°åˆ†æ)
--------------------------------------------------------------------------------
ğŸ“Š ç™¼ç¾ 230 å€‹æœ‰ V2 åˆ†æè³‡æ–™çš„ cases
â­ï¸  è·³éå»ºç«‹ MEDDIC Analyses,transcript å·²ä¿ç•™åœ¨ conversations ä¸­
ğŸ“  V3 ç³»çµ±å°‡åœ¨å¾ŒçºŒé‡æ–°åŸ·è¡Œ MEDDIC åˆ†æ

================================================================================
ğŸ“Š é·ç§»çµ±è¨ˆå ±å‘Š
================================================================================
â±ï¸  ç¸½è€—æ™‚: 12.35 ç§’

ğŸ¯ Opportunities:
  - ç¸½æ•¸: 85
  - å»ºç«‹: 85
  - è·³é: 0
  - éŒ¯èª¤: 0

ğŸ’¬ Conversations:
  - ç¸½æ•¸: 256
  - æˆåŠŸ: 256
  - å¤±æ•—: 0

ğŸ“Š MEDDIC Analyses:
  - ç¸½æ•¸: 230
  - æˆåŠŸ: 0
  - è·³é: 230
  - å¤±æ•—: 0

================================================================================
âœ… Dry Run å®Œæˆ! å¯¦éš›é·ç§»æ™‚è«‹ç§»é™¤ DRY_RUN=true ç’°å¢ƒè®Šæ•¸
```

**æª¢æŸ¥é …ç›®:**
- [ ] éæ¿¾é‚è¼¯æ­£ç¢º (æ¸¬è©¦è³‡æ–™è¢«è·³é)
- [ ] customerId å»é‡æ­£ç¢º (ç™¼ç¾çš„å®¢æˆ¶æ•¸åˆç†)
- [ ] æ˜ å°„é‚è¼¯æ­£ç¢º (User ID æˆ– service-account)
- [ ] çµ±è¨ˆæ•¸å­—ç¬¦åˆé æœŸ
- [ ] éŒ¯èª¤æ•¸ç‚º 0

#### æ­¥é©Ÿ 4: æ­£å¼é·ç§»

```bash
# åŸ·è¡Œæ­£å¼é·ç§»
DRY_RUN=false bun run scripts/migration/migrate-v3-cases.ts
```

**é è¨ˆè€—æ™‚:** 60-90 ç§’

**é‡è¦æ³¨æ„äº‹é …:**
- ç¢ºä¿ Firestore é€£ç·šç©©å®š
- ç¢ºä¿ PostgreSQL é€£ç·šç©©å®š
- ä¸è¦ä¸­æ–·åŸ·è¡Œéç¨‹
- å®Œæˆå¾Œæœƒé¡¯ç¤ºå®Œæ•´çµ±è¨ˆå ±å‘Š

#### æ­¥é©Ÿ 5: é©—è­‰çµæœ

```bash
# åŸ·è¡Œé©—è­‰è…³æœ¬
bun run scripts/migration/validate-v3-cases.ts
```

**é©—è­‰é …ç›®:**
1. âœ… Cases â†’ Conversations ç­†æ•¸ä¸€è‡´
2. âœ… Unique Customers â†’ Opportunities ç­†æ•¸
3. âœ… MEDDIC Analyses ç­†æ•¸ (æ‡‰ç‚º 0)
4. âœ… ç„¡å­¤ç«‹ Conversations (Orphaned Records)
5. âœ… customerNumber å¿…å¡«æ¬„ä½å®Œæ•´æ€§
6. âœ… caseNumber å¿…å¡«æ¬„ä½å®Œæ•´æ€§
7. âœ… éŸ³æª” URL ç¬¬ä¸€éšæ®µç‚º null
8. âœ… Service Account ä½¿ç”¨æ¯”ä¾‹ (<90% å¯æ¥å—)

**æ‰‹å‹•æŠ½æŸ¥ (å»ºè­°åŸ·è¡Œ):**

```sql
-- 1. æª¢æŸ¥ Opportunities
SELECT
  id,
  customer_number,
  company_name,
  user_id,
  source,
  created_at
FROM opportunities
WHERE source = 'import'
LIMIT 5;

-- 2. æª¢æŸ¥ Conversations æ¥­å‹™è³‡è¨Š
SELECT
  id,
  case_number,
  title,
  slack_user_id,
  slack_username,
  slack_user_email,  -- æ–°å¢æ¬„ä½
  created_at
FROM conversations
LIMIT 5;

-- 3. æª¢æŸ¥ transcript æ˜¯å¦å®Œæ•´
SELECT
  id,
  case_number,
  transcript IS NOT NULL as has_transcript,
  audio_url IS NULL as audio_pending
FROM conversations
LIMIT 10;

-- 4. çµ±è¨ˆè³‡æ–™
SELECT
  'opportunities' as table_name,
  COUNT(*) as count
FROM opportunities
WHERE source = 'import'

UNION ALL

SELECT
  'conversations',
  COUNT(*)
FROM conversations

UNION ALL

SELECT
  'meddic_analyses',
  COUNT(*)
FROM meddic_analyses;
```

### éšæ®µäºŒ: éŸ³æª”é·ç§» (å¾…å¯¦ä½œ)

**æ™‚æ©Ÿ:** ç¬¬ä¸€éšæ®µé©—è­‰é€šéå¾Œç¨ç«‹åŸ·è¡Œ

**å¾…å»ºç«‹è…³æœ¬:** `scripts/migration/migrate-v3-audio-compressed.ts`

**æµç¨‹:**
1. å–å¾—æ‰€æœ‰ `audioUrl IS NULL` çš„ conversations
2. å¾å°æ‡‰çš„ Firestore cases å–å¾— `audio.gcsPath`
3. å¾ GCS ä¸‹è¼‰éŸ³æª”
4. ä½¿ç”¨ ffmpeg å£“ç¸®éŸ³æª” (ç›®æ¨™: æ¸›å°‘ 50-70% å¤§å°)
5. ä¸Šå‚³è‡³ Cloudflare R2
6. æ›´æ–° `conversations.audioUrl`

**é è¨ˆè€—æ™‚:** 1-3 å°æ™‚ (å–æ±ºæ–¼ç¶²è·¯é€Ÿåº¦å’ŒéŸ³æª”æ•¸é‡)

**ç’°å¢ƒè®Šæ•¸éœ€æ±‚:**
```bash
CLOUDFLARE_R2_ENDPOINT=https://...r2.cloudflarestorage.com
CLOUDFLARE_R2_ACCESS_KEY=...
CLOUDFLARE_R2_SECRET_KEY=...
CLOUDFLARE_R2_BUCKET=sales-ai-audio-files
```

---

## âœ… é©—è­‰èˆ‡æª¢æŸ¥æ¸…å–®

### é·ç§»å‰æª¢æŸ¥

- [ ] Firestore é€£ç·šæ­£å¸¸ (å¯è®€å– cases collection)
- [ ] PostgreSQL é€£ç·šæ­£å¸¸ (DATABASE_URL æ­£ç¢º)
- [ ] ç’°å¢ƒè®Šæ•¸è¨­å®šå®Œæ•´
- [ ] **Schema Migration å·²åŸ·è¡Œ** (conversations.slackUserEmail æ¬„ä½å­˜åœ¨)
- [ ] å‚™ä»½ V3 è³‡æ–™åº« (å¦‚æœ‰æ­£å¼è³‡æ–™)
- [ ] Dry Run æ¸¬è©¦é€šé
- [ ] Dry Run è¼¸å‡ºæª¢æŸ¥ç„¡èª¤

### é·ç§»ä¸­ç›£æ§

- [ ] Phase 0: é è¼‰ç”¨æˆ¶æ˜ å°„æˆåŠŸ (é¡¯ç¤ºå·²å¿«å–æ•¸é‡)
- [ ] Phase 1: è®€å– 271 ç­† Firestore cases æˆåŠŸ
- [ ] Phase 1: æ¸¬è©¦è³‡æ–™éæ¿¾æ­£å¸¸ (é¡¯ç¤ºéæ¿¾æ•¸é‡å’Œå‰©é¤˜æ•¸é‡)
- [ ] Phase 2: Opportunities å»ºç«‹æˆåŠŸ (æª¢æŸ¥å»é‡é‚è¼¯)
- [ ] Phase 2: é¡¯ç¤ºä¸é‡è¤‡å®¢æˆ¶æ•¸é‡åˆç† (~50-100 ç­†)
- [ ] Phase 3: Conversations å»ºç«‹æˆåŠŸ (æª¢æŸ¥å¤–éµé—œè¯)
- [ ] Phase 4: ç¢ºèª MEDDIC ç‚ºè·³éç‹€æ…‹
- [ ] çµ±è¨ˆå ±å‘ŠéŒ¯èª¤æ•¸ç‚º 0 æˆ–åœ¨å¯æ¥å—ç¯„åœ

### é·ç§»å¾Œé©—è­‰

#### è‡ªå‹•é©—è­‰

- [ ] åŸ·è¡Œ `validate-v3-cases.ts` æ‰€æœ‰æª¢æŸ¥é€šé
- [ ] Cases â†’ Conversations ç­†æ•¸ä¸€è‡´
- [ ] Unique Customers â†’ Opportunities ç­†æ•¸æ­£ç¢º
- [ ] ç„¡å­¤ç«‹ Conversations
- [ ] customerNumber å¿…å¡«æ¬„ä½å®Œæ•´
- [ ] caseNumber å¿…å¡«æ¬„ä½å®Œæ•´
- [ ] éŸ³æª” URL ç¬¬ä¸€éšæ®µç‚º null
- [ ] Service Account ä½¿ç”¨æ¯”ä¾‹ <90%

#### æ‰‹å‹•é©—è­‰

- [ ] æ‰‹å‹•æŠ½æŸ¥ 3-5 ç­†è³‡æ–™:
  - [ ] Opportunity.customerNumber = V2 customerId
  - [ ] Conversation.slackUserEmail æœ‰å€¼
  - [ ] Conversation.slackUserId æœ‰å€¼
  - [ ] Conversation.slackUsername æœ‰å€¼
  - [ ] Conversation.transcript å®Œæ•´ (æœ‰ segments)
  - [ ] Conversation.audioUrl ç‚º null
  - [ ] Opportunity.source = "import"

#### åŠŸèƒ½æ¸¬è©¦

- [ ] æ¸¬è©¦ Web æ‡‰ç”¨æŸ¥è©¢åŠŸèƒ½
- [ ] ç¢ºèªå¯é€é Slack ID æŸ¥è©¢ conversations
- [ ] ç¢ºèªå¯é€é Email æŸ¥è©¢ conversations
- [ ] è¨˜éŒ„å¯¦éš›çµ±è¨ˆæ•¸æ“š

### éŸ³æª”é·ç§» (ç¬¬äºŒéšæ®µ,å¾…åŸ·è¡Œ)

- [ ] ç¢ºèª GCS é€£ç·šæ­£å¸¸
- [ ] ç¢ºèª Cloudflare R2 é€£ç·šæ­£å¸¸
- [ ] ç¢ºèª ffmpeg å·²å®‰è£
- [ ] è¨­å®šåˆé©çš„ AUDIO_CONCURRENCY å€¼ (å»ºè­° 5)
- [ ] åŸ·è¡Œ `migrate-v3-audio-compressed.ts`
- [ ] é©—è­‰éŸ³æª” URL å¯æ­£å¸¸å­˜å–
- [ ] ç¢ºèª conversations.audioUrl å·²æ›´æ–°
- [ ] æŠ½æŸ¥ 3-5 å€‹éŸ³æª”å¯æ­£å¸¸æ’­æ”¾

---

## âš ï¸ é¢¨éšªè©•ä¼°èˆ‡å›æ»¾

### å·²è­˜åˆ¥é¢¨éšª

| é¢¨éšª | å½±éŸ¿ | æ©Ÿç‡ | ç·©è§£æªæ–½ |
|-----|------|------|---------|
| å¤§é‡è³‡æ–™æ­¸åˆ° service-account | æ¥­å‹™çœ‹ä¸åˆ°è‡ªå·±çš„è³‡æ–™ | é«˜ (80-90%) | âœ… å®Œæ•´ä¿ç•™ Slack ID/Email,æœªä¾†å¯é‡æ–°æ­¸å±¬ |
| Firestore é€£ç·šä¸­æ–· | é·ç§»å¤±æ•— | ä½ | try-catch åŒ…è£,è¨˜éŒ„éŒ¯èª¤ç¹¼çºŒè™•ç† |
| PostgreSQL å¯«å…¥å¤±æ•— | éƒ¨åˆ†è³‡æ–™éºå¤± | ä½ | æ‰¹æ¬¡è™•ç† + éŒ¯èª¤è¨˜éŒ„,å¯é‡æ–°åŸ·è¡Œ |
| Schema æ¬„ä½ä¸ç¬¦ | è³‡æ–™ç„¡æ³•å¯«å…¥ | ä¸­ | Dry Run æ¸¬è©¦,å‹åˆ¥è½‰æ›è™•ç† |
| æ¸¬è©¦è³‡æ–™æ··å…¥æ­£å¼è³‡æ–™ | è³‡æ–™æ±¡æŸ“ | ä½ | 9 ç¨®èªè¨€é—œéµå­—éæ¿¾ + äººå·¥æŠ½æŸ¥ |
| å¿˜è¨˜åŸ·è¡Œ Schema Migration | é·ç§»å¤±æ•— (slackUserEmail æ¬„ä½ä¸å­˜åœ¨) | ä¸­ | âœ… åœ¨æ­¥é©Ÿ 1 æ˜ç¢ºæ¨™è¨»å¿…é ˆåŸ·è¡Œ |

### å›æ»¾æ©Ÿåˆ¶

#### æ–¹å¼ 1: ä½¿ç”¨æ¸…ç†è…³æœ¬ (æ¨è–¦)

```bash
FORCE_CLEANUP=true bun run scripts/migration/cleanup-v3-database.ts
```

**å„ªé»:** å®‰å…¨ã€å¿«é€Ÿã€è‡ªå‹•é©—è­‰

#### æ–¹å¼ 2: æ‰‹å‹• SQL

```sql
-- å®Œæ•´å›æ»¾ (ä¾ç…§å¤–éµé—œè¯é †åºåˆªé™¤)
BEGIN;

-- 1. åˆªé™¤ meddic_analyses (æ‡‰è©²æ²’æœ‰,ä½†ä»¥é˜²è¬ä¸€)
DELETE FROM meddic_analyses
WHERE conversation_id IN (
  SELECT id FROM conversations WHERE opportunity_id IN (
    SELECT id FROM opportunities WHERE source = 'import'
  )
);

-- 2. åˆªé™¤ conversations
DELETE FROM conversations
WHERE opportunity_id IN (
  SELECT id FROM opportunities WHERE source = 'import'
);

-- 3. åˆªé™¤ opportunities
DELETE FROM opportunities WHERE source = 'import';

-- 4. é©—è­‰çµæœ
SELECT
  (SELECT COUNT(*) FROM opportunities WHERE source = 'import') as opps,
  (SELECT COUNT(*) FROM conversations WHERE opportunity_id IN (
    SELECT id FROM opportunities WHERE source = 'import'
  )) as convs,
  (SELECT COUNT(*) FROM meddic_analyses WHERE conversation_id IN (
    SELECT id FROM conversations WHERE opportunity_id IN (
      SELECT id FROM opportunities WHERE source = 'import'
    )
  )) as meddics;

-- æ‡‰è©²å…¨éƒ¨ç‚º 0
COMMIT;
```

#### æ–¹å¼ 3: éƒ¨åˆ†å›æ»¾ (åƒ…å›æ»¾ç‰¹å®šæ™‚é–“ç¯„åœ)

```sql
-- å›æ»¾ç‰¹å®šæ™‚é–“ä¹‹å¾Œçš„è³‡æ–™
BEGIN;

DELETE FROM conversations
WHERE created_at > '2026-01-21 10:00:00'
  AND opportunity_id IN (
    SELECT id FROM opportunities WHERE source = 'import'
  );

DELETE FROM opportunities
WHERE created_at > '2026-01-21 10:00:00'
  AND source = 'import';

COMMIT;
```

---

## ğŸ“Š é æœŸé·ç§»çµæœ

### çµ±è¨ˆé ä¼°

**V2 Firestore:** 271 ç­† cases

**ç¬¬ä¸€éšæ®µé æœŸçµæœ:**

| é …ç›® | é æœŸæ•¸é‡ | å¯¦éš›æ•¸é‡ | èªªæ˜ |
|------|---------|---------|------|
| Firestore cases (ç¸½æ•¸) | 271 | - | V2 åŸå§‹è³‡æ–™ |
| éæ¿¾æ¸¬è©¦è³‡æ–™ | ~15 | - | å«æ¸¬è©¦é—œéµå­—çš„ customerName |
| æ­£å¼è³‡æ–™ cases | ~256 | - | å¯¦éš›é·ç§»çš„æ¡ˆä»¶æ•¸ |
| Opportunities | ~85 | - | æŒ‰ customerId å»é‡å¾Œçš„å®¢æˆ¶æ•¸ |
| Conversations | ~256 | - | ç­‰æ–¼æ­£å¼è³‡æ–™ cases |
| MEDDIC Analyses | 0 | - | ä¸é·ç§»,ç”± V3 é‡æ–°åˆ†æ |
| audioUrl ç‚º null | 100% | - | å¾…ç¬¬äºŒéšæ®µé·ç§» |
| slackUserEmail æœ‰å€¼ | >90% | - | æ–°å¢æ¬„ä½ |

**ç”¨æˆ¶æ˜ å°„é ä¼° (å‡è¨­ç›®å‰å·²æœ‰ 5 å€‹è¨»å†Šç”¨æˆ¶):**

| æ˜ å°„çµæœ | é æœŸæ¯”ä¾‹ | èªªæ˜ |
|---------|---------|------|
| æ˜ å°„æˆåŠŸ (çœŸå¯¦ UUID) | ~10-20% | å·²è¨»å†Šä¸¦ç¶å®š Slack ID |
| æ˜ å°„å¤±æ•— (service-account) | ~80-90% | æœªè¨»å†Šæˆ–æœªç¶å®š |

**ç¬¬äºŒéšæ®µé æœŸçµæœ (éŸ³æª”é·ç§»):**
- éŸ³æª”å£“ç¸®ç‡: ~50-70% (åŸå§‹æª”æ¡ˆå¤§å°)
- audioUrl æ›´æ–°æˆåŠŸç‡: >95%
- é è¨ˆå„²å­˜ç©ºé–“: åŸå§‹å¤§å°çš„ 30-50%

---

## ğŸš€ å¿«é€Ÿåƒè€ƒ

### å¸¸ç”¨æŒ‡ä»¤

```bash
# ========== Schema Migration ==========
cd packages/db
bun run db:generate
bun run db:migrate

# ========== æ¸…ç†è³‡æ–™ ==========
# Dry Run (åƒ…æŸ¥çœ‹)
DRY_RUN=true bun run scripts/migration/cleanup-v3-database.ts

# æ­£å¼æ¸…ç†
FORCE_CLEANUP=true bun run scripts/migration/cleanup-v3-database.ts

# ========== é·ç§» ==========
# Dry Run æ¸¬è©¦
DRY_RUN=true bun run scripts/migration/migrate-v3-cases.ts

# æ­£å¼é·ç§»
DRY_RUN=false bun run scripts/migration/migrate-v3-cases.ts

# ========== é©—è­‰ ==========
bun run scripts/migration/validate-v3-cases.ts
```

### é‡è¦ç’°å¢ƒè®Šæ•¸

```bash
# PostgreSQL (apps/server/.env)
DATABASE_URL=postgresql://neondb_owner:***@ep-sparkling-band-a130c5ks-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require

# Firebase (æ‡‰åœ¨ scripts/migration/config.ts ä¸­è¨­å®š)
# é€šå¸¸å¾ service account JSON æª”æ¡ˆå–å¾—

# Cloudflare R2 (éŸ³æª”é·ç§»ç”¨,apps/server/.env)
CLOUDFLARE_R2_ENDPOINT=https://2b14cb05a60d60ad55427f4dd7570b90.r2.cloudflarestorage.com
CLOUDFLARE_R2_ACCESS_KEY=78ffdd5460e7b0336a62b44bc00f90dc
CLOUDFLARE_R2_SECRET_KEY=255e6da0ab3ad565a43e40215856f12faf121792e0cb8516d825589f685cc917
CLOUDFLARE_R2_BUCKET=sales-ai-audio-files
```

### é—œéµç¨‹å¼ç¢¼ç‰‡æ®µ

#### æŸ¥è©¢æ¥­å‹™è² è²¬çš„æ¡ˆä»¶

```typescript
// é€é Slack ID æŸ¥è©¢
const conversations = await db.query.conversations.findMany({
  where: eq(conversations.slackUserId, "U01ABC123")
});

// é€é Email æŸ¥è©¢
const conversations = await db.query.conversations.findMany({
  where: eq(conversations.slackUserEmail, "stephen.kao@ichef.com.tw")
});

// é€é Username æ¨¡ç³ŠæŸ¥è©¢
const conversations = await db.query.conversations.findMany({
  where: like(conversations.slackUsername, "%Stephen%")
});
```

#### è³‡æ–™é‡æ–°æ­¸å±¬

```sql
-- å°‡ service-account çš„ opportunities è½‰ç§»çµ¦æ¥­å‹™
UPDATE opportunities
SET user_id = :newUserId
WHERE user_id = 'service-account'
  AND id IN (
    SELECT DISTINCT opportunity_id
    FROM conversations
    WHERE slack_user_id = :slackUserId
    -- æˆ– WHERE slack_user_email = :email
  );
```

#### çµ±è¨ˆæŸ¥è©¢

```sql
-- æŸ¥çœ‹å„æ¥­å‹™çš„æ¡ˆä»¶æ•¸
SELECT
  c.slack_username,
  c.slack_user_email,
  COUNT(DISTINCT c.opportunity_id) as opportunities,
  COUNT(c.id) as conversations
FROM conversations c
WHERE c.slack_user_id IS NOT NULL
GROUP BY c.slack_username, c.slack_user_email
ORDER BY conversations DESC;

-- æŸ¥çœ‹ service-account çš„è³‡æ–™
SELECT
  o.id,
  o.company_name,
  o.customer_number,
  c.slack_username,
  c.slack_user_email
FROM opportunities o
LEFT JOIN conversations c ON c.opportunity_id = o.id
WHERE o.user_id = 'service-account'
LIMIT 20;
```

---

## ğŸ“ é™„éŒ„

### å®Œæ•´æ˜ å°„è¡¨ç¸½è¦½

| V2 æ¬„ä½ | V3 æ¬„ä½ | èªªæ˜ |
|---------|---------|------|
| **Document ID** | `conversations.id` | å®Œå…¨æ²¿ç”¨ âœ… |
| `data.caseId` | `conversations.caseNumber` | å®Œå…¨æ²¿ç”¨ âœ… |
| **`data.customerId`** | **`opportunities.customerNumber`** | ç›´æ¥æ²¿ç”¨ âœ… (å®¢æˆ¶å±¤ç´šå»é‡) |
| `data.customerName` | `opportunities.companyName` | âœ… |
| `data.customerName` | `conversations.title` | âœ… |
| `data.customerName` | `conversations.storeName` | âœ… |
| `data.customerPhone` | `opportunities.contactPhone` | âœ… |
| `data.salesRepSlackId` | `opportunities.userId` (é€éæ˜ å°„) | âœ… æˆ– service-account |
| `data.salesRepSlackId` | `conversations.slackUserId` | âœ… å®Œæ•´ä¿ç•™ |
| `data.salesRepName` | `conversations.slackUsername` | âœ… å®Œæ•´ä¿ç•™ |
| **`data.salesRepEmail`** | **`conversations.slackUserEmail`** | âœ… å®Œæ•´ä¿ç•™ (æ–°å¢) |
| `data.unit` | `opportunities.productLine` | ICâ†’ichef, OCâ†’outchef âœ… |
| `data.unit` | `conversations.productLine` | ICâ†’ichef, OCâ†’outchef âœ… |
| `data.status` | `conversations.status` | æ˜ å°„å‡½æ•¸ âœ… |
| `data.transcription` | `conversations.transcript` | JSONB è½‰æ› âœ… |
| `data.audio.duration` | `conversations.duration` | ç§’æ•¸ âœ… |
| `data.audio.gcsPath` | `conversations.audioUrl` | ç¬¬äºŒéšæ®µé·ç§» â³ |
| `data.analysis.agents` | `conversations.meddicAnalysis` | JSONB ç°¡åŒ– âœ… |
| `data.analysis.agents.agent4.data.summary` | `conversations.summary` | æå–æ‘˜è¦ âœ… |
| `data.notification.slackChannelId` | `conversations.slackChannelId` | âœ… |
| `data.notification.slackThreadTs` | `conversations.slackThreadTs` | âœ… |
| `data.demoMeta.storeType` | `opportunities.storeType` | âœ… |
| `data.demoMeta.serviceType` | `opportunities.serviceType` | âœ… |
| `data.demoMeta.currentPos` | `opportunities.currentSystem` | âœ… |
| `data.demoMeta.decisionMakerOnsite` | `opportunities.decisionMakerPresent` | å¸ƒæ—â†’æ–‡å­— âœ… |
| `data.createdAt` | `opportunities.createdAt` | Timestamp è½‰æ› âœ… |
| `data.createdAt` | `conversations.createdAt` | Timestamp è½‰æ› âœ… |
| `data.createdAt` | `conversations.conversationDate` | Timestamp è½‰æ› âœ… |
| `data.updatedAt` | `opportunities.updatedAt` | Timestamp è½‰æ› âœ… |
| `data.updatedAt` | `conversations.updatedAt` | Timestamp è½‰æ› âœ… |
| `data.analysis.*` | - | âŒ ä¸é·ç§» (ç”± V3 é‡æ–°åˆ†æ) |

### æ¸¬è©¦é—œéµå­—åˆ—è¡¨

```typescript
const testKeywords = [
  // ç¹é«”ä¸­æ–‡
  'æ¸¬è©¦', 'ç¯„ä¾‹', 'æ¨£æœ¬',

  // ç°¡é«”ä¸­æ–‡
  'æµ‹è¯•', 'èŒƒä¾‹', 'æ ·æœ¬',

  // è‹±æ–‡
  'test', 'demo', 'sample', 'testing',

  // æ—¥æ–‡
  'ãƒ‡ãƒ¢', 'ãƒ†ã‚¹ãƒˆ'
];
```

### é·ç§»éšæ®µæ™‚é–“è¡¨

| éšæ®µ | ä»»å‹™ | é è¨ˆæ™‚é–“ | ç‹€æ…‹ |
|------|------|---------|------|
| æº–å‚™ | Schema Migration | 5 åˆ†é˜ | â³ å¾…åŸ·è¡Œ |
| æº–å‚™ | æ¸…ç†æ¸¬è©¦è³‡æ–™ | 2 åˆ†é˜ | â³ å¾…åŸ·è¡Œ |
| ç¬¬ä¸€éšæ®µ | Dry Run æ¸¬è©¦ | 10 åˆ†é˜ | â³ å¾…åŸ·è¡Œ |
| ç¬¬ä¸€éšæ®µ | æ­£å¼é·ç§» (æ–‡å­—) | 60-90 ç§’ | â³ å¾…åŸ·è¡Œ |
| ç¬¬ä¸€éšæ®µ | é©—è­‰çµæœ | 10 åˆ†é˜ | â³ å¾…åŸ·è¡Œ |
| ç¬¬äºŒéšæ®µ | éŸ³æª”å£“ç¸®é·ç§» | 1-3 å°æ™‚ | â³ å¾…å¯¦ä½œ |

---

**æœ€å¾Œæ›´æ–°:** 2026-01-21
**æ–‡ä»¶ç‰ˆæœ¬:** 2.0
**ç‹€æ…‹:** âœ… æº–å‚™åŸ·è¡Œ
