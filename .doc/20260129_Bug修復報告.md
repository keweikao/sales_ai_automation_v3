# 2026-01-29 Bug 修復報告

**日期**: 2026-01-29
**修復數量**: 6 個 Bug
**部署狀態**: ✅ 全部已部署

---

## 修復總覽

| # | Bug 描述 | 影響範圍 | Commit / 狀態 |
|---|---------|---------|---------------|
| 1 | DB 模組 top-level await 問題 | Server 部署 | ✅ `ff0427e` |
| 2 | getTodaysTodos API 權限問題 | Dashboard 今日待辦 | ✅ `3548c8a` |
| 3 | Dashboard 今日待辦錯誤處理 | Dashboard 首頁 | ✅ `bba87da` |
| 4 | Slack Bot 401 Unauthorized | 音檔上傳 | ✅ 已部署（secrets 更新） |
| 5 | 案件編號重複 | 音檔上傳 | ✅ `147a469` |
| 6 | Google OAuth `state_mismatch` 錯誤 | 用戶登入 | ✅ 已部署（同域 Proxy） |

---

## Bug #1: DB 模組 top-level await 問題

**Commit**: `ff0427e`
**影響範圍**: Server / Cloudflare Workers 部署

### 問題描述

Cloudflare Workers 部署失敗，錯誤與 `packages/db` 模組的 top-level await 有關。

### 根本原因

`initProductionDb` 函數使用了不相容的 import 方式。

### 解決方案

**檔案**: `packages/db/src/index.ts`

- 改為 async function
- 使用 dynamic import 取代 require
- 修復 Cloudflare Workers 部署失敗問題

### 驗證結果

| 測試項目 | 結果 |
|---------|------|
| Server 部署到 Cloudflare Workers | ✅ 通過 |

---

## Bug #2: getTodaysTodos API 權限問題

**Commit**: `3548c8a`
**影響範圍**: Dashboard 今日待辦功能

### 問題描述

Dashboard 首頁的「今日待辦」區塊無法正常顯示待辦事項，API 返回空結果或權限錯誤。

### 根本原因

後端 `getTodaysTodos` API 缺少用戶身份驗證和權限控制。

### 解決方案

**檔案**: `packages/api/src/routers/sales-todo.ts`

- 添加用戶身份驗證 (`context.session.user.id`)
- 根據用戶角色篩選待辦數據：
  - `sales_rep`: 只查詢自己的待辦
  - `manager`: 查詢同部門的待辦
  - `admin`: 查詢所有待辦

### 驗證結果

| 測試項目 | 結果 |
|---------|------|
| 業務查看自己的今日待辦 | ✅ 通過 |
| 主管查看部門今日待辦 | ✅ 通過 |
| 管理員查看所有今日待辦 | ✅ 通過 |

---

## Bug #3: Dashboard 今日待辦錯誤處理

**Commit**: `bba87da`
**影響範圍**: Dashboard 首頁 (`/`)

### 問題描述

前端的 `todosQuery` 沒有檢查 `isError` 狀態。當 API 呼叫失敗時，顯示「太棒了！今日沒有待辦事項」而非錯誤訊息。

### 解決方案

**檔案**: `apps/web/src/routes/index.tsx`

1. **新增錯誤處理**：檢查 `todosQuery.isError` 狀態，顯示錯誤訊息
2. **只顯示今日待辦**：將 `includeOverdue` 改為 `false`

```tsx
// 修復後
{todosQuery.isError ? (
  <div className="py-8 text-center">
    <AlertCircle className="text-red-400" />
    <p className="text-red-400">無法載入待辦事項</p>
  </div>
) : todos && todos.length > 0 ? (
  // 顯示待辦列表
) : (
  // 顯示空狀態
)}
```

### 驗證結果

| 測試項目 | 結果 |
|---------|------|
| API 錯誤時顯示錯誤訊息 | ✅ 通過 |
| 只顯示今日待辦（不含過期） | ✅ 通過 |

---

## Bug #4: Slack Bot 401 Unauthorized

**狀態**: ✅ 已修復（Cloudflare Secrets 更新）
**影響範圍**: Slack 音檔上傳功能

### 問題描述

從 Slack 上傳音檔時，出現錯誤：
```
API Error: 401 - {"code":"UNAUTHORIZED","message":"Unauthorized"}
```

### 根本原因

Slack Bot 的 `API_TOKEN` secret 與 Server 的 `API_TOKEN` 值不一致，導致認證失敗。

**相關檔案**: `packages/api/src/context.ts:32-36`

### 解決方案

同步更新兩邊的 `API_TOKEN` 為相同值：

```bash
# 生成新 Token
NEW_TOKEN=$(openssl rand -base64 32 | tr -d '/+=' | head -c 32)

# 更新 Server
echo "$NEW_TOKEN" | bunx wrangler secret put API_TOKEN --name sales-ai-server

# 更新 Slack Bot
echo "$NEW_TOKEN" | bunx wrangler secret put API_TOKEN --name sales-ai-slack-bot

# 重新部署 Slack Bot
cd apps/slack-bot && bunx wrangler deploy
```

### 驗證結果

| 測試項目 | 結果 |
|---------|------|
| Slack Bot 呼叫 Server API 認證 | ✅ 通過 |

---

## Bug #5: 案件編號重複 - 資料庫寫入失敗

**Commit**: `147a469`
**影響範圍**: 音檔上傳、對話建立

### 問題描述

音檔上傳時出現錯誤：
```
資料庫寫入失敗: Failed query: insert into "conversations" ... case_number: 202601-IC001
```

以及後續的變數作用域錯誤：
```
Failed to queue conversation: caseNumber is not defined
```

### 根本原因

1. **SQL 查詢問題**: `getNextCaseNumber` 函數使用字串排序找最大序號，可能返回錯誤結果
2. **並發衝突**: 多個請求同時執行時，可能生成相同的案件編號
3. **變數作用域**: 重構後 `caseNumber` 在 for 循環內定義，循環外無法存取

### 解決方案

**檔案**: `packages/api/src/routers/conversation.ts`

#### 修復 1: 改用 MAX() 聚合函數取得最大序號

```typescript
// 修復後：使用 MAX + SUBSTRING 直接取得最大序號
const result = await db
  .select({
    maxSeq: sql<number>`MAX(
      CAST(
        SUBSTRING(${conversations.caseNumber} FROM '${sql.raw(prefixCode)}([0-9]+)$')
        AS INTEGER
      )
    )`.as("max_seq"),
  })
  .from(conversations)
  .where(sql`${conversations.caseNumber} LIKE ${`${prefix}%`}`);

const maxSeq = result[0]?.maxSeq;
const nextSequence = maxSeq != null ? maxSeq + 1 : 1;
```

#### 修復 2: 加入重試邏輯處理並發衝突

```typescript
const MAX_RETRIES = 3;

for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
  try {
    const caseNumber = await getNextCaseNumber(resolvedProductLine);
    // 插入資料庫...
    break; // 成功則跳出
  } catch (error) {
    const isUniqueViolation = errorMessage.includes("unique") ||
                              errorMessage.includes("duplicate");
    if (isUniqueViolation && attempt < MAX_RETRIES) {
      await new Promise(resolve => setTimeout(resolve, 100 * attempt));
      continue; // 重試
    }
    throw error;
  }
}
```

#### 修復 3: 修正變數作用域問題

```typescript
// 修復後：使用 insertedConversation 的屬性
await queueBinding.send({
  caseNumber: insertedConversation.caseNumber,  // ✅ 正確
  ...
});
```

### 修改檔案清單

| 檔案 | 變更內容 |
|------|---------|
| `packages/api/src/routers/conversation.ts` | 改用 MAX() 聚合函數 |
| `packages/api/src/routers/conversation.ts` | 加入重試邏輯（最多 3 次） |
| `packages/api/src/routers/conversation.ts` | 修正變數作用域問題 |
| `packages/api/src/routers/conversation.ts` | 加入詳細日誌 |

### 驗證結果

| 測試項目 | 結果 |
|---------|------|
| 上傳音檔生成正確案件編號 | ✅ 通過 |
| 推送到 Queue 成功 | ✅ 通過 |
| 完整上傳流程 | ✅ 通過 |

---

## Bug #6: Google OAuth `state_mismatch` 錯誤

**狀態**: ✅ 已修復（同域 Proxy 架構）
**影響範圍**: 用戶 Google 登入功能

### 問題描述

用戶使用 Google 登入時，OAuth 流程完成後顯示 `state_mismatch` 錯誤：
```
https://sales-ai-server.salesaiautomationv3.workers.dev/?error=state_mismatch
```

登入後只顯示 "ok" 文字，無法正常跳轉到 Dashboard。

### 根本原因

**跨域 Cookie 問題**：
- 前端部署在 `sales-ai-web.pages.dev`
- 後端部署在 `sales-ai-server.salesaiautomationv3.workers.dev`
- OAuth state cookie 設定在後端域，但 callback 無法正確讀取
- 瀏覽器基於安全策略限制跨域 cookie 傳遞

**流程問題**：
1. 用戶從前端發起 OAuth 請求
2. State cookie 被設定在後端域
3. Google 回調到後端
4. 後端嘗試讀取 state cookie 但失敗（跨域問題）
5. 拋出 `state_mismatch` 錯誤

### 解決方案

**實作同域 Proxy 架構**，讓所有 auth 和 API 請求都經過前端代理：

#### 1. 建立 Auth Proxy（Pages Function）

**檔案**: `apps/web/functions/api/auth/[[path]].ts`

```typescript
const SERVER_URL = "https://sales-ai-server.salesaiautomationv3.workers.dev";

export const onRequest: PagesFunction = async (context) => {
  const url = new URL(context.request.url);
  const frontendOrigin = url.origin;
  const targetUrl = `${SERVER_URL}${url.pathname}${url.search}`;

  const headers = new Headers(context.request.headers);

  const response = await fetch(targetUrl, {
    method: context.request.method,
    headers,
    body: context.request.method !== "GET" && context.request.method !== "HEAD"
      ? context.request.body
      : undefined,
    redirect: "manual",
  });

  const responseHeaders = new Headers(response.headers);

  // 重寫 Location header，讓 redirect 留在前端域
  const location = response.headers.get("location");
  if (location) {
    const rewrittenLocation = location.replace(SERVER_URL, frontendOrigin);
    responseHeaders.set("location", rewrittenLocation);
  }

  return new Response(response.body, {
    status: response.status,
    statusText: response.statusText,
    headers: responseHeaders,
  });
};
```

#### 2. 建立 API Proxy（Pages Function）

**檔案**: `apps/web/functions/rpc/[[path]].ts`

```typescript
const SERVER_URL = "https://sales-ai-server.salesaiautomationv3.workers.dev";

export const onRequest: PagesFunction = async (context) => {
  const url = new URL(context.request.url);
  const targetUrl = `${SERVER_URL}${url.pathname}${url.search}`;

  const headers = new Headers(context.request.headers);

  const response = await fetch(targetUrl, {
    method: context.request.method,
    headers,
    body: context.request.method !== "GET" && context.request.method !== "HEAD"
      ? context.request.body
      : undefined,
  });

  return new Response(response.body, {
    status: response.status,
    statusText: response.statusText,
    headers: new Headers(response.headers),
  });
};
```

#### 3. 更新路由設定

**檔案**: `apps/web/public/_routes.json`

```json
{
  "version": 1,
  "include": ["/api/auth/*", "/rpc/*"],
  "exclude": []
}
```

#### 4. 更新 Auth Client

**檔案**: `apps/web/src/lib/auth-client.ts`

```typescript
import { createAuthClient } from "better-auth/react";

// 使用同域 proxy 來避免跨域 OAuth cookie 問題
export const authClient = createAuthClient({
  // 不指定 baseURL，使用當前域
});
```

#### 5. 更新 API Client

**檔案**: `apps/web/src/utils/orpc.ts`

```typescript
export const link = new RPCLink({
  // 使用同域 proxy 確保 session cookie 正確發送
  url: typeof window !== "undefined"
    ? `${window.location.origin}/rpc`
    : `${env.VITE_SERVER_URL}/rpc`,
  fetch(url, options) {
    return fetch(url, {
      ...options,
      credentials: "include",
    });
  },
});
```

#### 6. 更新 OAuth Redirect URI

**檔案**: `packages/auth/src/index.ts`

```typescript
socialProviders: {
  google: {
    clientId: env.GOOGLE_CLIENT_ID ?? "",
    clientSecret: env.GOOGLE_CLIENT_SECRET ?? "",
    // 使用 WEB_APP_URL 讓 callback 走 frontend proxy
    redirectURI: `${env.WEB_APP_URL}/api/auth/callback/google`,
  },
},
```

#### 7. Google Cloud Console 設定

新增授權的 redirect URI：
```
https://sales-ai-web.pages.dev/api/auth/callback/google
```

### 修改檔案清單

| 檔案 | 變更內容 |
|------|---------|
| `apps/web/functions/api/auth/[[path]].ts` | 新增 Auth Proxy（含 Location 重寫） |
| `apps/web/functions/rpc/[[path]].ts` | 新增 API Proxy |
| `apps/web/public/_routes.json` | 新增 `/api/auth/*` 和 `/rpc/*` 路由 |
| `apps/web/src/lib/auth-client.ts` | 移除 baseURL，使用同域 |
| `apps/web/src/utils/orpc.ts` | 使用 `window.location.origin` |
| `packages/auth/src/index.ts` | OAuth redirectURI 改用 `WEB_APP_URL` |

### 架構圖

```
修復前（跨域問題）:
┌─────────────────┐     ┌─────────────────────────────────────┐
│   Frontend      │────▶│            Server                   │
│ pages.dev       │     │ salesaiautomationv3.workers.dev     │
│                 │     │                                     │
│ ❌ Cookie A     │     │ ✅ Cookie B (設定在 server 域)      │
└─────────────────┘     └─────────────────────────────────────┘
                              ↑
                              │ state_mismatch!
                              │ (無法讀取 Cookie A)

修復後（同域 Proxy）:
┌─────────────────────────────────────────────────────────────┐
│   Frontend (pages.dev)                                      │
│  ┌─────────────────┐    ┌─────────────────────────────────┐ │
│  │   React App     │───▶│   Pages Functions (Proxy)       │ │
│  │                 │    │   /api/auth/* → Server          │ │
│  │ ✅ Cookie       │    │   /rpc/* → Server               │ │
│  │ (同一個域)      │    │                                 │ │
│  └─────────────────┘    └─────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                     ┌─────────────────────────────────────┐
                     │            Server                   │
                     │ salesaiautomationv3.workers.dev     │
                     └─────────────────────────────────────┘
```

### 驗證結果

| 測試項目 | 結果 |
|---------|------|
| Google OAuth 登入 | ✅ 通過 |
| 登入後跳轉 Dashboard | ✅ 通過 |
| Session Cookie 正確設定 | ✅ 通過 |
| API 呼叫帶 Cookie | ✅ 通過 |
| 團隊管理頁面存取（Admin） | ✅ 通過 |

---

## 部署記錄

| 時間 | 服務 | 版本 ID |
|-----|------|--------|
| 12:37 | sales-ai-server | (commit ff0427e) |
| 14:05 | sales-ai-server | `6fce6223-43ab-49d4-9c2c-f30ce2c7e7e4` |
| 14:07 | sales-ai-server | `81a31c98-8714-4b8b-8a33-362f66bdfb27` |
| 14:08 | sales-ai-slack-bot | `2f641fec-142c-4648-a2bf-9573157f917b` |
| 15:04 | sales-ai-server | `ea98b9e2-7c19-49d1-8b3f-94d84d94de5b` (OAuth redirect URI) |
| 15:05 | sales-ai-web | `2709a525` (同域 Proxy) |

---

## 相關文件

- [2026-01-28 Bug 修復報告](.doc/20260128_Bug修復報告.md)
- [Dashboard 角色權限與今日待辦功能](.doc/20260128_Dashboard角色權限與今日待辦功能.md)
