# 2026-01-28 Bug ä¿®å¾©å ±å‘Š

**æ—¥æœŸ**: 2026-01-28

---

## ç›®éŒ„

1. [Bug #1: æ©Ÿæœƒç®¡ç†é é¢æ¥­å‹™æ¬„ä½é¡¯ç¤ºéŒ¯èª¤](#bug-1-æ©Ÿæœƒç®¡ç†é é¢æ¥­å‹™æ¬„ä½é¡¯ç¤ºéŒ¯èª¤)
2. [Bug #2: Slack Bot å¾…è¾¦äº‹é …ç„¡æ³•å„²å­˜è‡³è³‡æ–™åº«](#bug-2-slack-bot-å¾…è¾¦äº‹é …ç„¡æ³•å„²å­˜è‡³è³‡æ–™åº«)
3. [Bug #3: æ©Ÿæœƒç·¨è¼¯æŒ‰éˆ•é»æ“Šç„¡åæ‡‰](#bug-3-æ©Ÿæœƒç·¨è¼¯æŒ‰éˆ•é»æ“Šç„¡åæ‡‰)
4. [Bug #4: IC004 æ¥­å‹™é¡¯ç¤ºç‚ºéŒ¯èª¤çš„äººå“¡](#bug-4-ic004-æ¥­å‹™é¡¯ç¤ºç‚ºéŒ¯èª¤çš„äººå“¡)
5. [Bug #5: IC005 PDCM åˆ†æ•¸æ²’æœ‰é¡¯ç¤º](#bug-5-ic005-pdcm-åˆ†æ•¸æ²’æœ‰é¡¯ç¤º)
6. [Bug #6: Opportunities é é¢ UI å•é¡Œ](#bug-6-opportunities-é é¢-ui-å•é¡Œ)

---

# Bug #1: æ©Ÿæœƒç®¡ç†é é¢æ¥­å‹™æ¬„ä½é¡¯ç¤ºéŒ¯èª¤

**ç‹€æ…‹**: å·²å®Œæˆ
**å½±éŸ¿ç¯„åœ**: ç”¨æˆ¶è¨»å†Šæµç¨‹ã€æ©Ÿæœƒç®¡ç†é é¢æ¥­å‹™æ¬„ä½é¡¯ç¤º

## å•é¡Œæè¿°

### ç¾è±¡
åœ¨æ©Ÿæœƒç®¡ç†é é¢ (`/opportunities`) çš„ã€Œæ¥­å‹™ã€æ¬„ä½ä¸­ï¼š
- éƒ¨åˆ†å·²è¨»å†Šç”¨æˆ¶ï¼ˆå¦‚ belle.chenï¼‰é¡¯ç¤ºçš„æ˜¯ Slack username è€Œéè¨»å†Šåç¨±
- ä¾‹å¦‚ï¼šæ¡ˆä»¶ `202601-IC001` æ‡‰é¡¯ç¤ºã€Œé™³å¯èª¼ã€ï¼Œå»é¡¯ç¤ºã€Œbelle.chenã€

### é æœŸè¡Œç‚º
æ¥­å‹™æ¬„ä½æ‡‰æŒ‰ä»¥ä¸‹å„ªå…ˆé †åºé¡¯ç¤ºï¼š
1. è‹¥ç”¨æˆ¶å·²é€é Gmail è¨»å†Šç³»çµ±ï¼Œé¡¯ç¤ºè¨»å†Šçš„åç¨±ï¼ˆå¦‚ã€Œé™³å¯èª¼ã€ï¼‰
2. è‹¥ç”¨æˆ¶æœªè¨»å†Šï¼Œé¡¯ç¤º Slack usernameï¼ˆå¦‚ã€Œbelle.chenã€ï¼‰

---

## æ ¹æœ¬åŸå› åˆ†æ

### è³‡æ–™æµç¨‹
```
Slack ä¸Šå‚³éŸ³æª”
    â†“
conversations è¡¨è¨˜éŒ„ slack_user_id å’Œ slack_username
    â†“
æ©Ÿæœƒç®¡ç†é é¢æŸ¥è©¢æ™‚
    â†“
é€é user_profiles.slack_user_id é—œè¯åˆ° user è¡¨
    â†“
é¡¯ç¤º user.name
```

### å•é¡Œé»
æŸ¥è©¢ `user_profiles` è¡¨ç™¼ç¾ï¼Œå·²è¨»å†Šç”¨æˆ¶ belle.chen çš„ `slack_user_id` æ¬„ä½ç‚ºç©ºï¼š

```sql
SELECT user_id, slack_user_id, role
FROM user_profiles
WHERE user_id = (SELECT id FROM "user" WHERE email = 'belle.chen@ichef.com.tw');

-- çµæœï¼šslack_user_id = NULL
```

### åŸå› 
1. **ç”¨æˆ¶è¨»å†Šæ™‚æœªè‡ªå‹•å¡«å…¥ slack_user_id**
   - Better Auth çš„ `databaseHooks` æœªè¨­å®š
   - ç”¨æˆ¶é€é Gmail è¨»å†Šæ™‚ï¼Œç³»çµ±æœªæª¢æŸ¥ `EMAIL_TO_SLACK_ID` æ˜ å°„è¡¨

2. **ç¾æœ‰ Slack æ˜ å°„é‚è¼¯ä½ç½®éŒ¯èª¤**
   - `SLACK_ID_TO_EMAIL` æ˜ å°„è¡¨ä½æ–¼ `packages/api/src/routers/conversation.ts`
   - è©²é‚è¼¯åªåœ¨ Slack ä¸Šå‚³éŸ³æª”æ™‚è§¸ç™¼ï¼Œä¸åœ¨ç”¨æˆ¶è¨»å†Šæ™‚è§¸ç™¼

---

## è§£æ±ºæ–¹æ¡ˆ

### æ–¹æ¡ˆè¨­è¨ˆ

```
ç”¨æˆ¶é€é Gmail è¨»å†Š
    â†“
Better Auth å»ºç«‹ user è¨˜éŒ„
    â†“
databaseHooks.user.create.after è§¸ç™¼
    â†“
æª¢æŸ¥ EMAIL_TO_SLACK_ID æ˜ å°„è¡¨
    â†“
è‡ªå‹•å»ºç«‹ user_profile ä¸¦å¡«å…¥ slack_user_id
```

### å¯¦ä½œç´°ç¯€

#### 1. æ–°å¢ EMAIL_TO_SLACK_ID æ˜ å°„è¡¨

**æª”æ¡ˆ**: `packages/auth/src/index.ts`

```typescript
/**
 * Email åˆ° Slack User ID çš„æ˜ å°„è¡¨
 * ç”¨æ–¼æ–°ç”¨æˆ¶è¨»å†Šæ™‚è‡ªå‹•å¡«å…¥ slack_user_id
 */
const EMAIL_TO_SLACK_ID: Record<string, string> = {
  "stephen.kao@ichef.com.tw": "U0BU3PESX",
  "solo.chung@ichef.com.tw": "UCPDC51A4",
  "kevin.chen@ichef.com.tw": "UEVG3HUF4",
  "belle.chen@ichef.com.tw": "U07K188QJFQ",
  "eileen.lee@ichef.com.tw": "U8TC4Q7HB",
  "ariel.liu@ichef.com.tw": "U06U7HUEZFT",
  "kim.liang@ichef.com.tw": "U028Q69EKF1",
  "bonnie.liu@ichef.com.tw": "U01FS5DQT0T",
  "anna.yang@ichef.com.tw": "U015SA8USQ1",
  "eddie.chan@ichef.com.tw": "U0MATRQ2U",
  "joy.wu@ichef.com.tw": "U041VGKJGA1",
  "mai.chang@ichef.com.tw": "US97EGHJ5",
};
```

#### 2. æ–°å¢ databaseHooks

**æª”æ¡ˆ**: `packages/auth/src/index.ts`

```typescript
export const auth = betterAuth({
  // ... å…¶ä»–è¨­å®š ...

  databaseHooks: {
    user: {
      create: {
        after: async (user) => {
          // ç•¶æ–°ç”¨æˆ¶å‰µå»ºæ™‚ï¼Œè‡ªå‹•å»ºç«‹ user_profile
          // å¦‚æœ email åœ¨æ˜ å°„è¡¨ä¸­ï¼ŒåŒæ™‚å¡«å…¥ slack_user_id
          const slackUserId = EMAIL_TO_SLACK_ID[user.email] || null;

          // æª¢æŸ¥æ˜¯å¦å·²æœ‰ profileï¼ˆé¿å…é‡è¤‡å»ºç«‹ï¼‰
          const existingProfile = await db.query.userProfiles.findFirst({
            where: eq(userProfiles.userId, user.id),
          });

          if (!existingProfile) {
            await db.insert(userProfiles).values({
              userId: user.id,
              role: "sales_rep",
              slackUserId,
              createdAt: new Date(),
              updatedAt: new Date(),
            });
          } else if (slackUserId && !existingProfile.slackUserId) {
            // å¦‚æœ profile å­˜åœ¨ä½†æ²’æœ‰ slackUserIdï¼Œæ›´æ–°å®ƒ
            await db
              .update(userProfiles)
              .set({ slackUserId, updatedAt: new Date() })
              .where(eq(userProfiles.userId, user.id));
          }
        },
      },
    },
  },
});
```

#### 3. æ–°å¢å¿…è¦çš„ imports

```typescript
import { db } from "@Sales_ai_automation_v3/db";
import { userProfiles } from "@Sales_ai_automation_v3/db/schema";
import { eq } from "drizzle-orm";
```

---

## å®Œæ•´ä¿®æ”¹æª”æ¡ˆ

### packages/auth/src/index.ts

```typescript
import { db } from "@Sales_ai_automation_v3/db";
import { userProfiles } from "@Sales_ai_automation_v3/db/schema";
import * as schema from "@Sales_ai_automation_v3/db/schema/auth";
import { env } from "@Sales_ai_automation_v3/env/server";
import { betterAuth } from "better-auth";
import { drizzleAdapter } from "better-auth/adapters/drizzle";
import { eq } from "drizzle-orm";

/**
 * Email åˆ° Slack User ID çš„æ˜ å°„è¡¨
 * ç”¨æ–¼æ–°ç”¨æˆ¶è¨»å†Šæ™‚è‡ªå‹•å¡«å…¥ slack_user_id
 */
const EMAIL_TO_SLACK_ID: Record<string, string> = {
  "stephen.kao@ichef.com.tw": "U0BU3PESX",
  "solo.chung@ichef.com.tw": "UCPDC51A4",
  "kevin.chen@ichef.com.tw": "UEVG3HUF4",
  "belle.chen@ichef.com.tw": "U07K188QJFQ",
  "eileen.lee@ichef.com.tw": "U8TC4Q7HB",
  "ariel.liu@ichef.com.tw": "U06U7HUEZFT",
  "kim.liang@ichef.com.tw": "U028Q69EKF1",
  "bonnie.liu@ichef.com.tw": "U01FS5DQT0T",
  "anna.yang@ichef.com.tw": "U015SA8USQ1",
  "eddie.chan@ichef.com.tw": "U0MATRQ2U",
  "joy.wu@ichef.com.tw": "U041VGKJGA1",
  "mai.chang@ichef.com.tw": "US97EGHJ5",
};

export const auth = betterAuth({
  database: drizzleAdapter(db, {
    provider: "pg",
    schema,
  }),
  trustedOrigins: [env.CORS_ORIGIN],
  emailAndPassword: {
    enabled: true,
  },
  socialProviders: {
    google: {
      clientId: env.GOOGLE_CLIENT_ID,
      clientSecret: env.GOOGLE_CLIENT_SECRET,
    },
  },
  session: {
    cookieCache: {
      enabled: true,
      maxAge: 60,
    },
  },
  secret: env.BETTER_AUTH_SECRET,
  baseURL: env.BETTER_AUTH_URL,
  advanced: {
    defaultCookieAttributes: {
      sameSite: "none",
      secure: true,
      httpOnly: true,
    },
  },
  databaseHooks: {
    user: {
      create: {
        after: async (user) => {
          const slackUserId = EMAIL_TO_SLACK_ID[user.email] || null;

          const existingProfile = await db.query.userProfiles.findFirst({
            where: eq(userProfiles.userId, user.id),
          });

          if (!existingProfile) {
            await db.insert(userProfiles).values({
              userId: user.id,
              role: "sales_rep",
              slackUserId,
              createdAt: new Date(),
              updatedAt: new Date(),
            });
          } else if (slackUserId && !existingProfile.slackUserId) {
            await db
              .update(userProfiles)
              .set({ slackUserId, updatedAt: new Date() })
              .where(eq(userProfiles.userId, user.id));
          }
        },
      },
    },
  },
});
```

---

## ä¿®å¾©ç¾æœ‰ç”¨æˆ¶è³‡æ–™

### SQL è…³æœ¬

åœ¨ Neon Console åŸ·è¡Œä»¥ä¸‹ SQL ä¾†ä¿®å¾©å·²è¨»å†Šä½†ç¼ºå°‘ `slack_user_id` çš„ç”¨æˆ¶ï¼š

```sql
-- æ‰¹æ¬¡æ›´æ–°æ‰€æœ‰å·²è¨»å†Šç”¨æˆ¶çš„ slack_user_id
WITH mappings AS (
  SELECT * FROM (VALUES
    ('stephen.kao@ichef.com.tw', 'U0BU3PESX'),
    ('solo.chung@ichef.com.tw', 'UCPDC51A4'),
    ('kevin.chen@ichef.com.tw', 'UEVG3HUF4'),
    ('belle.chen@ichef.com.tw', 'U07K188QJFQ'),
    ('eileen.lee@ichef.com.tw', 'U8TC4Q7HB'),
    ('ariel.liu@ichef.com.tw', 'U06U7HUEZFT'),
    ('kim.liang@ichef.com.tw', 'U028Q69EKF1'),
    ('bonnie.liu@ichef.com.tw', 'U01FS5DQT0T'),
    ('anna.yang@ichef.com.tw', 'U015SA8USQ1'),
    ('eddie.chan@ichef.com.tw', 'U0MATRQ2U'),
    ('joy.wu@ichef.com.tw', 'U041VGKJGA1'),
    ('mai.chang@ichef.com.tw', 'US97EGHJ5')
  ) AS t(email, slack_id)
)
UPDATE user_profiles up
SET slack_user_id = m.slack_id, updated_at = NOW()
FROM mappings m
JOIN "user" u ON u.email = m.email
WHERE up.user_id = u.id
  AND (up.slack_user_id IS NULL OR up.slack_user_id = '');
```

### å–®ä¸€ç”¨æˆ¶ä¿®å¾©ï¼ˆä»¥ belle.chen ç‚ºä¾‹ï¼‰

```sql
UPDATE user_profiles
SET slack_user_id = 'U07K188QJFQ', updated_at = NOW()
WHERE user_id = (
  SELECT id FROM "user" WHERE email = 'belle.chen@ichef.com.tw'
);
```

### é©—è­‰ä¿®å¾©çµæœ

```sql
-- æª¢æŸ¥æ‰€æœ‰ Slack æ˜ å°„
SELECT u.email, u.name, up.slack_user_id, up.role
FROM user_profiles up
JOIN "user" u ON u.id = up.user_id
ORDER BY u.email;
```

---

## ç›¸é—œä»£ç¢¼ä½ç½®

### æ¥­å‹™æ¬„ä½é¡¯ç¤ºé‚è¼¯

**æª”æ¡ˆ**: `packages/api/src/routers/opportunity.ts`
**è¡Œè™Ÿ**: 446-474

```typescript
salesRepName: await (async () => {
  // 1. å¦‚æœ opportunity æœ‰é—œè¯çš„è¨»å†Šç”¨æˆ¶ï¼Œç›´æ¥ä½¿ç”¨
  if (
    opportunity.userId &&
    opportunity.userId !== "service-account" &&
    opportunity.salesRepName
  ) {
    return opportunity.salesRepName;
  }

  // 2. é€é Slack User ID æŸ¥æ‰¾æ˜¯å¦æœ‰å·²è¨»å†Šçš„ç”¨æˆ¶
  if (latestConversation?.slackUserId) {
    const registeredUser = await db
      .select({ userName: user.name })
      .from(userProfiles)
      .innerJoin(user, eq(userProfiles.userId, user.id))
      .where(
        eq(userProfiles.slackUserId, latestConversation.slackUserId)
      )
      .limit(1);

    if (registeredUser[0]?.userName) {
      return registeredUser[0].userName;
    }
  }

  // 3. è‹¥éƒ½æ‰¾ä¸åˆ°ï¼Œé¡¯ç¤º Slack username
  return latestConversation?.slackUsername || null;
})(),
```

### å‰ç«¯æ¥­å‹™æ¬„ä½

**æª”æ¡ˆ**: `apps/web/src/routes/opportunities/index.tsx`
**è¡Œè™Ÿ**: 177-179, 245-247

```tsx
// Header
<TableHead>æ¥­å‹™</TableHead>

// Cell
<TableCell>{opportunity.salesRepName || "-"}</TableCell>
```

---

## éƒ¨ç½²æ­¥é©Ÿ

### 1. åŸ·è¡Œ SQL ä¿®å¾©ç¾æœ‰è³‡æ–™

åœ¨ Neon Console åŸ·è¡Œä¸Šè¿° SQL è…³æœ¬

### 2. éƒ¨ç½² Server

```bash
cd apps/server
bunx wrangler deploy
```

### 3. é©—è­‰

1. å‰å¾€ https://sales-ai-web.pages.dev/opportunities
2. ç¢ºèª belle.chen çš„æ¡ˆä»¶é¡¯ç¤ºã€Œé™³å¯èª¼ã€è€Œéã€Œbelle.chenã€

---

## æ¸¬è©¦æ¡ˆä¾‹

| æ¡ˆä»¶ç·¨è™Ÿ | Slack User | å·²è¨»å†Š | é æœŸé¡¯ç¤º |
|---------|------------|--------|---------|
| 202601-IC001 | belle.chen (U07K188QJFQ) | æ˜¯ï¼ˆé™³å¯èª¼ï¼‰ | é™³å¯èª¼ |
| 202601-IC002 | belle.chen (U07K188QJFQ) | æ˜¯ï¼ˆé™³å¯èª¼ï¼‰ | é™³å¯èª¼ |
| æ–°æ¡ˆä»¶ | stephen.kao | æ˜¯ | Stephen Kao |
| æ–°æ¡ˆä»¶ | æœªçŸ¥ç”¨æˆ¶ | å¦ | slack_username |

---

## æœªä¾†ç¶­è­·

### æ–°å¢æ¥­å‹™äººå“¡

ç•¶æœ‰æ–°æ¥­å‹™åŠ å…¥æ™‚ï¼Œéœ€è¦æ›´æ–°å…©å€‹åœ°æ–¹ï¼š

1. **packages/auth/src/index.ts** - `EMAIL_TO_SLACK_ID` æ˜ å°„è¡¨
2. **packages/api/src/routers/conversation.ts** - `SLACK_ID_TO_EMAIL` æ˜ å°„è¡¨

### å»ºè­°æ”¹é€²

è€ƒæ…®å°‡æ˜ å°„è¡¨é›†ä¸­ç®¡ç†ï¼š
- å»ºç«‹å…±äº«çš„ `packages/shared/src/slack-mappings.ts`
- æˆ–æ”¹ç‚ºå¾è³‡æ–™åº«è®€å–æ˜ å°„é—œä¿‚

---

## ç›¸é—œæ–‡ä»¶

- [Slack Bot å•é¡Œæ’æŸ¥æ‰‹å†Š](.doc/20260113_Slack_Botå•é¡Œæ’æŸ¥æ‰‹å†Š.md)
- [V2 åˆ° V3 è³‡æ–™é·ç§»è¦åŠƒ](.doc/20260121_V2åˆ°V3è³‡æ–™é·ç§»å®Œæ•´è¦åŠƒ.md)
- [Google OAuth ç™»å…¥è¨­å®šèªªæ˜](.doc/20260120_Google_OAuthç™»å…¥è¨­å®šèªªæ˜.md)

---

# Bug #2: Slack Bot å¾…è¾¦äº‹é …ç„¡æ³•å„²å­˜è‡³è³‡æ–™åº«

**ç‹€æ…‹**: å·²ä¿®å¾©
**å½±éŸ¿ç¯„åœ**: Slack æ•´åˆåŠŸèƒ½
**åš´é‡ç¨‹åº¦**: é«˜

## å•é¡Œæè¿°

### ç¾è±¡
å¾ Slack Bot å»ºç«‹çš„å¾…è¾¦äº‹é …æœªèƒ½æˆåŠŸå„²å­˜åˆ°è³‡æ–™åº«ï¼ŒAPI å‘¼å«å¤±æ•—ã€‚

- ä½¿ç”¨è€…åœ¨ Slack ä¸­å»ºç«‹å¾…è¾¦äº‹é …
- ç³»çµ±é¡¯ç¤ºå»ºç«‹æˆåŠŸçš„è¨Šæ¯
- ä½†è³‡æ–™åº«ä¸­æŸ¥ä¸åˆ°æ–°å»ºç«‹çš„å¾…è¾¦äº‹é …

## æ ¹æœ¬åŸå› åˆ†æ

**API Token ä¸åŒ¹é…**

Slack Bot ä½¿ç”¨çš„ `API_TOKEN` èˆ‡ Server ç«¯æœŸæœ›çš„ Token ä¸ä¸€è‡´ï¼Œå°è‡´èªè­‰å¤±æ•—ã€‚

```
Slack Bot (API_TOKEN) â”€â”€âœ—â”€â”€> Server (é æœŸä¸åŒçš„ Token)
```

## è¨ºæ–·éç¨‹

1. åœ¨ `apps/slack-bot/src/api-client.ts` åŠ å…¥ debug loggingï¼š
```typescript
console.log(`[ApiClient] Request: ${options.method || "POST"} ${url}`);
console.log(`[ApiClient] Headers: ${JSON.stringify({
  ...headers,
  Authorization: headers.Authorization ? "Bearer ***" : undefined
})}`);
console.log(`[ApiClient] Body: ${body}`);

const response = await fetch(url, {...});
const responseText = await response.text();

console.log(`[ApiClient] Response status: ${response.status}`);
console.log(`[ApiClient] Response body: ${responseText.slice(0, 500)}`);
```

2. æª¢æŸ¥ Cloudflare Workers logs ç™¼ç¾èªè­‰éŒ¯èª¤

3. ä½¿ç”¨ curl ç›´æ¥æ¸¬è©¦ API ç¢ºèª Token å•é¡Œï¼š
```bash
curl -X POST https://sales-ai-server.salesaiautomationv3.workers.dev/rpc/salesTodo/create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <correct-token>" \
  -d '{"title":"æ¸¬è©¦","dueDate":"2026-01-30T00:00:00.000Z","source":"slack"}'
```

## è§£æ±ºæ–¹æ¡ˆ

é‡æ–°è¨­å®š Cloudflare Workers çš„ Secretï¼Œç¢ºä¿ Slack Bot èˆ‡ Server ä½¿ç”¨ç›¸åŒçš„ API_TOKENï¼š

```bash
# æ›´æ–° Slack Bot çš„ API_TOKEN
cd apps/slack-bot
wrangler secret put API_TOKEN
# è¼¸å…¥æ­£ç¢ºçš„ Token

# æ›´æ–° Server çš„ API_TOKENï¼ˆå¦‚éœ€è¦ï¼‰
cd apps/server
wrangler secret put API_TOKEN
# è¼¸å…¥ç›¸åŒçš„ Token
```

## é©—è­‰

1. é‡æ–°éƒ¨ç½² Slack Bot
2. åœ¨ Slack ä¸­å»ºç«‹å¾…è¾¦äº‹é …
3. åŸ·è¡Œè³‡æ–™åº«æŸ¥è©¢ç¢ºèªè³‡æ–™å·²å„²å­˜ï¼š
```bash
bun run apps/server/scripts/check-todos.ts
```

## é é˜²æªæ–½

- åœ¨éƒ¨ç½² checklist ä¸­åŠ å…¥ Secret åŒæ­¥æª¢æŸ¥
- è€ƒæ…®ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ç®¡ç†å·¥å…·çµ±ä¸€ç®¡ç†å¤šå€‹ Workers çš„ secrets

---

# Bug #3: æ©Ÿæœƒç·¨è¼¯æŒ‰éˆ•é»æ“Šç„¡åæ‡‰

**ç‹€æ…‹**: å·²ä¿®å¾©
**å½±éŸ¿ç¯„åœ**: æ©Ÿæœƒè©³æƒ…é  (`/opportunities/$id`)
**åš´é‡ç¨‹åº¦**: ä¸­

## å•é¡Œæè¿°

### ç¾è±¡
åœ¨æ©Ÿæœƒè©³æƒ…é é¢é»æ“Šã€Œç·¨è¼¯ã€æŒ‰éˆ•æ™‚ï¼Œé é¢æ²’æœ‰ä»»ä½•åæ‡‰ï¼Œç„¡æ³•å°èˆªåˆ°ç·¨è¼¯é é¢ã€‚

- é»æ“Šã€Œç·¨è¼¯ã€æŒ‰éˆ•
- ç„¡ä»»ä½•è¦–è¦ºåé¥‹
- URL ä¸è®Š
- é é¢ä¸è·³è½‰

## æ ¹æœ¬åŸå› åˆ†æ

**`<Link>` å…ƒä»¶åœ¨å·¢ç‹€è·¯ç”±ä¸­çš„å•é¡Œ**

åŸæœ¬ä½¿ç”¨ TanStack Router çš„ `<Link>` å…ƒä»¶é€²è¡Œå°èˆªï¼š

```tsx
// åŸæœ¬çš„å¯«æ³•ï¼ˆæœ‰å•é¡Œï¼‰
<Link
  to="/opportunities/$id/edit"
  params={{ id: opportunity.id }}
>
  <Edit className="mr-2 h-4 w-4" />
  ç·¨è¼¯
</Link>
```

åœ¨æŸäº›æƒ…æ³ä¸‹ï¼Œ`<Link>` å…ƒä»¶èˆ‡å·¢ç‹€å‹•æ…‹è·¯ç”±ï¼ˆ`$id/edit`ï¼‰æ­é…æ™‚å¯èƒ½ç„¡æ³•æ­£ç¢ºé‹ä½œã€‚

## è§£æ±ºæ–¹æ¡ˆ

æ”¹ç”¨ `useNavigate()` hook æ­é… `<Button>` å…ƒä»¶é€²è¡Œç¨‹å¼åŒ–å°èˆªï¼š

```tsx
// ä¿®å¾©å¾Œçš„å¯«æ³•
const navigate = useNavigate();

<Button
  onClick={() => navigate({
    to: "/opportunities/$id/edit",
    params: { id: opportunity.id },
  })}
  variant="outline"
>
  <Edit className="mr-2 h-4 w-4" />
  ç·¨è¼¯
</Button>
```

## ä¿®æ”¹æª”æ¡ˆ

| æª”æ¡ˆ | è®Šæ›´ |
|------|------|
| `apps/web/src/routes/opportunities/$id.tsx` | å°‡ `<Link>` æ”¹ç‚º `<Button>` + `navigate()` |

## é©—è­‰

1. é‡æ–° build ä¸¦éƒ¨ç½² web æ‡‰ç”¨
2. æ¸…é™¤ç€è¦½å™¨å¿«å–
3. å°èˆªè‡³ä»»ä¸€æ©Ÿæœƒè©³æƒ…é 
4. é»æ“Šã€Œç·¨è¼¯ã€æŒ‰éˆ•
5. ç¢ºèªæˆåŠŸå°èˆªè‡³ `/opportunities/$id/edit`

## é™„è¨»ï¼šuseQueryClient is not defined éŒ¯èª¤

åœ¨åŒä¸€æ¬¡ä¿®å¾©ä¸­ä¹Ÿè™•ç†äº† `useQueryClient is not defined` éŒ¯èª¤ï¼Œè©²éŒ¯èª¤æ˜¯ç”±ç€è¦½å™¨å¿«å–å°è‡´çš„èˆŠç‰ˆ JavaScript bundle è¢«è¼‰å…¥ã€‚è§£æ±ºæ–¹å¼ï¼š

```bash
cd apps/web
rm -rf dist .vite node_modules/.vite
bun run build
bunx wrangler pages deploy dist --project-name=sales-ai-web --branch=main
```

---

## æ¸¬è©¦çµæœ

| Bug | æ¸¬è©¦é …ç›® | çµæœ |
|-----|----------|------|
| #2 | Slack å»ºç«‹å¾…è¾¦ â†’ è³‡æ–™åº«æŸ¥è©¢ | âœ… é€šé |
| #3 | é»æ“Šç·¨è¼¯æŒ‰éˆ• â†’ å°èˆªè‡³ç·¨è¼¯é  | âœ… é€šé |

---

# Bug #4: IC004 æ¥­å‹™é¡¯ç¤ºç‚ºéŒ¯èª¤çš„äººå“¡

**ç‹€æ…‹**: å·²å®Œæˆ
**å½±éŸ¿ç¯„åœ**: æ©Ÿæœƒç®¡ç†é é¢æ¥­å‹™æ¬„ä½é¡¯ç¤º
**åš´é‡ç¨‹åº¦**: é«˜

## å•é¡Œæè¿°

### ç¾è±¡
æ¡ˆä»¶ `202601-IC004` çš„æ¥­å‹™æ¬„ä½é¡¯ç¤ºç‚ºã€ŒStephen Kaoã€ï¼Œä½†è©²æ¡ˆä»¶å¯¦éš›ä¸Šæ˜¯ç”± `anna.yang` é€é Slack ä¸Šå‚³çš„éŸ³æª”ã€‚

### é æœŸè¡Œç‚º
æ¥­å‹™æ¬„ä½æ‡‰é¡¯ç¤ºã€Œanna.yangã€æˆ–å…¶è¨»å†Šåç¨±ã€‚

---

## æ ¹æœ¬åŸå› åˆ†æ

### è³‡æ–™æµç¨‹è¿½è¹¤

1. æŸ¥è©¢ `conversations` è¡¨ç¢ºèªéŸ³æª”ä¸Šå‚³è€…ï¼š
```sql
SELECT id, slack_user_id, slack_username
FROM conversations
WHERE opportunity_id = (SELECT id FROM opportunities WHERE case_number = '202601-IC004')
ORDER BY created_at DESC
LIMIT 1;

-- çµæœï¼šslack_user_id = 'U015SA8USQ1', slack_username = 'anna.yang'
```

2. æŸ¥è©¢ `opportunities` è¡¨ç¢ºèª ownerï¼š
```sql
SELECT user_id, sales_rep_name
FROM opportunities
WHERE case_number = '202601-IC004';

-- çµæœï¼šuser_id = 'stephen-kao-user-id', sales_rep_name = 'Stephen Kao'
```

### å•é¡Œé»

åŸæœ¬çš„ `salesRepName` æŸ¥è©¢é‚è¼¯éŒ¯èª¤ï¼Œ**å„ªå…ˆä½¿ç”¨ `opportunity.userId`**ï¼Œè€Œä¸æ˜¯**å°è©±çš„ä¸Šå‚³è€…**ï¼š

```typescript
// éŒ¯èª¤çš„å„ªå…ˆé †åº
salesRepName: await (async () => {
  // 1. å¦‚æœ opportunity æœ‰é—œè¯çš„è¨»å†Šç”¨æˆ¶ï¼Œç›´æ¥ä½¿ç”¨ â† é€™æ˜¯éŒ¯çš„ï¼
  if (opportunity.userId && opportunity.userId !== "service-account" && opportunity.salesRepName) {
    return opportunity.salesRepName;
  }
  // 2. æ‰é€é Slack User ID æŸ¥æ‰¾
  if (latestConversation?.slackUserId) { ... }
})()
```

### åŸå› è§£é‡‹

- IC004 çš„ `opportunity.userId` æ˜¯ `Stephen Kao`ï¼ˆå› ç‚º Stephen æ˜¯ç³»çµ±ç®¡ç†å“¡æˆ–å»ºç«‹è€…ï¼‰
- ä½†å¯¦éš›ä¸Šå‚³éŸ³æª”çš„æ˜¯ `anna.yang`
- éŒ¯èª¤çš„å„ªå…ˆé †åºå°è‡´é¡¯ç¤ºäº† opportunity owner è€Œéå°è©±ä¸Šå‚³è€…

---

## è§£æ±ºæ–¹æ¡ˆ

### ä¿®æ­£å„ªå…ˆé †åº

å°‡æŸ¥è©¢é‚è¼¯æ”¹ç‚ºï¼š**å…ˆæª¢æŸ¥å°è©±çš„ Slack è³‡è¨Šï¼Œå† fallback åˆ° opportunity owner**

**æª”æ¡ˆ**: `packages/api/src/routers/opportunity.ts`
**è¡Œè™Ÿ**: ç´„ 446-474

```typescript
salesRepName: await (async () => {
  // 1. å¦‚æœæœ‰å°è©±ï¼Œå„ªå…ˆä½¿ç”¨å°è©±çš„ Slack è³‡è¨Š
  if (latestConversation?.slackUserId) {
    // å…ˆæŸ¥æ‰¾æ˜¯å¦æœ‰å·²è¨»å†Šçš„ç”¨æˆ¶
    const registeredUser = await db
      .select({ userName: user.name })
      .from(userProfiles)
      .innerJoin(user, eq(userProfiles.userId, user.id))
      .where(eq(userProfiles.slackUserId, latestConversation.slackUserId))
      .limit(1);

    if (registeredUser[0]?.userName) {
      return registeredUser[0].userName;
    }

    // è‹¥æ²’æœ‰è¨»å†Šï¼Œä½¿ç”¨ Slack username
    if (latestConversation.slackUsername) {
      return latestConversation.slackUsername;
    }
  }

  // 2. è‹¥æ²’æœ‰å°è©±è³‡è¨Šï¼Œæ‰ä½¿ç”¨ opportunity æ“æœ‰è€…
  if (
    opportunity.userId &&
    opportunity.userId !== "service-account" &&
    opportunity.salesRepName
  ) {
    return opportunity.salesRepName;
  }

  return null;
})(),
```

### é‚è¼¯èªªæ˜

```
æŸ¥è©¢æ¥­å‹™åç¨±
    â†“
æœ‰å°è©±è¨˜éŒ„ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ å°è©±æœ‰ slackUserIdï¼Ÿ
    â”‚        â”œâ”€ æ˜¯ â†’ slackUserId å°æ‡‰åˆ°å·²è¨»å†Šç”¨æˆ¶ï¼Ÿ
    â”‚        â”‚        â”œâ”€ æ˜¯ â†’ è¿”å›ç”¨æˆ¶è¨»å†Šåç¨±
    â”‚        â”‚        â””â”€ å¦ â†’ è¿”å› slack_username
    â”‚        â””â”€ å¦ â†’ æª¢æŸ¥ opportunity owner
    â””â”€ å¦ â†’ æª¢æŸ¥ opportunity owner
              â”œâ”€ æœ‰æ•ˆ â†’ è¿”å› salesRepName
              â””â”€ ç„¡æ•ˆ â†’ è¿”å› null
```

---

## éƒ¨ç½²æ­¥é©Ÿ

```bash
cd apps/server
bunx wrangler deploy
```

## é©—è­‰çµæœ

| æ¡ˆä»¶ç·¨è™Ÿ | ä¸Šå‚³è€… Slack ID | é æœŸé¡¯ç¤º | å¯¦éš›é¡¯ç¤º | ç‹€æ…‹ |
|---------|----------------|---------|---------|------|
| 202601-IC004 | U015SA8USQ1 (anna.yang) | anna.yang | anna.yang | âœ… |

---

# Bug #5: IC005 PDCM åˆ†æ•¸æ²’æœ‰é¡¯ç¤º

**ç‹€æ…‹**: å·²å®Œæˆ
**å½±éŸ¿ç¯„åœ**: æ©Ÿæœƒç®¡ç†é é¢ PDCM åˆ†æ•¸æ¬„ä½
**åš´é‡ç¨‹åº¦**: ä¸­

## å•é¡Œæè¿°

### ç¾è±¡
æ¡ˆä»¶ `202601-IC005` åœ¨æ©Ÿæœƒç®¡ç†é é¢çš„ PDCM åˆ†æ•¸æ¬„ä½é¡¯ç¤ºç‚º `-`ï¼ˆç©ºå€¼ï¼‰ï¼Œä½†è©²æ¡ˆä»¶æ‡‰è©²æœ‰ MEDDIC åˆ†æçµæœã€‚

### é æœŸè¡Œç‚º
æ‡‰é¡¯ç¤º PDCM åˆ†æ•¸ï¼ˆå¦‚ `P 65`ï¼‰ã€‚

---

## æ ¹æœ¬åŸå› åˆ†æ

### è³‡æ–™è¿½è¹¤

1. æŸ¥è©¢ `meddic_analyses` è¡¨ç¢ºèªåˆ†æçµæœï¼š
```sql
SELECT id, conversation_id, overall_score, metrics, decision, economic_buyer
FROM meddic_analyses
WHERE conversation_id IN (
  SELECT id FROM conversations
  WHERE opportunity_id = (SELECT id FROM opportunities WHERE case_number = '202601-IC005')
);

-- çµæœï¼šæœ‰ä¸€ç­†è¨˜éŒ„ï¼Œoverall_score = 65
```

2. æŸ¥è©¢ `opportunities` è¡¨ç¢ºèª meddic_scoreï¼š
```sql
SELECT meddic_score
FROM opportunities
WHERE case_number = '202601-IC005';

-- çµæœï¼šmeddic_score = NULL
```

### å•é¡Œé»

`meddic_analyses` è¡¨æœ‰åˆ†æçµæœï¼Œä½† `opportunities.meddic_score` æ¬„ä½ç‚º `NULL`ã€‚

**è³‡æ–™ä¸åŒæ­¥**ï¼šåˆ†æå®Œæˆå¾Œï¼Œ`meddic_score` æœªæ­£ç¢ºåŒæ­¥åˆ° `opportunities` è¡¨ã€‚

---

## è§£æ±ºæ–¹æ¡ˆ

### æ‰‹å‹•åŒæ­¥è³‡æ–™

åœ¨ Neon Console åŸ·è¡Œ SQL å°‡ `meddic_analyses` çš„çµæœåŒæ­¥åˆ° `opportunities`ï¼š

```sql
-- åŒæ­¥ IC005 çš„ MEDDIC åˆ†æ•¸
UPDATE opportunities o
SET meddic_score = (
  SELECT jsonb_build_object(
    'overall', ma.overall_score,
    'metrics', ma.metrics,
    'decision', ma.decision,
    'economicBuyer', ma.economic_buyer,
    'identifiedPain', ma.identified_pain,
    'champion', ma.champion,
    'competitionScore', ma.competition_score
  )
  FROM meddic_analyses ma
  INNER JOIN conversations c ON ma.conversation_id = c.id
  WHERE c.opportunity_id = o.id
  ORDER BY ma.created_at DESC
  LIMIT 1
)
WHERE o.case_number = '202601-IC005';
```

### æ‰¹æ¬¡åŒæ­¥æ‰€æœ‰ç¼ºå¤±çš„ MEDDIC åˆ†æ•¸

```sql
-- åŒæ­¥æ‰€æœ‰æœ‰åˆ†æçµæœä½† meddic_score ç‚º NULL çš„ opportunities
UPDATE opportunities o
SET meddic_score = subquery.score
FROM (
  SELECT DISTINCT ON (c.opportunity_id)
    c.opportunity_id,
    jsonb_build_object(
      'overall', ma.overall_score,
      'metrics', ma.metrics,
      'decision', ma.decision,
      'economicBuyer', ma.economic_buyer,
      'identifiedPain', ma.identified_pain,
      'champion', ma.champion,
      'competitionScore', ma.competition_score
    ) as score
  FROM meddic_analyses ma
  INNER JOIN conversations c ON ma.conversation_id = c.id
  ORDER BY c.opportunity_id, ma.created_at DESC
) subquery
WHERE o.id = subquery.opportunity_id
  AND o.meddic_score IS NULL;
```

---

## é©—è­‰çµæœ

åŸ·è¡Œ SQL å¾ŒæŸ¥è©¢ç¢ºèªï¼š

```sql
SELECT case_number, meddic_score->>'overall' as pdcm_score
FROM opportunities
WHERE case_number = '202601-IC005';

-- çµæœï¼špdcm_score = '65'
```

| æ¡ˆä»¶ç·¨è™Ÿ | ä¿®å¾©å‰ | ä¿®å¾©å¾Œ | ç‹€æ…‹ |
|---------|--------|--------|------|
| 202601-IC005 | - (NULL) | P 65 | âœ… |

---

## é é˜²æªæ–½

è€ƒæ…®åœ¨ MEDDIC åˆ†æå®Œæˆæ™‚ï¼Œè‡ªå‹•åŒæ­¥åˆ†æ•¸åˆ° `opportunities` è¡¨ã€‚éœ€æª¢æŸ¥ä»¥ä¸‹ä»£ç¢¼ï¼š

**æª”æ¡ˆ**: `packages/services/src/llm/meddic.ts`

ç¢ºä¿åœ¨ `analyzeMeddic()` å‡½æ•¸å®Œæˆå¾Œï¼Œæœ‰å‘¼å«æ›´æ–° `opportunities.meddic_score` çš„é‚è¼¯ã€‚

---

# Bug #6: Opportunities é é¢ UI å•é¡Œ

**ç‹€æ…‹**: å·²å®Œæˆ
**å½±éŸ¿ç¯„åœ**: æ©Ÿæœƒç®¡ç†é é¢ (`/opportunities`)
**åš´é‡ç¨‹åº¦**: ä½ï¼ˆUX æ”¹å–„ï¼‰

## å•é¡Œæè¿°

### ç¾è±¡

1. **é»æ“Šæ•´è¡Œéƒ½æœƒé€²å…¥è©³æƒ…é **
   - ç”¨æˆ¶æƒ³è¤‡è£½æ¡ˆä»¶ç·¨è™Ÿæˆ–å®¢æˆ¶ç·¨è™Ÿæ™‚ï¼Œé»æ“Šæœƒè§¸ç™¼å°èˆª
   - æ‡‰åªæœ‰é»æ“Šå…¬å¸åç¨±æ‰é€²å…¥è©³æƒ…é 

2. **PDCM å’Œ SPIN æ¬„ä½ä½ç½®ä¸ç¬¦åˆç¿’æ…£**
   - ç›®å‰é †åºï¼šSPIN â†’ PDCM
   - æœŸæœ›é †åºï¼šPDCM â†’ SPIN

3. **ä¸‰é»é¸å–®ç„¡åŠŸèƒ½**
   - æ¯è¡Œæœ€å³å´æœ‰ä¸‰é»é¸å–®æŒ‰éˆ•
   - ä½†é¸å–®å…§æ²’æœ‰ä»»ä½•é¸é …
   - æ‡‰ç§»é™¤ç„¡ç”¨çš„ UI å…ƒç´ 

---

## è§£æ±ºæ–¹æ¡ˆ

### 1. ä¿®æ”¹é»æ“Šè¡Œç‚º

**æª”æ¡ˆ**: `apps/web/src/routes/opportunities/index.tsx`

**ä¿®æ”¹å‰**ï¼šæ•´å€‹ `<TableRow>` æœ‰ `onClick`
```tsx
<TableRow
  onClick={() => handleView(opportunity.id)}
  className="cursor-pointer hover:bg-muted/50"
>
```

**ä¿®æ”¹å¾Œ**ï¼šåªæœ‰å…¬å¸åç¨±æœ‰ `onClick`
```tsx
<TableRow
  className={cn(
    "border-border/30 transition-all duration-200",
    index % 2 === 0 ? "bg-transparent" : "bg-muted/30"
  )}
>
  <TableCell className="font-display font-medium">
    <button
      className="cursor-pointer text-left hover:text-[var(--ds-accent)] hover:underline"
      onClick={() => handleView(opportunity.id)}
    >
      {opportunity.companyName}
    </button>
  </TableCell>
  {/* å…¶ä»–æ¬„ä½æ²’æœ‰ onClick */}
</TableRow>
```

### 2. äº¤æ› PDCM å’Œ SPIN æ¬„ä½é †åº

**ä¿®æ”¹å‰ï¼ˆHeaderï¼‰**ï¼š
```tsx
<TableHead>SPIN</TableHead>
<TableHead>PDCM</TableHead>
```

**ä¿®æ”¹å¾Œï¼ˆHeaderï¼‰**ï¼š
```tsx
<TableHead>
  <TermTooltip termKey="pdcmScore">PDCM</TermTooltip>
</TableHead>
<TableHead>
  <div className="flex items-center gap-2">
    <TrendingUp className="h-4 w-4 text-[var(--ds-accent)]" />
    <TermTooltip termKey="spinScore">SPIN</TermTooltip>
  </div>
</TableHead>
```

**ä¿®æ”¹å¾Œï¼ˆCellï¼‰**ï¼šå°æ‡‰èª¿æ•´æ¬„ä½é †åº

### 3. ç§»é™¤ä¸‰é»é¸å–®

**åˆªé™¤çš„ imports**ï¼š
```tsx
// ç§»é™¤
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { MoreHorizontal } from "lucide-react";
```

**åˆªé™¤çš„ JSX**ï¼š
```tsx
// ç§»é™¤æ•´å€‹ TableCell
<TableCell className="text-right">
  <DropdownMenu>
    <DropdownMenuTrigger asChild>
      <Button size="icon" variant="ghost">
        <MoreHorizontal className="h-4 w-4" />
      </Button>
    </DropdownMenuTrigger>
    <DropdownMenuContent align="end">
      {/* ç©ºçš„é¸å–® */}
    </DropdownMenuContent>
  </DropdownMenu>
</TableCell>
```

**æ›´æ–° colSpan**ï¼š
```tsx
// ç©ºè³‡æ–™é¡¯ç¤ºæ™‚çš„ colSpan å¾ 9 æ”¹ç‚º 8
<TableCell className="h-32 text-center" colSpan={8}>
```

---

## å®Œæ•´ä¿®æ”¹æ‘˜è¦

| é …ç›® | ä¿®æ”¹å‰ | ä¿®æ”¹å¾Œ |
|------|--------|--------|
| é»æ“Šè¡Œç‚º | æ•´è¡Œå¯é»æ“Š | åªæœ‰å…¬å¸åç¨±å¯é»æ“Š |
| æ¬„ä½é †åº | SPIN â†’ PDCM | PDCM â†’ SPIN |
| ä¸‰é»é¸å–® | å­˜åœ¨ä½†ç„¡åŠŸèƒ½ | å·²ç§»é™¤ |
| è¡¨æ ¼æ¬„æ•¸ | 9 æ¬„ | 8 æ¬„ |

---

## éƒ¨ç½²æ­¥é©Ÿ

```bash
cd apps/web
bun run build
bunx wrangler pages deploy dist --project-name=sales-ai-web --branch=main --commit-dirty=true --commit-message="fix: opportunities page UI optimization"
```

## é©—è­‰çµæœ

1. âœ… é»æ“Šå…¬å¸åç¨±é€²å…¥è©³æƒ…é 
2. âœ… é»æ“Šå…¶ä»–æ¬„ä½ä¸è§¸ç™¼å°èˆªï¼Œå¯æ­£å¸¸é¸å–æ–‡å­—
3. âœ… PDCM æ¬„ä½åœ¨ SPIN æ¬„ä½ä¹‹å‰
4. âœ… ä¸‰é»é¸å–®å·²ç§»é™¤

---

---

# Bug #7: Queue Worker æœªå‚³é competitorAnalysis åˆ° Slack é€šçŸ¥

**ç‹€æ…‹**: å·²å®Œæˆ
**å½±éŸ¿ç¯„åœ**: Slack é€šçŸ¥æœå‹™ã€ç«¶å“åˆ†æåŠŸèƒ½
**åš´é‡ç¨‹åº¦**: é«˜
**Commit**: 73efa93

## å•é¡Œæè¿°

### ç¾è±¡
ç«¶å“åˆ†æåŠŸèƒ½å·²å®Œæ•´å¯¦ä½œï¼ˆå¾Œç«¯ Agentã€è³‡æ–™åº«ã€APIã€å‰ç«¯ UIï¼‰ï¼Œä½† Slack é€šçŸ¥ä¸­æ²’æœ‰é¡¯ç¤ºç«¶å“åˆ†æå€å¡Šã€‚

- å¾Œç«¯ Orchestrator æˆåŠŸç”¢ç”Ÿ `competitorAnalysis` è³‡æ–™
- è³‡æ–™åº« `meddic_analyses.competitor_analysis` æ¬„ä½æœ‰æ­£ç¢ºå„²å­˜
- å‰ç«¯ Web UI å¯æ­£ç¢ºé¡¯ç¤ºç«¶å“åˆ†æå¡ç‰‡
- **ä½† Slack é€šçŸ¥ç¼ºå°‘ç«¶å“åˆ†æå€å¡Š**

### é æœŸè¡Œç‚º
Slack é€šçŸ¥æ‡‰é¡¯ç¤ºç«¶å“åˆ†æå€å¡Šï¼ŒåŒ…å«ï¼š
- æ•´é«”å¨è„…ç­‰ç´š
- æ¥­å‹™æ‡‰å°è©•åˆ†
- åµæ¸¬åˆ°çš„ç«¶å“è©³ç´°è³‡è¨Šï¼ˆå®¢æˆ¶åŸè©±ã€æˆ‘æ–¹å„ªå‹¢ã€å»ºè­°è©±è¡“ï¼‰

---

## æ ¹æœ¬åŸå› åˆ†æ

### è³‡æ–™æµç¨‹è¿½è¹¤

æ­£å¸¸çš„ç«¶å“åˆ†æè³‡æ–™æµç¨‹ï¼š
```
1. Orchestrator åŸ·è¡Œ Agent DAG
   â†“
2. Agent 2 åµæ¸¬ç«¶å“ä¸¦æŸ¥è©¢è³‡æ–™åº«
   â†“
3. Agent 6 è©•ä¼°æ¥­å‹™æ‡‰å°è¡¨ç¾
   â†“
4. Orchestrator.buildCompetitorAnalysis()
   - æ§‹å»º competitorAnalysis ç‰©ä»¶
   â†“
5. Queue Worker å„²å­˜åˆ°è³‡æ–™åº«
   â†“
6. Queue Worker å‘¼å« notifyProcessingCompleted â† å•é¡Œåœ¨é€™è£¡ï¼
   â†“
7. Slack Notification Service æ§‹å»º Blocks
   â†“
8. ç™¼é€åˆ° Slack é »é“
```

### å•é¡Œé»

**æª”æ¡ˆ**: `apps/queue-worker/src/index.ts`
**è¡Œè™Ÿ**: ç´„ 912

Queue Worker åœ¨å‘¼å« `notifyProcessingCompleted` æ™‚ï¼Œ**æ²’æœ‰å‚³é `competitorAnalysis` æ¬„ä½**ï¼š

```typescript
// éŒ¯èª¤çš„å¯«æ³•ï¼ˆç¼ºå°‘ competitorAnalysisï¼‰
await slackNotificationService.notifyProcessingCompleted({
  userId,
  conversationId: conversation.id,
  caseNumber: conversation.opportunity?.caseNumber || conversationId,
  analysisResult: {
    overallScore: analysis.overallScore,
    qualificationStatus: analysis.qualificationStatus,
    // ... å…¶ä»–æ¬„ä½ ...
    pdcmSpinAlerts,
    // âŒ ç¼ºå°‘ competitorAnalysisï¼
  },
  processingTimeMs: Date.now() - startTime,
  threadTs,
  shareToken,
});
```

### æ ¹æœ¬åŸå› 
åœ¨æ•´åˆç«¶å“åˆ†æåŠŸèƒ½æ™‚ï¼Œæ›´æ–°äº†ï¼š
- âœ… Orchestratorï¼ˆç”¢ç”Ÿ competitorAnalysisï¼‰
- âœ… Database Schemaï¼ˆå„²å­˜ competitorAnalysisï¼‰
- âœ… API Responseï¼ˆå›å‚³ competitorAnalysisï¼‰
- âœ… Frontend UIï¼ˆé¡¯ç¤º competitorAnalysisï¼‰
- âœ… Slack Notification Blocksï¼ˆbuildCompetitorAnalysisBlocks å‡½æ•¸ï¼‰
- âŒ **ä½†å¿˜è¨˜æ›´æ–° Queue Worker å‚³éåƒæ•¸**

---

## è§£æ±ºæ–¹æ¡ˆ

### ä¿®æ”¹ Queue Worker

**æª”æ¡ˆ**: `apps/queue-worker/src/index.ts`
**è¡Œè™Ÿ**: ç´„ 912-928

åœ¨ `notifyProcessingCompleted` å‘¼å«ä¸­åŠ å…¥ `competitorAnalysis` æ¬„ä½ï¼š

```typescript
// ä¿®å¾©å¾Œçš„å¯«æ³•
await slackNotificationService.notifyProcessingCompleted({
  userId,
  conversationId: conversation.id,
  caseNumber: conversation.opportunity?.caseNumber || conversationId,
  analysisResult: {
    overallScore: analysis.overallScore,
    qualificationStatus: analysis.qualificationStatus,
    // ... å…¶ä»–æ¬„ä½ ...
    pdcmSpinAlerts,

    // âœ… æ–°å¢ï¼šç«¶å“åˆ†æ
    competitorAnalysis: analysisResult.competitorAnalysis as
      | {
          detectedCompetitors: Array<{
            name: string;
            customerQuote: string;
            attitude: "positive" | "negative" | "neutral";
            threatLevel: "high" | "medium" | "low";
            ourAdvantages: string[];
            suggestedTalkTracks: string[];
          }>;
          overallThreatLevel: "high" | "medium" | "low" | "none";
          handlingScore?: number;
        }
      | undefined,
  },
  processingTimeMs: Date.now() - startTime,
  threadTs,
  shareToken,
});
```

### å‹åˆ¥å®šç¾©

ç¢ºä¿ `packages/services/src/notifications/types.ts` å·²åŒ…å«æ­£ç¢ºçš„å‹åˆ¥å®šç¾©ï¼š

```typescript
export interface CompetitorAnalysis {
  detectedCompetitors: DetectedCompetitor[];
  overallThreatLevel: "high" | "medium" | "low" | "none";
  handlingScore?: number;
}

export interface MEDDICAnalysisResult {
  // ... å…¶ä»–æ¬„ä½ ...

  /** ç«¶å“åˆ†æçµæœ */
  competitorAnalysis?: CompetitorAnalysis;
}
```

---

## éƒ¨ç½²æ­¥é©Ÿ

### 1. éƒ¨ç½² Queue Worker

é€™æ˜¯æœ€é—œéµçš„éƒ¨ç½²ï¼Œå¿…é ˆå…ˆå®Œæˆï¼š

```bash
cd apps/queue-worker
bunx wrangler deploy
```

### 2. é©—è­‰éƒ¨ç½²

1. ä¸Šå‚³åŒ…å«ç«¶å“æåŠçš„æ¸¬è©¦èªéŸ³æª”ï¼ˆå¦‚æåˆ°ã€Œè‚šè‚šã€ã€ã€ŒEats365ã€ï¼‰
2. ç­‰å¾…åˆ†æå®Œæˆ
3. æª¢æŸ¥ Slack é€šçŸ¥æ˜¯å¦åŒ…å«ã€ŒğŸ¯ ç«¶å“åˆ†æã€å€å¡Š
4. ç¢ºèªé¡¯ç¤ºï¼š
   - æ•´é«”å¨è„…ç­‰ç´šï¼ˆğŸ”´/ğŸŸ¡/ğŸŸ¢/âšªï¼‰
   - æ¥­å‹™æ‡‰å°è©•åˆ†ï¼ˆâ­â­â­â˜†â˜†ï¼‰
   - ç«¶å“åç¨±ã€å®¢æˆ¶æ…‹åº¦ã€å¨è„…ç­‰ç´š
   - å®¢æˆ¶åŸè©±å¼•ç”¨
   - æˆ‘æ–¹å„ªå‹¢åˆ—è¡¨
   - å»ºè­°è©±è¡“

---

## æ¸¬è©¦çµæœ

### ä¿®å¾©å‰
```
Slack é€šçŸ¥å…§å®¹ï¼š
âœ… æ¡ˆä»¶è³‡è¨Š
âœ… PDCM å¿«é€Ÿè¨ºæ–·
âœ… é—œéµç—›é»
âœ… ä¸‹ä¸€æ­¥è¡Œå‹•
âœ… æˆ°è¡“å»ºè­°
âœ… PDCM+SPIN è­¦ç¤º
âŒ ç«¶å“åˆ†æ â† ç¼ºå°‘æ­¤å€å¡Š
```

### ä¿®å¾©å¾Œ
```
Slack é€šçŸ¥å…§å®¹ï¼š
âœ… æ¡ˆä»¶è³‡è¨Š
âœ… PDCM å¿«é€Ÿè¨ºæ–·
âœ… é—œéµç—›é»
âœ… ä¸‹ä¸€æ­¥è¡Œå‹•
âœ… æˆ°è¡“å»ºè­°
âœ… PDCM+SPIN è­¦ç¤º
âœ… ç«¶å“åˆ†æ â† ç¾åœ¨æœ‰äº†ï¼
   - ğŸ”´ æ•´é«”å¨è„…ç­‰ç´š: é«˜
   - â­â­â­â˜†â˜† æ¥­å‹™æ‡‰å°è©•åˆ†: 3/5
   - è‚šè‚š | ğŸ‘ æ­£é¢ | ğŸ”´ é«˜å¨è„…
   - å®¢æˆ¶åŸè©±: ã€Œä»–å€‘ä¹‹å‰ç”¨éè‚šè‚š POS...ã€
   - æˆ‘æ–¹å„ªå‹¢: iCHEF æœ‰ 10,000+ é¤å»³å¯¦éš›é©—è­‰...
   - ğŸ’¡ å»ºè­°è©±è¡“: è‚šè‚šä¸»è¦åšé€£é–ï¼Œå–®åº—æ›´é©åˆ iCHEF...
```

---

## ç›¸é—œæ–‡ä»¶

- [ç«¶å“åˆ†ææ•´åˆ_å¾Œç«¯å®Œæˆå ±å‘Š](.doc/20260128_ç«¶å“åˆ†ææ•´åˆ_å¾Œç«¯å®Œæˆå ±å‘Š.md)
- [ç«¶å“åˆ†æå‰ç«¯å¯¦ä½œå®Œæˆå ±å‘Š](.doc/20260128_ç«¶å“åˆ†æå‰ç«¯å¯¦ä½œå®Œæˆå ±å‘Š.md)

---

## é é˜²æªæ–½

### 1. ç¨‹å¼ç¢¼å¯©æŸ¥ Checklist

ç•¶æ–°å¢åˆ†æç¶­åº¦æ™‚ï¼Œç¢ºä¿æ›´æ–°æ‰€æœ‰ç›¸é—œæ¨¡çµ„ï¼š
- [ ] Orchestratorï¼ˆç”¢ç”Ÿè³‡æ–™ï¼‰
- [ ] Database Schemaï¼ˆå„²å­˜è³‡æ–™ï¼‰
- [ ] API Responseï¼ˆå›å‚³è³‡æ–™ï¼‰
- [ ] Frontend UIï¼ˆé¡¯ç¤ºè³‡æ–™ï¼‰
- [ ] **Queue Workerï¼ˆå‚³éè³‡æ–™çµ¦é€šçŸ¥æœå‹™ï¼‰**
- [ ] Notification Blocksï¼ˆæ¸²æŸ“è³‡æ–™ï¼‰

### 2. ç«¯åˆ°ç«¯æ¸¬è©¦

å»ºè­°å»ºç«‹è‡ªå‹•åŒ–æ¸¬è©¦ï¼š
```typescript
// æ¸¬è©¦ Queue Worker å‚³éæ‰€æœ‰å¿…è¦æ¬„ä½
test("notifyProcessingCompleted includes all analysis fields", () => {
  expect(params.analysisResult).toHaveProperty("competitorAnalysis");
  expect(params.analysisResult).toHaveProperty("pdcmSpinAlerts");
  // ... å…¶ä»–æ¬„ä½
});
```

---

## ä»Šæ—¥ä¿®å¾©ç¸½è¦½

| Bug # | å•é¡Œ | ç‹€æ…‹ |
|-------|------|------|
| #1 | æ©Ÿæœƒç®¡ç†é é¢æ¥­å‹™æ¬„ä½é¡¯ç¤ºéŒ¯èª¤ï¼ˆuser_profile ç¼ºå°‘ slack_user_idï¼‰ | âœ… å·²å®Œæˆ |
| #2 | Slack Bot å¾…è¾¦äº‹é …ç„¡æ³•å„²å­˜è‡³è³‡æ–™åº« | âœ… å·²å®Œæˆ |
| #3 | æ©Ÿæœƒç·¨è¼¯æŒ‰éˆ•é»æ“Šç„¡åæ‡‰ | âœ… å·²å®Œæˆ |
| #4 | IC004 æ¥­å‹™é¡¯ç¤ºç‚ºéŒ¯èª¤çš„äººå“¡ï¼ˆå„ªå…ˆé †åºéŒ¯èª¤ï¼‰ | âœ… å·²å®Œæˆ |
| #5 | IC005 PDCM åˆ†æ•¸æ²’æœ‰é¡¯ç¤ºï¼ˆè³‡æ–™ä¸åŒæ­¥ï¼‰ | âœ… å·²å®Œæˆ |
| #6 | Opportunities é é¢ UI å•é¡Œ | âœ… å·²å®Œæˆ |
| #7 | Queue Worker æœªå‚³é competitorAnalysis åˆ° Slack é€šçŸ¥ | âœ… å·²å®Œæˆ |
