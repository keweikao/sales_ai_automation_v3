# 2026-01-28 Bug 修復報告

**日期**: 2026-01-28

---

## 目錄

1. [Bug #1: 機會管理頁面業務欄位顯示錯誤](#bug-1-機會管理頁面業務欄位顯示錯誤)
2. [Bug #2: Slack Bot 待辦事項無法儲存至資料庫](#bug-2-slack-bot-待辦事項無法儲存至資料庫)
3. [Bug #3: 機會編輯按鈕點擊無反應](#bug-3-機會編輯按鈕點擊無反應)
4. [Bug #4: IC004 業務顯示為錯誤的人員](#bug-4-ic004-業務顯示為錯誤的人員)
5. [Bug #5: IC005 PDCM 分數沒有顯示](#bug-5-ic005-pdcm-分數沒有顯示)
6. [Bug #6: Opportunities 頁面 UI 問題](#bug-6-opportunities-頁面-ui-問題)

---

# Bug #1: 機會管理頁面業務欄位顯示錯誤

**狀態**: 已完成
**影響範圍**: 用戶註冊流程、機會管理頁面業務欄位顯示

## 問題描述

### 現象
在機會管理頁面 (`/opportunities`) 的「業務」欄位中：
- 部分已註冊用戶（如 belle.chen）顯示的是 Slack username 而非註冊名稱
- 例如：案件 `202601-IC001` 應顯示「陳可誼」，卻顯示「belle.chen」

### 預期行為
業務欄位應按以下優先順序顯示：
1. 若用戶已透過 Gmail 註冊系統，顯示註冊的名稱（如「陳可誼」）
2. 若用戶未註冊，顯示 Slack username（如「belle.chen」）

---

## 根本原因分析

### 資料流程
```
Slack 上傳音檔
    ↓
conversations 表記錄 slack_user_id 和 slack_username
    ↓
機會管理頁面查詢時
    ↓
透過 user_profiles.slack_user_id 關聯到 user 表
    ↓
顯示 user.name
```

### 問題點
查詢 `user_profiles` 表發現，已註冊用戶 belle.chen 的 `slack_user_id` 欄位為空：

```sql
SELECT user_id, slack_user_id, role
FROM user_profiles
WHERE user_id = (SELECT id FROM "user" WHERE email = 'belle.chen@ichef.com.tw');

-- 結果：slack_user_id = NULL
```

### 原因
1. **用戶註冊時未自動填入 slack_user_id**
   - Better Auth 的 `databaseHooks` 未設定
   - 用戶透過 Gmail 註冊時，系統未檢查 `EMAIL_TO_SLACK_ID` 映射表

2. **現有 Slack 映射邏輯位置錯誤**
   - `SLACK_ID_TO_EMAIL` 映射表位於 `packages/api/src/routers/conversation.ts`
   - 該邏輯只在 Slack 上傳音檔時觸發，不在用戶註冊時觸發

---

## 解決方案

### 方案設計

```
用戶透過 Gmail 註冊
    ↓
Better Auth 建立 user 記錄
    ↓
databaseHooks.user.create.after 觸發
    ↓
檢查 EMAIL_TO_SLACK_ID 映射表
    ↓
自動建立 user_profile 並填入 slack_user_id
```

### 實作細節

#### 1. 新增 EMAIL_TO_SLACK_ID 映射表

**檔案**: `packages/auth/src/index.ts`

```typescript
/**
 * Email 到 Slack User ID 的映射表
 * 用於新用戶註冊時自動填入 slack_user_id
 */
const EMAIL_TO_SLACK_ID: Record<string, string> = {
  "stephen.kao@ichef.com.tw": "U0BU3PESX",
  "solo.chung@ichef.com.tw": "UCPDC51A4",
  "kevin.chen@ichef.com.tw": "UEVG3HUF4",
  "belle.chen@ichef.com.tw": "U07K188QJFQ",
  "eileen.lee@ichef.com.tw": "U8TC4Q7HB",
  "ariel.liu@ichef.com.tw": "U06U7HUEZFT",
  "kim.liang@ichef.com.tw": "U028Q69EKF1",
  "bonnie.liu@ichef.com.tw": "U01FS5DQT0T",
  "anna.yang@ichef.com.tw": "U015SA8USQ1",
  "eddie.chan@ichef.com.tw": "U0MATRQ2U",
  "joy.wu@ichef.com.tw": "U041VGKJGA1",
  "mai.chang@ichef.com.tw": "US97EGHJ5",
};
```

#### 2. 新增 databaseHooks

**檔案**: `packages/auth/src/index.ts`

```typescript
export const auth = betterAuth({
  // ... 其他設定 ...

  databaseHooks: {
    user: {
      create: {
        after: async (user) => {
          // 當新用戶創建時，自動建立 user_profile
          // 如果 email 在映射表中，同時填入 slack_user_id
          const slackUserId = EMAIL_TO_SLACK_ID[user.email] || null;

          // 檢查是否已有 profile（避免重複建立）
          const existingProfile = await db.query.userProfiles.findFirst({
            where: eq(userProfiles.userId, user.id),
          });

          if (!existingProfile) {
            await db.insert(userProfiles).values({
              userId: user.id,
              role: "sales_rep",
              slackUserId,
              createdAt: new Date(),
              updatedAt: new Date(),
            });
          } else if (slackUserId && !existingProfile.slackUserId) {
            // 如果 profile 存在但沒有 slackUserId，更新它
            await db
              .update(userProfiles)
              .set({ slackUserId, updatedAt: new Date() })
              .where(eq(userProfiles.userId, user.id));
          }
        },
      },
    },
  },
});
```

#### 3. 新增必要的 imports

```typescript
import { db } from "@Sales_ai_automation_v3/db";
import { userProfiles } from "@Sales_ai_automation_v3/db/schema";
import { eq } from "drizzle-orm";
```

---

## 完整修改檔案

### packages/auth/src/index.ts

```typescript
import { db } from "@Sales_ai_automation_v3/db";
import { userProfiles } from "@Sales_ai_automation_v3/db/schema";
import * as schema from "@Sales_ai_automation_v3/db/schema/auth";
import { env } from "@Sales_ai_automation_v3/env/server";
import { betterAuth } from "better-auth";
import { drizzleAdapter } from "better-auth/adapters/drizzle";
import { eq } from "drizzle-orm";

/**
 * Email 到 Slack User ID 的映射表
 * 用於新用戶註冊時自動填入 slack_user_id
 */
const EMAIL_TO_SLACK_ID: Record<string, string> = {
  "stephen.kao@ichef.com.tw": "U0BU3PESX",
  "solo.chung@ichef.com.tw": "UCPDC51A4",
  "kevin.chen@ichef.com.tw": "UEVG3HUF4",
  "belle.chen@ichef.com.tw": "U07K188QJFQ",
  "eileen.lee@ichef.com.tw": "U8TC4Q7HB",
  "ariel.liu@ichef.com.tw": "U06U7HUEZFT",
  "kim.liang@ichef.com.tw": "U028Q69EKF1",
  "bonnie.liu@ichef.com.tw": "U01FS5DQT0T",
  "anna.yang@ichef.com.tw": "U015SA8USQ1",
  "eddie.chan@ichef.com.tw": "U0MATRQ2U",
  "joy.wu@ichef.com.tw": "U041VGKJGA1",
  "mai.chang@ichef.com.tw": "US97EGHJ5",
};

export const auth = betterAuth({
  database: drizzleAdapter(db, {
    provider: "pg",
    schema,
  }),
  trustedOrigins: [env.CORS_ORIGIN],
  emailAndPassword: {
    enabled: true,
  },
  socialProviders: {
    google: {
      clientId: env.GOOGLE_CLIENT_ID,
      clientSecret: env.GOOGLE_CLIENT_SECRET,
    },
  },
  session: {
    cookieCache: {
      enabled: true,
      maxAge: 60,
    },
  },
  secret: env.BETTER_AUTH_SECRET,
  baseURL: env.BETTER_AUTH_URL,
  advanced: {
    defaultCookieAttributes: {
      sameSite: "none",
      secure: true,
      httpOnly: true,
    },
  },
  databaseHooks: {
    user: {
      create: {
        after: async (user) => {
          const slackUserId = EMAIL_TO_SLACK_ID[user.email] || null;

          const existingProfile = await db.query.userProfiles.findFirst({
            where: eq(userProfiles.userId, user.id),
          });

          if (!existingProfile) {
            await db.insert(userProfiles).values({
              userId: user.id,
              role: "sales_rep",
              slackUserId,
              createdAt: new Date(),
              updatedAt: new Date(),
            });
          } else if (slackUserId && !existingProfile.slackUserId) {
            await db
              .update(userProfiles)
              .set({ slackUserId, updatedAt: new Date() })
              .where(eq(userProfiles.userId, user.id));
          }
        },
      },
    },
  },
});
```

---

## 修復現有用戶資料

### SQL 腳本

在 Neon Console 執行以下 SQL 來修復已註冊但缺少 `slack_user_id` 的用戶：

```sql
-- 批次更新所有已註冊用戶的 slack_user_id
WITH mappings AS (
  SELECT * FROM (VALUES
    ('stephen.kao@ichef.com.tw', 'U0BU3PESX'),
    ('solo.chung@ichef.com.tw', 'UCPDC51A4'),
    ('kevin.chen@ichef.com.tw', 'UEVG3HUF4'),
    ('belle.chen@ichef.com.tw', 'U07K188QJFQ'),
    ('eileen.lee@ichef.com.tw', 'U8TC4Q7HB'),
    ('ariel.liu@ichef.com.tw', 'U06U7HUEZFT'),
    ('kim.liang@ichef.com.tw', 'U028Q69EKF1'),
    ('bonnie.liu@ichef.com.tw', 'U01FS5DQT0T'),
    ('anna.yang@ichef.com.tw', 'U015SA8USQ1'),
    ('eddie.chan@ichef.com.tw', 'U0MATRQ2U'),
    ('joy.wu@ichef.com.tw', 'U041VGKJGA1'),
    ('mai.chang@ichef.com.tw', 'US97EGHJ5')
  ) AS t(email, slack_id)
)
UPDATE user_profiles up
SET slack_user_id = m.slack_id, updated_at = NOW()
FROM mappings m
JOIN "user" u ON u.email = m.email
WHERE up.user_id = u.id
  AND (up.slack_user_id IS NULL OR up.slack_user_id = '');
```

### 單一用戶修復（以 belle.chen 為例）

```sql
UPDATE user_profiles
SET slack_user_id = 'U07K188QJFQ', updated_at = NOW()
WHERE user_id = (
  SELECT id FROM "user" WHERE email = 'belle.chen@ichef.com.tw'
);
```

### 驗證修復結果

```sql
-- 檢查所有 Slack 映射
SELECT u.email, u.name, up.slack_user_id, up.role
FROM user_profiles up
JOIN "user" u ON u.id = up.user_id
ORDER BY u.email;
```

---

## 相關代碼位置

### 業務欄位顯示邏輯

**檔案**: `packages/api/src/routers/opportunity.ts`
**行號**: 446-474

```typescript
salesRepName: await (async () => {
  // 1. 如果 opportunity 有關聯的註冊用戶，直接使用
  if (
    opportunity.userId &&
    opportunity.userId !== "service-account" &&
    opportunity.salesRepName
  ) {
    return opportunity.salesRepName;
  }

  // 2. 透過 Slack User ID 查找是否有已註冊的用戶
  if (latestConversation?.slackUserId) {
    const registeredUser = await db
      .select({ userName: user.name })
      .from(userProfiles)
      .innerJoin(user, eq(userProfiles.userId, user.id))
      .where(
        eq(userProfiles.slackUserId, latestConversation.slackUserId)
      )
      .limit(1);

    if (registeredUser[0]?.userName) {
      return registeredUser[0].userName;
    }
  }

  // 3. 若都找不到，顯示 Slack username
  return latestConversation?.slackUsername || null;
})(),
```

### 前端業務欄位

**檔案**: `apps/web/src/routes/opportunities/index.tsx`
**行號**: 177-179, 245-247

```tsx
// Header
<TableHead>業務</TableHead>

// Cell
<TableCell>{opportunity.salesRepName || "-"}</TableCell>
```

---

## 部署步驟

### 1. 執行 SQL 修復現有資料

在 Neon Console 執行上述 SQL 腳本

### 2. 部署 Server

```bash
cd apps/server
bunx wrangler deploy
```

### 3. 驗證

1. 前往 https://sales-ai-web.pages.dev/opportunities
2. 確認 belle.chen 的案件顯示「陳可誼」而非「belle.chen」

---

## 測試案例

| 案件編號 | Slack User | 已註冊 | 預期顯示 |
|---------|------------|--------|---------|
| 202601-IC001 | belle.chen (U07K188QJFQ) | 是（陳可誼） | 陳可誼 |
| 202601-IC002 | belle.chen (U07K188QJFQ) | 是（陳可誼） | 陳可誼 |
| 新案件 | stephen.kao | 是 | Stephen Kao |
| 新案件 | 未知用戶 | 否 | slack_username |

---

## 未來維護

### 新增業務人員

當有新業務加入時，需要更新兩個地方：

1. **packages/auth/src/index.ts** - `EMAIL_TO_SLACK_ID` 映射表
2. **packages/api/src/routers/conversation.ts** - `SLACK_ID_TO_EMAIL` 映射表

### 建議改進

考慮將映射表集中管理：
- 建立共享的 `packages/shared/src/slack-mappings.ts`
- 或改為從資料庫讀取映射關係

---

## 相關文件

- [Slack Bot 問題排查手冊](.doc/20260113_Slack_Bot問題排查手冊.md)
- [V2 到 V3 資料遷移規劃](.doc/20260121_V2到V3資料遷移完整規劃.md)
- [Google OAuth 登入設定說明](.doc/20260120_Google_OAuth登入設定說明.md)

---

# Bug #2: Slack Bot 待辦事項無法儲存至資料庫

**狀態**: 已修復
**影響範圍**: Slack 整合功能
**嚴重程度**: 高

## 問題描述

### 現象
從 Slack Bot 建立的待辦事項未能成功儲存到資料庫，API 呼叫失敗。

- 使用者在 Slack 中建立待辦事項
- 系統顯示建立成功的訊息
- 但資料庫中查不到新建立的待辦事項

## 根本原因分析

**API Token 不匹配**

Slack Bot 使用的 `API_TOKEN` 與 Server 端期望的 Token 不一致，導致認證失敗。

```
Slack Bot (API_TOKEN) ──✗──> Server (預期不同的 Token)
```

## 診斷過程

1. 在 `apps/slack-bot/src/api-client.ts` 加入 debug logging：
```typescript
console.log(`[ApiClient] Request: ${options.method || "POST"} ${url}`);
console.log(`[ApiClient] Headers: ${JSON.stringify({
  ...headers,
  Authorization: headers.Authorization ? "Bearer ***" : undefined
})}`);
console.log(`[ApiClient] Body: ${body}`);

const response = await fetch(url, {...});
const responseText = await response.text();

console.log(`[ApiClient] Response status: ${response.status}`);
console.log(`[ApiClient] Response body: ${responseText.slice(0, 500)}`);
```

2. 檢查 Cloudflare Workers logs 發現認證錯誤

3. 使用 curl 直接測試 API 確認 Token 問題：
```bash
curl -X POST https://sales-ai-server.salesaiautomationv3.workers.dev/rpc/salesTodo/create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <correct-token>" \
  -d '{"title":"測試","dueDate":"2026-01-30T00:00:00.000Z","source":"slack"}'
```

## 解決方案

重新設定 Cloudflare Workers 的 Secret，確保 Slack Bot 與 Server 使用相同的 API_TOKEN：

```bash
# 更新 Slack Bot 的 API_TOKEN
cd apps/slack-bot
wrangler secret put API_TOKEN
# 輸入正確的 Token

# 更新 Server 的 API_TOKEN（如需要）
cd apps/server
wrangler secret put API_TOKEN
# 輸入相同的 Token
```

## 驗證

1. 重新部署 Slack Bot
2. 在 Slack 中建立待辦事項
3. 執行資料庫查詢確認資料已儲存：
```bash
bun run apps/server/scripts/check-todos.ts
```

## 預防措施

- 在部署 checklist 中加入 Secret 同步檢查
- 考慮使用環境變數管理工具統一管理多個 Workers 的 secrets

---

# Bug #3: 機會編輯按鈕點擊無反應

**狀態**: 已修復
**影響範圍**: 機會詳情頁 (`/opportunities/$id`)
**嚴重程度**: 中

## 問題描述

### 現象
在機會詳情頁面點擊「編輯」按鈕時，頁面沒有任何反應，無法導航到編輯頁面。

- 點擊「編輯」按鈕
- 無任何視覺反饋
- URL 不變
- 頁面不跳轉

## 根本原因分析

**`<Link>` 元件在巢狀路由中的問題**

原本使用 TanStack Router 的 `<Link>` 元件進行導航：

```tsx
// 原本的寫法（有問題）
<Link
  to="/opportunities/$id/edit"
  params={{ id: opportunity.id }}
>
  <Edit className="mr-2 h-4 w-4" />
  編輯
</Link>
```

在某些情況下，`<Link>` 元件與巢狀動態路由（`$id/edit`）搭配時可能無法正確運作。

## 解決方案

改用 `useNavigate()` hook 搭配 `<Button>` 元件進行程式化導航：

```tsx
// 修復後的寫法
const navigate = useNavigate();

<Button
  onClick={() => navigate({
    to: "/opportunities/$id/edit",
    params: { id: opportunity.id },
  })}
  variant="outline"
>
  <Edit className="mr-2 h-4 w-4" />
  編輯
</Button>
```

## 修改檔案

| 檔案 | 變更 |
|------|------|
| `apps/web/src/routes/opportunities/$id.tsx` | 將 `<Link>` 改為 `<Button>` + `navigate()` |

## 驗證

1. 重新 build 並部署 web 應用
2. 清除瀏覽器快取
3. 導航至任一機會詳情頁
4. 點擊「編輯」按鈕
5. 確認成功導航至 `/opportunities/$id/edit`

## 附註：useQueryClient is not defined 錯誤

在同一次修復中也處理了 `useQueryClient is not defined` 錯誤，該錯誤是由瀏覽器快取導致的舊版 JavaScript bundle 被載入。解決方式：

```bash
cd apps/web
rm -rf dist .vite node_modules/.vite
bun run build
bunx wrangler pages deploy dist --project-name=sales-ai-web --branch=main
```

---

## 測試結果

| Bug | 測試項目 | 結果 |
|-----|----------|------|
| #2 | Slack 建立待辦 → 資料庫查詢 | ✅ 通過 |
| #3 | 點擊編輯按鈕 → 導航至編輯頁 | ✅ 通過 |

---

# Bug #4: IC004 業務顯示為錯誤的人員

**狀態**: 已完成
**影響範圍**: 機會管理頁面業務欄位顯示
**嚴重程度**: 高

## 問題描述

### 現象
案件 `202601-IC004` 的業務欄位顯示為「Stephen Kao」，但該案件實際上是由 `anna.yang` 透過 Slack 上傳的音檔。

### 預期行為
業務欄位應顯示「anna.yang」或其註冊名稱。

---

## 根本原因分析

### 資料流程追蹤

1. 查詢 `conversations` 表確認音檔上傳者：
```sql
SELECT id, slack_user_id, slack_username
FROM conversations
WHERE opportunity_id = (SELECT id FROM opportunities WHERE case_number = '202601-IC004')
ORDER BY created_at DESC
LIMIT 1;

-- 結果：slack_user_id = 'U015SA8USQ1', slack_username = 'anna.yang'
```

2. 查詢 `opportunities` 表確認 owner：
```sql
SELECT user_id, sales_rep_name
FROM opportunities
WHERE case_number = '202601-IC004';

-- 結果：user_id = 'stephen-kao-user-id', sales_rep_name = 'Stephen Kao'
```

### 問題點

原本的 `salesRepName` 查詢邏輯錯誤，**優先使用 `opportunity.userId`**，而不是**對話的上傳者**：

```typescript
// 錯誤的優先順序
salesRepName: await (async () => {
  // 1. 如果 opportunity 有關聯的註冊用戶，直接使用 ← 這是錯的！
  if (opportunity.userId && opportunity.userId !== "service-account" && opportunity.salesRepName) {
    return opportunity.salesRepName;
  }
  // 2. 才透過 Slack User ID 查找
  if (latestConversation?.slackUserId) { ... }
})()
```

### 原因解釋

- IC004 的 `opportunity.userId` 是 `Stephen Kao`（因為 Stephen 是系統管理員或建立者）
- 但實際上傳音檔的是 `anna.yang`
- 錯誤的優先順序導致顯示了 opportunity owner 而非對話上傳者

---

## 解決方案

### 修正優先順序

將查詢邏輯改為：**先檢查對話的 Slack 資訊，再 fallback 到 opportunity owner**

**檔案**: `packages/api/src/routers/opportunity.ts`
**行號**: 約 446-474

```typescript
salesRepName: await (async () => {
  // 1. 如果有對話，優先使用對話的 Slack 資訊
  if (latestConversation?.slackUserId) {
    // 先查找是否有已註冊的用戶
    const registeredUser = await db
      .select({ userName: user.name })
      .from(userProfiles)
      .innerJoin(user, eq(userProfiles.userId, user.id))
      .where(eq(userProfiles.slackUserId, latestConversation.slackUserId))
      .limit(1);

    if (registeredUser[0]?.userName) {
      return registeredUser[0].userName;
    }

    // 若沒有註冊，使用 Slack username
    if (latestConversation.slackUsername) {
      return latestConversation.slackUsername;
    }
  }

  // 2. 若沒有對話資訊，才使用 opportunity 擁有者
  if (
    opportunity.userId &&
    opportunity.userId !== "service-account" &&
    opportunity.salesRepName
  ) {
    return opportunity.salesRepName;
  }

  return null;
})(),
```

### 邏輯說明

```
查詢業務名稱
    ↓
有對話記錄？
    ├─ 是 → 對話有 slackUserId？
    │        ├─ 是 → slackUserId 對應到已註冊用戶？
    │        │        ├─ 是 → 返回用戶註冊名稱
    │        │        └─ 否 → 返回 slack_username
    │        └─ 否 → 檢查 opportunity owner
    └─ 否 → 檢查 opportunity owner
              ├─ 有效 → 返回 salesRepName
              └─ 無效 → 返回 null
```

---

## 部署步驟

```bash
cd apps/server
bunx wrangler deploy
```

## 驗證結果

| 案件編號 | 上傳者 Slack ID | 預期顯示 | 實際顯示 | 狀態 |
|---------|----------------|---------|---------|------|
| 202601-IC004 | U015SA8USQ1 (anna.yang) | anna.yang | anna.yang | ✅ |

---

# Bug #5: IC005 PDCM 分數沒有顯示

**狀態**: 已完成
**影響範圍**: 機會管理頁面 PDCM 分數欄位
**嚴重程度**: 中

## 問題描述

### 現象
案件 `202601-IC005` 在機會管理頁面的 PDCM 分數欄位顯示為 `-`（空值），但該案件應該有 MEDDIC 分析結果。

### 預期行為
應顯示 PDCM 分數（如 `P 65`）。

---

## 根本原因分析

### 資料追蹤

1. 查詢 `meddic_analyses` 表確認分析結果：
```sql
SELECT id, conversation_id, overall_score, metrics, decision, economic_buyer
FROM meddic_analyses
WHERE conversation_id IN (
  SELECT id FROM conversations
  WHERE opportunity_id = (SELECT id FROM opportunities WHERE case_number = '202601-IC005')
);

-- 結果：有一筆記錄，overall_score = 65
```

2. 查詢 `opportunities` 表確認 meddic_score：
```sql
SELECT meddic_score
FROM opportunities
WHERE case_number = '202601-IC005';

-- 結果：meddic_score = NULL
```

### 問題點

`meddic_analyses` 表有分析結果，但 `opportunities.meddic_score` 欄位為 `NULL`。

**資料不同步**：分析完成後，`meddic_score` 未正確同步到 `opportunities` 表。

---

## 解決方案

### 手動同步資料

在 Neon Console 執行 SQL 將 `meddic_analyses` 的結果同步到 `opportunities`：

```sql
-- 同步 IC005 的 MEDDIC 分數
UPDATE opportunities o
SET meddic_score = (
  SELECT jsonb_build_object(
    'overall', ma.overall_score,
    'metrics', ma.metrics,
    'decision', ma.decision,
    'economicBuyer', ma.economic_buyer,
    'identifiedPain', ma.identified_pain,
    'champion', ma.champion,
    'competitionScore', ma.competition_score
  )
  FROM meddic_analyses ma
  INNER JOIN conversations c ON ma.conversation_id = c.id
  WHERE c.opportunity_id = o.id
  ORDER BY ma.created_at DESC
  LIMIT 1
)
WHERE o.case_number = '202601-IC005';
```

### 批次同步所有缺失的 MEDDIC 分數

```sql
-- 同步所有有分析結果但 meddic_score 為 NULL 的 opportunities
UPDATE opportunities o
SET meddic_score = subquery.score
FROM (
  SELECT DISTINCT ON (c.opportunity_id)
    c.opportunity_id,
    jsonb_build_object(
      'overall', ma.overall_score,
      'metrics', ma.metrics,
      'decision', ma.decision,
      'economicBuyer', ma.economic_buyer,
      'identifiedPain', ma.identified_pain,
      'champion', ma.champion,
      'competitionScore', ma.competition_score
    ) as score
  FROM meddic_analyses ma
  INNER JOIN conversations c ON ma.conversation_id = c.id
  ORDER BY c.opportunity_id, ma.created_at DESC
) subquery
WHERE o.id = subquery.opportunity_id
  AND o.meddic_score IS NULL;
```

---

## 驗證結果

執行 SQL 後查詢確認：

```sql
SELECT case_number, meddic_score->>'overall' as pdcm_score
FROM opportunities
WHERE case_number = '202601-IC005';

-- 結果：pdcm_score = '65'
```

| 案件編號 | 修復前 | 修復後 | 狀態 |
|---------|--------|--------|------|
| 202601-IC005 | - (NULL) | P 65 | ✅ |

---

## 預防措施

考慮在 MEDDIC 分析完成時，自動同步分數到 `opportunities` 表。需檢查以下代碼：

**檔案**: `packages/services/src/llm/meddic.ts`

確保在 `analyzeMeddic()` 函數完成後，有呼叫更新 `opportunities.meddic_score` 的邏輯。

---

# Bug #6: Opportunities 頁面 UI 問題

**狀態**: 已完成
**影響範圍**: 機會管理頁面 (`/opportunities`)
**嚴重程度**: 低（UX 改善）

## 問題描述

### 現象

1. **點擊整行都會進入詳情頁**
   - 用戶想複製案件編號或客戶編號時，點擊會觸發導航
   - 應只有點擊公司名稱才進入詳情頁

2. **PDCM 和 SPIN 欄位位置不符合習慣**
   - 目前順序：SPIN → PDCM
   - 期望順序：PDCM → SPIN

3. **三點選單無功能**
   - 每行最右側有三點選單按鈕
   - 但選單內沒有任何選項
   - 應移除無用的 UI 元素

---

## 解決方案

### 1. 修改點擊行為

**檔案**: `apps/web/src/routes/opportunities/index.tsx`

**修改前**：整個 `<TableRow>` 有 `onClick`
```tsx
<TableRow
  onClick={() => handleView(opportunity.id)}
  className="cursor-pointer hover:bg-muted/50"
>
```

**修改後**：只有公司名稱有 `onClick`
```tsx
<TableRow
  className={cn(
    "border-border/30 transition-all duration-200",
    index % 2 === 0 ? "bg-transparent" : "bg-muted/30"
  )}
>
  <TableCell className="font-display font-medium">
    <button
      className="cursor-pointer text-left hover:text-[var(--ds-accent)] hover:underline"
      onClick={() => handleView(opportunity.id)}
    >
      {opportunity.companyName}
    </button>
  </TableCell>
  {/* 其他欄位沒有 onClick */}
</TableRow>
```

### 2. 交換 PDCM 和 SPIN 欄位順序

**修改前（Header）**：
```tsx
<TableHead>SPIN</TableHead>
<TableHead>PDCM</TableHead>
```

**修改後（Header）**：
```tsx
<TableHead>
  <TermTooltip termKey="pdcmScore">PDCM</TermTooltip>
</TableHead>
<TableHead>
  <div className="flex items-center gap-2">
    <TrendingUp className="h-4 w-4 text-[var(--ds-accent)]" />
    <TermTooltip termKey="spinScore">SPIN</TermTooltip>
  </div>
</TableHead>
```

**修改後（Cell）**：對應調整欄位順序

### 3. 移除三點選單

**刪除的 imports**：
```tsx
// 移除
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { MoreHorizontal } from "lucide-react";
```

**刪除的 JSX**：
```tsx
// 移除整個 TableCell
<TableCell className="text-right">
  <DropdownMenu>
    <DropdownMenuTrigger asChild>
      <Button size="icon" variant="ghost">
        <MoreHorizontal className="h-4 w-4" />
      </Button>
    </DropdownMenuTrigger>
    <DropdownMenuContent align="end">
      {/* 空的選單 */}
    </DropdownMenuContent>
  </DropdownMenu>
</TableCell>
```

**更新 colSpan**：
```tsx
// 空資料顯示時的 colSpan 從 9 改為 8
<TableCell className="h-32 text-center" colSpan={8}>
```

---

## 完整修改摘要

| 項目 | 修改前 | 修改後 |
|------|--------|--------|
| 點擊行為 | 整行可點擊 | 只有公司名稱可點擊 |
| 欄位順序 | SPIN → PDCM | PDCM → SPIN |
| 三點選單 | 存在但無功能 | 已移除 |
| 表格欄數 | 9 欄 | 8 欄 |

---

## 部署步驟

```bash
cd apps/web
bun run build
bunx wrangler pages deploy dist --project-name=sales-ai-web --branch=main --commit-dirty=true --commit-message="fix: opportunities page UI optimization"
```

## 驗證結果

1. ✅ 點擊公司名稱進入詳情頁
2. ✅ 點擊其他欄位不觸發導航，可正常選取文字
3. ✅ PDCM 欄位在 SPIN 欄位之前
4. ✅ 三點選單已移除

---

## 今日修復總覽

| Bug # | 問題 | 狀態 |
|-------|------|------|
| #1 | 機會管理頁面業務欄位顯示錯誤（user_profile 缺少 slack_user_id） | ✅ 已完成 |
| #2 | Slack Bot 待辦事項無法儲存至資料庫 | ✅ 已完成 |
| #3 | 機會編輯按鈕點擊無反應 | ✅ 已完成 |
| #4 | IC004 業務顯示為錯誤的人員（優先順序錯誤） | ✅ 已完成 |
| #5 | IC005 PDCM 分數沒有顯示（資料不同步） | ✅ 已完成 |
| #6 | Opportunities 頁面 UI 問題 | ✅ 已完成 |
