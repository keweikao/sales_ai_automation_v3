# 機會頁面功能升級

**日期**：2026-01-28
**版本**：v3.x
**開發者**：Claude Code

---

## 功能概述

本次更新針對機會詳情頁面（`/opportunities/$id`）進行了功能增強，新增待辦事項建立功能與編輯頁面。

---

## 新增功能

### 1. 增加待辦按鈕

**位置**：機會詳情頁右上角

**功能說明**：
- 點擊按鈕開啟 Modal 對話框
- 待辦事項自動綁定當前機會（無法選擇其他機會）
- Modal 顯示綁定的機會資訊（公司名稱 + 客戶編號）

**表單欄位**：
| 欄位 | 類型 | 必填 | 說明 |
|------|------|------|------|
| 待辦事項 | 文字輸入 | 是 | 待辦事項標題 |
| 備註說明 | 多行文字 | 否 | 補充說明 |
| 幾天後到期 | 按鈕選擇 | 是 | 1/3/7/14/30 天 |

**技術實作**：
```typescript
// apps/web/src/routes/opportunities/$id.tsx

// 使用 useMutation 建立待辦
const createTodoMutation = useMutation({
  mutationFn: async (data) => {
    return await client.salesTodo.create(data);
  },
  onSuccess: () => {
    // 重設表單、關閉 Modal、刷新資料
    queryClient.invalidateQueries({
      queryKey: ["opportunities", "get", { opportunityId: id }],
    });
  },
});

// 自動綁定機會 ID
createTodoMutation.mutate({
  title: todoTitle,
  description: todoDescription || undefined,
  dueDate: dueDate.toISOString(),
  opportunityId: opportunity.id,  // 自動綁定
  source: "web",
});
```

---

### 2. 機會編輯頁面

**路徑**：`/opportunities/$id/edit`

**檔案位置**：`apps/web/src/routes/opportunities/$id/edit.tsx`

**可編輯欄位**：
| 欄位 | 對應 API 欄位 | 說明 |
|------|---------------|------|
| 公司名稱 | companyName | 客戶公司名稱 |
| 聯絡人 | contactName | 主要聯絡人姓名 |
| 聯絡電話 | contactPhone | 聯絡電話 |
| 聯絡信箱 | contactEmail | 電子郵件（email 格式驗證） |
| 備註 | notes | 自由文字備註 |

**技術實作**：
```typescript
// 使用 opportunities.update API
const updateMutation = useMutation({
  mutationFn: async (data) => {
    return await client.opportunities.update(data);
  },
  onSuccess: () => {
    // 刷新資料並返回詳情頁
    queryClient.invalidateQueries({
      queryKey: ["opportunities", "get", { opportunityId: id }],
    });
    navigate({ to: "/opportunities/$id", params: { id } });
  },
});
```

**導航方式**：
- 從詳情頁點擊「編輯」按鈕進入
- 使用 `navigate()` 而非 `<Link>` 元件（解決點擊無反應問題）

---

### 3. 暫停新增對話功能

**變更說明**：
- 「新增對話」按鈕已被註解
- 可在未來需要時快速恢復

```tsx
{/* 暫時停用新增對話功能
<Link
  to="/conversations/new"
  search={{ opportunityId: opportunity.id }}
>
  <Plus className="mr-2 h-4 w-4" />
  新增對話
</Link>
*/}
```

---

## 檔案變更清單

| 檔案 | 變更類型 | 說明 |
|------|----------|------|
| `apps/web/src/routes/opportunities/$id.tsx` | 修改 | 新增待辦按鈕、Modal、編輯按鈕導航 |
| `apps/web/src/routes/opportunities/$id/edit.tsx` | 新增 | 機會編輯頁面 |

---

## UI 設計

### 增加待辦 Modal

```
┌─────────────────────────────────────┐
│ 新增待辦事項                          │
├─────────────────────────────────────┤
│ ┌─────────────────────────────────┐ │
│ │ 綁定機會                          │ │
│ │ 客戶公司名稱 (客戶編號)            │ │
│ └─────────────────────────────────┘ │
│                                       │
│ 待辦事項 *                            │
│ ┌─────────────────────────────────┐ │
│ │ 例：跟進客戶需求                   │ │
│ └─────────────────────────────────┘ │
│                                       │
│ 備註說明                              │
│ ┌─────────────────────────────────┐ │
│ │ 補充說明...                       │ │
│ └─────────────────────────────────┘ │
│                                       │
│ 幾天後到期                            │
│ [1天] [3天] [7天] [14天] [30天]       │
│ 到期日：2026/2/4                      │
│                                       │
│              [取消] [建立待辦]         │
└─────────────────────────────────────┘
```

---

## 相關 API

| API 端點 | 方法 | 說明 |
|----------|------|------|
| `/rpc/salesTodo/create` | POST | 建立待辦事項 |
| `/rpc/opportunities/update` | POST | 更新機會資訊 |

---

## 注意事項

1. **自動綁定**：從機會頁面建立的待辦會自動綁定該機會，無法選擇其他機會
2. **權限控制**：編輯功能僅限機會擁有者使用
3. **資料刷新**：建立/編輯後自動刷新頁面資料
