# 案件硬刪除補充報告：孤立 Opportunities 清理

**執行日期**: 2026-01-28
**操作類型**: 資料庫硬刪除補充（清理孤立的客戶記錄）
**執行者**: Claude Code (自動化腳本)

---

## 問題發現

在初次刪除 14 個案件（conversations）後，使用者發現前端機會列表頁面 (https://sales-ai-web.pages.dev/opportunities) 仍然顯示這些案件的**客戶編號和公司名稱**。

### 原因分析

初次刪除只處理了 **conversations** 表（案件記錄），但沒有處理 **opportunities** 表（機會/客戶記錄）。

資料庫關係：
```
opportunities (客戶記錄)
    ↓ 1對多關係
conversations (案件記錄) ← 我們第一次只刪除了這個
```

當 conversations 被刪除後，對應的 opportunities 變成「孤立」狀態（沒有任何關聯的 conversations），但仍然存在於資料庫中，因此前端機會列表仍會顯示。

---

## 執行動作

### 1. 檢查孤立的 Opportunities

**執行腳本**: `scripts/check-orphaned-opportunities.ts`

發現 **13 個孤立的 opportunities**：

| 客戶編號 | 公司名稱 | 對應案件 |
|---------|---------|---------|
| 202601-111777 | wade 咖啡 | 202601-IC010 |
| 202601-111111 | wade 飲料 | 202601-IC011 |
| 202601-111333 | wade 火鍋店 | 202601-IC012 |
| 202601-111234 | wade 飲料店 | 202601-IC013 |
| 202601-111444 | wade 酒吧 | 202601-IC015 |
| 202701-000030 | test | 202601-IC016 |
| 202609-000001 | test-stephen | 202601-IC017 |
| 202609-000004 | test_StephenK | 202601-IC018 |
| 202609-000010 | StephenTest | 202601-IC019 |
| 202610-000002 | testKKKK | 202601-IC020 |
| 202601-00004 | testTSTEphen | 202601-IC021 |
| 202612-000005 | testStephen | 202601-IC022 |
| 202612-000043 | testSKKKK | 202601-IC024 |

**注意**: 202601-IC023 (teststephen) 沒有對應的孤立 opportunity，可能該 opportunity 還有其他 conversations 關聯。

### 2. 刪除孤立的 Opportunities

**執行腳本**: `scripts/delete-orphaned-opportunities.ts`

**刪除順序**：
1. 刪除關聯的 sales_todos（通過 opportunity_id）
2. 刪除關聯的 alerts（通過 opportunity_id）
3. 刪除 opportunities 主記錄

**執行結果**：
- ✅ 13 筆 opportunities（客戶記錄）
- ✅ 2 筆關聯的 sales_todos
- ✅ 0 筆 alerts

### 3. 驗證結果

再次執行檢查腳本，確認結果：
```
✅ 沒有孤立的 opportunities
```

---

## 完整刪除統計（含補充）

### 第一次刪除（Conversations）
| 資料表 | 刪除筆數 |
|--------|---------|
| conversations | 14 |
| meddic_analyses | 14 |
| alerts | 0 |
| sales_todos | 0 |

### 第二次刪除（Opportunities）
| 資料表 | 刪除筆數 |
|--------|---------|
| opportunities | 13 |
| sales_todos | 2 |
| alerts | 0 |

### 總計
| 資料表 | 總刪除筆數 |
|--------|-----------|
| **conversations** | **14** |
| **opportunities** | **13** |
| **meddic_analyses** | **14** |
| **sales_todos** | **2** |
| **alerts** | **0** |

---

## 建立的腳本

1. `scripts/check-orphaned-opportunities.ts` - 檢查孤立的 opportunities
2. `scripts/delete-orphaned-opportunities.ts` - 刪除孤立的 opportunities

---

## 前端影響

現在前端所有頁面都不會再顯示這些資料：
- ✅ 機會列表 (`/opportunities`) - **客戶編號和公司名稱已完全移除**
- ✅ 機會詳情 (`/opportunities/$id`)
- ✅ 對話列表
- ✅ 儀表板統計

---

## 經驗教訓

### 資料庫設計觀察
- opportunities 和 conversations 是 1:多 關係
- 刪除 conversations 時，對應的 opportunity 不會自動刪除（沒有 CASCADE）
- 這是合理的設計，因為一個客戶可能有多個對話記錄

### 刪除策略建議
未來刪除案件時，應該：
1. **先確認刪除範圍**：只刪除案件？還是連同客戶記錄？
2. **檢查關聯狀態**：該 opportunity 是否還有其他 conversations
3. **分階段執行**：
   - 第一步：刪除 conversations
   - 第二步：清理孤立的 opportunities（如需要）

---

## 結論

✅ **所有相關資料已完全清理**

- 14 個案件記錄（conversations）已刪除
- 13 個對應的客戶記錄（opportunities）已刪除
- 前端機會列表不再顯示這些資料
- 驗證腳本確認無殘留

⚠️ **注意事項**：
- 1 個案件（202601-IC023）對應的 opportunity 未刪除，可能該客戶還有其他對話記錄
- 如需進一步清理，請先檢查該 opportunity 的完整狀態
