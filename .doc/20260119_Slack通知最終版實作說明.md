# Slack 通知最終版實作說明

**日期**: 2026-01-19
**版本**: v2 (最終版)

---

## 📋 需求澄清

### 1. Slack 通知內容結構

按照以下順序顯示:

1. ✅ **音檔處理完成** (Header)
2. **核心資訊** (案件編號、處理時間、MEDDIC 分數、資格狀態)
3. ⚠️ **需要注意** (高優先級警報 - 從 Agent 6, Agent 2 提取)
4. 💡 **客戶痛點** (從 Agent 4 markdown 提取)
5. **風險與緩解措施** (含 emoji: 🔴 High, 🟡 Medium, 🟢 Low)
6. 📱 **建議 SMS 跟進訊息** (Agent 4 的 sms_text)
7. **兩個操作按鈕**:
   - 「查看完整分析」
   - 「編輯會議摘要與簡訊」

**每個區塊用明顯的 divider 分割**,確保閱讀流暢度。

---

## 🎯 兩個網頁功能

### 1. 完整分析頁面 (`/conversations/:id`)

**URL**: `http://localhost:5173/conversations/{conversationId}`

**內容** (原本的完整版詳細分析):
- 案件基本資訊
- **MEDDIC 總分**: 50/100
- **資格狀態**: 🟡 Medium
- **MEDDIC 各維度評分**:
  - Metrics (業務指標): 0/100
  - Economic Buyer (決策者): 100/100
  - Decision Criteria (決策標準): 0/100
  - Decision Process (決策流程): 0/100
  - Identify Pain (痛點識別): 80/100
  - Champion (內部推手): 0/100
- **關鍵發現** (10 項)
- **客戶痛點** (5 項)
- **解決方案** (5 項)
- **下一步行動** (分為 iCHEF 和客戶待辦)
- **風險評估** (4 個風險 + 緩解措施)
- **教練建議** (優勢 + 改進建議)
- 音檔播放器
- 完整轉錄記錄

**用途**: 業務人員查看**所有詳細分析**

---

### 2. 會議摘要與簡訊編輯頁面 (`/conversations/:id/summary`)

**URL**: `http://localhost:5173/conversations/{conversationId}/summary`

**內容** (Agent 4 的 markdown 摘要):
```markdown
# 您的餐廳 x iCHEF 會議記錄

親愛的 王老闆 您好,

感謝您今天撥冗與我們討論。以下是會議重點摘要:

## 🔍 您目前遇到的挑戰
- **新店導入與時間壓力**: 首次經營餐飲業...
- **成本效益考量**: 對於POS系統的總體費用...
- **人力運用效率**: 希望透過系統節省人力...
- **員工訓練與系統接受度**: 關心系統操作是否複雜...
- **帳務管理**: 希望每日帳務清晰...

## 💡 iCHEF 如何協助您
- **一站式整合方案**: iCHEF提供POS系統...
- **彈性計費與方案選擇**: POS系統月租費依iPad數量...
- **提升營運效率**: 線上點餐可節省人力...
- **簡化操作與完善售後**: 系統操作簡單易學...
- **清晰帳務與權限管理**: 提供詳細的關帳流程...

## ✅ 已達成共識
- 客戶合夥人曾使用iCHEF並推薦...
- 確認新店將使用iCHEF POS系統...
- 確認需要電子發票功能...

## 📋 建議下一步
1. iCHEF提供詳細報價單...
2. 客戶確認最終軟體方案...
3. 準備菜單資料...
```

**SMS 簡訊內容** (可編輯):
```
王老闆您好,謝謝今天的討論!針對您關心的系統費用與功能加購,已為您整理會議重點,點擊查看👉[SHORT_URL]
```

**功能**:
1. 顯示完整會議摘要 (Agent 4 的 markdown)
2. 顯示 SMS 簡訊文字 (可編輯)
3. 業務可以**修改摘要內容**和**SMS 文字**
4. 修改完成後可以**直接發送簡訊**給客戶
5. [SHORT_URL] 會被替換成實際的短網址,指向這個會議摘要頁面

**用途**:
- 業務人員核對會議摘要內容
- 修改 SMS 簡訊文字 (如果需要)
- 確認無誤後發送簡訊給客戶
- 客戶收到簡訊後,點擊連結會看到這個會議摘要

---

## 🔧 技術實作

### 1. 修改的檔案

#### `packages/services/src/notifications/types.ts`
```typescript
export interface MEDDICAnalysisResult {
  // ... 原有欄位 ...
  risks?: Array<{
    risk: string;
    severity: string;
    mitigation?: string;
  }>; // 改為完整物件格式 (含嚴重程度)
  alerts?: string[]; // 高優先級警報
  painPoints?: string[]; // 客戶痛點 (從 Agent 4 markdown 提取)
  summary?: string; // Agent 4 會議摘要 (markdown)
  smsText?: string; // Agent 4 SMS 文字
  contactPhone?: string; // 客戶電話
}
```

#### `packages/services/src/notifications/blocks.ts`
**新增區塊**:
1. 客戶痛點區塊 (💡 客戶痛點)
2. 風險與緩解措施區塊 (含 emoji)
3. 建議 SMS 跟進訊息區塊
4. 兩個操作按鈕:
   - 「查看完整分析」 → `/conversations/:id`
   - 「編輯會議摘要與簡訊」 → `/conversations/:id/summary`

**新增函數**:
```typescript
function getSeverityEmoji(severity: string): string {
  const severityMap: Record<string, string> = {
    high: "🔴",
    medium: "🟡",
    low: "🟢",
  };
  return severityMap[severity.toLowerCase()] || "🟡";
}
```

#### `apps/queue-worker/src/index.ts`
**新增提取邏輯**:
```typescript
// 從 Agent 4 markdown 提取客戶痛點
const painPoints: string[] = [];
if (summary) {
  const painPointsMatch = summary.match(
    /##\s*🔍\s*您目前遇到的挑戰\s*\n\n((?:- \*\*.*?\*\*:.*?\n)+)/
  );
  if (painPointsMatch?.[1]) {
    const painPointsText = painPointsMatch[1];
    const matches = Array.from(
      painPointsText.matchAll(/- \*\*(.*?)\*\*:/g)
    );
    for (const match of matches) {
      if (match[1]) {
        painPoints.push(match[1]);
      }
    }
  }
}
```

**傳遞給 Slack 通知**:
```typescript
await slackService.notifyProcessingCompleted({
  // ...
  analysisResult: {
    // ...
    risks: analysisResult.risks ?? [], // 保留完整格式
    painPoints, // 客戶痛點
    summary, // 會議摘要 (markdown)
    smsText, // SMS 文字
    contactPhone, // 客戶電話
  },
});
```

---

## 📊 Slack 通知結構

**總共 12 個 Blocks** (案件 202601-IC019):

1. **Header**: ✅ 音檔處理完成
2. **Section**: 核心資訊 (4 欄位)
3. **Divider**
4. **Section**: ⚠️ 需要注意 (1 個警報)
5. **Divider**
6. **Section**: 💡 客戶痛點 (5 個痛點)
7. **Divider**
8. **Section**: 風險與緩解措施 (4 個風險)
9. **Divider**
10. **Section**: 📱 建議 SMS 跟進訊息
11. **Divider**
12. **Actions**: 兩個按鈕

---

## 🎨 Slack 通知範例

```
✅ 音檔處理完成

案件編號: 202601-IC019
處理時間: 105.7 秒
MEDDIC 分數: 50/100
資格狀態: 🟡 Medium

━━━━━━━━━━━━━━━━━━━━

⚠️ 需要注意:
• 錯失推進機會 - 客戶表示「我的合夥人他之前也是有用你們的iShape...」

━━━━━━━━━━━━━━━━━━━━

💡 客戶痛點
• 新店導入與時間壓力
• 成本效益考量
• 人力運用效率
• 員工訓練與系統接受度
• 帳務管理

━━━━━━━━━━━━━━━━━━━━

🟡 客戶對轉換有顧慮: 員工訓練/菜單設定
緩解措施: 提供詳細的轉換計劃和支援服務,降低轉換成本

🟡 業務錯失關鍵機會: 客戶表示「我的合夥人...」
緩解措施: 後續跟進時補救這些機會點

🔴 客戶存在多重障礙: 預算限制, 硬體限制, 人力限制...
緩解措施: 逐一解決各項障礙,優先處理最關鍵的

🟡 競爭對手提及: POS
緩解措施: 強化差異化價值主張,突顯 iCHEF 優勢

━━━━━━━━━━━━━━━━━━━━

📱 建議 SMS 跟進訊息
王老闆您好,謝謝今天的討論!針對您關心的系統費用與功能加購,已為您整理會議重點,點擊查看👉[SHORT_URL]

點擊下方「編輯會議摘要與簡訊」可修改內容並發送

━━━━━━━━━━━━━━━━━━━━

[查看完整分析] [編輯會議摘要與簡訊]
```

---

## 📱 SMS 簡訊流程

### 1. 業務人員收到 Slack 通知
- 看到建議的 SMS 文字
- 點擊「編輯會議摘要與簡訊」按鈕

### 2. 進入編輯頁面 (`/conversations/:id/summary`)
- 查看完整會議摘要 (Agent 4 的 markdown)
- 查看 SMS 文字
- 可以修改摘要內容或 SMS 文字

### 3. 確認後發送簡訊
- 點擊「發送簡訊」按鈕
- SMS 中的 [SHORT_URL] 會被替換成實際短網址
- 短網址指向 `/conversations/:id/summary` (會議摘要頁面)

### 4. 客戶收到簡訊
```
王老闆您好,謝謝今天的討論!針對您關心的系統費用與功能加購,已為您整理會議重點,點擊查看👉https://短網址
```

### 5. 客戶點擊連結
- 開啟會議摘要頁面
- 看到完整的會議記錄 (Agent 4 的 markdown 內容)
- 包含挑戰、解決方案、已達成共識、建議下一步等

---

## 🚀 部署檢查清單

### 環境變數
- [x] `WEB_APP_URL=http://localhost:5173` (開發)
- [ ] `WEB_APP_URL=https://your-domain.com` (生產)

### 網頁路由
- [x] `/conversations/:id` - 完整分析頁面 (已存在)
- [ ] `/conversations/:id/summary` - 會議摘要與簡訊編輯頁面 (需新增)

### 功能需求
- [x] Slack 通知顯示兩個按鈕
- [x] 第一個按鈕跳轉到完整分析頁面
- [x] 第二個按鈕跳轉到會議摘要編輯頁面
- [ ] 會議摘要編輯頁面實作
  - [ ] 顯示 Agent 4 的 markdown 摘要
  - [ ] 顯示 SMS 文字 (可編輯)
  - [ ] 「發送簡訊」按鈕
  - [ ] 整合 EVERY8D API 發送簡訊
  - [ ] [SHORT_URL] 替換為實際短網址
  - [ ] 記錄到 sms_logs 表

---

## 📝 待辦事項

### 1. 建立會議摘要編輯頁面
**路徑**: `apps/web/src/routes/conversations/$id.summary.tsx`

**功能**:
- 讀取 Agent 4 的 markdown 摘要
- 顯示為可編輯的 textarea
- 顯示 SMS 文字 (可編輯)
- 顯示客戶電話
- 「發送簡訊」按鈕
- 整合 EVERY8D API

### 2. 實作短網址服務
**選項**:
- 使用第三方服務 (如 bit.ly API)
- 自建短網址服務
- 使用 Firebase Dynamic Links

### 3. 整合 SMS 發送
**已有的服務**: `apps/slack-bot/src/services/notification.ts`

**需要**:
- 將 SMS 發送邏輯整合到網頁端
- 或建立 API endpoint 供網頁呼叫
- 記錄到 `sms_logs` 表

---

## ✅ 驗收標準

### Slack 通知
- [x] 顯示 12 個 Blocks
- [x] 包含客戶痛點區塊 (5 個痛點)
- [x] 包含風險與緩解措施 (4 個風險 + emoji)
- [x] 包含建議 SMS 跟進訊息
- [x] 顯示兩個按鈕

### 完整分析頁面
- [x] 顯示所有 MEDDIC 維度
- [x] 顯示關鍵發現、痛點、解決方案
- [x] 顯示下一步行動、風險、教練建議

### 會議摘要編輯頁面 (待實作)
- [ ] 顯示 Agent 4 的 markdown 摘要
- [ ] 可編輯摘要內容
- [ ] 可編輯 SMS 文字
- [ ] 發送簡訊功能
- [ ] [SHORT_URL] 正確替換

---

## 🎉 總結

目前 Slack 通知的程式碼修改已全部完成:
1. ✅ 顯示精簡的戰略通知 (12 個 Blocks)
2. ✅ 兩個按鈕:「查看完整分析」和「編輯會議摘要與簡訊」
3. ✅ 客戶痛點從 Agent 4 markdown 提取
4. ✅ 風險顯示完整資訊 (含嚴重程度 emoji 和緩解措施)
5. ✅ 建議 SMS 跟進訊息顯示

**下一步**: 實作會議摘要編輯頁面 (`/conversations/:id/summary`),讓業務可以修改內容並發送簡訊。
