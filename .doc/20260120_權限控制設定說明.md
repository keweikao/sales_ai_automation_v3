# 權限控制設定說明

**建立日期**: 2026-01-20
**版本**: v1.0

---

## 📋 權限等級

系統實作三級權限控制：

### 1. 管理者 (Admin)
- **權限範圍**: 可查看所有業務的資料
- **設定方式**: 在 `ADMIN_EMAILS` 環境變數中加入 email
- **使用場景**: 系統管理員、高層主管
- **目前功能**: 與主管權限相同（未來可擴展額外管理功能）

### 2. 主管 (Manager)
- **權限範圍**: 可查看所有業務的資料
- **設定方式**: 在 `MANAGER_EMAILS` 環境變數中加入 email
- **使用場景**: 團隊主管、部門經理
- **目前功能**: 與管理者權限相同（可查看全部資料）

### 3. 一般業務 (Sales)
- **權限範圍**: 只能查看自己創建的 opportunities 和 conversations
- **設定方式**: 無需設定，預設權限
- **使用場景**: 一般業務人員
- **權限限制**: 無法查看其他業務的資料

---

## 🔧 環境變數設定

### 生產環境

編輯 `apps/server/wrangler.toml`:

```toml
[vars]
# 管理者：最高權限（目前與主管權限相同，可查看所有資料）
ADMIN_EMAILS = "admin@company.com,ceo@company.com"

# 主管：可以查看所有業務的資料
MANAGER_EMAILS = "manager1@company.com,manager2@company.com,supervisor@company.com"
```

### 開發環境

編輯 `apps/server/wrangler.toml`:

```toml
[env.dev.vars]
# 權限白名單 - 三級權限
ADMIN_EMAILS = "admin@company.com"
MANAGER_EMAILS = "manager@company.com"
```

### 格式說明

- **多個 email 用逗號分隔**（無空格或有空格皆可，系統會自動 trim）
- **區分大小寫**（建議統一使用小寫）
- **留空表示該等級無人**（`ADMIN_EMAILS = ""`）

---

## 💻 程式實作

### 權限檢查邏輯

位置: `packages/api/src/routers/conversation.ts`

```typescript
// 檢查用戶角色
function getUserRole(userEmail: string | null | undefined): "admin" | "manager" | "sales" {
  if (!userEmail) return "sales";
  if (ADMIN_EMAILS.includes(userEmail)) return "admin";
  if (MANAGER_EMAILS.includes(userEmail)) return "manager";
  return "sales";
}

// 權限驗證
const isOwner = conversation.opportunity.userId === userId;
const userRole = getUserRole(userEmail);
const hasAdminAccess = userRole === "admin" || userRole === "manager";

// 一般業務只能看自己的，管理者和主管可以看全部
if (!isOwner && !hasAdminAccess) {
  throw new ORPCError("FORBIDDEN");
}
```

### 權限優先順序

1. **管理者** (ADMIN_EMAILS) - 最高優先
2. **主管** (MANAGER_EMAILS) - 次優先
3. **一般業務** - 預設

> ⚠️ **注意**: 如果同一個 email 同時出現在 `ADMIN_EMAILS` 和 `MANAGER_EMAILS`，將被識別為 `admin`（優先順序較高）

---

## 📝 設定範例

### 範例 1: 小團隊設定

```toml
# 1 位管理者、2 位主管
ADMIN_EMAILS = "boss@ichef.com.tw"
MANAGER_EMAILS = "manager1@ichef.com.tw,manager2@ichef.com.tw"
```

### 範例 2: 大團隊設定

```toml
# 2 位管理者、5 位主管
ADMIN_EMAILS = "ceo@ichef.com.tw,cto@ichef.com.tw"
MANAGER_EMAILS = "sales-manager@ichef.com.tw,team-lead1@ichef.com.tw,team-lead2@ichef.com.tw,supervisor1@ichef.com.tw,supervisor2@ichef.com.tw"
```

### 範例 3: 僅管理者設定

```toml
# 只有管理者，沒有主管
ADMIN_EMAILS = "admin@ichef.com.tw"
MANAGER_EMAILS = ""
```

---

## 🧪 測試權限設定

### 測試步驟

1. **註冊測試帳號**:
   - 管理者帳號：使用 `ADMIN_EMAILS` 中的 email
   - 主管帳號：使用 `MANAGER_EMAILS` 中的 email
   - 一般業務帳號：使用其他 email

2. **建立測試資料**:
   - 用一般業務帳號 A 建立 opportunity 和 conversation
   - 用另一個一般業務帳號 B 登入

3. **驗證權限**:
   - ✅ 業務 A 可以查看自己的資料
   - ❌ 業務 B **無法**查看業務 A 的資料（403 Forbidden）
   - ✅ 主管可以查看業務 A 和業務 B 的資料
   - ✅ 管理者可以查看業務 A 和業務 B 的資料

---

## 🔐 安全性建議

### 1. Email 驗證

確保只有經過驗證的公司 email 才能註冊：
- 使用公司域名限制（如 `@ichef.com.tw`）
- 實作 email 驗證流程

### 2. 定期審查

- 定期檢查 `ADMIN_EMAILS` 和 `MANAGER_EMAILS` 白名單
- 移除離職人員的 email
- 記錄權限變更歷史

### 3. 最小權限原則

- 只給予必要的權限
- 優先使用 `MANAGER_EMAILS` 而非 `ADMIN_EMAILS`
- 一般業務不應出現在白名單中

### 4. 監控與日誌

- 記錄所有權限檢查失敗的嘗試
- 監控異常的資料訪問模式
- 設定警報機制

---

## 🚀 部署更新

### 1. 修改環境變數

編輯 `apps/server/wrangler.toml`，更新 `ADMIN_EMAILS` 和 `MANAGER_EMAILS`

### 2. 部署到 Cloudflare Workers

```bash
cd apps/server
bun run deploy
```

### 3. 驗證部署

```bash
# 檢查環境變數是否正確設定
wrangler tail sales-ai-server
```

### 4. 測試權限

使用不同權限等級的帳號登入，驗證權限控制是否正常運作。

---

## 📞 常見問題

### Q1: 如何新增管理者？

**A**: 編輯 `wrangler.toml`，在 `ADMIN_EMAILS` 中加入新的 email，然後重新部署。

```toml
ADMIN_EMAILS = "existing@company.com,new-admin@company.com"
```

### Q2: 主管和管理者的權限有什麼不同？

**A**: 目前兩者權限相同，都可以查看所有資料。未來可能會為管理者新增額外的系統管理功能（如用戶管理、系統設定等）。

### Q3: 如何移除某人的管理權限？

**A**: 從 `ADMIN_EMAILS` 或 `MANAGER_EMAILS` 中移除該 email，然後重新部署。該用戶將自動降級為一般業務權限。

### Q4: 可以動態修改權限嗎？

**A**: 目前權限透過環境變數設定，修改後需要重新部署。未來可以考慮實作資料庫驅動的權限管理系統。

### Q5: 如何測試權限設定是否生效？

**A**:
1. 用一般業務帳號建立資料
2. 用另一個一般業務帳號嘗試訪問
3. 應該收到 403 Forbidden 錯誤
4. 用主管/管理者帳號訪問應該成功

---

## 📊 權限矩陣

| 操作 | 一般業務 | 主管 | 管理者 |
|------|---------|------|--------|
| 查看自己的 opportunities | ✅ | ✅ | ✅ |
| 查看他人的 opportunities | ❌ | ✅ | ✅ |
| 查看自己的 conversations | ✅ | ✅ | ✅ |
| 查看他人的 conversations | ❌ | ✅ | ✅ |
| 建立 opportunity | ✅ | ✅ | ✅ |
| 上傳音檔 | ✅ | ✅ | ✅ |
| 編輯會議摘要 | ✅ (自己的) | ✅ (全部) | ✅ (全部) |

> 註：未來功能（如用戶管理、系統設定）可能只開放給管理者

---

## 📝 變更歷史

- **2026-01-20**: 初版發布，實作三級權限控制（管理者、主管、一般業務）

---

**需要協助？** 請聯繫系統管理員或參考開發文件。
