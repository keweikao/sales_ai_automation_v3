# 多產品線支援開發影響評估報告

> **評估日期**: 2026-01-19
> **評估對象**: 多產品線支援實作計畫 (iCHEF + 美業)
> **目的**: 評估開發過程對現有系統使用的影響

---

## 執行摘要

### 🟢 總體評估: **低風險,可安全開發**

**結論**: 此計畫的設計已充分考慮向後相容性,**對現有 iCHEF 使用者不會有任何影響**。所有變更都是「新增」而非「修改」,且使用預設值確保現有功能完全不受干擾。

**建議**:
- ✅ 可以立即開始開發
- ⚠️ 建議採用**分階段部署**策略
- ✅ 需要完整的回歸測試

---

## 詳細影響分析

### 1️⃣ 資料庫變更影響 [🟢 無影響]

#### 變更內容
```sql
ALTER TABLE opportunities ADD COLUMN product_line TEXT DEFAULT 'ichef' NOT NULL;
ALTER TABLE conversations ADD COLUMN product_line TEXT DEFAULT 'ichef' NOT NULL;
ALTER TABLE talk_tracks ADD COLUMN product_line TEXT DEFAULT 'ichef' NOT NULL;
ALTER TABLE meddic_analyses ADD COLUMN product_line TEXT DEFAULT 'ichef' NOT NULL;
```

#### 影響評估

**✅ 對現有資料無影響**:
- 新欄位使用 `DEFAULT 'ichef'` → 所有現有資料自動標記為 iCHEF
- 現有查詢不需要修改 → 繼續正常運作
- 新增 Index 不影響現有查詢性能

**✅ 對現有程式碼無影響**:
- 現有的 INSERT 不需要指定 `product_line` → 自動使用預設值 'ichef'
- 現有的 SELECT 不需要過濾 `product_line` → 回傳所有資料 (iCHEF)
- 現有的 UPDATE 不需要更新 `product_line` → 保持原有值

**風險**: 無

---

### 2️⃣ API 變更影響 [🟢 向後相容]

#### 變更內容
- `uploadConversation()` 新增 optional 參數 `metadata.productLine`
- `listConversations()` 新增 optional 過濾參數 `productLine`
- `getTalkTracks()` 新增 optional 過濾參數 `productLine`

#### 影響評估

**✅ 完全向後相容**:
```typescript
// 現有呼叫方式 (不傳 productLine) → 繼續正常運作
await api.conversation.upload({
  opportunityId: 'opp-123',
  audioBase64: '...',
  // 不傳 productLine → 預設使用 'ichef'
});

// 新呼叫方式 (明確指定 productLine) → 新功能
await api.conversation.upload({
  opportunityId: 'opp-456',
  audioBase64: '...',
  metadata: {
    productLine: 'beauty'  // 明確指定美業
  }
});
```

**✅ 對現有前端/客戶端無影響**:
- 所有新參數都是 `optional`
- 未指定時預設為 'ichef'
- 現有的 API 呼叫不需要修改

**風險**: 無

---

### 3️⃣ Slack Bot 變更影響 [🟡 需要設定]

#### 變更內容
- 新增 Channel 解析器 (根據 Channel ID 識別產品線)
- 動態表單生成 (根據產品線顯示不同欄位)

#### 影響評估

**✅ 對現有 iCHEF Channel 無影響**:
- 未配置的 Channel → 預設為 'ichef'
- 現有表單欄位不變
- 現有工作流程完全相同

**⚠️ 需要環境變數設定**:
```bash
# 新增環境變數 (可選)
PRODUCT_LINE_CHANNELS={"C12345":"ichef","C67890":"beauty"}

# 不設定 → 所有 Channel 預設使用 'ichef' (向後相容)
```

**🟢 部署策略**:
1. **第一階段**: 不設定環境變數 → 所有 Channel 維持 iCHEF 模式 (無影響)
2. **第二階段**: 新增美業 Channel 設定 → 只有新 Channel 使用美業模式
3. **第三階段**: 逐步將現有 Channel 加入設定 (如果需要)

**風險**: 極低 (僅需要正確設定環境變數)

---

### 4️⃣ MEDDIC 分析影響 [🟢 向後相容]

#### 變更內容
- Orchestrator 新增 `productLine` 參數
- Prompts 重組為產品線特定結構
- 新增 PromptLoader 動態載入機制

#### 影響評估

**✅ 完全向後相容**:
```typescript
// 現有呼叫方式 (不傳 productLine) → 使用 iCHEF prompts
const orchestrator = new MeddicOrchestrator(geminiClient);
await orchestrator.analyze(transcript, {
  leadId: 'lead-123',
  conversationId: 'conv-456',
  salesRep: 'John',
  conversationDate: new Date()
  // 不傳 productLine → 預設 'ichef'
});

// 新呼叫方式 (明確指定 productLine) → 使用對應 prompts
const orchestrator = new MeddicOrchestrator(geminiClient, { productLine: 'beauty' });
await orchestrator.analyze(transcript, {
  leadId: 'lead-789',
  conversationId: 'conv-012',
  salesRep: 'Jane',
  conversationDate: new Date(),
  productLine: 'beauty'
});
```

**✅ 分析品質不受影響**:
- iCHEF prompts 內容不變 (只是搬移位置)
- iCHEF 分析邏輯完全相同
- 向後相容測試可確保品質

**風險**: 無 (Prompts 內容未改變,只是重新組織)

---

### 5️⃣ Queue Worker 影響 [🟢 無影響]

#### 變更內容
- 從 DB 讀取 `product_line` 欄位
- 傳遞給 Orchestrator

#### 影響評估

**✅ 對現有任務無影響**:
```typescript
// Queue Worker 邏輯
const conversation = await db.query.conversations.findFirst({
  where: eq(conversations.id, conversationId)
});

// 現有資料: product_line = 'ichef' (DEFAULT 值)
const productLine = conversation.productLine || 'ichef';

// 使用 iCHEF 模式執行分析 → 與現在完全相同
const orchestrator = new MeddicOrchestrator(geminiClient, { productLine });
```

**✅ 處理流程不變**:
1. 接收訊息 → 相同
2. 下載音檔 → 相同
3. 轉錄 → 相同
4. MEDDIC 分析 → 相同 (使用 iCHEF prompts)
5. 更新 DB → 相同
6. Slack 通知 → 相同

**風險**: 無

---

### 6️⃣ 前端/儀表板影響 [🟢 功能擴充]

#### 變更內容
- 新增產品線切換器組件
- Dashboard 支援產品線過濾

#### 影響評估

**✅ 對現有使用者體驗無影響**:
- 預設顯示所有資料 (iCHEF + Beauty)
- 或預設顯示 iCHEF (根據設計選擇)
- 新增的是「過濾」功能,不是「限制」功能

**🟢 使用者體驗提升**:
- 可以選擇只看 iCHEF 資料
- 可以選擇只看美業資料
- 可以選擇看所有資料

**風險**: 無

---

## 開發期間的影響評估

### 開發階段 1: Agent A (Config + DB)
**影響**: 🟢 無影響
- 只是新增檔案和 Migration
- 不部署到 Production = 不影響使用

### 開發階段 2: Agent B (Slack Bot)
**影響**: 🟢 無影響 (如果不設定環境變數)
- 程式碼變更但向後相容
- 不設定 `PRODUCT_LINE_CHANNELS` = 所有 Channel 維持 iCHEF

### 開發階段 3: Agent C (MEDDIC Prompts)
**影響**: 🟢 無影響
- Prompts 重組但內容不變
- PromptLoader 有 fallback 機制

### 開發階段 4: Agent D (API + Queue)
**影響**: 🟢 無影響
- 所有變更向後相容
- 不傳 productLine = 預設 'ichef'

### 開發階段 5: Agent E (Dashboard)
**影響**: 🟢 功能擴充
- 新增過濾功能,不影響現有使用

---

## 部署策略建議

### 🚀 建議採用「分階段部署」策略

#### 階段 1: 基礎設施部署 (Week 1)
**部署內容**:
- ✅ Migration (新增 `product_line` 欄位)
- ✅ Shared package (ProductLineConfig)

**影響**: 🟢 無影響
- 只是新增欄位,現有功能不變
- 所有現有資料自動標記為 'ichef'

**驗證**:
```sql
-- 檢查 Migration 是否成功
SELECT product_line, COUNT(*) FROM conversations GROUP BY product_line;
-- 預期結果: 所有資料都是 'ichef'
```

#### 階段 2: 後端服務部署 (Week 2)
**部署內容**:
- ✅ API Router 更新
- ✅ Queue Worker 更新
- ✅ Orchestrator 更新
- ✅ Prompts 重組

**影響**: 🟢 無影響 (向後相容)
- 不傳 productLine = 預設 'ichef'
- 現有流程完全相同

**驗證**:
- 回歸測試: 上傳 iCHEF 音檔 → 確認分析結果與之前相同
- API 測試: 不傳 productLine → 確認預設為 'ichef'

#### 階段 3: Slack Bot 部署 (Week 3)
**部署內容**:
- ✅ Channel 解析器
- ✅ 動態表單生成
- ⚠️ **不設定** `PRODUCT_LINE_CHANNELS` 環境變數

**影響**: 🟢 無影響
- 未設定環境變數 → 所有 Channel 維持 iCHEF 模式

**驗證**:
- 在現有 Channel 上傳音檔 → 確認表單與之前相同
- 確認 DB 中 product_line = 'ichef'

#### 階段 4: 美業功能啟用 (Week 4)
**部署內容**:
- ✅ 設定 `PRODUCT_LINE_CHANNELS` 環境變數 (只包含新的美業 Channel)
- ✅ 前端 Dashboard 更新

**影響**: 🟢 無影響 (只影響新 Channel)
- 現有 Channel 繼續使用 iCHEF
- 只有新 Channel 使用美業模式

**驗證**:
- 測試美業 Channel → 確認使用美業表單和分析
- 測試現有 Channel → 確認仍使用 iCHEF 模式

---

## 風險評估矩陣

| 風險項目 | 影響程度 | 發生機率 | 風險等級 | 緩解措施 |
|---------|---------|---------|---------|---------|
| DB Migration 失敗 | 高 | 極低 | 🟢 低 | DEFAULT 值確保相容性 + 充分測試 |
| API 向後不相容 | 高 | 極低 | 🟢 低 | 所有新參數 optional + 單元測試 |
| Prompts 品質下降 | 中 | 低 | 🟡 中低 | A/B 測試 + 內容不變只重組 |
| 環境變數設定錯誤 | 中 | 低 | 🟡 中低 | 不設定 = 預設 iCHEF (安全) |
| Queue Worker 處理異常 | 高 | 極低 | 🟢 低 | Fallback 機制 + 充分測試 |
| 使用者體驗混淆 | 低 | 低 | 🟢 低 | 預設顯示 iCHEF + 清楚的 UI |

**總體風險評估**: 🟢 **低風險**

---

## 回歸測試清單

### ✅ 必須通過的測試 (確保無影響)

#### 1. 資料庫測試
- [ ] Migration 執行成功
- [ ] 所有現有資料 `product_line = 'ichef'`
- [ ] 現有查詢性能無下降 (< 10% 差異)

#### 2. API 測試
- [ ] 不傳 `productLine` → 預設 'ichef'
- [ ] 上傳音檔不傳 `productLine` → DB 中為 'ichef'
- [ ] 列表查詢不傳 `productLine` → 回傳所有 iCHEF 資料

#### 3. MEDDIC 分析測試
- [ ] 使用相同音檔測試
- [ ] 分析結果與之前版本相同 (或更好)
- [ ] 分析時間無明顯增加

#### 4. Slack Bot 測試
- [ ] 現有 Channel 上傳音檔 → 表單相同
- [ ] 表單提交 → product_line = 'ichef'
- [ ] Slack 通知正常

#### 5. Queue Worker 測試
- [ ] 處理現有任務正常
- [ ] 轉錄成功
- [ ] MEDDIC 分析成功
- [ ] Slack 通知成功

#### 6. 端到端測試
- [ ] 完整流程: 上傳 → 轉錄 → 分析 → 通知
- [ ] 結果與之前版本一致

---

## 監控建議

### 開發期間監控
- ✅ Unit Test Coverage > 80%
- ✅ 所有回歸測試通過
- ✅ TypeScript 編譯無錯誤

### 部署後監控 (第一週)
- 📊 監控錯誤率 (應維持在原有水平)
- 📊 監控 API 回應時間 (應無明顯增加)
- 📊 監控 Queue 處理時間 (應無明顯增加)
- 📊 監控 DB 查詢性能 (應無下降)

### 關鍵指標
```
✅ 錯誤率增加 < 5%
✅ API 回應時間增加 < 10%
✅ 分析品質保持一致
✅ 使用者無負面反饋
```

---

## 結論與建議

### ✅ 可以安全開發的理由

1. **設計原則正確**:
   - 所有變更都是「新增」而非「修改」
   - 充分使用預設值確保向後相容
   - 所有新參數都是 optional

2. **技術架構穩健**:
   - Database DEFAULT 值機制
   - API optional 參數機制
   - Prompts fallback 機制
   - Queue Worker fallback 機制

3. **部署策略安全**:
   - 分階段部署
   - 每階段都有驗證
   - 可以隨時回滾

4. **測試覆蓋完整**:
   - 單元測試
   - 整合測試
   - 回歸測試
   - 端到端測試

### 🎯 最終建議

**建議**: ✅ **可以立即開始開發**

**條件**:
1. 嚴格遵循修正版規劃文件
2. 完成所有回歸測試
3. 採用分階段部署策略
4. 部署後密切監控

**預期結果**:
- ✅ 現有 iCHEF 使用者: **無任何影響**
- ✅ 新美業使用者: **獲得專屬功能**
- ✅ 系統性能: **無下降**
- ✅ 程式碼品質: **提升** (更模組化、可擴展)

---

## 附錄: 緊急回滾計畫

萬一部署後發現問題,可以快速回滾:

### 回滾步驟

#### 1. 回滾 Slack Bot (最快)
```bash
# 移除環境變數設定
unset PRODUCT_LINE_CHANNELS
# 重新部署前一版本
wrangler deploy --env production
```
**影響**: 所有 Channel 回到 iCHEF 模式

#### 2. 回滾 API/Queue (次快)
```bash
# 部署前一版本
git checkout <previous-commit>
wrangler deploy --env production
```
**影響**: API 回到不支援 productLine

#### 3. 回滾 Database (最後手段,不建議)
```sql
-- 只在極端情況使用
ALTER TABLE opportunities DROP COLUMN product_line;
ALTER TABLE conversations DROP COLUMN product_line;
-- ... (需要完整的 rollback script)
```
**影響**: 失去所有產品線資訊

**建議**: 通常只需要回滾 Slack Bot 或 API,不需要回滾 Database

---

**報告完成日期**: 2026-01-19
**下次審查日期**: 開發完成後,部署前
