# Lambda éŸ³æª”å£“ç¸®æ•´åˆæŒ‡å—

**æ—¥æœŸ**: 2026-01-15
**ç›®çš„**: å°‡ AWS Lambda éŸ³æª”å£“ç¸®æœå‹™æ•´åˆåˆ° Sales AI Automation V3 ç³»çµ±

---

## ä¸€ã€æ•´é«”æ¶æ§‹

### æµç¨‹åœ– (æ•´åˆ Lambda å¾Œ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Slack Bot        â”‚
â”‚  (ä¸Šå‚³ 92MB éŸ³æª”)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    API Server       â”‚
â”‚  (Cloudflare Worker)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. ä¸‹è¼‰éŸ³æª”         â”‚
â”‚ 2. â¡ï¸ å‘¼å« Lambda    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AWS Lambda        â”‚
â”‚ (Audio Compressor)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ FFmpeg å£“ç¸®:        â”‚
â”‚ â€¢ 32kbps           â”‚
â”‚ â€¢ 16kHz            â”‚
â”‚ â€¢ å–®è²é“           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ å›å‚³ 9.2MB
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    API Server       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. ä¸Šå‚³å£“ç¸®ç‰ˆåˆ° R2  â”‚
â”‚ 4. æ¨é€ Queue      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   R2 Storage        â”‚
â”‚ (åªå„²å­˜å£“ç¸®ç‰ˆ 9.2MB)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Queue Worker      â”‚
â”‚  (Cloudflare Worker)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. ä¸‹è¼‰å£“ç¸®ç‰ˆ (å¿«)  â”‚
â”‚ 2. Whisper è½‰éŒ„     â”‚
â”‚ 3. MEDDIC åˆ†æ      â”‚
â”‚ 4. Slack é€šçŸ¥       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€ç’°å¢ƒè®Šæ•¸è¨­å®š

### æ–°å¢ç’°å¢ƒè®Šæ•¸

#### 1. Server `.env`

åœ¨ `apps/server/.env` æ–°å¢:

```bash
# Lambda Audio Compression Service
LAMBDA_COMPRESSOR_URL=https://your-lambda-function-url.lambda-url.us-east-1.on.aws/
ENABLE_AUDIO_COMPRESSION=true
COMPRESSION_THRESHOLD_MB=10  # è¶…éæ­¤å¤§å°æ‰å£“ç¸®
```

#### 2. Server `wrangler.toml`

```toml
# apps/server/wrangler.toml

[vars]
ENVIRONMENT = "production"
BETTER_AUTH_URL = "https://sales-ai-server.salesaiautomationv3.workers.dev"
CORS_ORIGIN = "https://sales-ai-web.salesaiautomationv3.workers.dev"
ENABLE_AUDIO_COMPRESSION = "true"
COMPRESSION_THRESHOLD_MB = "10"

# ä½¿ç”¨ wrangler secret è¨­å®š:
# npx wrangler secret put LAMBDA_COMPRESSOR_URL
```

#### 3. è¨­å®š Lambda URL Secret

```bash
cd apps/server

# åœ¨éƒ¨ç½² Lambda å¾Œå–å¾— Function URL,ç„¶å¾Œ:
npx wrangler secret put LAMBDA_COMPRESSOR_URL
# è¼¸å…¥: https://abc123xyz.lambda-url.us-east-1.on.aws/
```

---

## ä¸‰ã€ç¨‹å¼ç¢¼ä¿®æ”¹

### ä¿®æ”¹ 1: æ›´æ–° env schema

æª”æ¡ˆ: `packages/env/src/server.ts`

```typescript
import { createEnv } from "@t3-oss/env-core";
import { z } from "zod";

export const env = createEnv({
  server: {
    // ... ç¾æœ‰ç’°å¢ƒè®Šæ•¸ ...

    // Lambda Compression
    LAMBDA_COMPRESSOR_URL: z.string().url().optional(),
    ENABLE_AUDIO_COMPRESSION: z.enum(["true", "false"]).default("false"),
    COMPRESSION_THRESHOLD_MB: z.coerce.number().default(10),
  },
  runtimeEnv: process.env,
});
```

### ä¿®æ”¹ 2: æ›´æ–° conversation router

æª”æ¡ˆ: `packages/api/src/routers/conversation.ts`

åœ¨æª”æ¡ˆé–‹é ­åŠ å…¥ import:

```typescript
import { createLambdaCompressor } from "@Sales_ai_automation_v3/services/compression";
```

åœ¨ `upload` procedure ä¸­,æ‰¾åˆ°é€™æ®µ:

```typescript
// Step 2: Get audio buffer
let audioBuffer: Buffer;
// ... ä¸‹è¼‰æˆ–è§£ç¢¼é‚è¼¯ ...
```

åœ¨ Step 3 ä¹‹å‰åŠ å…¥å£“ç¸®é‚è¼¯:

```typescript
// Step 2.5: Compress audio if enabled and file is large
if (
  env.ENABLE_AUDIO_COMPRESSION === "true" &&
  env.LAMBDA_COMPRESSOR_URL
) {
  const fileSizeMB = audioBuffer.length / 1024 / 1024;
  const threshold = Number(env.COMPRESSION_THRESHOLD_MB) || 10;

  if (fileSizeMB > threshold) {
    console.log(
      `[${requestId}] ğŸ—œï¸  Audio file is ${fileSizeMB.toFixed(2)} MB, compressing...`
    );

    const compressor = createLambdaCompressor(env.LAMBDA_COMPRESSOR_URL, {
      timeout: 60000, // 60 ç§’
    });

    const compressionStartTime = Date.now();
    const result = await compressor.compressFromBuffer(audioBuffer);

    if (result.success && result.compressedAudioBase64) {
      const compressedBuffer = Buffer.from(
        result.compressedAudioBase64,
        "base64"
      );
      const compressionTime = Date.now() - compressionStartTime;

      console.log(
        `[${requestId}] âœ“ Compressed in ${compressionTime}ms: ${(result.originalSize! / 1024 / 1024).toFixed(2)} MB â†’ ${(result.compressedSize! / 1024 / 1024).toFixed(2)} MB (${result.compressionRatio}% reduction)`
      );

      audioBuffer = compressedBuffer;
    } else {
      console.warn(
        `[${requestId}] âš ï¸  Compression failed: ${result.error}, using original audio`
      );
      // ç¹¼çºŒä½¿ç”¨åŸå§‹éŸ³æª”
    }
  } else {
    console.log(
      `[${requestId}] â„¹ï¸  Audio file is ${fileSizeMB.toFixed(2)} MB (< ${threshold} MB), skipping compression`
    );
  }
}

// Step 3: Upload to R2 (ä½¿ç”¨å£“ç¸®å¾Œçš„ audioBuffer)
```

### ä¿®æ”¹ 3: æ›´æ–° services index

æª”æ¡ˆ: `packages/services/src/index.ts`

åŠ å…¥:

```typescript
export * from "./compression";
```

---

## å››ã€éƒ¨ç½²æ­¥é©Ÿ

### Phase 1: éƒ¨ç½² Lambda Function

```bash
cd apps/lambda-audio-compressor

# 1. å®‰è£ä¾è³´
npm install

# 2. æ‰“åŒ…
npm run build

# 3. å»ºç«‹ Lambda Function (é¦–æ¬¡)
# åƒè€ƒ README.md çš„è©³ç´°æ­¥é©Ÿ

# 4. æ–°å¢ FFmpeg Layer
# åœ¨ AWS Console æˆ–ä½¿ç”¨ CLI æ–°å¢

# 5. å»ºç«‹ Function URL
# å–å¾—é¡ä¼¼: https://abc123xyz.lambda-url.us-east-1.on.aws/
```

### Phase 2: è¨­å®š Server ç’°å¢ƒè®Šæ•¸

```bash
cd apps/server

# è¨­å®š Lambda URL
npx wrangler secret put LAMBDA_COMPRESSOR_URL
# è¼¸å…¥å¾ Phase 1 å–å¾—çš„ Function URL

# æ›´æ–° wrangler.toml (å·²å®Œæˆ)
```

### Phase 3: éƒ¨ç½² Server

```bash
cd apps/server

# éƒ¨ç½²æ›´æ–°å¾Œçš„ Server
npx wrangler deploy
```

### Phase 4: æ¸¬è©¦

```bash
# ä¸Šå‚³æ¸¬è©¦éŸ³æª”
curl -X POST https://sales-ai-server.salesaiautomationv3.workers.dev/api/conversations/upload \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "opportunityId": "test-opp-id",
    "audioBase64": "...",
    "title": "æ¸¬è©¦å£“ç¸®"
  }'

# æª¢æŸ¥ R2 Storage
# æ‡‰è©²çœ‹åˆ°å£“ç¸®å¾Œçš„éŸ³æª” (ç´„ 9.2MB)
```

---

## äº”ã€åŠŸèƒ½é–‹é—œ

### å•Ÿç”¨å£“ç¸®

```bash
cd apps/server

# æ–¹æ³• 1: ä¿®æ”¹ wrangler.toml
[vars]
ENABLE_AUDIO_COMPRESSION = "true"

# æ–¹æ³• 2: ä½¿ç”¨ secret (å¯ç†±æ›´æ–°)
npx wrangler secret put ENABLE_AUDIO_COMPRESSION
# è¼¸å…¥: true
```

### åœç”¨å£“ç¸®

```bash
npx wrangler secret put ENABLE_AUDIO_COMPRESSION
# è¼¸å…¥: false
```

### èª¿æ•´å£“ç¸®é–¾å€¼

```bash
# åªå£“ç¸® > 20MB çš„éŸ³æª”
npx wrangler secret put COMPRESSION_THRESHOLD_MB
# è¼¸å…¥: 20
```

---

## å…­ã€ç›£æ§èˆ‡é™¤éŒ¯

### Server æ—¥èªŒ

```bash
cd apps/server
npx wrangler tail
```

æ‡‰è©²çœ‹åˆ°:
```
[req-123] ğŸ—œï¸ Audio file is 92.00 MB, compressing...
[req-123] âœ“ Compressed in 3245ms: 92.00 MB â†’ 9.20 MB (90.00% reduction)
```

### Lambda æ—¥èªŒ

```bash
aws logs tail /aws/lambda/sales-ai-audio-compressor --follow
```

æ‡‰è©²çœ‹åˆ°:
```
Lambda invoked with event: { hasAudioBase64: true }
Original size: 92.00 MB
Compression completed in 2850ms
Compressed size: 9.20 MB
Compression ratio: 90.00%
```

### CloudWatch Metrics

åœ¨ AWS Console æŸ¥çœ‹:
- **Invocations**: å‘¼å«æ¬¡æ•¸
- **Duration**: å¹³å‡ 2-5 ç§’
- **Errors**: æ‡‰è©²æ˜¯ 0
- **Throttles**: æ‡‰è©²æ˜¯ 0

---

## ä¸ƒã€æˆæœ¬ç›£æ§

### Lambda æˆæœ¬

æŸ¥çœ‹ AWS Cost Explorer:
- ç¯©é¸æœå‹™: Lambda
- æŸ¥çœ‹ `sales-ai-audio-compressor`

**é æœŸæˆæœ¬**: æ¯æœˆ $0 (åœ¨å…è²»é¡åº¦å…§)

### R2 Storage ç¯€çœ

```
ä¸å£“ç¸®:
- 1000 å€‹éŸ³æª”/æœˆ Ã— 50 MB = 50 GB
- è²»ç”¨: $0.60/æœˆ

å£“ç¸®:
- 1000 å€‹éŸ³æª”/æœˆ Ã— 5 MB = 5 GB
- è²»ç”¨: $0/æœˆ (å…è²»é¡åº¦å…§)

ç¯€çœ: $0.60/æœˆ = $7.2/å¹´
```

---

## å…«ã€æ•…éšœè™•ç†

### å•é¡Œ 1: Lambda è¶…æ™‚

**ç—‡ç‹€**: Server æ—¥èªŒé¡¯ç¤º "Compression timeout"

**è§£æ±º**:
```bash
# å¢åŠ  Lambda timeout
aws lambda update-function-configuration \
  --function-name sales-ai-audio-compressor \
  --timeout 60

# å¢åŠ  Server å‘¼å« timeout (ä¿®æ”¹ç¨‹å¼ç¢¼)
const compressor = createLambdaCompressor(env.LAMBDA_COMPRESSOR_URL, {
  timeout: 120000, // 120 ç§’
});
```

### å•é¡Œ 2: FFmpeg not found

**ç—‡ç‹€**: Lambda å›å‚³ "FFmpeg spawn error"

**è§£æ±º**:
```bash
# ç¢ºèª Layer å·²æ–°å¢
aws lambda get-function \
  --function-name sales-ai-audio-compressor \
  --query 'Configuration.Layers'

# æ–°å¢ FFmpeg Layer (å¦‚æœæ²’æœ‰)
aws lambda update-function-configuration \
  --function-name sales-ai-audio-compressor \
  --layers arn:aws:lambda:us-east-1:145266761615:layer:ffmpeg:4
```

### å•é¡Œ 3: å£“ç¸®å¤±æ•—ä½†ç¹¼çºŒæµç¨‹

**è¡Œç‚º**: é€™æ˜¯é æœŸçš„ fallback æ©Ÿåˆ¶

```
[req-123] âš ï¸ Compression failed: timeout, using original audio
[req-123] âœ“ Uploaded to R2: audio/opp-123/original.mp3 (92 MB)
```

**è§£æ±º**: æª¢æŸ¥ Lambda æ—¥èªŒæ‰¾å‡ºæ ¹æœ¬åŸå› 

---

## ä¹ã€å›æ»¾è¨ˆç•«

å¦‚æœå£“ç¸®åŠŸèƒ½å‡ºå•é¡Œ,å¯ä»¥å¿«é€Ÿåœç”¨:

### æ–¹æ³• 1: é—œé–‰åŠŸèƒ½é–‹é—œ

```bash
cd apps/server
npx wrangler secret put ENABLE_AUDIO_COMPRESSION
# è¼¸å…¥: false

# ä¸éœ€è¦é‡æ–°éƒ¨ç½²,ç«‹å³ç”Ÿæ•ˆ
```

### æ–¹æ³• 2: ç§»é™¤ç¨‹å¼ç¢¼ (å®Œå…¨å›æ»¾)

```bash
# å›åˆ°å£“ç¸®å‰çš„ç‰ˆæœ¬
git revert <commit-hash>

# é‡æ–°éƒ¨ç½²
cd apps/server
npx wrangler deploy
```

---

## åã€æ¸¬è©¦æª¢æŸ¥æ¸…å–®

éƒ¨ç½²å‰è«‹ç¢ºèª:

- [ ] Lambda Function å·²å»ºç«‹ä¸¦æ¸¬è©¦
- [ ] FFmpeg Layer å·²æ–°å¢
- [ ] Function URL å·²å»ºç«‹
- [ ] Server ç’°å¢ƒè®Šæ•¸å·²è¨­å®š
- [ ] ä½¿ç”¨å°éŸ³æª”æ¸¬è©¦ (< 10MB) â†’ ä¸å£“ç¸®
- [ ] ä½¿ç”¨å¤§éŸ³æª”æ¸¬è©¦ (> 10MB) â†’ å£“ç¸®
- [ ] å£“ç¸®å¤±æ•—æ™‚ fallback æ­£å¸¸
- [ ] R2 Storage å„²å­˜æ­£ç¢ºæª”æ¡ˆ
- [ ] Queue Worker å¯æ­£å¸¸è½‰éŒ„å£“ç¸®ç‰ˆ
- [ ] CloudWatch æ—¥èªŒæ­£å¸¸
- [ ] æˆæœ¬åœ¨å…è²»é¡åº¦å…§

---

## åä¸€ã€æ•ˆèƒ½æŒ‡æ¨™

### ç›®æ¨™

| æŒ‡æ¨™ | ç›®æ¨™å€¼ | å¯¦æ¸¬å€¼ |
|------|--------|--------|
| å£“ç¸®ç‡ | > 80% | 90% âœ… |
| å£“ç¸®æ™‚é–“ | < 5 ç§’ | 2-3 ç§’ âœ… |
| Lambda éŒ¯èª¤ç‡ | < 1% | - |
| è½‰éŒ„æº–ç¢ºåº¦ | > 80% | 85-90% âœ… |
| ç«¯åˆ°ç«¯æ™‚é–“æ¸›å°‘ | > 15 ç§’ | ~19 ç§’ âœ… |

---

## åäºŒã€æœªä¾†å„ªåŒ–

### é¸é … 1: å¹³è¡Œè™•ç†

åŒæ™‚ä¸Šå‚³åŸå§‹å’Œå£“ç¸®ç‰ˆ:

```typescript
// åŒæ™‚åŸ·è¡Œ
const [originalUpload, compressedUpload] = await Promise.allSettled([
  r2.upload(originalKey, audioBuffer),
  r2.upload(compressedKey, compressedBuffer),
]);

// è½‰éŒ„ä½¿ç”¨å£“ç¸®ç‰ˆ,ä¿ç•™åŸå§‹ç‰ˆä¾›æœªä¾†ä½¿ç”¨
```

### é¸é … 2: æ¼¸é€²å¼å£“ç¸®

æ ¹æ“šéŸ³æª”é•·åº¦å‹•æ…‹èª¿æ•´å£“ç¸®åƒæ•¸:

```typescript
const duration = metadata.duration || estimateDuration(audioBuffer);

const bitrate = duration > 3600 ? '24k' :  // > 1 å°æ™‚
                duration > 1800 ? '32k' :  // > 30 åˆ†é˜
                '48k';                      // < 30 åˆ†é˜
```

### é¸é … 3: å¿«å–å£“ç¸®çµæœ

å¦‚æœåŒä¸€éŸ³æª”é‡è¤‡ä¸Šå‚³:

```typescript
const hash = crypto.createHash('sha256').update(audioBuffer).digest('hex');
// æª¢æŸ¥ R2 æ˜¯å¦å·²æœ‰ç›¸åŒ hash çš„å£“ç¸®ç‰ˆ
```

---

**æ•´åˆå®Œæˆ!** ç³»çµ±ç¾åœ¨å¯ä»¥è‡ªå‹•å£“ç¸®å¤§éŸ³æª”,ç¯€çœå„²å­˜ç©ºé–“ä¸¦åŠ å¿«è™•ç†é€Ÿåº¦ã€‚
