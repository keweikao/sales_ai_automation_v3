# å¤šç”¢å“ç·šæ”¯æ´å¯¦ä½œè¨ˆç•«ï¼šé¤é£² (iCHEF) + ç¾æ¥­ [ä¿®æ­£ç‰ˆ]

> **ä¿®æ­£èªªæ˜**: æœ¬ç‰ˆæœ¬å·²æ ¹æ“šå°ˆæ¡ˆå¯¦éš›æŠ€è¡“æ¶æ§‹ä¿®æ­£ä»¥ä¸‹è¡çª:
> 1. âœ… Migration æª”åæ”¹ç‚º Drizzle ORM æ ¼å¼ (`0003_add_product_line.sql`)
> 2. âœ… Migration è·¯å¾‘ä¿®æ­£ç‚º `/packages/db/src/migrations/`
> 3. âœ… Prompts é‡çµ„æ–¹æ¡ˆç›¸å®¹ç¾æœ‰ç·¨è­¯æ©Ÿåˆ¶ (`build-prompts.ts`)
> 4. âœ… Orchestrator ä»‹é¢ä¿ç•™æ‰€æœ‰ç¾æœ‰åƒæ•¸
> 5. âœ… Package import è·¯å¾‘ä½¿ç”¨æ­£ç¢ºå¤§å°å¯« `@Sales_ai_automation_v3/`

---

## ä¸»è¦ä¿®æ­£é …ç›®

### ğŸ”´ è¡çª 1: Migration æª”åå’Œè·¯å¾‘ [å·²ä¿®æ­£]

**åŸè¦åŠƒ**:
- æª”æ¡ˆ: `/packages/db/migrations/20260116_add_product_line.sql`

**ä¿®æ­£å¾Œ**:
- æª”æ¡ˆ: `/packages/db/src/migrations/0003_add_product_line.sql`
- åŸå› : å°ˆæ¡ˆä½¿ç”¨ Drizzle ORM è‡ªå‹•ç·¨è™Ÿæ ¼å¼ (`0000_`, `0001_`, `0002_`)
- Migration å¿…é ˆæ”¾åœ¨ `/packages/db/src/migrations/` ç›®éŒ„

### ğŸŸ¡ è¡çª 2: Prompts ç·¨è­¯æ©Ÿåˆ¶ [å·²ä¿®æ­£]

**å°ˆæ¡ˆç¾æ³**:
- ä½¿ç”¨ç·¨è­¯æ©Ÿåˆ¶: `.md` â†’ `prompts.generated.ts`
- ç·¨è­¯è…³æœ¬: `/packages/services/scripts/build-prompts.ts`
- å¾ `prompts.ts` import ç·¨è­¯å¾Œçš„å¸¸æ•¸

**ä¿®æ­£æ–¹æ¡ˆ**:
- éœ€è¦æ›´æ–° `build-prompts.ts` æ”¯æ´å¤šç”¢å“ç·šç›®éŒ„çµæ§‹
- ç›®éŒ„çµæ§‹æ”¹ç‚º:
  ```
  prompts/meddic/
    ichef/global-context.md
    beauty/global-context.md
    shared/agent1-context.md
  ```

### ğŸŸ¢ è¡çª 3: Orchestrator ä»‹é¢ [å·²ä¿®æ­£]

**åŸè¦åŠƒ** (ä¸å®Œæ•´):
```typescript
async analyze(transcript: Transcript[], metadata: { productLine?: ProductLine })
```

**ä¿®æ­£å¾Œ** (ä¿ç•™æ‰€æœ‰ç¾æœ‰æ¬„ä½):
```typescript
async analyze(
  transcript: TranscriptSegment[],
  metadata: {
    leadId: string;              // ç¾æœ‰
    conversationId: string;      // ç¾æœ‰
    salesRep: string;            // ç¾æœ‰
    conversationDate: Date;      // ç¾æœ‰
    productLine?: ProductLine;   // æ–°å¢
  }
)
```

---

## Agent Aï¼šåŸºç¤è¨­æ–½èˆ‡æ ¸å¿ƒæœå‹™ [å·²ä¿®æ­£]

### è³‡æ–™åº«æ“´å±•ä»»å‹™ (ä¿®æ­£ç‰ˆ)

**ä¿®æ­£å¾Œçš„ä»»å‹™**:
- [ ] æ’°å¯« Migration SQL: `/packages/db/src/migrations/0003_add_product_line.sql`
  - âš ï¸ **é‡è¦**: ä½¿ç”¨ Drizzle ORM ç·¨è™Ÿæ ¼å¼ `0003_`
  - è·¯å¾‘å¿…é ˆæ˜¯ `/packages/db/src/migrations/` (ä¸æ˜¯ `/packages/db/migrations/`)
- [ ] æ›´æ–° Migration metadata: `/packages/db/src/migrations/meta/_journal.json`
- [ ] æ›´æ–° Schema æ–‡ä»¶:
  - `/packages/db/src/schema/opportunity.ts` - æ·»åŠ  `productLine: text("product_line").default('ichef').notNull()`
  - `/packages/db/src/schema/conversation.ts` - æ·»åŠ  `productLine: text("product_line").default('ichef').notNull()`
  - `/packages/db/src/schema/talk-tracks.ts` - æ·»åŠ  `productLine: text("product_line").default('ichef').notNull()`
  - `/packages/db/src/schema/meddic.ts` - æ·»åŠ  `productLine: text("product_line").default('ichef').notNull()`
- [ ] åŸ·è¡Œ Migration: `bun run db:migrate`

**Migration SQL ç¯„ä¾‹**:
```sql
-- /packages/db/src/migrations/0003_add_product_line.sql
ALTER TABLE opportunities ADD COLUMN product_line TEXT DEFAULT 'ichef' NOT NULL;
ALTER TABLE conversations ADD COLUMN product_line TEXT DEFAULT 'ichef' NOT NULL;
ALTER TABLE talk_tracks ADD COLUMN product_line TEXT DEFAULT 'ichef' NOT NULL;
ALTER TABLE meddic_analyses ADD COLUMN product_line TEXT DEFAULT 'ichef' NOT NULL;

CREATE INDEX idx_opportunities_product_line ON opportunities(product_line);
CREATE INDEX idx_conversations_product_line ON conversations(product_line);
CREATE INDEX idx_talk_tracks_product_line ON talk_tracks(product_line);
CREATE INDEX idx_meddic_analyses_product_line ON meddic_analyses(product_line);
```

### Package è¨­å®š

**packages/shared/package.json** éœ€è¦æ·»åŠ :
```json
{
  "name": "@Sales_ai_automation_v3/shared",
  "exports": {
    "./product-configs": "./src/product-configs/index.ts",
    "./product-configs/*": "./src/product-configs/*.ts",
    "./types/*": "./src/types/*/index.ts",
    "./errors": "./src/errors/index.ts"
  }
}
```

---

## Agent Cï¼šMEDDIC æç¤ºè©ç³»çµ± [å·²ä¿®æ­£ - é‡è¦]

**æ™‚ç¨‹èª¿æ•´**: 10-12h â†’ **12-14h** (å¢åŠ  2h è™•ç†ç·¨è­¯æ©Ÿåˆ¶)

### é—œéµä¿®æ­£: Prompts ç·¨è­¯æ©Ÿåˆ¶

**ç¾æœ‰æ©Ÿåˆ¶**:
1. Markdown æª”æ¡ˆåœ¨ `/packages/services/prompts/meddic/*.md`
2. åŸ·è¡Œ `/packages/services/scripts/build-prompts.ts` ç·¨è­¯
3. ç”Ÿæˆ `/packages/services/src/llm/prompts.generated.ts`
4. `prompts.ts` import ä¸¦å°å‡ºå‡½æ•¸

**ä¿®æ­£å¾Œçš„ç›®éŒ„çµæ§‹**:
```
/packages/services/prompts/meddic/
  ichef/
    global-context.md          # å¾æ ¹ç›®éŒ„é·ç§»
    product-context.md         # æ–°å¢
  beauty/
    global-context.md          # æ–°å¢
    product-context.md         # æ–°å¢
  shared/
    agent1-context.md          # å¾æ ¹ç›®éŒ„é·ç§»
    agent2-buyer.md            # å¾æ ¹ç›®éŒ„é·ç§»
    agent3-seller.md           # å¾æ ¹ç›®éŒ„é·ç§»
    agent4-summary.md          # å¾æ ¹ç›®éŒ„é·ç§»
    agent5-crm-extractor.md    # å¾æ ¹ç›®éŒ„é·ç§»
    agent6-coach.md            # å¾æ ¹ç›®éŒ„é·ç§»
```

### æ–°å¢ä»»å‹™: æ›´æ–°ç·¨è­¯è…³æœ¬

**å¿…é ˆä¿®æ”¹ `/packages/services/scripts/build-prompts.ts`**:

```typescript
// ä¿®æ­£å¾Œçš„ build-prompts.ts é‚è¼¯

const PROMPTS_DIR = join(__dirname, "../prompts/meddic");

// æ–°å¢: ç”¢å“ç·šæç¤ºè©
const productPrompts = [
  { productLine: 'ichef', name: 'global-context', varName: 'ichefGlobalContext' },
  { productLine: 'ichef', name: 'product-context', varName: 'ichefProductContext' },
  { productLine: 'beauty', name: 'global-context', varName: 'beautyGlobalContext' },
  { productLine: 'beauty', name: 'product-context', varName: 'beautyProductContext' },
];

// ç¾æœ‰: å…±ç”¨ Agent æ¨¡æ¿
const sharedPrompts = [
  { name: "agent1-context", varName: "sharedAgent1Context" },
  { name: "agent2-buyer", varName: "sharedAgent2Buyer" },
  { name: "agent3-seller", varName: "sharedAgent3Seller" },
  { name: "agent4-summary", varName: "sharedAgent4Summary" },
  { name: "agent5-crm-extractor", varName: "sharedAgent5Crm" },
  { name: "agent6-coach", varName: "sharedAgent6Coach" },
];

// è®€å–ç”¢å“ç·šæç¤ºè©
const productContents = productPrompts.map(({ productLine, name, varName }) => {
  const filePath = join(PROMPTS_DIR, productLine, `${name}.md`);
  const content = readFileSync(filePath, 'utf-8');
  const escapedContent = escapeContent(content);
  return { varName, content: escapedContent };
});

// è®€å–å…±ç”¨æç¤ºè©
const sharedContents = sharedPrompts.map(({ name, varName }) => {
  const filePath = join(PROMPTS_DIR, 'shared', `${name}.md`);
  const content = readFileSync(filePath, 'utf-8');
  const escapedContent = escapeContent(content);
  return { varName, content: escapedContent };
});

// ç”Ÿæˆ TypeScript æª”æ¡ˆ
const output = `// Auto-generated file - DO NOT EDIT
// Generated from markdown files in packages/services/prompts/meddic/

// Product Line Prompts
${productContents.map(({ varName, content }) => 
  `export const ${varName} = \`${content}\`;`
).join('\n\n')}

// Shared Agent Templates
${sharedContents.map(({ varName, content }) => 
  `export const ${varName} = \`${content}\`;`
).join('\n\n')}
`;
```

### æ–°å¢: PromptLoader å¯¦ä½œ

```typescript
// /packages/services/src/llm/prompt-loader.ts
import {
  ichefGlobalContext,
  ichefProductContext,
  beautyGlobalContext,
  beautyProductContext,
  sharedAgent1Context,
  sharedAgent2Buyer,
  sharedAgent3Seller,
  sharedAgent4Summary,
  sharedAgent5Crm,
  sharedAgent6Coach,
} from './prompts.generated';

export class PromptLoader {
  private static cache = new Map<string, string>();

  /**
   * è¼‰å…¥ç”¢å“ç·šå…¨åŸŸä¸Šä¸‹æ–‡
   */
  static loadGlobalContext(productLine: ProductLine): string {
    const key = `${productLine}-global`;
    if (this.cache.has(key)) {
      return this.cache.get(key)!;
    }

    const prompt = productLine === 'beauty' 
      ? beautyGlobalContext 
      : ichefGlobalContext;
    
    this.cache.set(key, prompt);
    return prompt;
  }

  /**
   * è¼‰å…¥ç”¢å“ç‰¹å®šä¸Šä¸‹æ–‡
   */
  static loadProductContext(productLine: ProductLine): string {
    const key = `${productLine}-product`;
    if (this.cache.has(key)) {
      return this.cache.get(key)!;
    }

    const prompt = productLine === 'beauty'
      ? beautyProductContext
      : ichefProductContext;

    this.cache.set(key, prompt);
    return prompt;
  }

  /**
   * è¼‰å…¥å…±ç”¨ Agent æ¨¡æ¿
   */
  static loadSharedAgent(agentName: string): string {
    const agentMap: Record<string, string> = {
      'agent1-context': sharedAgent1Context,
      'agent2-buyer': sharedAgent2Buyer,
      'agent3-seller': sharedAgent3Seller,
      'agent4-summary': sharedAgent4Summary,
      'agent5-crm': sharedAgent5Crm,
      'agent6-coach': sharedAgent6Coach,
    };

    return agentMap[agentName] || '';
  }

  /**
   * çµ„åˆå®Œæ•´çš„ Agent æç¤ºè©
   */
  static buildAgentPrompt(
    productLine: ProductLine,
    agentName: string,
    demoMeta?: Record<string, unknown>
  ): string {
    const globalContext = this.loadGlobalContext(productLine);
    const productContext = this.loadProductContext(productLine);
    const agentTemplate = this.loadSharedAgent(agentName);

    let prompt = `${globalContext}\n\n${productContext}\n\n${agentTemplate}`;

    // å¦‚æœæœ‰ demoMeta,æ’å…¥åˆ°æç¤ºè©ä¸­
    if (demoMeta) {
      prompt += `\n\n## Demo Metadata\n${JSON.stringify(demoMeta, null, 2)}`;
    }

    return prompt;
  }
}
```

### Orchestrator ä¿®æ­£ (å®Œæ•´ç‰ˆ)

```typescript
// /packages/services/src/llm/orchestrator.ts
import { PromptLoader } from './prompt-loader';

export class MeddicOrchestrator {
  private readonly geminiClient: GeminiClient;
  private readonly productLine: ProductLine;
  private readonly USE_DAG_EXECUTOR: boolean;

  constructor(
    geminiClient: GeminiClient,
    options: {
      useDagExecutor?: boolean;
      productLine?: ProductLine;  // æ–°å¢
    } = {}
  ) {
    this.geminiClient = geminiClient;
    this.productLine = options.productLine || 'ichef';  // é è¨­ ichef
    this.USE_DAG_EXECUTOR = options.useDagExecutor ?? true;
  }

  async analyze(
    transcript: TranscriptSegment[],
    metadata: {
      leadId: string;
      conversationId: string;
      salesRep: string;
      conversationDate: Date;
      productLine?: ProductLine;  // æ–°å¢ (optional)
    }
  ): Promise<AnalysisResult> {
    // å„ªå…ˆä½¿ç”¨ metadata.productLine, å…¶æ¬¡ä½¿ç”¨å»ºæ§‹å‡½æ•¸çš„ productLine
    const effectiveProductLine = metadata.productLine || this.productLine;

    const initialState: AnalysisState = {
      transcript,
      metadata: {
        ...metadata,
        productLine: effectiveProductLine,
      },
      refinementCount: 0,
      maxRefinements: this.MAX_REFINEMENTS,
      hasCompetitor: this.detectCompetitor(transcript),
      competitorKeywords: this.extractCompetitorKeywords(transcript),
    };

    if (this.USE_DAG_EXECUTOR) {
      return this.executeWithDAG(initialState);
    }
    return this.executeLegacy(initialState);
  }

  // åœ¨å»ºç«‹ Agents æ™‚ä½¿ç”¨ PromptLoader
  private createAgentsWithProductLine(productLine: ProductLine) {
    const contextPrompt = PromptLoader.buildAgentPrompt(productLine, 'agent1-context');
    const buyerPrompt = PromptLoader.buildAgentPrompt(productLine, 'agent2-buyer');
    // ... å…¶ä»– agents

    return {
      contextAgent: createContextAgent(this.geminiClient, contextPrompt),
      buyerAgent: createBuyerAgent(this.geminiClient, buyerPrompt),
      // ...
    };
  }
}
```

---

## Agent Dï¼šQueue Worker æ•´åˆ [å·²ä¿®æ­£]

### Queue Worker ä¿®æ­£è¦é»

```typescript
// /apps/queue-worker/src/index.ts

async function processTranscription(message: QueueMessage) {
  const { conversationId } = message;

  // 1. å¾ DB è®€å– conversation (åŒ…å« product_line)
  const conversation = await db.query.conversations.findFirst({
    where: eq(conversations.id, conversationId),
    with: { opportunity: true }
  });

  if (!conversation) {
    throw new Error(`Conversation ${conversationId} not found`);
  }

  // 2. å–å¾— productLine (fallback åˆ° 'ichef')
  const productLine = (conversation.productLine as ProductLine) || 'ichef';

  // 3. å»ºç«‹ Orchestrator (å‚³é productLine)
  const orchestrator = new MeddicOrchestrator(geminiClient, {
    productLine,
    useDagExecutor: true
  });

  // 4. åŸ·è¡Œåˆ†æ (ä¿ç•™æ‰€æœ‰ç¾æœ‰åƒæ•¸)
  const analysisResult = await orchestrator.analyze(transcriptSegments, {
    leadId: conversation.opportunityId,
    conversationId: conversation.id,
    salesRep: conversation.slackUsername || 'unknown',
    conversationDate: conversation.conversationDate || new Date(),
    productLine,  // æ–°å¢
  });

  // 5. Slack é€šçŸ¥åŒ…å«ç”¢å“ç·šè³‡è¨Š
  const productDisplayName = productLine === 'beauty' ? 'ç¾æ¥­' : 'iCHEF';
  await slackClient.postMessage({
    channel: conversation.slackChannelId,
    text: `âœ… ${productDisplayName} åˆ†æå®Œæˆ`,
    blocks: buildAnalysisResultBlocks(analysisResult, productDisplayName)
  });
}
```

---

## ä¿®æ­£æ‘˜è¦

### âœ… å·²ä¿®æ­£çš„æŠ€è¡“è¡çª

1. **Migration æª”å**: `20260116_add_product_line.sql` â†’ `0003_add_product_line.sql`
2. **Migration è·¯å¾‘**: `/packages/db/migrations/` â†’ `/packages/db/src/migrations/`
3. **Prompts ç·¨è­¯**: æ–°å¢ç·¨è­¯è…³æœ¬æ›´æ–°ä»»å‹™,æ”¯æ´å¤šç”¢å“ç·šç›®éŒ„
4. **Orchestrator åƒæ•¸**: ä¿ç•™æ‰€æœ‰ç¾æœ‰ metadata æ¬„ä½
5. **Package import**: ä½¿ç”¨æ­£ç¢ºçš„ `@Sales_ai_automation_v3/`

### âš ï¸ æ–°å¢çš„ä»»å‹™

1. **Agent C**: æ›´æ–° `build-prompts.ts` ç·¨è­¯è…³æœ¬ (2-3h)
2. **Agent C**: å»ºç«‹ `PromptLoader` é¡åˆ¥ (3-4h)
3. **Agent A**: æ›´æ–° `packages/shared/package.json` exports
4. **Agent D**: Queue Worker å®Œæ•´ä¿ç•™ç¾æœ‰åƒæ•¸

### ğŸ¯ é©—æ”¶æ¨™æº–æ›´æ–°

**å‘å¾Œç›¸å®¹æ€§æ¸¬è©¦**:
- [ ] ä¸å‚³ `productLine` åƒæ•¸æ™‚,ç³»çµ±é è¨­ä½¿ç”¨ 'ichef'
- [ ] ç¾æœ‰çš„ iCHEF æ¸¬è©¦æ¡ˆä¾‹å…¨éƒ¨é€šé
- [ ] Prompts ç·¨è­¯è…³æœ¬æˆåŠŸç”Ÿæˆ `prompts.generated.ts`
- [ ] PromptLoader æ­£ç¢ºè¼‰å…¥ iCHEF å’Œ Beauty æç¤ºè©

---

## å¿«é€Ÿåƒè€ƒ

### Migration å‘½ä»¤
```bash
# åŸ·è¡Œ migration
bun run db:migrate

# æª¢æŸ¥ migration ç‹€æ…‹
bun run db:studio
```

### Prompts ç·¨è­¯å‘½ä»¤
```bash
# ç·¨è­¯ prompts
bun run /packages/services/scripts/build-prompts.ts

# æª¢æŸ¥ç”Ÿæˆçµæœ
cat /packages/services/src/llm/prompts.generated.ts | head -50
```

### Import è·¯å¾‘ç¯„ä¾‹
```typescript
// âœ… æ­£ç¢º
import { getProductConfig } from '@Sales_ai_automation_v3/shared/product-configs';

// âŒ éŒ¯èª¤ (å°å¯« s)
import { getProductConfig } from '@sales_ai_automation_v3/shared/product-configs';
```
