# æ©Ÿæœƒæˆäº¤/æ‹’çµ•åŠŸèƒ½èˆ‡åˆ—è¡¨åˆ†é å¯¦ä½œå ±å‘Š

**æ—¥æœŸ**: 2026-01-28
**ç‹€æ…‹**: âœ… å·²å®Œæˆ
**Commit**: 1485962

---

## åŠŸèƒ½æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°é‡å°æ©Ÿæœƒç®¡ç†åŠŸèƒ½é€²è¡Œå…¨é¢å‡ç´šï¼Œæ–°å¢æ©Ÿæœƒæˆäº¤/æ‹’çµ•æ¨™è¨˜åŠŸèƒ½ï¼Œä¸¦åœ¨æ©Ÿæœƒåˆ—è¡¨é åŠ å…¥ç‹€æ…‹åˆ†é¡ Tabï¼Œå¹«åŠ©æ¥­å‹™åœ˜éšŠæ›´æœ‰æ•ˆåœ°ç®¡ç†éŠ·å”®æ¼æ–—ã€‚

---

## âœ… æ–°å¢åŠŸèƒ½

### 1. æ©Ÿæœƒæˆäº¤æ¨™è¨˜åŠŸèƒ½

**ä½ç½®**: æ©Ÿæœƒè©³æƒ…é å³ä¸Šè§’æ“ä½œå€

**åŠŸèƒ½èªªæ˜**:
- ç¶ è‰²ã€Œæ¨™è¨˜ç‚ºæˆäº¤ã€æŒ‰éˆ•
- é»æ“Šé–‹å•Ÿç¢ºèª Dialog
- è¨˜éŒ„æˆäº¤æ™‚é–“æˆ³ï¼ˆ`wonAt`ï¼‰
- æˆäº¤å¾Œæ©Ÿæœƒå¾ã€Œé€²è¡Œä¸­ã€åˆ—è¡¨ç§»è‡³ã€Œå·²æˆäº¤ã€åˆ—è¡¨

**UI è¨­è¨ˆ**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¢ºèªæ¨™è¨˜ç‚ºæˆäº¤                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¢ºå®šè¦å°‡æ­¤æ©Ÿæœƒæ¨™è¨˜ç‚ºå·²æˆäº¤å—ï¼Ÿ       â”‚
â”‚                                        â”‚
â”‚ â€¢ æ©Ÿæœƒå°‡ç§»è‡³ã€Œå·²æˆäº¤ã€åˆ—è¡¨             â”‚
â”‚ â€¢ æˆäº¤æ™‚é–“å°‡è¨˜éŒ„ç‚ºç•¶å‰æ™‚é–“             â”‚
â”‚                                        â”‚
â”‚              [å–æ¶ˆ] [ç¢ºèªæˆäº¤]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æŠ€è¡“å¯¦ä½œ**:
```typescript
// apps/web/src/routes/opportunities/$id.tsx

const winMutation = useMutation({
  mutationFn: async () => {
    return await client.opportunities.win({
      opportunityId: id,
    });
  },
  onSuccess: () => {
    toast.success("æ©Ÿæœƒå·²æ¨™è¨˜ç‚ºæˆäº¤");
    queryClient.invalidateQueries({
      queryKey: ["opportunities", "get", { opportunityId: id }],
    });
  },
});
```

---

### 2. æ©Ÿæœƒæ‹’çµ•æ¨™è¨˜åŠŸèƒ½

**ä½ç½®**: æ©Ÿæœƒè©³æƒ…é å³ä¸Šè§’æ“ä½œå€

**åŠŸèƒ½èªªæ˜**:
- ç´…è‰²ã€Œæ¨™è¨˜ç‚ºæ‹’çµ•ã€æŒ‰éˆ•
- é»æ“Šé–‹å•Ÿç¢ºèª Dialog
- è¨˜éŒ„æ‹’çµ•æ™‚é–“æˆ³ï¼ˆ`lostAt`ï¼‰
- æ‹’çµ•å¾Œæ©Ÿæœƒå¾ã€Œé€²è¡Œä¸­ã€åˆ—è¡¨ç§»è‡³ã€Œå·²æ‹’çµ•ã€åˆ—è¡¨

**UI è¨­è¨ˆ**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¢ºèªæ¨™è¨˜ç‚ºæ‹’çµ•                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¢ºå®šè¦å°‡æ­¤æ©Ÿæœƒæ¨™è¨˜ç‚ºå·²æ‹’çµ•å—ï¼Ÿ       â”‚
â”‚                                        â”‚
â”‚ â€¢ æ©Ÿæœƒå°‡ç§»è‡³ã€Œå·²æ‹’çµ•ã€åˆ—è¡¨             â”‚
â”‚ â€¢ æ‹’çµ•æ™‚é–“å°‡è¨˜éŒ„ç‚ºç•¶å‰æ™‚é–“             â”‚
â”‚                                        â”‚
â”‚              [å–æ¶ˆ] [ç¢ºèªæ‹’çµ•]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æŠ€è¡“å¯¦ä½œ**:
```typescript
// apps/web/src/routes/opportunities/$id.tsx

const rejectMutation = useMutation({
  mutationFn: async () => {
    return await client.opportunities.reject({
      opportunityId: id,
    });
  },
  onSuccess: () => {
    toast.success("æ©Ÿæœƒå·²æ¨™è¨˜ç‚ºæ‹’çµ•");
    queryClient.invalidateQueries({
      queryKey: ["opportunities", "get", { opportunityId: id }],
    });
  },
});
```

---

### 3. æ©Ÿæœƒåˆ—è¡¨ç‹€æ…‹åˆ†é¡ Tab

**ä½ç½®**: æ©Ÿæœƒåˆ—è¡¨é  (`/opportunities`) é ‚éƒ¨

**Tab é¡å‹**:
- **é€²è¡Œä¸­** (Active): æœªæ¨™è¨˜æˆäº¤æˆ–æ‹’çµ•çš„æ©Ÿæœƒï¼ˆé è¨­é¡¯ç¤ºï¼‰
- **å·²æˆäº¤** (Won): å·²æ¨™è¨˜ç‚ºæˆäº¤çš„æ©Ÿæœƒ
- **å·²æ‹’çµ•** (Lost): å·²æ¨™è¨˜ç‚ºæ‹’çµ•çš„æ©Ÿæœƒ

**UI è¨­è¨ˆ**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ©Ÿæœƒç®¡ç†                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [é€²è¡Œä¸­] [å·²æˆäº¤] [å·²æ‹’çµ•]                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ¡ˆä»¶ç·¨è™Ÿ | å…¬å¸åç¨± | å®¢æˆ¶ç·¨è™Ÿ | ... | æ›´æ–°æ–¼ â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚ ...                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æŠ€è¡“å¯¦ä½œ**:
```typescript
// apps/web/src/routes/opportunities/index.tsx

const [activeTab, setActiveTab] = useState<"active" | "won" | "lost">("active");

const { data: opportunities, isLoading } = useQuery({
  queryKey: ["opportunities", "list", { status: activeTab }],
  queryFn: async () => {
    return await client.opportunities.list({
      status: activeTab, // å‚³éç‹€æ…‹ç¯©é¸åƒæ•¸
    });
  },
});
```

---

### 4. æ™‚é–“é¡¯ç¤ºå„ªå…ˆç´šé‚è¼¯

**é¡¯ç¤ºè¦å‰‡**:
1. **å·²æˆäº¤**: é¡¯ç¤ºã€Œæˆäº¤æ–¼ YYYY/MM/DDã€ï¼ˆç¶ è‰²æ¨™ç±¤ï¼‰
2. **å·²æ‹’çµ•**: é¡¯ç¤ºã€Œæ‹’çµ•æ–¼ YYYY/MM/DDã€ï¼ˆç´…è‰²æ¨™ç±¤ï¼‰
3. **é€²è¡Œä¸­**: é¡¯ç¤ºã€Œæ›´æ–°æ–¼ YYYY/MM/DDã€ï¼ˆç°è‰²æ¨™ç±¤ï¼‰

**UI ç¯„ä¾‹**:
```
æˆäº¤æ–¼ 2026/01/28  [ç¶ è‰²èƒŒæ™¯]
æ‹’çµ•æ–¼ 2026/01/25  [ç´…è‰²èƒŒæ™¯]
æ›´æ–°æ–¼ 2026/01/20  [ç°è‰²èƒŒæ™¯]
```

**æŠ€è¡“å¯¦ä½œ**:
```typescript
// apps/web/src/routes/opportunities/index.tsx

const getTimeLabel = (opportunity) => {
  if (opportunity.wonAt) {
    return {
      label: "æˆäº¤æ–¼",
      date: opportunity.wonAt,
      color: "bg-green-500/20 text-green-400",
    };
  } else if (opportunity.lostAt) {
    return {
      label: "æ‹’çµ•æ–¼",
      date: opportunity.lostAt,
      color: "bg-red-500/20 text-red-400",
    };
  } else {
    return {
      label: "æ›´æ–°æ–¼",
      date: opportunity.updatedAt,
      color: "bg-slate-500/20 text-slate-400",
    };
  }
};
```

---

## ğŸ“Š è³‡æ–™åº«è®Šæ›´

### Migration 0008: æ–°å¢æˆäº¤/æ‹’çµ•æ™‚é–“æˆ³

**æª”æ¡ˆ**: `packages/db/migrations/0008_add_won_lost_timestamps.sql`

```sql
-- æ–°å¢ wonAt å’Œ lostAt æ¬„ä½
ALTER TABLE opportunities
ADD COLUMN won_at TIMESTAMP,
ADD COLUMN lost_at TIMESTAMP;

-- å»ºç«‹ç´¢å¼•ä»¥åŠ é€ŸæŸ¥è©¢
CREATE INDEX idx_opportunities_won_at ON opportunities(won_at);
CREATE INDEX idx_opportunities_lost_at ON opportunities(lost_at);
```

### Migration 0009: Cascade Delete å¾…è¾¦äº‹é …

**æª”æ¡ˆ**: `packages/db/migrations/0009_cascade_delete_todos_with_opportunity.sql`

```sql
-- ä¿®æ”¹å¤–éµç´„æŸï¼Œç•¶æ©Ÿæœƒåˆªé™¤æ™‚é€£å¸¶åˆªé™¤å¾…è¾¦äº‹é …
ALTER TABLE sales_todos
DROP CONSTRAINT IF EXISTS sales_todos_opportunity_id_opportunities_id_fk;

ALTER TABLE sales_todos
ADD CONSTRAINT sales_todos_opportunity_id_opportunities_id_fk
FOREIGN KEY (opportunity_id)
REFERENCES opportunities(id)
ON DELETE CASCADE;
```

### Schema æ›´æ–°

**æª”æ¡ˆ**: `packages/db/src/schema/opportunity.ts`

```typescript
export const opportunities = pgTable("opportunities", {
  // ... å…¶ä»–æ¬„ä½ ...
  wonAt: timestamp("won_at"), // æ–°å¢
  lostAt: timestamp("lost_at"), // æ–°å¢
});
```

---

## ğŸ”Œ API è®Šæ›´

### 1. æ–°å¢ `winOpportunity` Endpoint

**è·¯å¾‘**: `/rpc/opportunities/win`
**æ–¹æ³•**: POST

**Request Body**:
```typescript
{
  opportunityId: string;
}
```

**Response**:
```typescript
{
  success: boolean;
  opportunityId: string;
  wonAt: string; // ISO 8601 timestamp
}
```

**å¯¦ä½œé‚è¼¯**:
```typescript
// packages/api/src/routers/opportunity.ts

winOpportunity: protectedProcedure
  .input(z.object({ opportunityId: z.string() }))
  .mutation(async ({ ctx, input }) => {
    const { opportunityId } = input;

    // æ›´æ–° wonAt æ™‚é–“æˆ³
    const updated = await ctx.db
      .update(opportunities)
      .set({
        wonAt: new Date(),
        updatedAt: new Date(),
      })
      .where(eq(opportunities.id, opportunityId))
      .returning();

    return {
      success: true,
      opportunityId,
      wonAt: updated[0].wonAt.toISOString(),
    };
  }),
```

---

### 2. ä¿®æ”¹ `rejectOpportunity` Endpoint

**è·¯å¾‘**: `/rpc/opportunities/reject`
**æ–¹æ³•**: POST

**è®Šæ›´èªªæ˜**: åŸæœ¬åªæ›´æ–° `status`ï¼Œç¾åœ¨åŒæ™‚è¨­å®š `lostAt` æ™‚é–“æˆ³

**Request Body**:
```typescript
{
  opportunityId: string;
}
```

**Response**:
```typescript
{
  success: boolean;
  opportunityId: string;
  lostAt: string; // ISO 8601 timestamp
}
```

**å¯¦ä½œé‚è¼¯**:
```typescript
// packages/api/src/routers/opportunity.ts

rejectOpportunity: protectedProcedure
  .input(z.object({ opportunityId: z.string() }))
  .mutation(async ({ ctx, input }) => {
    const { opportunityId } = input;

    // æ›´æ–° lostAt æ™‚é–“æˆ³
    const updated = await ctx.db
      .update(opportunities)
      .set({
        lostAt: new Date(),
        updatedAt: new Date(),
      })
      .where(eq(opportunities.id, opportunityId))
      .returning();

    return {
      success: true,
      opportunityId,
      lostAt: updated[0].lostAt.toISOString(),
    };
  }),
```

---

### 3. ä¿®æ”¹ `listOpportunities` Endpoint

**è·¯å¾‘**: `/rpc/opportunities/list`
**æ–¹æ³•**: GET

**æ–°å¢æŸ¥è©¢åƒæ•¸**:
```typescript
{
  status?: "active" | "won" | "lost"; // æ–°å¢ç‹€æ…‹ç¯©é¸
  limit?: number;
  offset?: number;
}
```

**ç¯©é¸é‚è¼¯**:
- `status: "active"`: è¿”å› `wonAt IS NULL AND lostAt IS NULL` çš„æ©Ÿæœƒï¼ˆé è¨­ï¼‰
- `status: "won"`: è¿”å› `wonAt IS NOT NULL` çš„æ©Ÿæœƒ
- `status: "lost"`: è¿”å› `lostAt IS NOT NULL` çš„æ©Ÿæœƒ

**å¯¦ä½œé‚è¼¯**:
```typescript
// packages/api/src/routers/opportunity.ts

listOpportunities: protectedProcedure
  .input(
    z.object({
      status: z.enum(["active", "won", "lost"]).optional().default("active"),
      limit: z.number().optional().default(50),
      offset: z.number().optional().default(0),
    })
  )
  .query(async ({ ctx, input }) => {
    const { status, limit, offset } = input;

    // æ§‹å»ºç¯©é¸æ¢ä»¶
    let whereCondition;
    if (status === "won") {
      whereCondition = isNotNull(opportunities.wonAt);
    } else if (status === "lost") {
      whereCondition = isNotNull(opportunities.lostAt);
    } else {
      // active: æ—¢æ²’æœ‰æˆäº¤ä¹Ÿæ²’æœ‰æ‹’çµ•
      whereCondition = and(
        isNull(opportunities.wonAt),
        isNull(opportunities.lostAt)
      );
    }

    const results = await ctx.db
      .select()
      .from(opportunities)
      .where(whereCondition)
      .orderBy(desc(opportunities.updatedAt))
      .limit(limit)
      .offset(offset);

    return results;
  }),
```

---

### 4. ä¿®æ”¹ `getOpportunity` Endpoint

**è®Šæ›´èªªæ˜**: è¿”å›çµæœæ–°å¢ `wonAt` å’Œ `lostAt` æ¬„ä½

**Response æ–°å¢æ¬„ä½**:
```typescript
{
  // ... å…¶ä»–æ¬„ä½ ...
  wonAt: string | null; // ISO 8601 timestamp
  lostAt: string | null; // ISO 8601 timestamp
}
```

---

## ğŸ¨ å‰ç«¯è®Šæ›´

### 1. æ©Ÿæœƒè©³æƒ…é æ“ä½œæŒ‰éˆ•

**æª”æ¡ˆ**: `apps/web/src/routes/opportunities/$id.tsx`

**æ–°å¢å…ƒä»¶**:
- ã€Œæ¨™è¨˜ç‚ºæˆäº¤ã€Buttonï¼ˆç¶ è‰² Variantï¼‰
- ã€Œæ¨™è¨˜ç‚ºæ‹’çµ•ã€Buttonï¼ˆç´…è‰² Destructive Variantï¼‰
- æˆäº¤ç¢ºèª Dialog
- æ‹’çµ•ç¢ºèª Dialog

**æ¢ä»¶é¡¯ç¤ºé‚è¼¯**:
```typescript
// åªåœ¨ã€Œé€²è¡Œä¸­ã€ç‹€æ…‹é¡¯ç¤ºæŒ‰éˆ•
{!opportunity.wonAt && !opportunity.lostAt && (
  <>
    <Button
      variant="default"
      className="bg-green-600 hover:bg-green-700"
      onClick={() => setShowWinDialog(true)}
    >
      <CheckCircle2 className="mr-2 h-4 w-4" />
      æ¨™è¨˜ç‚ºæˆäº¤
    </Button>
    <Button
      variant="destructive"
      onClick={() => setShowRejectDialog(true)}
    >
      <XCircle className="mr-2 h-4 w-4" />
      æ¨™è¨˜ç‚ºæ‹’çµ•
    </Button>
  </>
)}
```

---

### 2. æ©Ÿæœƒåˆ—è¡¨é  Tab åˆ‡æ›

**æª”æ¡ˆ**: `apps/web/src/routes/opportunities/index.tsx`

**æ–°å¢å…ƒä»¶**:
- Tabs å®¹å™¨
- TabsListï¼ˆä¸‰å€‹ Tabï¼‰
- TabsContentï¼ˆå°æ‡‰çš„åˆ—è¡¨å…§å®¹ï¼‰

**Tab åˆ‡æ›é‚è¼¯**:
```typescript
const [activeTab, setActiveTab] = useState<"active" | "won" | "lost">("active");

<Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as any)}>
  <TabsList>
    <TabsTrigger value="active">é€²è¡Œä¸­</TabsTrigger>
    <TabsTrigger value="won">å·²æˆäº¤</TabsTrigger>
    <TabsTrigger value="lost">å·²æ‹’çµ•</TabsTrigger>
  </TabsList>

  <TabsContent value={activeTab}>
    {/* æ©Ÿæœƒåˆ—è¡¨ */}
  </TabsContent>
</Tabs>
```

---

### 3. æ™‚é–“æ¨™ç±¤é¡¯ç¤º

**å‹•æ…‹é¡è‰²æ¨™ç±¤**:
```tsx
<Badge className={timeLabel.color}>
  {timeLabel.label} {formatDate(timeLabel.date)}
</Badge>
```

---

## ğŸ“ ä¿®æ”¹æª”æ¡ˆæ¸…å–®

| æª”æ¡ˆ | è®Šæ›´é¡å‹ | èªªæ˜ |
|------|----------|------|
| `packages/db/migrations/0008_add_won_lost_timestamps.sql` | æ–°å¢ | æ–°å¢ wonAt/lostAt æ¬„ä½ |
| `packages/db/migrations/0009_cascade_delete_todos_with_opportunity.sql` | æ–°å¢ | Cascade delete å¾…è¾¦äº‹é … |
| `packages/db/src/schema/opportunity.ts` | ä¿®æ”¹ | æ–°å¢ wonAt/lostAt æ¬„ä½å®šç¾© |
| `packages/api/src/routers/opportunity.ts` | ä¿®æ”¹ | æ–°å¢ winOpportunityã€ä¿®æ”¹ rejectOpportunity å’Œ listOpportunities |
| `apps/web/src/routes/opportunities/$id.tsx` | ä¿®æ”¹ | æ–°å¢æˆäº¤/æ‹’çµ•æŒ‰éˆ•å’Œ Dialog |
| `apps/web/src/routes/opportunities/index.tsx` | ä¿®æ”¹ | æ–°å¢ Tab åˆ‡æ›å’Œç‹€æ…‹ç¯©é¸ |

---

## ğŸš€ éƒ¨ç½²æ­¥é©Ÿ

### 1. åŸ·è¡Œè³‡æ–™åº« Migration

```bash
# Migration 0008: æ–°å¢ wonAt/lostAt æ¬„ä½
cd packages/db
bun run run-migration-0008.ts

# Migration 0009: Cascade delete å¾…è¾¦äº‹é …
bun run run-migration-0009.ts
```

### 2. éƒ¨ç½² Server å¾Œç«¯

```bash
cd apps/server
bunx wrangler deploy
```

### 3. éƒ¨ç½² Web å‰ç«¯

```bash
cd apps/web
bun run build
bunx wrangler pages deploy dist --project-name=sales-ai-web --branch=main
```

---

## ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹

### æ¸¬è©¦ 1: æ¨™è¨˜æ©Ÿæœƒç‚ºæˆäº¤

1. å°èˆªè‡³ä»»ä¸€é€²è¡Œä¸­çš„æ©Ÿæœƒè©³æƒ…é 
2. é»æ“Šã€Œæ¨™è¨˜ç‚ºæˆäº¤ã€æŒ‰éˆ•
3. ç¢ºèª Dialog é¡¯ç¤ºæ­£ç¢º
4. é»æ“Šã€Œç¢ºèªæˆäº¤ã€
5. **é æœŸçµæœ**:
   - Toast é€šçŸ¥ã€Œæ©Ÿæœƒå·²æ¨™è¨˜ç‚ºæˆäº¤ã€
   - é é¢è‡ªå‹•åˆ·æ–°
   - æˆäº¤/æ‹’çµ•æŒ‰éˆ•æ¶ˆå¤±
   - æ©Ÿæœƒå¾ã€Œé€²è¡Œä¸­ã€Tab ç§»è‡³ã€Œå·²æˆäº¤ã€Tab

### æ¸¬è©¦ 2: æ¨™è¨˜æ©Ÿæœƒç‚ºæ‹’çµ•

1. å°èˆªè‡³ä»»ä¸€é€²è¡Œä¸­çš„æ©Ÿæœƒè©³æƒ…é 
2. é»æ“Šã€Œæ¨™è¨˜ç‚ºæ‹’çµ•ã€æŒ‰éˆ•
3. ç¢ºèª Dialog é¡¯ç¤ºæ­£ç¢º
4. é»æ“Šã€Œç¢ºèªæ‹’çµ•ã€
5. **é æœŸçµæœ**:
   - Toast é€šçŸ¥ã€Œæ©Ÿæœƒå·²æ¨™è¨˜ç‚ºæ‹’çµ•ã€
   - é é¢è‡ªå‹•åˆ·æ–°
   - æˆäº¤/æ‹’çµ•æŒ‰éˆ•æ¶ˆå¤±
   - æ©Ÿæœƒå¾ã€Œé€²è¡Œä¸­ã€Tab ç§»è‡³ã€Œå·²æ‹’çµ•ã€Tab

### æ¸¬è©¦ 3: Tab åˆ‡æ›èˆ‡ç‹€æ…‹ç¯©é¸

1. å°èˆªè‡³æ©Ÿæœƒåˆ—è¡¨é 
2. é è¨­é¡¯ç¤ºã€Œé€²è¡Œä¸­ã€Tab
3. åˆ‡æ›è‡³ã€Œå·²æˆäº¤ã€Tab
4. **é æœŸçµæœ**: åªé¡¯ç¤º `wonAt IS NOT NULL` çš„æ©Ÿæœƒ
5. åˆ‡æ›è‡³ã€Œå·²æ‹’çµ•ã€Tab
6. **é æœŸçµæœ**: åªé¡¯ç¤º `lostAt IS NOT NULL` çš„æ©Ÿæœƒ
7. åˆ‡æ›å›ã€Œé€²è¡Œä¸­ã€Tab
8. **é æœŸçµæœ**: åªé¡¯ç¤º `wonAt IS NULL AND lostAt IS NULL` çš„æ©Ÿæœƒ

### æ¸¬è©¦ 4: æ™‚é–“æ¨™ç±¤é¡¯ç¤º

1. åœ¨ã€Œå·²æˆäº¤ã€Tab ä¸­æŸ¥çœ‹æ©Ÿæœƒ
2. **é æœŸçµæœ**: é¡¯ç¤ºã€Œæˆäº¤æ–¼ YYYY/MM/DDã€ç¶ è‰²æ¨™ç±¤
3. åœ¨ã€Œå·²æ‹’çµ•ã€Tab ä¸­æŸ¥çœ‹æ©Ÿæœƒ
4. **é æœŸçµæœ**: é¡¯ç¤ºã€Œæ‹’çµ•æ–¼ YYYY/MM/DDã€ç´…è‰²æ¨™ç±¤
5. åœ¨ã€Œé€²è¡Œä¸­ã€Tab ä¸­æŸ¥çœ‹æ©Ÿæœƒ
6. **é æœŸçµæœ**: é¡¯ç¤ºã€Œæ›´æ–°æ–¼ YYYY/MM/DDã€ç°è‰²æ¨™ç±¤

---

## ğŸ“ˆ ä½¿ç”¨å ´æ™¯

### å ´æ™¯ 1: æ¥­å‹™æˆäº¤å¾Œçš„è™•ç†

```
æ¥­å‹™è·Ÿå®¢æˆ¶ç°½ç´„
    â†“
æ‰“é–‹æ©Ÿæœƒè©³æƒ…é 
    â†“
é»æ“Šã€Œæ¨™è¨˜ç‚ºæˆäº¤ã€
    â†“
ç³»çµ±è¨˜éŒ„æˆäº¤æ™‚é–“
    â†“
æ©Ÿæœƒç§»è‡³ã€Œå·²æˆäº¤ã€åˆ—è¡¨
    â†“
æ¥­å‹™å¯å°ˆæ³¨è™•ç†å…¶ä»–é€²è¡Œä¸­çš„æ©Ÿæœƒ
```

### å ´æ™¯ 2: æ©Ÿæœƒæµå¤±å¾Œçš„è¨˜éŒ„

```
å®¢æˆ¶æ±ºå®šé¸æ“‡ç«¶å“
    â†“
æ‰“é–‹æ©Ÿæœƒè©³æƒ…é 
    â†“
é»æ“Šã€Œæ¨™è¨˜ç‚ºæ‹’çµ•ã€
    â†“
ç³»çµ±è¨˜éŒ„æ‹’çµ•æ™‚é–“
    â†“
æ©Ÿæœƒç§»è‡³ã€Œå·²æ‹’çµ•ã€åˆ—è¡¨
    â†“
ä¸»ç®¡å¯åˆ†ææµå¤±åŸå› 
```

### å ´æ™¯ 3: éŠ·å”®æ¼æ–—ç®¡ç†

```
ä¸»ç®¡æ‰“é–‹æ©Ÿæœƒåˆ—è¡¨é 
    â†“
é è¨­æŸ¥çœ‹ã€Œé€²è¡Œä¸­ã€æ©Ÿæœƒ
    â†“
è©•ä¼°æ¯å€‹æ©Ÿæœƒçš„ PDCM åˆ†æ•¸
    â†“
åˆ‡æ›è‡³ã€Œå·²æ‹’çµ•ã€Tab
    â†“
åˆ†ææµå¤±æ©Ÿæœƒçš„å…±åŒç‰¹å¾µ
    â†“
èª¿æ•´éŠ·å”®ç­–ç•¥
```

---

## ğŸ¯ æœªä¾†å„ªåŒ–å»ºè­°

### Phase 2A: æˆäº¤é‡‘é¡è¨˜éŒ„
- [ ] æ–°å¢ `dealAmount` æ¬„ä½è¨˜éŒ„æˆäº¤é‡‘é¡
- [ ] åœ¨æˆäº¤ Dialog ä¸­åŠ å…¥é‡‘é¡è¼¸å…¥æ¬„ä½
- [ ] åœ¨ã€Œå·²æˆäº¤ã€Tab é¡¯ç¤ºç¸½æˆäº¤é‡‘é¡çµ±è¨ˆ

### Phase 2B: æ‹’çµ•åŸå› åˆ†é¡
- [ ] æ–°å¢ `lostReason` æ¬„ä½è¨˜éŒ„æ‹’çµ•åŸå› 
- [ ] æ‹’çµ• Dialog æ–°å¢åŸå› é¸å–®ï¼ˆåƒ¹æ ¼ã€åŠŸèƒ½ã€ç«¶å“ã€æ™‚æ©Ÿç­‰ï¼‰
- [ ] ç”Ÿæˆæ‹’çµ•åŸå› åˆ†æå ±è¡¨

### Phase 2C: æˆäº¤ç‡å„€è¡¨æ¿
- [ ] è¨ˆç®—æ¯å€‹æ¥­å‹™çš„æˆäº¤ç‡
- [ ] é¡¯ç¤ºæœ¬æœˆ/æœ¬å­£æˆäº¤è¶¨å‹¢åœ–
- [ ] æ¯”è¼ƒä¸åŒæ¥­å‹™çš„æˆäº¤ç‡

### Phase 2D: è‡ªå‹•åŒ–æé†’
- [ ] é•·æ™‚é–“æœªæ›´æ–°çš„é€²è¡Œä¸­æ©Ÿæœƒè‡ªå‹•æé†’è·Ÿé€²
- [ ] æˆäº¤æ©Ÿæœƒè‡ªå‹•è§¸ç™¼å¾ŒçºŒæµç¨‹ï¼ˆå¦‚åˆç´„ç°½ç½²ã€äº¤ä»˜å®‰æ’ï¼‰

---

## ç›¸é—œæ–‡ä»¶

- [æ©Ÿæœƒé é¢åŠŸèƒ½å‡ç´š](.doc/20260128_æ©Ÿæœƒé é¢åŠŸèƒ½å‡ç´š.md)
- [Bug ä¿®å¾©å ±å‘Š](.doc/20260128_Bugä¿®å¾©å ±å‘Š.md)

---

**ç‹€æ…‹**: âœ… åŠŸèƒ½å·²å®Œæˆä¸¦éƒ¨ç½²
**å¯¦ä½œæ™‚é–“**: ç´„ 3 å°æ™‚
**ç¨‹å¼ç¢¼è¡Œæ•¸**: 835+ è¡Œï¼ˆå‰ç«¯ + å¾Œç«¯ + Migrationï¼‰
