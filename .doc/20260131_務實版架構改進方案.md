# å‹™å¯¦ç‰ˆæ¶æ§‹æ”¹é€²æ–¹æ¡ˆ

> **å»ºç«‹æ—¥æœŸ**ï¼š2026-01-31
> **é¡å‹**ï¼šæ¶æ§‹è¨­è¨ˆ
> **ç‹€æ…‹**ï¼šææ¡ˆä¸­
> **å–ä»£æ–‡ä»¶**ï¼š20260129_æ¨¡çµ„åŒ–æ¶æ§‹é‡æ§‹è¦åŠƒ.md

---

## ä¸€ã€èƒŒæ™¯èˆ‡å‹•æ©Ÿ

### 1.1 ç¾æœ‰æ¶æ§‹åˆ†æ

ç¶“éæ·±å…¥åˆ†æï¼ŒSales AI Automation V3 å°ˆæ¡ˆå…·æœ‰ä»¥ä¸‹ç‰¹é»ï¼š

**âœ… åšå¾—å¥½çš„éƒ¨åˆ†**
- DAG Executor å¯¦ç¾ Agent ä¸¦è¡ŒåŒ–ï¼ˆæ¸›å°‘ 42% åŸ·è¡Œæ™‚é–“ï¼‰
- MCP å·¥å…·æ¡†æ¶ï¼ˆ70+ é‹ç¶­å·¥å…·ï¼‰
- ORPC è·¯ç”±æ¡†æ¶ï¼ˆå‹åˆ¥å®‰å…¨ï¼‰
- Cloudflare Workers é›²åŸç”Ÿè¨­è¨ˆ
- Drizzle ORM å‹åˆ¥æ¨æ–·

**âš ï¸ éœ€è¦æ”¹é€²çš„éƒ¨åˆ†**
- Router å±¤ç›´æ¥æ“ä½œ DBï¼ˆæŸ¥è©¢é‚è¼¯ç„¡æ³•é‡ç”¨ï¼‰
- æ—¥èªŒä½¿ç”¨ `console.log` ç¡¬ç·¨ç¢¼ï¼ˆç„¡çµæ§‹åŒ–ã€é›£ä»¥æœå°‹ï¼‰
- ç¼ºä¹æ¥­å‹™é‚è¼¯å±¤ï¼ˆè¤‡é›œé‚è¼¯æ•£è½åœ¨ Router ä¸­ï¼‰
- æ¸¬è©¦å›°é›£ï¼ˆç„¡æ³• mock DB æ“ä½œï¼‰

### 1.2 è¨­è¨ˆåŸå‰‡

1. **ä¸è¦ç‚ºäº†æ¶æ§‹è€Œæ¶æ§‹** - é€™æ˜¯ä¸­å‹å°ˆæ¡ˆï¼Œä¸éœ€è¦å®Œæ•´ DDD
2. **ä¿ç•™å·²ç¶“åšå¾—å¥½çš„éƒ¨åˆ†** - DAG Executorã€MCP æ¡†æ¶ã€ORPC
3. **åªè§£æ±ºçœŸæ­£çš„ç—›é»** - è·¯ç”±å±¤å¤ªèƒ–ã€æ—¥èªŒå¤ªå¼±ã€æ¸¬è©¦å›°é›£
4. **Cloudflare Workers å‹å¥½** - é¿å…é‡ä¾è³´ã€ä¿æŒè¼•é‡
5. **æ¼¸é€²å¼é·ç§»** - ä¸å½±éŸ¿ç¾æœ‰åŠŸèƒ½ï¼Œæ–°èˆŠä¸¦å­˜

---

## äºŒã€ç›®æ¨™æ¶æ§‹

### 2.1 åˆ†å±¤è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Router Layer                          â”‚
â”‚                   packages/api/routers/                      â”‚
â”‚                                                              â”‚
â”‚  è·è²¬ï¼šè¼¸å…¥é©—è­‰ã€æˆæ¬Šæª¢æŸ¥ã€å‘¼å« Service/Queries              â”‚
â”‚  è¦ç¯„ï¼šâŒ ä¸ç›´æ¥æ“ä½œ DB                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        Service Layer                         â”‚
â”‚                packages/services/src/domain/                 â”‚
â”‚                                                              â”‚
â”‚  è·è²¬ï¼šæ¥­å‹™é‚è¼¯ã€è·¨æ¨¡çµ„å”èª¿ã€å¿«å–ç®¡ç†ã€å‰¯ä½œç”¨è™•ç†            â”‚
â”‚  è¦ç¯„ï¼šåªåœ¨éœ€è¦æ™‚å»ºç«‹ï¼Œä¸å¼·åˆ¶æ¯å€‹æ¨¡çµ„éƒ½æœ‰                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        Query Layer                           â”‚
â”‚               packages/services/src/queries/                 â”‚
â”‚                                                              â”‚
â”‚  è·è²¬ï¼šå°è£ DB æŸ¥è©¢ã€å¯é‡ç”¨ã€å¯æ¸¬è©¦                          â”‚
â”‚  è¦ç¯„ï¼šç›´æ¥ä½¿ç”¨ Drizzleï¼Œä¸é¡å¤–åŒ…è£ Repository               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       Database Layer                         â”‚
â”‚                       packages/db/                           â”‚
â”‚                                                              â”‚
â”‚  è·è²¬ï¼šSchema å®šç¾©ã€é€£ç·šç®¡ç†ã€Migration                      â”‚
â”‚  è¦ç¯„ï¼šä¿æŒç¾æœ‰çµæ§‹ä¸è®Š                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç‚ºä»€éº¼ä¸è¦ Repository å±¤ï¼Ÿ

| æ–¹æ¡ˆ | å±¤æ•¸ | è©•ä¼° |
|------|------|------|
| åŸè¦åŠƒ | Router â†’ Service â†’ Repository â†’ Drizzle â†’ DB | éåº¦æŠ½è±¡ï¼ŒRepository åªæ˜¯è½‰ç™¼ |
| **æœ¬æ–¹æ¡ˆ** | Router â†’ Service/Queries â†’ Drizzle â†’ DB | âœ… ç²¾ç°¡ï¼ŒDrizzle æœ¬èº«å°±æ˜¯å¥½çš„æŠ½è±¡ |

**ç†ç”±**ï¼š
- Drizzle ORM å·²æä¾›å®Œæ•´çš„å‹åˆ¥æ¨æ–·å’ŒæŸ¥è©¢å»ºæ§‹å™¨
- å°ˆæ¡ˆä¸æœƒæ›´æ›è³‡æ–™åº«ï¼ˆNeon + Drizzle å¾ˆç©©å®šï¼‰
- æ¸›å°‘ä¸€å±¤ = æ¸›å°‘ boilerplateã€æ¸›å°‘ç¶­è­·æˆæœ¬
- Repository Pattern é©åˆéœ€è¦åˆ‡æ› ORM æˆ–è³‡æ–™åº«çš„å ´æ™¯

### 2.3 ç‚ºä»€éº¼ä¸è¦ DI Containerï¼Ÿ

| æ–¹æ¡ˆ | è©•ä¼° |
|------|------|
| åŸè¦åŠƒï¼šContainer + ServiceKeys | Workers ç’°å¢ƒ Singleton è¡Œç‚ºä¸å¯é ï¼Œå¢åŠ è¤‡é›œåº¦ |
| **æœ¬æ–¹æ¡ˆ**ï¼šæ‰‹å‹•å‚³é deps | âœ… ç°¡å–®ç›´æ¥ï¼Œå®¹æ˜“ç†è§£å’Œæ¸¬è©¦ |

**Cloudflare Workers ç‰¹æ€§**ï¼š
- æ¯å€‹è«‹æ±‚å¯èƒ½åœ¨ä¸åŒ isolate åŸ·è¡Œ
- Singleton cache åªåœ¨åŒä¸€ isolate çš„ warm start æœ‰æ•ˆ
- æ‰‹å‹•å‚³é deps æ›´æ˜ç¢ºã€æ›´å¯æ§

---

## ä¸‰ã€Query Layer è¨­è¨ˆ

### 3.1 ç›®éŒ„çµæ§‹

```
packages/services/src/queries/
â”œâ”€â”€ opportunity.queries.ts    # å•†æ©Ÿç›¸é—œæŸ¥è©¢
â”œâ”€â”€ conversation.queries.ts   # å°è©±ç›¸é—œæŸ¥è©¢
â”œâ”€â”€ meddic.queries.ts         # MEDDIC åˆ†ææŸ¥è©¢
â”œâ”€â”€ alert.queries.ts          # è­¦ç¤ºç›¸é—œæŸ¥è©¢
â”œâ”€â”€ sales-todo.queries.ts     # å¾…è¾¦äº‹é …æŸ¥è©¢
â””â”€â”€ index.ts                  # çµ±ä¸€åŒ¯å‡º
```

### 3.2 å¯¦ä½œç¯„ä¾‹

```typescript
// packages/services/src/queries/opportunity.queries.ts
import { db } from "@sales_ai_automation_v3/db";
import { opportunities, conversations } from "@sales_ai_automation_v3/db/schema";
import { eq, and, gte, desc, inArray } from "drizzle-orm";

/**
 * æ ¹æ“š ID æŸ¥è©¢å–®ä¸€å•†æ©Ÿ
 */
export async function findById(id: string) {
  const [result] = await db
    .select()
    .from(opportunities)
    .where(eq(opportunities.id, id))
    .limit(1);
  return result ?? null;
}

/**
 * æŸ¥è©¢ç”¨æˆ¶çš„æ‰€æœ‰å•†æ©Ÿ
 */
export async function findByUserId(userId: string) {
  return db
    .select()
    .from(opportunities)
    .where(eq(opportunities.userId, userId))
    .orderBy(desc(opportunities.updatedAt));
}

/**
 * æŸ¥è©¢ç”¨æˆ¶çš„å•†æ©Ÿï¼ˆå«é—œè¯å°è©±ï¼‰
 */
export async function findByUserIdWithConversations(
  userId: string,
  options: { limit?: number } = {}
) {
  const { limit = 50 } = options;

  return db.query.opportunities.findMany({
    where: eq(opportunities.userId, userId),
    with: {
      conversations: {
        orderBy: desc(conversations.createdAt),
      },
    },
    orderBy: desc(opportunities.updatedAt),
    limit,
  });
}

/**
 * æŸ¥è©¢æœ€è¿‘ N å¤©æœ‰æ´»å‹•çš„å•†æ©Ÿ
 */
export async function findRecentlyActive(
  userId: string,
  options: { days?: number; limit?: number } = {}
) {
  const { days = 30, limit = 50 } = options;
  const since = new Date(Date.now() - days * 24 * 60 * 60 * 1000);

  return db.query.opportunities.findMany({
    where: and(
      eq(opportunities.userId, userId),
      gte(opportunities.updatedAt, since)
    ),
    orderBy: desc(opportunities.updatedAt),
    limit,
  });
}

/**
 * æ‰¹æ¬¡æŸ¥è©¢å¤šå€‹å•†æ©Ÿ
 */
export async function findByIds(ids: string[]) {
  if (ids.length === 0) return [];

  return db
    .select()
    .from(opportunities)
    .where(inArray(opportunities.id, ids));
}

/**
 * å»ºç«‹å•†æ©Ÿ
 */
export async function create(data: {
  userId: string;
  customerNumber: string;
  companyName: string;
  productLine?: string;
}) {
  const [result] = await db
    .insert(opportunities)
    .values({
      id: crypto.randomUUID(),
      ...data,
      createdAt: new Date(),
      updatedAt: new Date(),
    })
    .returning();
  return result;
}

/**
 * æ›´æ–°å•†æ©Ÿ
 */
export async function update(
  id: string,
  data: Partial<{
    companyName: string;
    stage: string;
    notes: string;
  }>
) {
  const [result] = await db
    .update(opportunities)
    .set({
      ...data,
      updatedAt: new Date(),
    })
    .where(eq(opportunities.id, id))
    .returning();
  return result;
}
```

### 3.3 åœ¨ Router ä¸­ä½¿ç”¨

```typescript
// packages/api/src/routers/opportunity.ts
import * as opportunityQueries from "@sales_ai_automation_v3/services/queries/opportunity.queries";

export const getOpportunity = protectedProcedure
  .input(z.object({ id: z.string() }))
  .handler(async ({ input, context }) => {
    const userId = context.session?.user?.id;
    if (!userId) throw new ORPCError("UNAUTHORIZED");

    // âœ… ä½¿ç”¨ Query å‡½æ•¸ï¼Œè€Œéç›´æ¥å¯« SQL
    const opportunity = await opportunityQueries.findById(input.id);

    if (!opportunity) {
      throw new ORPCError("NOT_FOUND");
    }

    if (opportunity.userId !== userId) {
      throw new ORPCError("FORBIDDEN");
    }

    return opportunity;
  });

export const listOpportunities = protectedProcedure
  .input(z.object({ limit: z.number().optional() }))
  .handler(async ({ input, context }) => {
    const userId = context.session?.user?.id;
    if (!userId) throw new ORPCError("UNAUTHORIZED");

    // âœ… è¤‡é›œæŸ¥è©¢ä¹Ÿå°è£åœ¨ Query å‡½æ•¸ä¸­
    return opportunityQueries.findByUserIdWithConversations(userId, {
      limit: input.limit,
    });
  });
```

### 3.4 Query å‡½æ•¸å‘½åè¦ç¯„

| å‰ç¶´ | ç”¨é€” | ç¯„ä¾‹ |
|------|------|------|
| `findById` | æŸ¥è©¢å–®ç­† | `findById(id)` |
| `findBy*` | æ¢ä»¶æŸ¥è©¢ | `findByUserId(userId)` |
| `findAll` | æŸ¥è©¢å…¨éƒ¨ | `findAll()` |
| `find*With*` | å«é—œè¯æŸ¥è©¢ | `findByIdWithConversations(id)` |
| `create` | å»ºç«‹ | `create(data)` |
| `update` | æ›´æ–° | `update(id, data)` |
| `delete` | åˆªé™¤ | `deleteById(id)` |
| `count*` | è¨ˆæ•¸ | `countByUserId(userId)` |
| `exists*` | å­˜åœ¨æª¢æŸ¥ | `existsById(id)` |

---

## å››ã€Service Layer è¨­è¨ˆ

### 4.1 ä½•æ™‚éœ€è¦ Serviceï¼Ÿ

| æƒ…å¢ƒ | éœ€è¦ Service | èªªæ˜ |
|------|-------------|------|
| å–®ç´” CRUD | âŒ | Router ç›´æ¥ç”¨ Queries |
| éœ€è¦å¿«å–é‚è¼¯ | âœ… | å¿«å–è®€å¯«ã€å¤±æ•ˆç­–ç•¥ |
| è·¨æ¨¡çµ„å”èª¿ | âœ… | conversation + opportunity + meddic |
| è¤‡é›œæ¥­å‹™è¦å‰‡ | âœ… | ç‹€æ…‹æ©Ÿã€é©—è­‰é‚è¼¯ |
| éœ€è¦ç™¼é€šçŸ¥/å‰¯ä½œç”¨ | âœ… | Slack é€šçŸ¥ã€äº‹ä»¶ç™¼é€ |

### 4.2 ç›®éŒ„çµæ§‹

```
packages/services/src/domain/
â”œâ”€â”€ conversation/
â”‚   â”œâ”€â”€ conversation.service.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ report/
â”‚   â”œâ”€â”€ report.service.ts
â”‚   â””â”€â”€ index.ts
â””â”€â”€ index.ts
```

### 4.3 Service å¯¦ä½œç¯„ä¾‹

```typescript
// packages/services/src/domain/conversation/conversation.service.ts
import * as conversationQueries from "../../queries/conversation.queries";
import * as opportunityQueries from "../../queries/opportunity.queries";
import * as meddicQueries from "../../queries/meddic.queries";
import type { KVNamespace } from "@cloudflare/workers-types";
import type { Logger } from "../../../shared/logger";
import { errors } from "@sales_ai_automation_v3/shared/errors";

export interface ConversationServiceDeps {
  cache: KVNamespace;
  logger: Logger;
}

export function createConversationService(deps: ConversationServiceDeps) {
  const { cache, logger } = deps;

  return {
    /**
     * å–å¾—å°è©±è©³æƒ…ï¼ˆå«å¿«å–ï¼‰
     */
    async getDetail(conversationId: string, userId: string) {
      const cacheKey = `conversation:${conversationId}`;

      // 1. å˜—è©¦å¾å¿«å–å–å¾—
      const cached = await cache.get(cacheKey, "json");
      if (cached) {
        logger.debug("Cache hit", { cacheKey });
        return cached;
      }

      // 2. æŸ¥è©¢è³‡æ–™åº«
      const conversation = await conversationQueries.findById(conversationId);
      if (!conversation) {
        return null;
      }

      // 3. æ¬Šé™æª¢æŸ¥ï¼ˆè·¨æ¨¡çµ„ï¼‰
      const opportunity = await opportunityQueries.findById(
        conversation.opportunityId
      );
      if (opportunity?.userId !== userId) {
        throw errors.FORBIDDEN("ç„¡æ¬Šé™å­˜å–æ­¤å°è©±");
      }

      // 4. å–å¾— MEDDIC åˆ†æï¼ˆè·¨æ¨¡çµ„ï¼‰
      const analysis = await meddicQueries.findLatestByConversationId(
        conversationId
      );

      const result = {
        ...conversation,
        opportunity,
        analysis,
      };

      // 5. å¯«å…¥å¿«å–
      await cache.put(cacheKey, JSON.stringify(result), {
        expirationTtl: 300, // 5 åˆ†é˜
      });

      logger.info("Conversation detail fetched", { conversationId });
      return result;
    },

    /**
     * å¤±æ•ˆå°è©±ç›¸é—œå¿«å–
     */
    async invalidateCache(conversationId: string, userId: string) {
      const keysToDelete = [
        `conversation:${conversationId}`,
        `conversations:${userId}`,
        `report:rep:${userId}`,
      ];

      await Promise.all(keysToDelete.map((key) => cache.delete(key)));

      logger.info("Cache invalidated", { keys: keysToDelete });
    },

    /**
     * å–å¾—ç”¨æˆ¶å°è©±åˆ—è¡¨ï¼ˆå«å¿«å–ï¼‰
     */
    async listByUser(userId: string, options: { limit?: number } = {}) {
      const cacheKey = `conversations:${userId}`;

      const cached = await cache.get(cacheKey, "json");
      if (cached) {
        logger.debug("Cache hit", { cacheKey });
        return cached;
      }

      const conversations = await conversationQueries.findByUserId(userId, {
        limit: options.limit,
      });

      await cache.put(cacheKey, JSON.stringify(conversations), {
        expirationTtl: 300,
      });

      return conversations;
    },
  };
}

export type ConversationService = ReturnType<typeof createConversationService>;
```

### 4.4 åœ¨ Router ä¸­ä½¿ç”¨ Service

```typescript
// packages/api/src/routers/conversation.ts
import { createConversationService } from "@sales_ai_automation_v3/services/domain/conversation";
import { createLogger } from "@sales_ai_automation_v3/shared/logger";

export const getConversationDetail = protectedProcedure
  .input(z.object({ id: z.string() }))
  .handler(async ({ input, context }) => {
    const userId = context.session?.user?.id;
    if (!userId) throw new ORPCError("UNAUTHORIZED");

    // å»ºç«‹ Serviceï¼ˆå‚³å…¥ä¾è³´ï¼‰
    const conversationService = createConversationService({
      cache: context.env.CACHE_KV,
      logger: createLogger({ service: "api", requestId: context.requestId }),
    });

    const result = await conversationService.getDetail(input.id, userId);
    if (!result) {
      throw new ORPCError("NOT_FOUND");
    }

    return result;
  });
```

---

## äº”ã€Logger è¨­è¨ˆ

### 5.1 è¨­è¨ˆåŸå‰‡

- çµæ§‹åŒ– JSON è¼¸å‡ºï¼ˆæ–¹ä¾¿ Cloudflare Dashboard æœå°‹ï¼‰
- è¼•é‡å¯¦ä½œï¼ˆä¸ä¾è³´ Winston/Pinoï¼‰
- æ”¯æ´ child loggerï¼ˆå‚³é contextï¼‰
- é©é… Cloudflare Workers ç’°å¢ƒ

### 5.2 å¯¦ä½œ

```typescript
// packages/shared/src/logger/index.ts
export type LogLevel = "debug" | "info" | "warn" | "error";

export interface LogContext {
  service?: string;
  requestId?: string;
  userId?: string;
  conversationId?: string;
  opportunityId?: string;
  [key: string]: unknown;
}

export interface Logger {
  debug(message: string, data?: Record<string, unknown>): void;
  info(message: string, data?: Record<string, unknown>): void;
  warn(message: string, data?: Record<string, unknown>): void;
  error(message: string, data?: Record<string, unknown>): void;
  child(context: LogContext): Logger;
}

export function createLogger(baseContext: LogContext = {}): Logger {
  const log = (
    level: LogLevel,
    message: string,
    data?: Record<string, unknown>
  ) => {
    const entry = {
      level,
      timestamp: new Date().toISOString(),
      message,
      ...baseContext,
      ...data,
    };

    // çµæ§‹åŒ– JSON è¼¸å‡º
    // Cloudflare Workers æœƒè‡ªå‹•æ”¶é›† console è¼¸å‡º
    const output = JSON.stringify(entry);

    switch (level) {
      case "debug":
        console.debug(output);
        break;
      case "info":
        console.info(output);
        break;
      case "warn":
        console.warn(output);
        break;
      case "error":
        console.error(output);
        break;
    }
  };

  return {
    debug: (msg, data) => log("debug", msg, data),
    info: (msg, data) => log("info", msg, data),
    warn: (msg, data) => log("warn", msg, data),
    error: (msg, data) => log("error", msg, data),
    child: (ctx) => createLogger({ ...baseContext, ...ctx }),
  };
}
```

### 5.3 ä½¿ç”¨ç¯„ä¾‹

```typescript
// apps/queue-worker/src/index.ts
import { createLogger } from "@sales_ai_automation_v3/shared/logger";

export default {
  async queue(batch, env) {
    const logger = createLogger({ service: "queue-worker" });

    for (const message of batch.messages) {
      const { conversationId } = message.body;
      const msgLogger = logger.child({ conversationId });

      msgLogger.info("Processing started");

      try {
        // ... è™•ç†é‚è¼¯
        msgLogger.info("Transcription completed", { duration: 1234 });
      } catch (error) {
        msgLogger.error("Processing failed", {
          error: error instanceof Error ? error.message : String(error),
          stack: error instanceof Error ? error.stack : undefined,
        });
      }
    }
  },
};
```

### 5.4 æ—¥èªŒè¼¸å‡ºç¯„ä¾‹

```json
{
  "level": "info",
  "timestamp": "2026-01-31T10:30:00.000Z",
  "service": "queue-worker",
  "conversationId": "conv-123",
  "message": "Transcription completed",
  "duration": 1234
}

{
  "level": "error",
  "timestamp": "2026-01-31T10:30:05.000Z",
  "service": "queue-worker",
  "conversationId": "conv-456",
  "message": "Processing failed",
  "error": "Groq API rate limited",
  "stack": "Error: Groq API rate limited\n    at ..."
}
```

---

## å…­ã€éŒ¯èª¤è™•ç†å¢å¼·

### 6.1 æ–°å¢éŒ¯èª¤ç¢¼

```typescript
// packages/shared/src/errors/index.tsï¼ˆå¢å¼·ï¼‰

export type ErrorCode =
  // èªè­‰æˆæ¬Š
  | "UNAUTHORIZED"
  | "FORBIDDEN"
  // è³‡æº
  | "NOT_FOUND"
  | "CONFLICT"
  // é©—è­‰
  | "VALIDATION_ERROR"
  // å¤–éƒ¨æœå‹™
  | "EXTERNAL_SERVICE_ERROR"
  | "RATE_LIMITED"
  // ç¾æœ‰çš„
  | "AUDIO_TOO_LARGE"
  | "INVALID_AUDIO_FORMAT"
  | "FILE_DOWNLOAD_FAILED"
  | "TRANSCRIPTION_FAILED"
  | "TRANSCRIPTION_TIMEOUT"
  | "GROQ_API_ERROR"
  | "GEMINI_API_ERROR"
  | "DATABASE_ERROR"
  | "RECORD_NOT_FOUND"
  | "OPPORTUNITY_NOT_FOUND"
  | "UNKNOWN_ERROR";
```

### 6.2 æ–°å¢éŒ¯èª¤å·¥å» 

```typescript
// packages/shared/src/errors/index.tsï¼ˆå¢å¼·ï¼‰

export const errors = {
  // === ç¾æœ‰çš„ ===
  AUDIO_TOO_LARGE: (size: number, maxSize: number) =>
    new AppError(
      "AUDIO_TOO_LARGE",
      `éŸ³æª”å¤§å° ${size} è¶…éé™åˆ¶ ${maxSize}`,
      400
    ),

  // ... å…¶ä»–ç¾æœ‰çš„ ...

  // === æ–°å¢ ===

  /**
   * é©—è­‰éŒ¯èª¤
   */
  VALIDATION_ERROR: (field: string, reason: string) =>
    new AppError("VALIDATION_ERROR", `${field}: ${reason}`, 400, undefined, {
      field,
      reason,
    }),

  /**
   * è³‡æºè¡çª
   */
  CONFLICT: (resource: string, reason?: string) =>
    new AppError(
      "CONFLICT",
      reason ? `${resource}: ${reason}` : `${resource} å·²å­˜åœ¨`,
      409
    ),

  /**
   * è«‹æ±‚éæ–¼é »ç¹
   */
  RATE_LIMITED: (service: string, retryAfterSeconds?: number) =>
    new AppError(
      "RATE_LIMITED",
      `${service} è«‹æ±‚éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦`,
      429,
      undefined,
      { service, retryAfter: retryAfterSeconds }
    ),

  /**
   * å¤–éƒ¨æœå‹™éŒ¯èª¤
   */
  EXTERNAL_SERVICE: (service: string, originalError?: Error) =>
    new AppError(
      "EXTERNAL_SERVICE_ERROR",
      `å¤–éƒ¨æœå‹™ ${service} ç™¼ç”ŸéŒ¯èª¤`,
      502,
      originalError,
      { service }
    ),

  /**
   * æ¬Šé™ä¸è¶³
   */
  FORBIDDEN: (reason?: string) =>
    new AppError("FORBIDDEN", reason ?? "æ¬Šé™ä¸è¶³", 403),

  /**
   * æœªèªè­‰
   */
  UNAUTHORIZED: (reason?: string) =>
    new AppError("UNAUTHORIZED", reason ?? "è«‹å…ˆç™»å…¥", 401),

  /**
   * è³‡æºä¸å­˜åœ¨
   */
  NOT_FOUND: (resource: string, id?: string) =>
    new AppError(
      "NOT_FOUND",
      id ? `${resource} (${id}) ä¸å­˜åœ¨` : `${resource} ä¸å­˜åœ¨`,
      404
    ),
} as const;
```

### 6.3 ä½¿ç”¨ç¯„ä¾‹

```typescript
import { errors } from "@sales_ai_automation_v3/shared/errors";

// é©—è­‰éŒ¯èª¤
if (!isValidEmail(input.email)) {
  throw errors.VALIDATION_ERROR("email", "æ ¼å¼ä¸æ­£ç¢º");
}

// è³‡æºè¡çª
const existing = await opportunityQueries.findByCustomerNumber(customerNumber);
if (existing) {
  throw errors.CONFLICT("å•†æ©Ÿ", "æ­¤å®¢æˆ¶ç·¨è™Ÿå·²å­˜åœ¨");
}

// å¤–éƒ¨æœå‹™éŒ¯èª¤
try {
  await geminiClient.generate(prompt);
} catch (error) {
  throw errors.EXTERNAL_SERVICE("Gemini", error as Error);
}

// é »ç‡é™åˆ¶
if (isRateLimited) {
  throw errors.RATE_LIMITED("Groq Whisper", 60);
}
```

---

## ä¸ƒã€é·ç§»ç­–ç•¥

### 7.1 Phase 1ï¼šQuery Layerï¼ˆé ä¼° 1 é€±ï¼‰

**ç›®æ¨™**ï¼šå»ºç«‹ Query å‡½æ•¸ï¼Œå¾æœ€å¸¸ç”¨çš„æ¨¡çµ„é–‹å§‹

**æ­¥é©Ÿ**ï¼š
1. å»ºç«‹ `packages/services/src/queries/` ç›®éŒ„
2. å¯¦ä½œæ ¸å¿ƒæ¨¡çµ„çš„ Query å‡½æ•¸ï¼š
   - `opportunity.queries.ts`
   - `conversation.queries.ts`
   - `meddic.queries.ts`
3. é€æ­¥å¾ Router ä¸­æŠ½å‡º DB æ“ä½œ
4. æ–°åŠŸèƒ½ä¸€å¾‹ä½¿ç”¨ Query å‡½æ•¸

**é©—æ”¶æ¨™æº–**ï¼š
- [ ] 3 å€‹æ ¸å¿ƒ Query æª”æ¡ˆå·²å»ºç«‹
- [ ] è‡³å°‘ 1 å€‹ Router å·²æ”¹ç”¨ Query å‡½æ•¸
- [ ] Query å‡½æ•¸æœ‰å°æ‡‰çš„å‹åˆ¥å®šç¾©

### 7.2 Phase 2ï¼šLogger + éŒ¯èª¤è™•ç†ï¼ˆé ä¼° 3 å¤©ï¼‰

**ç›®æ¨™**ï¼šçµ±ä¸€æ—¥èªŒæ ¼å¼ï¼Œå¢å¼·éŒ¯èª¤è™•ç†

**æ­¥é©Ÿ**ï¼š
1. å»ºç«‹ `packages/shared/src/logger/`
2. åœ¨ `queue-worker` å…ˆè©¦ç”¨ï¼ˆæœ€éœ€è¦å¥½çš„æ—¥èªŒï¼‰
3. è£œå…… `errors` å·¥å» å‡½æ•¸
4. é€æ­¥æ›¿æ› `console.log` ç‚º `logger`

**é©—æ”¶æ¨™æº–**ï¼š
- [ ] Logger æ¨¡çµ„å·²å»ºç«‹
- [ ] queue-worker ä½¿ç”¨çµæ§‹åŒ–æ—¥èªŒ
- [ ] æ–°å¢çš„éŒ¯èª¤å·¥å» å‡½æ•¸å·²å¯¦ä½œ

### 7.3 Phase 3ï¼šService Layerï¼ˆæŒ‰éœ€é€²è¡Œï¼‰

**ç›®æ¨™**ï¼šåªåœ¨éœ€è¦æ™‚å»ºç«‹ Service

**è§¸ç™¼æ¢ä»¶**ï¼š
- æ–°åŠŸèƒ½éœ€è¦è·¨æ¨¡çµ„å”èª¿
- ç¾æœ‰ Router å¤ªè¤‡é›œéœ€è¦æ‹†åˆ†
- éœ€è¦åŠ å…¥å¿«å–é‚è¼¯

**ä¸è¦åš**ï¼š
- ä¸è¦ä¸€æ¬¡å»ºç«‹æ‰€æœ‰ Service
- ä¸è¦ç‚ºäº†æ¶æ§‹è€Œå»ºç«‹ Service
- ä¸è¦æŠŠç°¡å–® CRUD ä¹ŸåŒ…æˆ Service

---

## å…«ã€æœ€çµ‚ç›®éŒ„çµæ§‹

```
packages/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ queries/                 # âœ¨ æ–°å¢ï¼šQuery å‡½æ•¸
â”‚       â”‚   â”œâ”€â”€ opportunity.queries.ts
â”‚       â”‚   â”œâ”€â”€ conversation.queries.ts
â”‚       â”‚   â”œâ”€â”€ meddic.queries.ts
â”‚       â”‚   â”œâ”€â”€ alert.queries.ts
â”‚       â”‚   â””â”€â”€ index.ts
â”‚       â”‚
â”‚       â”œâ”€â”€ domain/                  # âœ¨ æ–°å¢ï¼šæ¥­å‹™ Serviceï¼ˆæŒ‰éœ€ï¼‰
â”‚       â”‚   â”œâ”€â”€ conversation/
â”‚       â”‚   â”‚   â”œâ”€â”€ conversation.service.ts
â”‚       â”‚   â”‚   â””â”€â”€ index.ts
â”‚       â”‚   â””â”€â”€ report/
â”‚       â”‚       â”œâ”€â”€ report.service.ts
â”‚       â”‚       â””â”€â”€ index.ts
â”‚       â”‚
â”‚       â”œâ”€â”€ llm/                     # ç¾æœ‰ï¼šä¿æŒä¸è®Š
â”‚       â”œâ”€â”€ transcription/           # ç¾æœ‰ï¼šä¿æŒä¸è®Š
â”‚       â”œâ”€â”€ storage/                 # ç¾æœ‰ï¼šä¿æŒä¸è®Š
â”‚       â”œâ”€â”€ mcp/                     # ç¾æœ‰ï¼šä¿æŒä¸è®Š
â”‚       â”œâ”€â”€ ops/                     # ç¾æœ‰ï¼šä¿æŒä¸è®Š
â”‚       â””â”€â”€ notifications/           # ç¾æœ‰ï¼šä¿æŒä¸è®Š
â”‚
â”œâ”€â”€ shared/
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ errors/                  # ç¾æœ‰ï¼šå¢å¼·
â”‚       â”‚   â””â”€â”€ index.ts
â”‚       â””â”€â”€ logger/                  # âœ¨ æ–°å¢ï¼šçµæ§‹åŒ–æ—¥èªŒ
â”‚           â””â”€â”€ index.ts
â”‚
â”œâ”€â”€ api/                             # ç¾æœ‰ï¼šRouter æ”¹ç”¨ Queries
â”œâ”€â”€ db/                              # ç¾æœ‰ï¼šä¿æŒä¸è®Š
â”œâ”€â”€ auth/                            # ç¾æœ‰ï¼šä¿æŒä¸è®Š
â””â”€â”€ env/                             # ç¾æœ‰ï¼šä¿æŒä¸è®Š
```

---

## ä¹ã€èˆ‡åŸè¦åŠƒæ¯”è¼ƒ

| é …ç›® | åŸè¦åŠƒ | æœ¬æ–¹æ¡ˆ |
|------|-------|--------|
| **åˆ†å±¤æ•¸é‡** | 4 å±¤ï¼ˆRouter â†’ Service â†’ Repository â†’ DBï¼‰ | 3 å±¤ï¼ˆRouter â†’ Service/Queries â†’ DBï¼‰ |
| **DI æ–¹å¼** | Container + ServiceKeys | æ‰‹å‹•å‚³é deps |
| **Repository å±¤** | âœ… æœ‰ | âŒ ä¸éœ€è¦ |
| **Result<T, E> å‹åˆ¥** | âœ… æœ‰ | âŒ ä¸éœ€è¦ï¼Œçµ±ä¸€ç”¨ throw |
| **è¤‡é›œåº¦** | é«˜ï¼ˆå®Œæ•´ DDDï¼‰ | ä¸­ï¼ˆå‹™å¯¦ç‰ˆï¼‰ |
| **é·ç§»æˆæœ¬** | 4+ é€± | 1-2 é€± |
| **é©åˆåº¦** | å¤§å‹ä¼æ¥­å°ˆæ¡ˆ | âœ… ä¸­å‹ Cloudflare Workers å°ˆæ¡ˆ |

---

## åã€æ±ºç­–è¨˜éŒ„

### 10.1 ç‚ºä»€éº¼é¸æ“‡ Query å‡½æ•¸è€Œé Repository Patternï¼Ÿ

**æ±ºç­–**ï¼šä½¿ç”¨ Query å‡½æ•¸ï¼ˆç´”å‡½æ•¸ï¼‰è€Œé Repository é¡åˆ¥

**åŸå› **ï¼š
1. Drizzle ORM æœ¬èº«å·²ç¶“æ˜¯å¾ˆå¥½çš„æŠ½è±¡ï¼Œä¸éœ€è¦å†åŒ…ä¸€å±¤
2. ç´”å‡½æ•¸æ›´å®¹æ˜“æ¸¬è©¦å’Œçµ„åˆ
3. æ¸›å°‘ boilerplate ç¨‹å¼ç¢¼
4. ç¬¦åˆå‡½æ•¸å¼ç¨‹å¼è¨­è¨ˆé¢¨æ ¼

**æ¬Šè¡¡**ï¼š
- çŠ§ç‰²äº† Repository Pattern çš„ä¸€äº›éˆæ´»æ€§ï¼ˆå¦‚åˆ‡æ› ORMï¼‰
- ä½†é€™å€‹å°ˆæ¡ˆä¸å¤ªå¯èƒ½æ› ORMï¼Œæ‰€ä»¥é€™æ˜¯å¯æ¥å—çš„æ¬Šè¡¡

### 10.2 ç‚ºä»€éº¼ä¸ä½¿ç”¨ DI Containerï¼Ÿ

**æ±ºç­–**ï¼šæ‰‹å‹•å‚³éä¾è³´ï¼Œä¸ä½¿ç”¨ Container

**åŸå› **ï¼š
1. Cloudflare Workers çš„ Singleton è¡Œç‚ºä¸å¯é 
2. æ‰‹å‹•å‚³éæ›´æ˜ç¢ºã€æ›´å®¹æ˜“ç†è§£
3. æ¸›å°‘äº†ä¸€å€‹æŠ½è±¡å±¤
4. æ¸¬è©¦æ™‚ç›´æ¥å‚³å…¥ mock å³å¯

### 10.3 ç‚ºä»€éº¼ Service æ˜¯ã€ŒæŒ‰éœ€å»ºç«‹ã€ï¼Ÿ

**æ±ºç­–**ï¼šä¸å¼·åˆ¶æ¯å€‹æ¨¡çµ„éƒ½æœ‰ Serviceï¼Œåªåœ¨éœ€è¦æ™‚å»ºç«‹

**åŸå› **ï¼š
1. ç°¡å–®çš„ CRUD æ“ä½œä¸éœ€è¦ Service å±¤
2. é¿å…éåº¦å·¥ç¨‹åŒ–
3. ä¿æŒç¨‹å¼ç¢¼ç²¾ç°¡
4. è®“é–‹ç™¼è€…å°ˆæ³¨æ–¼çœŸæ­£éœ€è¦æŠ½è±¡çš„åœ°æ–¹

---

## é™„éŒ„ Aï¼šå¸¸è¦‹å•é¡Œ

### Q1ï¼šæ–°èˆŠç¨‹å¼ç¢¼å¦‚ä½•ä¸¦å­˜ï¼Ÿ

å¯ä»¥æ¼¸é€²å¼é·ç§»ï¼Œæ–°èˆŠç¨‹å¼ç¢¼ä¸¦å­˜æ²’å•é¡Œï¼š

```typescript
// èˆŠå¯«æ³•ï¼ˆç›´æ¥åœ¨ Router æŸ¥è©¢ï¼‰
const opportunity = await db.query.opportunities.findFirst({
  where: eq(opportunities.id, id),
});

// æ–°å¯«æ³•ï¼ˆä½¿ç”¨ Query å‡½æ•¸ï¼‰
const opportunity = await opportunityQueries.findById(id);
```

å…©ç¨®å¯«æ³•éƒ½å¯ä»¥æ­£å¸¸é‹ä½œï¼Œé€æ­¥é·ç§»å³å¯ã€‚

### Q2ï¼šQuery å‡½æ•¸å¦‚ä½•æ¸¬è©¦ï¼Ÿ

```typescript
// ä½¿ç”¨ vitest mock
vi.mock("@sales_ai_automation_v3/db", () => ({
  db: {
    select: vi.fn().mockReturnValue({
      from: vi.fn().mockReturnValue({
        where: vi.fn().mockResolvedValue([mockOpportunity]),
      }),
    }),
  },
}));

// æˆ–ä½¿ç”¨æ¸¬è©¦è³‡æ–™åº«
beforeEach(async () => {
  await seedTestData();
});

afterEach(async () => {
  await cleanupTestData();
});
```

### Q3ï¼šä»€éº¼æ™‚å€™æ‡‰è©²å»ºç«‹ Serviceï¼Ÿ

ç•¶ä½ ç™¼ç¾è‡ªå·±åœ¨ Router ä¸­ï¼š
1. éœ€è¦æ“ä½œå¤šå€‹ Query å‡½æ•¸ä¸¦å”èª¿å®ƒå€‘
2. éœ€è¦åŠ å…¥å¿«å–é‚è¼¯
3. éœ€è¦ç™¼é€é€šçŸ¥æˆ–è§¸ç™¼å‰¯ä½œç”¨
4. æ¥­å‹™é‚è¼¯è¶…é 20 è¡Œ

å°±æ˜¯å»ºç«‹ Service çš„æ™‚æ©Ÿã€‚

---

## é™„éŒ„ Bï¼šæª¢æŸ¥æ¸…å–®

### é–‹ç™¼æ™‚è‡ªæˆ‘æª¢æŸ¥

- [ ] Router å±¤æ˜¯å¦ç›´æ¥æ“ä½œ DBï¼Ÿï¼ˆæ‡‰è©²ç”¨ Query å‡½æ•¸ï¼‰
- [ ] æ˜¯å¦ä½¿ç”¨ `console.log`ï¼Ÿï¼ˆæ‡‰è©²ç”¨ Loggerï¼‰
- [ ] éŒ¯èª¤æ˜¯å¦ä½¿ç”¨ `new Error()`ï¼Ÿï¼ˆæ‡‰è©²ç”¨ `errors.*` å·¥å» ï¼‰
- [ ] è¤‡é›œé‚è¼¯æ˜¯å¦æ”¾åœ¨ Routerï¼Ÿï¼ˆè€ƒæ…®æŠ½åˆ° Serviceï¼‰

### Code Review æª¢æŸ¥

- [ ] æ–°çš„ DB æŸ¥è©¢æ˜¯å¦æ”¾åœ¨ Query å‡½æ•¸ï¼Ÿ
- [ ] Logger æ˜¯å¦æœ‰å‚³éæ­£ç¢ºçš„ contextï¼Ÿ
- [ ] éŒ¯èª¤è™•ç†æ˜¯å¦ä½¿ç”¨æ¨™æº–çš„ AppErrorï¼Ÿ
- [ ] Service æ˜¯å¦çœŸçš„éœ€è¦ï¼Ÿé‚„æ˜¯å¯ä»¥ç”¨ Query å°±å¥½ï¼Ÿ

---

## é™„éŒ„ Cï¼šArchitecture Check SKILL

ç‚ºäº†ç¢ºä¿æ¶æ§‹åŸå‰‡è¢«æŒçºŒéµå®ˆï¼Œå»ºè­°æ•´åˆ `/architecture-check` SKILL åˆ° Claude é–‹ç™¼æµç¨‹ä¸­ã€‚

### C.1 è§¸ç™¼æ™‚æ©Ÿ

| æƒ…å¢ƒ | èªªæ˜ |
|------|------|
| æ–°å¢ API è·¯ç”± | åœ¨ `packages/api/src/routers/` æ–°å¢æª”æ¡ˆ |
| ä¿®æ”¹ API è·¯ç”± | ä¿®æ”¹ç¾æœ‰çš„è·¯ç”±é‚è¼¯ |
| æ–°å¢ Service | åœ¨ `packages/services/src/` æ–°å¢æœå‹™ |
| ç”¨æˆ¶è¦æ±‚ | èªªã€Œæª¢æŸ¥æ¶æ§‹ã€ã€`/architecture-check` |

### C.2 æª¢æŸ¥é …ç›®

#### 1. Query Layer åˆ†é›¢

```typescript
// âŒ é•è¦ï¼šRouter ç›´æ¥æ“ä½œ DB
export const getOpportunity = protectedProcedure
  .handler(async ({ input, context }) => {
    await db.select().from(opportunities).where(...);  // ç›´æ¥ DB
  });

// âœ… æ­£ç¢ºï¼šä½¿ç”¨ Query å‡½æ•¸
export const getOpportunity = protectedProcedure
  .handler(async ({ input, context }) => {
    return opportunityQueries.findById(input.id);
  });
```

**æœå°‹é•è¦**ï¼š
```bash
grep -r "await db\." packages/api/src/routers/
grep -r "\.insert(" packages/api/src/routers/
grep -r "\.update(" packages/api/src/routers/
grep -r "\.delete(" packages/api/src/routers/
```

#### 2. éŒ¯èª¤è™•ç†æ¨™æº–åŒ–

```typescript
// âŒ é•è¦
throw new Error("æ‰¾ä¸åˆ°å•†æ©Ÿ");

// âœ… æ­£ç¢º
throw errors.NOT_FOUND("å•†æ©Ÿ", id);
```

**æœå°‹é•è¦**ï¼š
```bash
grep -r "throw new Error" packages/api/ packages/services/
```

#### 3. çµæ§‹åŒ–æ—¥èªŒ

```typescript
// âŒ é•è¦
console.log("Creating opportunity...");

// âœ… æ­£ç¢º
logger.info("Creating opportunity", { userId, customerNumber });
```

**æœå°‹é•è¦**ï¼š
```bash
grep -r "console\.(log|error|warn)" packages/api/ packages/services/
```

### C.3 è¼¸å‡ºæ ¼å¼

```markdown
## æ¶æ§‹æª¢æŸ¥å ±å‘Š

### ğŸ“Š æ‘˜è¦
- **æª¢æŸ¥ç¯„åœ**: X å€‹æª”æ¡ˆ
- **é•è¦æ•¸é‡**: ğŸ”´ åš´é‡ X | ğŸŸ¡ è­¦å‘Š X
- **æ¶æ§‹è©•åˆ†**: â­â­â­â­â˜† (4/5)

---

### 1. Query Layer åˆ†é›¢
| ç‹€æ…‹ | æª”æ¡ˆ | å•é¡Œ |
|------|------|------|
| ğŸ”´ | `routers/opportunity.ts:45` | ç›´æ¥æ“ä½œ db.insert() |

### 2. éŒ¯èª¤è™•ç†
| ç‹€æ…‹ | æª”æ¡ˆ | å•é¡Œ |
|------|------|------|
| âœ… | å…¨éƒ¨é€šé | - |

### 3. çµæ§‹åŒ–æ—¥èªŒ
| ç‹€æ…‹ | æª”æ¡ˆ | å•é¡Œ |
|------|------|------|
| ğŸŸ¡ | `services/llm/gemini.ts:123` | ä½¿ç”¨ console.error |
```

### C.4 è±å…è¦å‰‡

ä»¥ä¸‹ä½ç½®å¯è±å…æª¢æŸ¥ï¼š

| ä½ç½® | åŸå›  |
|------|------|
| `apps/server/src/index.ts` | é€²å…¥é»ï¼Œå¯ç›´æ¥è¨­å®š |
| `packages/services/src/*/index.ts` | å·¥å» å‡½æ•¸æ‰€åœ¨ |
| `**/test/**`, `**/__tests__/**` | æ¸¬è©¦æª”æ¡ˆ |
| `packages/shared/src/logger/` | Logger å¯¦ä½œæœ¬èº« |

### C.5 æ•´åˆåˆ° CLAUDE.md

å°‡ä»¥ä¸‹å…§å®¹åŠ å…¥ `.claude/CLAUDE.md`ï¼š

```markdown
### æ¶æ§‹å“è³ªé¡ï¼ˆæ–°å¢/ä¿®æ”¹ API æ™‚è‡ªå‹•åŸ·è¡Œï¼‰

| Skill | è§¸ç™¼æ™‚æ©Ÿ | åŠŸèƒ½ |
|-------|---------|------|
| `architecture-check` | æ–°å¢/ä¿®æ”¹ API è·¯ç”±ã€Service æ™‚ | æª¢æŸ¥ Query åˆ†é›¢ã€éŒ¯èª¤è™•ç†ã€æ—¥èªŒä½¿ç”¨ |

### è‡ªå‹•åŸ·è¡Œè¦å‰‡ï¼ˆæ›´æ–°ï¼‰

1. **å®ŒæˆåŠŸèƒ½é–‹ç™¼å¾Œ**ï¼š`code-review` + `typescript-quality`
2. **æ–°å¢/ä¿®æ”¹ API è·¯ç”±æ™‚**ï¼š`architecture-check` â† æ–°å¢
3. **æº–å‚™ commit å‰**ï¼š`secret-scanner` + `tdd-guard`
4. **å»ºç«‹ PR å‰**ï¼š`pr-review`
```

---

## é™„éŒ„ Dï¼šç›¸é—œæ–‡ä»¶é€£çµ

| æ–‡ä»¶ | èªªæ˜ |
|------|------|
| [ARCHITECTURE.md](./ARCHITECTURE.md) | å®Œæ•´å°ˆæ¡ˆæ¶æ§‹èªªæ˜ |
| [åŸè¦åŠƒ](./20260129_æ¨¡çµ„åŒ–æ¶æ§‹é‡æ§‹è¦åŠƒ.md) | åŸå§‹çš„ DDD é¢¨æ ¼è¦åŠƒï¼ˆå·²å–ä»£ï¼‰ |
| [CLAUDE.md](../.claude/CLAUDE.md) | Claude é–‹ç™¼æŒ‡å¼•èˆ‡ Skills |
