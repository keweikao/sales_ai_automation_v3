# ç«¶å“åˆ†ææ•´åˆ - å¾Œç«¯å®Œæˆå ±å‘Š

**æ—¥æœŸ**: 2026-01-28
**ç‹€æ…‹**: âœ… Phase 1 & 2 å®Œæˆï¼Œæº–å‚™æ¸¬è©¦
**ä¸‹ä¸€æ­¥**: æ¸¬è©¦èªéŸ³æª”ä¸Šå‚³ä¸¦é©—è­‰ç«¶å“åˆ†æåŠŸèƒ½

---

## âœ… å·²å®Œæˆé …ç›®

### 1. è³‡æ–™åº«è¨­å®š (Phase 1)

#### Migration 0011: å»ºç«‹ competitor_info è¡¨
- **æª”æ¡ˆ**: `packages/db/migrations/0011_add_competitor_info.sql`
- **å…§å®¹**:
  - å»ºç«‹ competitor_info è¡¨
  - åŒ…å«æ¬„ä½: id, competitor_name, strengths, weaknesses, our_advantages, counter_talk_tracks, switching_cases
  - å»ºç«‹ç´¢å¼•: competitor_info_name_idx
- **ç‹€æ…‹**: âœ… å·²åŸ·è¡ŒæˆåŠŸ

#### Migration 0012: æ–°å¢ competitor_analysis æ¬„ä½
- **æª”æ¡ˆ**: `packages/db/migrations/0012_add_competitor_analysis_to_meddic.sql`
- **å…§å®¹**: åœ¨ meddic_analyses è¡¨æ–°å¢ competitor_analysis JSONB æ¬„ä½
- **ç‹€æ…‹**: âœ… å·²åŸ·è¡ŒæˆåŠŸ

#### Seed Script: åŒ¯å…¥ç«¶å“è³‡æ–™
- **æª”æ¡ˆ**: `scripts/seed-competitors.ts`
- **è³‡æ–™ä¾†æº**: `competitor-kb.json` (9 å€‹ç«¶å“)
  - é¤é£²æ¥­ (5å€‹): è‚šè‚šã€Eats365ã€å¾®ç¢§ã€å¤§éº¥ã€é–‹åº—å¿«æ‰‹
  - ç¾æ¥­ (4å€‹): ezPrettyã€Dolyuã€SHOPLINEã€Contenta
- **è½‰æ›é‚è¼¯**:
  - å¾ advantages â†’ strengths
  - å¾ disadvantages â†’ weaknesses
  - å¾ differentiation æå– â†’ ourAdvantages
  - å¾ rebuttal_scripts â†’ counterTalkTracks
- **ç‹€æ…‹**: âœ… å·²æˆåŠŸåŒ¯å…¥ 9 å€‹ç«¶å“

---

### 2. Agent åˆ†æå¢å¼· (Phase 2)

#### Agent 2 (Buyer Agent) å¢å¼·
- **æª”æ¡ˆ**: `packages/services/src/llm/agents.ts` (Line 99-155)
- **åŠŸèƒ½**:
  1. Agent 2 åŸ·è¡Œ PDCM åˆ†æï¼Œåµæ¸¬ `detected_competitors`
  2. é‡å°æ¯å€‹åµæ¸¬åˆ°çš„ç«¶å“ï¼Œè‡ªå‹•å‘¼å« `getCompetitorInfo()` MCP tool
  3. æŸ¥è©¢è³‡æ–™åº«ç²å–ç«¶å“è©³ç´°è³‡è¨Š (strengths, weaknesses, ourAdvantages, counterTalkTracks)
  4. å°‡è©³ç´°è³‡è¨Šé™„åŠ åˆ° `detected_competitors[].details`
- **ç‹€æ…‹**: âœ… å·²å¯¦ä½œä¸¦æ•´åˆ

#### Agent 6 (Coach Agent) å¢å¼·
- **æª”æ¡ˆ**: `packages/services/src/llm/agents.ts` (Line 311-370)
- **åŠŸèƒ½**:
  1. æª¢æŸ¥ `state.buyerData.detected_competitors` æ˜¯å¦æœ‰ç«¶å“è³‡è¨Š
  2. å¦‚æœæœ‰ï¼Œå°‡ç«¶å“çŸ¥è­˜åº«æ³¨å…¥åˆ° Prompt ä¸­:
     - æˆ‘æ–¹å„ªå‹¢ (å‰ 5 é …)
     - å»ºè­°è©±è¡“ (å‰ 3 é …)
  3. Agent 6 åŸºæ–¼é€™äº›è³‡è¨Šè©•ä¼°æ¥­å‹™çš„ç«¶å“æ‡‰å°è¡¨ç¾ (`competitor_handling_evaluation`)
- **ç‹€æ…‹**: âœ… å·²å¯¦ä½œä¸¦æ•´åˆ

#### Orchestrator å¢å¼·
- **æª”æ¡ˆ**: `packages/services/src/llm/orchestrator.ts`
- **æ–°å¢æ–¹æ³•**:
  1. `buildCompetitorAnalysis(state)` (Line 762-805)
     - å¾ Agent 2 çš„ `detected_competitors` æå–è³‡è¨Š
     - æ§‹å»º `competitorAnalysis` ç‰©ä»¶
     - åŒ…å«: detectedCompetitors, overallThreatLevel, handlingScore
  2. `assessThreatLevel(attitude)` (Line 810-821)
     - positive â†’ high (å®¢æˆ¶å°ç«¶å“æœ‰å¥½æ„Ÿ)
     - neutral â†’ medium (ä¸­æ€§æåŠ)
     - negative â†’ low (å®¢æˆ¶ä¸æ»¿ï¼Œè½‰æ›æ©Ÿæœƒ)
  3. `calculateOverallThreatLevel(competitors)` (Line 826-850)
     - ä»»ä½• high â†’ æ•´é«” high
     - ä»»ä½• medium â†’ æ•´é«” medium
     - å…¨éƒ¨ low â†’ æ•´é«” low
     - ç„¡ç«¶å“ â†’ none
  4. `calculateAverageHandlingScore(evaluations)` (Line 855-864)
     - å¾ Agent 6 çš„è©•åˆ†è¨ˆç®—å¹³å‡
- **æ•´åˆä½ç½®**: `buildResult()` (Line 482)
- **ç‹€æ…‹**: âœ… å·²å¯¦ä½œä¸¦æ•´åˆ

---

### 3. Schema æ›´æ–°

#### Shared Schema
- **æª”æ¡ˆ**: `packages/shared/src/schemas/meddic.ts`
- **æ–°å¢æ¬„ä½**: `competitorAnalysis`
  ```typescript
  competitorAnalysis: z.object({
    detectedCompetitors: z.array(z.object({
      name: z.string(),
      customerQuote: z.string(),
      attitude: z.enum(["positive", "negative", "neutral"]),
      threatLevel: z.enum(["high", "medium", "low"]),
      ourAdvantages: z.array(z.string()),
      suggestedTalkTracks: z.array(z.string()),
    })),
    overallThreatLevel: z.enum(["high", "medium", "low", "none"]),
    handlingScore: z.number().min(1).max(5).optional(),
  }).optional()
  ```
- **ç‹€æ…‹**: âœ… å·²æ–°å¢

#### Database Schema
- **æª”æ¡ˆ**: `packages/db/src/schema/meddic.ts`
- **æ–°å¢æ¬„ä½**: `competitorAnalysis` (JSONB é¡å‹)
- **ç‹€æ…‹**: âœ… å·²æ–°å¢ä¸¦åŸ·è¡Œ Migration

#### API Router
- **æª”æ¡ˆ**: `packages/api/src/routers/conversation.ts` (Line 694-707)
- **ä¿®æ”¹**: åœ¨ `meddicAnalyses.insert()` ä¸­æ–°å¢ `competitorAnalysis` æ¬„ä½
- **ç‹€æ…‹**: âœ… å·²æ–°å¢

---

## ğŸ“Š è³‡æ–™æµç¨‹ (Data Flow)

```
1. èªéŸ³æª”ä¸Šå‚³ â†’ Queue è½‰éŒ„
   â†“
2. Orchestrator å•Ÿå‹• DAG åŸ·è¡Œ
   â†“
3. Level 0: Agent 1 (Context) + Agent 2 (Buyer) ä¸¦è¡ŒåŸ·è¡Œ
   â†“
4. Agent 2 åµæ¸¬ç«¶å“é—œéµè©
   - detected_competitors: [{ name, customer_quote, attitude }]
   â†“
5. ã€æ–°å¢ã€‘Agent 2 å‘¼å« getCompetitorInfo() MCP Tool
   - æŸ¥è©¢ competitor_info è¡¨
   - ç²å–: strengths, weaknesses, ourAdvantages, counterTalkTracks
   - é™„åŠ åˆ° detected_competitors[].details
   â†“
6. Level 1: Agent 3 (Seller) åŸ·è¡Œ
   â†“
7. Level 2: Agent 4 (Summary) + Agent 5 (CRM) ä¸¦è¡ŒåŸ·è¡Œ
   â†“
8. Level 3: Agent 6 (Coach) åŸ·è¡Œ
   - è®€å– detected_competitors (å« details)
   - ã€æ–°å¢ã€‘å°‡ç«¶å“çŸ¥è­˜åº«æ³¨å…¥ Prompt
   - è©•ä¼°æ¥­å‹™æ‡‰å°è¡¨ç¾ â†’ competitor_handling_evaluation
   â†“
9. Orchestrator.buildResult()
   - ã€æ–°å¢ã€‘å‘¼å« buildCompetitorAnalysis(state)
   - æ§‹å»º competitorAnalysis ç‰©ä»¶:
     * detectedCompetitors (å« ourAdvantages, suggestedTalkTracks)
     * overallThreatLevel (high/medium/low/none)
     * handlingScore (1-5)
   â†“
10. API Router å„²å­˜åˆ° meddic_analyses è¡¨
    - ã€æ–°å¢ã€‘competitor_analysis JSONB æ¬„ä½
   â†“
11. å‰ç«¯å‘ˆç¾ (Phase 3 - å¾…å¯¦ä½œ)
    - Web: CompetitorAnalysisCard çµ„ä»¶
    - Slack: ç«¶å“æ‡‰å°å€å¡Š
```

---

## ğŸ§ª æ¸¬è©¦æ­¥é©Ÿ

### æ¸¬è©¦ç›®æ¨™
é©—è­‰å®Œæ•´ç«¯åˆ°ç«¯æµç¨‹:
1. ä¸Šå‚³åŒ…å«ç«¶å“æåŠçš„èªéŸ³æª”
2. Agent 2 æ­£ç¢ºåµæ¸¬ç«¶å“ä¸¦æŸ¥è©¢è³‡æ–™åº«
3. Agent 6 ä½¿ç”¨ç«¶å“çŸ¥è­˜åº«æä¾›å»ºè­°
4. Orchestrator æ§‹å»º competitorAnalysis ç‰©ä»¶
5. è³‡æ–™åº«æ­£ç¢ºå„²å­˜ competitor_analysis æ¬„ä½

### æ¸¬è©¦æº–å‚™
1. ç¢ºä¿æœå‹™æ­£åœ¨é‹è¡Œ:
   ```bash
   # å•Ÿå‹• Server
   cd apps/server && bun run dev

   # å•Ÿå‹• Queue Worker
   cd apps/queue-worker && bun run dev

   # å•Ÿå‹• Web (å¯é¸)
   cd apps/web && bun run dev
   ```

2. æº–å‚™æ¸¬è©¦èªéŸ³æª” (éœ€åŒ…å«ç«¶å“æåŠ):
   - ä¾‹å¦‚: "å®¢æˆ¶æåˆ°ä»–å€‘ä¹‹å‰ç”¨éè‚šè‚š POS..."
   - æˆ–: "å®¢æˆ¶èªª Eats365 çš„åƒ¹æ ¼æ¯”è¼ƒä¾¿å®œ..."

### æ¸¬è©¦æ­¥é©Ÿ

#### Step 1: ä¸Šå‚³èªéŸ³æª”
- é€é Web UI æˆ– API ä¸Šå‚³åŒ…å«ç«¶å“æåŠçš„èªéŸ³æª”
- ç¢ºä¿ç”¢å“ç·šè¨­å®šæ­£ç¢º (é¤é£²: iCHEF / ç¾æ¥­: QLiEER)

#### Step 2: ç›£æ§ Agent åŸ·è¡Œæ—¥èªŒ
é æœŸçœ‹åˆ°:
```
[Agent 2] åµæ¸¬åˆ° 1 å€‹ç«¶å“
[Agent 2] æŸ¥è©¢ç«¶å“è³‡è¨Š: è‚šè‚š
[Agent 2] âœ… æ‰¾åˆ°ç«¶å“è³‡è¨Š: è‚šè‚š
[Agent 6] æ³¨å…¥ 1 å€‹ç«¶å“çš„çŸ¥è­˜åº«åƒè€ƒè³‡è¨Š
[Orchestrator] æ§‹å»ºç«¶å“åˆ†æï¼Œå…± 1 å€‹ç«¶å“
```

#### Step 3: æª¢æŸ¥è³‡æ–™åº«
```sql
-- æŸ¥è©¢æœ€æ–°çš„åˆ†æçµæœ
SELECT
  id,
  conversation_id,
  competitor_analysis
FROM meddic_analyses
ORDER BY created_at DESC
LIMIT 1;
```

é æœŸçµæœ:
```json
{
  "detectedCompetitors": [
    {
      "name": "è‚šè‚š",
      "customerQuote": "å®¢æˆ¶æåˆ°ä¹‹å‰ç”¨éè‚šè‚š POS",
      "attitude": "positive",
      "threatLevel": "high",
      "ourAdvantages": [
        "iCHEF æœ‰ 10,000+ é¤å»³å¯¦éš›é©—è­‰",
        "ç³»çµ±ç©©å®šåº¦æ¥­ç•Œç¬¬ä¸€",
        "..."
      ],
      "suggestedTalkTracks": [
        "è‚šè‚šä¸»è¦åšé€£é–ï¼Œå–®åº—æ›´é©åˆ iCHEF",
        "æˆ‘å€‘çš„åƒ¹æ ¼é€æ˜ï¼Œæ²’æœ‰éš±è—æˆæœ¬",
        "..."
      ]
    }
  ],
  "overallThreatLevel": "high",
  "handlingScore": 3
}
```

#### Step 4: æª¢æŸ¥ Agent Outputs
```sql
-- æª¢æŸ¥ Agent 2 çš„åŸå§‹è¼¸å‡º
SELECT
  agent_outputs->'agent2'->'detected_competitors'
FROM meddic_analyses
ORDER BY created_at DESC
LIMIT 1;
```

é æœŸçœ‹åˆ°æ¯å€‹ç«¶å“éƒ½æœ‰ `details` ç‰©ä»¶ (å« strengths, weaknesses, ourAdvantages, counterTalkTracks)

---

## âš ï¸ å·²çŸ¥é™åˆ¶

1. **ç«¶å“åµæ¸¬ä¾è³´ Agent 2 çš„æç¤ºè©**
   - å¦‚æœèªéŸ³æª”ä¸­çš„ç«¶å“æåŠä¸æ˜é¡¯ï¼ŒAgent 2 å¯èƒ½ç„¡æ³•åµæ¸¬
   - å»ºè­°æ¸¬è©¦æ™‚æ˜ç¢ºæåŠç«¶å“åç¨±

2. **åªæ”¯æ´ 9 å€‹é è¨­ç«¶å“**
   - é¤é£²: è‚šè‚šã€Eats365ã€å¾®ç¢§ã€å¤§éº¥ã€é–‹åº—å¿«æ‰‹
   - ç¾æ¥­: ezPrettyã€Dolyuã€SHOPLINEã€Contenta
   - å¦‚åµæ¸¬åˆ°ä¸åœ¨è³‡æ–™åº«ä¸­çš„ç«¶å“ï¼Œ`details` å°‡ç‚º `null`

3. **Agent 6 è©•åˆ†ä¾è³´æ¥­å‹™æ‡‰å°å…§å®¹**
   - å¦‚æœå°è©±ä¸­æ²’æœ‰æ¥­å‹™æ‡‰å°ç«¶å“çš„å…§å®¹ï¼Œ`handlingScore` å¯èƒ½ç‚ºé»˜èªå€¼ 3

---

## ğŸ“ ä¿®æ”¹æª”æ¡ˆæ¸…å–®

### æ–°å»ºæª”æ¡ˆ
- `packages/db/migrations/0011_add_competitor_info.sql`
- `packages/db/migrations/0012_add_competitor_analysis_to_meddic.sql`
- `scripts/seed-competitors.ts`
- `scripts/run-migration-0011.ts`
- `scripts/run-migration-0012.ts`
- `scripts/add-competitor-field-direct.ts`
- `scripts/check-competitor-analysis-field.ts`

### ä¿®æ”¹æª”æ¡ˆ
- `packages/services/src/llm/agents.ts`
  - BuyerAgent (Line 99-155)
  - CoachAgent (Line 311-370)
- `packages/services/src/llm/orchestrator.ts`
  - buildResult() (Line 482)
  - buildCompetitorAnalysis() (Line 762-805)
  - assessThreatLevel() (Line 810-821)
  - calculateOverallThreatLevel() (Line 826-850)
  - calculateAverageHandlingScore() (Line 855-864)
- `packages/shared/src/schemas/meddic.ts`
  - æ–°å¢ competitorAnalysis æ¬„ä½
- `packages/db/src/schema/meddic.ts`
  - æ–°å¢ competitor_analysis æ¬„ä½
- `packages/api/src/routers/conversation.ts`
  - insert meddicAnalyses æ–°å¢ competitorAnalysis (Line 694-707)

---

## ğŸ¯ ä¸‹ä¸€æ­¥ (Phase 3 - å‰ç«¯å¯¦ä½œ)

å®Œæˆæ¸¬è©¦å¾Œ,å¦‚æœä¸€åˆ‡æ­£å¸¸,ä¸‹ä¸€æ­¥å°‡å¯¦ä½œå‰ç«¯å‘ˆç¾:

1. **Web çµ„ä»¶** (`apps/web/src/components/meddic/competitor-analysis-card.tsx`)
   - é¡¯ç¤ºåµæ¸¬åˆ°çš„ç«¶å“
   - å¨è„…ç­‰ç´šè¦–è¦ºåŒ– (ç´…/é»ƒ/ç¶ )
   - å®¢æˆ¶æ…‹åº¦æ¨™ç±¤
   - æˆ‘æ–¹å„ªå‹¢åˆ—è¡¨ (Accordion)
   - å»ºè­°è©±è¡“åˆ—è¡¨ (Accordion)

2. **æ•´åˆåˆ°å°è©±è©³æƒ…é ** (`apps/web/src/routes/conversations/$id.tsx`)
   - åœ¨ PDCM åˆ†æå¾Œé¡¯ç¤ºç«¶å“åˆ†æå¡ç‰‡

3. **æ•´åˆåˆ°æ©Ÿæœƒè©³æƒ…é ** (`apps/web/src/routes/opportunities/$id.tsx`)
   - æ–°å¢ç«¶å“å¨è„…çµ±è¨ˆå¡ç‰‡

4. **Slack é€šçŸ¥å¢å¼·** (Phase 4)
   - åœ¨åˆ†æå®Œæˆé€šçŸ¥ä¸­åŠ å…¥ç«¶å“æ‡‰å°å€å¡Š

---

## ğŸ“ å‚™è¨»

- æœ¬æ¬¡å¯¦ä½œå®Œå…¨éµå¾ªè¨ˆç•«æª”æ¡ˆ: `/Users/stephen/.claude/plans/shimmying-pondering-moonbeam.md`
- Phase 5 (åˆ†äº«é é¢) æ ¹æ“šä½¿ç”¨è€…è¦æ±‚æš«ä¸å¯¦ä½œ
- æ‰€æœ‰è³‡æ–™åº« Migration å·²æˆåŠŸåŸ·è¡Œ,Schema å·²åŒæ­¥
- MCP Tool `get-competitor-info` å·²åœ¨ Agent ä¸­æ­£å¸¸ä½¿ç”¨

---

**ç‹€æ…‹**: âœ… å¾Œç«¯æ•´åˆå®Œæˆï¼Œç­‰å¾…æ¸¬è©¦é©—è­‰
**æ¸¬è©¦è² è²¬äºº**: Stephen
**é æœŸæ¸¬è©¦æ™‚é–“**: 2026-01-28
