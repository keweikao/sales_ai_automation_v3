# 2026-01-29 新增 Agent 分析欄位實作計劃

**日期**: 2026-01-29
**類型**: 功能規劃
**優先級**: 高

---

## 背景

目前 MEDDIC 分析主要聚焦於 PDCM 四維度（Pain/Decision/Champion/Metrics）和銷售策略，但缺少以下對主管決策至關重要的資訊：

1. **店家輪廓** - 了解客戶的業務背景
2. **決策鏈** - 誰是真正的決策者、影響者
3. **競爭態勢** - 競品狀況和我方優勢（目前已有基礎實作）
4. **成交預測** - 預測成交時間、金額、概率
5. **銷售技巧診斷** - 評估業務員的表現和改進方向

---

## 新增欄位設計

### 1. Store Profile（店家輪廓）

```typescript
interface StoreProfile {
  // 基本資訊
  businessType: "餐廳" | "咖啡廳" | "飲料店" | "複合式" | "小吃攤" | "美容美髮" | "美甲美睫" | "SPA按摩" | "其他";
  businessScale: "微型" | "小型" | "中型" | "連鎖";
  estimatedMonthlyRevenue?: string; // "10-30萬" | "30-50萬" | "50-100萬" | "100萬以上"
  estimatedEmployeeCount?: number;

  // 營運狀態
  operationalStatus: "新開店" | "穩定經營" | "擴展中" | "困難中" | "轉型中";
  currentPainPoints: string[]; // 從對話中提取的痛點

  // 系統使用
  currentSystems: {
    pos?: string; // 現有 POS 系統
    crm?: string; // 現有 CRM
    reservation?: string; // 訂位系統
    other?: string[];
  };
  techSavviness: "高" | "中" | "低"; // 對科技的接受度

  // 提取證據
  evidence: string[]; // 支持以上判斷的對話片段
}
```

### 2. Decision Info（決策鏈）

```typescript
interface DecisionInfo {
  // 決策者識別
  primaryDecisionMaker: {
    role: "老闆" | "店長" | "經理" | "合夥人" | "家族成員" | "其他";
    name?: string;
    isPresent: boolean; // 是否在本次對話中
    attitude: "積極" | "中立" | "抗拒";
  };

  // 其他影響者
  influencers: Array<{
    role: string;
    influence: "高" | "中" | "低";
    attitude: "支持" | "中立" | "反對";
    concerns?: string;
  }>;

  // 決策流程
  decisionProcess: {
    stage: "初步了解" | "評估比較" | "內部討論" | "最終決定";
    estimatedTimeline: "本週" | "本月" | "1-3個月" | "未定";
    blockers: string[]; // 阻礙決策的因素
    triggers: string[]; // 可能加速決策的因素
  };

  // 預算
  budgetInfo: {
    hasBeenDiscussed: boolean;
    range?: "低於1萬" | "1-3萬" | "3-5萬" | "5萬以上";
    concerns?: string; // 價格顧慮
  };

  evidence: string[];
}
```

### 3. Competitive Situation（競爭態勢）- 擴展現有

```typescript
interface CompetitiveSituation {
  // 現有欄位 (保持相容)
  detectedCompetitors: Array<{
    name: string;
    customerQuote: string;
    attitude: "positive" | "negative" | "neutral";
    threatLevel: "high" | "medium" | "low";
    ourAdvantages: string[];
    suggestedTalkTracks: string[];
  }>;
  overallThreatLevel: "high" | "medium" | "low" | "none";
  handlingScore?: number;

  // 新增欄位
  competitiveContext: {
    isActivelyComparing: boolean; // 是否正在比價
    comparisonCriteria: string[]; // 客戶比較的重點（價格、功能、服務等）
    ourPositioning: "領先" | "平手" | "落後" | "未知";
    switchingBarriers: string[]; // 客戶轉換的障礙
    switchingMotivators: string[]; // 客戶轉換的動力
  };

  // 戰略建議
  competitiveStrategy: {
    recommended: "功能差異化" | "價格競爭" | "服務優勢" | "急迫感建立" | "風險強調";
    keyMessages: string[]; // 應該強調的訊息
    avoidTopics: string[]; // 應該避免的話題
  };
}
```

### 4. Deal Prediction（成交預測）

```typescript
interface DealPrediction {
  // 核心預測
  probability: number; // 0-100%
  confidenceLevel: "高" | "中" | "低"; // AI 對預測的信心

  // 預測時間
  expectedCloseDate: {
    range: "本週" | "1-2週" | "本月" | "1-3個月" | "3個月以上" | "不太可能";
    reasoning: string;
  };

  // 預測金額
  expectedDealSize: {
    productType: "標準版" | "進階版" | "企業版" | "組合方案";
    estimatedMRR?: number; // 月費
    estimatedSetupFee?: number; // 設定費
    upsellPotential: "高" | "中" | "低";
  };

  // 成交路徑
  closingPath: {
    nextMilestone: string; // 下一個里程碑
    criticalActions: Array<{
      action: string;
      owner: "業務" | "客戶" | "主管";
      deadline?: string;
      importance: "必要" | "建議";
    }>;
    potentialRisks: string[];
  };

  // 對比信號
  buyingSignals: string[]; // 購買信號
  warningSignals: string[]; // 警示信號
}
```

### 5. Sales Diagnosis（銷售技巧診斷）

```typescript
interface SalesDiagnosis {
  // 整體評分
  overallScore: number; // 1-100
  level: "專家" | "熟練" | "普通" | "需改進";

  // 各維度評分
  dimensions: {
    // 開場和建立關係
    rapport: {
      score: number; // 1-5
      highlights: string[];
      improvements: string[];
    };

    // 需求挖掘（SPIN 提問）
    discovery: {
      score: number;
      situationQuestions: number; // 情境問題數
      problemQuestions: number; // 問題問題數
      implicationQuestions: number; // 暗示問題數
      needPayoffQuestions: number; // 需求-效益問題數
      highlights: string[];
      improvements: string[];
    };

    // 產品展示
    presentation: {
      score: number;
      focusedOnBenefits: boolean; // 是否聚焦利益而非功能
      customizedToNeeds: boolean; // 是否針對客戶需求客製化
      highlights: string[];
      improvements: string[];
    };

    // 異議處理
    objectionHandling: {
      score: number;
      objectionsCounted: number;
      objectionsResolved: number;
      techniques: string[]; // 使用的技巧
      highlights: string[];
      improvements: string[];
    };

    // 收尾技巧
    closing: {
      score: number;
      attemptedClose: boolean;
      closeType?: "直接成交" | "假設成交" | "選擇成交" | "緊迫成交" | "未嘗試";
      nextStepSecured: boolean;
      highlights: string[];
      improvements: string[];
    };
  };

  // 具體話術建議
  talkTrackSuggestions: Array<{
    situation: string; // 情境描述
    said: string; // 業務說的
    suggested: string; // 建議說法
    reason: string; // 改進原因
  }>;

  // 教練重點
  coachingPriorities: Array<{
    area: string;
    currentState: string;
    targetState: string;
    actionPlan: string;
  }>;
}
```

---

## 資料庫 Schema 變更

### 方案 A：擴展 meddicAnalyses 表（推薦）

```sql
-- 新增欄位到 meddic_analyses 表
ALTER TABLE meddic_analyses
ADD COLUMN store_profile jsonb,
ADD COLUMN decision_info jsonb,
ADD COLUMN competitive_situation jsonb, -- 替代現有 competitor_analysis，更完整
ADD COLUMN deal_prediction jsonb,
ADD COLUMN sales_diagnosis jsonb,
ADD COLUMN analysis_version integer DEFAULT 1; -- 追蹤分析版本
```

**Drizzle Schema 變更**：

```typescript
// packages/db/src/schema/meddic.ts

export const meddicAnalyses = pgTable("meddic_analyses", {
  // ... 現有欄位 ...

  // 新增欄位
  storeProfile: jsonb("store_profile").$type<StoreProfile>(),
  decisionInfo: jsonb("decision_info").$type<DecisionInfo>(),
  competitiveSituation: jsonb("competitive_situation").$type<CompetitiveSituation>(),
  dealPrediction: jsonb("deal_prediction").$type<DealPrediction>(),
  salesDiagnosis: jsonb("sales_diagnosis").$type<SalesDiagnosis>(),

  // 版本追蹤
  analysisVersion: integer("analysis_version").default(1), // v1=現有, v2=新增欄位
});
```

### 方案 B：建立獨立的分析表

如果資料量大或需要獨立查詢，可考慮：

```sql
CREATE TABLE analysis_insights (
  id text PRIMARY KEY,
  conversation_id text NOT NULL REFERENCES conversations(id),
  meddic_analysis_id text REFERENCES meddic_analyses(id),

  store_profile jsonb,
  decision_info jsonb,
  competitive_situation jsonb,
  deal_prediction jsonb,
  sales_diagnosis jsonb,

  created_at timestamp DEFAULT NOW(),
  analysis_version integer DEFAULT 2
);
```

**推薦方案 A**，因為：
- 維持資料完整性（一次分析的所有維度放在一起）
- 查詢效能更好（單表 JOIN）
- 較少的 migration 複雜度

---

## Agent 架構調整

### 選項 1：擴展現有 Agents

| Agent | 現有職責 | 新增職責 |
|-------|----------|----------|
| Agent 1 (Context) | 會議背景 | + Store Profile |
| Agent 2 (Buyer) | PDCM 分析 | + Decision Info（擴展現有） |
| Agent 2 (Buyer) | 競品偵測 | + Competitive Situation（擴展） |
| Agent 3 (Seller) | 銷售策略 | + Deal Prediction |
| Agent 6 (Coach) | 即時教練 | + Sales Diagnosis |

**優點**：不增加 API 調用次數
**缺點**：單個 Agent prompt 變長，可能影響品質

### 選項 2：新增專門 Agents（推薦）

```
現有 DAG:
Level 0: Agent 1 + Agent 2 (並行)
Level 1: Quality Loop
Level 2: Agent 3
Level 3: Agent 4 + Agent 5 (並行)
Level 4: Agent 6

新增 DAG:
Level 0: Agent 1 + Agent 2 (並行)
Level 1: Quality Loop
Level 2: Agent 3 + Agent 7 (並行) ← 新增 Prediction Agent
Level 3: Agent 4 + Agent 5 + Agent 8 (並行) ← 新增 Diagnosis Agent
Level 4: Agent 6
```

**新增 Agent 7: Deal Prediction Agent**

```typescript
const AGENT_7_PROMPT = `你是一位資深銷售預測分析師，專精於 SMB 市場的成交預測。

分析以下銷售對話，輸出成交預測：

## 輸入資料
- 對話逐字稿
- Agent 1 的 Context 分析
- Agent 2 的 PDCM 分析

## 輸出格式 (JSON)
{
  "probability": 0-100,
  "confidenceLevel": "高|中|低",
  "expectedCloseDate": {
    "range": "本週|1-2週|本月|1-3個月|3個月以上|不太可能",
    "reasoning": "string"
  },
  "expectedDealSize": {
    "productType": "string",
    "estimatedMRR": number,
    "upsellPotential": "高|中|低"
  },
  "closingPath": {
    "nextMilestone": "string",
    "criticalActions": [...],
    "potentialRisks": [...]
  },
  "buyingSignals": [...],
  "warningSignals": [...]
}`;
```

**新增 Agent 8: Sales Diagnosis Agent**

```typescript
const AGENT_8_PROMPT = `你是一位頂尖銷售教練，專精於 SPIN Selling 和顧問式銷售。

分析業務員在對話中的表現，提供具體的改進建議：

## 評分維度
1. Rapport Building (關係建立)
2. Discovery (需求挖掘) - 使用 SPIN 方法論
3. Presentation (產品展示)
4. Objection Handling (異議處理)
5. Closing (收尾技巧)

## 輸出格式 (JSON)
{
  "overallScore": 1-100,
  "level": "專家|熟練|普通|需改進",
  "dimensions": {
    "rapport": { "score": 1-5, "highlights": [], "improvements": [] },
    // ... 其他維度
  },
  "talkTrackSuggestions": [
    {
      "situation": "客戶提到價格太貴時",
      "said": "我們的價格是合理的...",
      "suggested": "我理解您對投資的考量。讓我們來看看...",
      "reason": "不要直接辯護，先同理再引導"
    }
  ],
  "coachingPriorities": [...]
}`;
```

---

## 已分析音檔的補齊策略

### 策略 1：按需補齊（推薦）

```typescript
// 在 API 或 Queue 中新增「補齊分析」功能
async function enrichAnalysis(conversationId: string, dimensions: string[]) {
  // 1. 取得現有分析結果
  const existing = await db.query.meddicAnalyses.findFirst({
    where: eq(meddicAnalyses.conversationId, conversationId),
  });

  if (!existing) throw new Error("找不到分析記錄");

  // 2. 取得對話逐字稿
  const conversation = await db.query.conversations.findFirst({
    where: eq(conversations.id, conversationId),
  });

  // 3. 只執行需要的 Agents
  const enrichmentResults: Partial<AnalysisResult> = {};

  if (dimensions.includes("store_profile")) {
    enrichmentResults.storeProfile = await runAgent1Extended(conversation.transcript);
  }

  if (dimensions.includes("deal_prediction")) {
    enrichmentResults.dealPrediction = await runAgent7(
      conversation.transcript,
      existing.agentOutputs
    );
  }

  if (dimensions.includes("sales_diagnosis")) {
    enrichmentResults.salesDiagnosis = await runAgent8(
      conversation.transcript,
      existing.agentOutputs
    );
  }

  // 4. 更新資料庫
  await db.update(meddicAnalyses)
    .set({
      ...enrichmentResults,
      analysisVersion: 2,
    })
    .where(eq(meddicAnalyses.id, existing.id));
}
```

### 策略 2：批次補齊 Queue

```typescript
// 新增 Queue 消息類型
interface EnrichmentQueueMessage {
  type: "enrich_analysis";
  conversationId: string;
  dimensions: ("store_profile" | "decision_info" | "deal_prediction" | "sales_diagnosis")[];
  priority: "high" | "normal" | "low";
}

// 觸發批次補齊
async function triggerBatchEnrichment(
  filter: {
    dateRange?: { from: Date; to: Date };
    opportunityId?: string;
    salesRepId?: string;
  },
  dimensions: string[]
) {
  const conversations = await db.query.conversations.findMany({
    where: and(
      eq(conversations.status, "analyzed"),
      // ... filter conditions
    ),
  });

  for (const conv of conversations) {
    await queue.send({
      type: "enrich_analysis",
      conversationId: conv.id,
      dimensions,
      priority: "low", // 避免影響新上傳
    });
  }
}
```

### 策略 3：懶加載補齊

```typescript
// 在前端請求詳細分析時，若缺少新欄位則即時補齊
async function getAnalysisWithEnrichment(conversationId: string) {
  const analysis = await db.query.meddicAnalyses.findFirst({
    where: eq(meddicAnalyses.conversationId, conversationId),
  });

  // 檢查是否缺少新欄位
  const missingDimensions = [];
  if (!analysis.dealPrediction) missingDimensions.push("deal_prediction");
  if (!analysis.salesDiagnosis) missingDimensions.push("sales_diagnosis");

  if (missingDimensions.length > 0 && analysis.analysisVersion < 2) {
    // 即時補齊（可選：加入快取避免重複）
    const enriched = await enrichAnalysis(conversationId, missingDimensions);
    return { ...analysis, ...enriched };
  }

  return analysis;
}
```

---

## 實作階段

### Phase 1：資料庫 & 類型定義（1 天）

1. 建立新的 TypeScript interface 定義
2. 更新 Drizzle schema
3. 執行 migration
4. 更新 packages/services 中的類型

```bash
# 執行順序
cd packages/db
bun run generate  # 生成 migration
bun run migrate   # 執行 migration
```

### Phase 2：Agent Prompts 開發（2-3 天）

1. 設計並測試 Agent 7 (Deal Prediction) prompt
2. 設計並測試 Agent 8 (Sales Diagnosis) prompt
3. 擴展 Agent 1 加入 Store Profile
4. 擴展 Agent 2 加入 Decision Info 細節

**測試方法**：
```typescript
// 使用現有對話逐字稿測試
const testTranscripts = [
  "高意願成交案例",
  "價格異議案例",
  "競品比較案例",
  "新手業務案例",
];

for (const name of testTranscripts) {
  const result = await testAgent(name);
  console.log(`${name}: ${JSON.stringify(result, null, 2)}`);
}
```

### Phase 3：Orchestrator 整合（1-2 天）

1. 更新 DAG 結構加入新 Agents
2. 實作新 Agent 的執行邏輯
3. 更新結果合併邏輯
4. 更新資料庫儲存邏輯

### Phase 4：補齊功能（1 天）

1. 實作 `enrichAnalysis` 函數
2. 新增 API endpoint（可選）
3. 設計批次補齊策略

### Phase 5：前端展示（2-3 天）

1. 更新案件詳情頁顯示新維度
2. 新增「成交預測」卡片
3. 新增「銷售診斷」報告
4. 更新報告頁面整合新數據

### Phase 6：測試 & 部署（1 天）

1. 端到端測試新上傳流程
2. 測試補齊功能
3. 部署到 staging
4. 生產環境部署

---

## 成本估算

### API 調用增加

| 項目 | 原本 | 新增 | 預估 Token |
|------|------|------|-----------|
| Agent 7 (Prediction) | 0 | 1 | ~2,000 input + 500 output |
| Agent 8 (Diagnosis) | 0 | 1 | ~3,000 input + 1,500 output |

**每次分析額外成本**：約 $0.02-0.05（Claude 3.5 Sonnet）

### 時間影響

由於新 Agents 可並行執行，預估增加分析時間：**10-15 秒**

---

## 向後相容

1. **資料庫**：新欄位為 nullable，不影響現有記錄
2. **API**：新欄位為 optional，不影響現有 client
3. **前端**：gracefully 處理 null 值
4. **補齊**：按需執行，不強制重新分析

---

## 風險 & 緩解

| 風險 | 緩解措施 |
|------|----------|
| 新 prompt 品質不穩定 | 先在 staging 大量測試，收集 edge cases |
| 分析時間過長 | 使用更小模型（Haiku）處理部分維度 |
| 成本增加 | 按需啟用新維度，非強制 |
| 補齊 queue 擠壓 | 使用低優先級，限制並發數 |

---

## 下一步

1. [ ] 確認是否採用此方案
2. [ ] 決定 Phase 1 開始時間
3. [ ] 選擇優先實作的維度（建議先做 Deal Prediction + Sales Diagnosis）
4. [ ] 準備測試用的對話逐字稿樣本

---

## 附錄：現有 agentOutputs 可提取的資訊

以下資訊已存在於現有分析中，可直接使用：

| 新欄位 | 現有來源 | 需要的工作 |
|--------|----------|-----------|
| Store Profile.currentPainPoints | agent2.pdcm_scores.pain | 直接映射 |
| Decision Info.budgetInfo | agent2.pdcm_scores.decision | 直接映射 |
| Competitive Situation.detectedCompetitors | agent2.detected_competitors | 直接映射 |
| Deal Prediction.probability | agent2.pdcm_scores.deal_probability | 需轉換為數字 |
| Sales Diagnosis.coachingPriorities | agent6.coaching_suggestions | 需重組格式 |

這意味著部分新欄位可以從現有資料「轉換」而非重新分析，降低補齊成本。
