# 測試資料刪除工具使用說明

**腳本位置**：`scripts/delete-test-cases.ts`
**建立日期**：2026-01-28

---

## 快速開始

### 基本用法

```bash
# 刪除單一案件
bun scripts/delete-test-cases.ts 202601-IC010

# 刪除多個案件
bun scripts/delete-test-cases.ts 202601-IC010 202601-IC011 202601-IC012

# 刪除範圍案件
bun scripts/delete-test-cases.ts 202601-IC010~202601-IC020

# 刪除案件 + 自動清理孤立的客戶記錄
bun scripts/delete-test-cases.ts 202601-IC010 --cleanup-opportunities
```

### 進階選項

```bash
# 預覽模式（不實際刪除）
bun scripts/delete-test-cases.ts 202601-IC010~202601-IC020 --dry-run

# 跳過確認直接執行
bun scripts/delete-test-cases.ts 202601-IC010 --yes

# 只清理所有孤立的客戶記錄
bun scripts/delete-test-cases.ts --all-orphaned

# 顯示幫助
bun scripts/delete-test-cases.ts --help
```

---

## 選項說明

| 選項 | 說明 |
|------|------|
| `--cleanup-opportunities` | 刪除案件後，自動清理孤立的 opportunities（客戶記錄） |
| `--all-orphaned` | 只清理孤立的 opportunities，不刪除案件 |
| `--dry-run` | 預覽模式，顯示會刪除什麼，但不實際執行 |
| `--yes`, `-y` | 跳過確認提示，直接執行刪除 |
| `--help`, `-h` | 顯示幫助訊息 |

---

## 使用場景

### 場景 1：清理測試案件

**情境**：剛測試完上傳功能，產生了 10 個測試案件需要清理

```bash
# 方法 1：逐一指定
bun scripts/delete-test-cases.ts 202601-IC050 202601-IC051 202601-IC052

# 方法 2：使用範圍（推薦）
bun scripts/delete-test-cases.ts 202601-IC050~202601-IC059

# 方法 3：範圍 + 自動清理客戶記錄
bun scripts/delete-test-cases.ts 202601-IC050~202601-IC059 --cleanup-opportunities
```

### 場景 2：預覽刪除範圍

**情境**：不確定範圍內有多少案件，想先預覽

```bash
# 先預覽
bun scripts/delete-test-cases.ts 202601-IC001~202601-IC100 --dry-run

# 確認後再執行
bun scripts/delete-test-cases.ts 202601-IC001~202601-IC100 --yes
```

### 場景 3：定期清理孤立客戶記錄

**情境**：定期清理沒有任何案件的客戶記錄

```bash
# 先預覽有多少孤立記錄
bun scripts/delete-test-cases.ts --all-orphaned --dry-run

# 確認後執行
bun scripts/delete-test-cases.ts --all-orphaned
```

### 場景 4：自動化腳本

**情境**：在 CI/CD 或定時任務中使用，不需要互動確認

```bash
# 使用 --yes 跳過確認
bun scripts/delete-test-cases.ts 202601-IC999 --yes --cleanup-opportunities
```

---

## 刪除流程

腳本會按照以下順序刪除資料：

### 刪除案件（Conversations）
1. **alerts** - 警示記錄
2. **sms_logs** - 簡訊記錄
3. **meddic_analyses** - MEDDIC 分析
4. **sales_todos** - 待辦事項（關聯 conversationId）
5. **conversations** - 案件主記錄

### 清理孤立客戶（Opportunities）
如果使用 `--cleanup-opportunities` 或 `--all-orphaned`：

1. **sales_todos** - 待辦事項（關聯 opportunityId）
2. **alerts** - 警示記錄（關聯 opportunityId）
3. **opportunities** - 客戶記錄

---

## 安全機制

### 1. 互動式確認
預設會顯示刪除內容並要求確認：
```
⚠️  即將刪除 3 個案件及其所有關聯資料
是否繼續？輸入 "yes" 確認：
>
```

### 2. 預覽模式
使用 `--dry-run` 可以預覽刪除內容而不實際執行：
```bash
bun scripts/delete-test-cases.ts 202601-IC010~202601-IC020 --dry-run
```

### 3. 詳細日誌
執行過程會顯示每個步驟的結果：
- 找到幾個案件
- 每個資料表刪除了多少筆
- 最終刪除統計

---

## 常見問題

### Q1: 刪除案件後，前端機會列表還顯示客戶？

**A**: 需要加上 `--cleanup-opportunities` 選項，或單獨執行清理孤立客戶：
```bash
bun scripts/delete-test-cases.ts --all-orphaned
```

### Q2: 如何刪除非連續的案件？

**A**: 可以分多次執行，或直接列出所有編號：
```bash
bun scripts/delete-test-cases.ts 202601-IC005 202601-IC010 202601-IC015 202601-IC020
```

### Q3: 誤刪了資料怎麼辦？

**A**: 此操作**無法恢復**。建議：
1. 使用 `--dry-run` 先預覽
2. 確保有資料庫備份
3. 只刪除確認是測試資料的案件

### Q4: 範圍刪除的格式是什麼？

**A**: 格式為 `起始編號~結束編號`，例如：
- `202601-IC010~202601-IC020` - 刪除 IC010 到 IC020（含）
- 兩邊的編號必須是同一個月份前綴（YYYYMM）

### Q5: 什麼是「孤立的 opportunities」？

**A**: 指沒有任何 conversations 關聯的客戶記錄。通常發生在：
- 刪除了所有該客戶的對話記錄
- 從 Slack 建立了客戶但沒有上傳對話

---

## 技術細節

### 案件編號格式
- 格式：`YYYYMM-IC###`
- 範例：`202601-IC046`
- YYYYMM：年月
- IC：產品線代碼（iChef）
- ###：三位數序號

### 孤立 Opportunities 判定
使用 SQL 查詢：
```sql
SELECT o.*
FROM opportunities o
LEFT JOIN conversations c ON c.opportunity_id = o.id
GROUP BY o.id
HAVING COUNT(c.id) = 0
```

### 錯誤處理
- 自動跳過不存在的表或欄位
- 遇到外鍵約束錯誤會停止並顯示錯誤訊息
- 使用 transaction 確保資料一致性

---

## 相關腳本

| 腳本 | 用途 |
|------|------|
| `delete-test-cases.ts` | **主要刪除工具**（本文件） |
| `delete-specific-cases.ts` | 刪除特定案件列表（舊版） |
| `delete-orphaned-opportunities.ts` | 只刪除孤立客戶（舊版） |
| `verify-deletion.ts` | 驗證案件是否已刪除 |

---

## 最佳實踐

1. **測試環境先試用**
   ```bash
   # 在測試環境先用 --dry-run 驗證
   bun scripts/delete-test-cases.ts 202601-IC001 --dry-run
   ```

2. **建立刪除前快照**
   ```bash
   # 使用資料庫備份功能
   ./scripts/backup-database.sh
   ```

3. **記錄刪除操作**
   ```bash
   # 將輸出重導向到日誌檔
   bun scripts/delete-test-cases.ts 202601-IC010~202601-IC020 --yes \
     > .doc/deletions/$(date +%Y%m%d_%H%M%S)_deletion.log 2>&1
   ```

4. **批次刪除使用範圍語法**
   ```bash
   # 優先使用範圍，避免手動輸入多個編號
   bun scripts/delete-test-cases.ts 202601-IC050~202601-IC099 --cleanup-opportunities
   ```

---

## 更新日誌

- **2026-01-28**：初版建立，整合 conversations 和 opportunities 刪除功能

---

**⚠️ 重要提醒**

此工具會**永久刪除**資料，無法恢復。使用前請：
1. 確認刪除的是測試資料
2. 使用 `--dry-run` 預覽
3. 確保有資料庫備份
4. 在正式環境使用時格外小心
