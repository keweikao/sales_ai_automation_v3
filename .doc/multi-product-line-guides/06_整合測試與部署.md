# æ•´åˆæ¸¬è©¦èˆ‡éƒ¨ç½²æŒ‡å—

> **è§’è‰²**: æ¸¬è©¦/éƒ¨ç½²åœ˜éšŠ
> **ä»»å‹™**: æ•´åˆæ¸¬è©¦èˆ‡åˆ†éšæ®µéƒ¨ç½²
> **é ä¼°æ™‚é–“**: 8-10 å°æ™‚
> **å‰ç½®æ¢ä»¶**: Agent A-E å…¨éƒ¨å®Œæˆ

---

## ğŸ“‹ ç›®éŒ„

1. [å‰ç½®æ¢ä»¶æª¢æŸ¥](#å‰ç½®æ¢ä»¶æª¢æŸ¥)
2. [æ•´åˆæ¸¬è©¦](#æ•´åˆæ¸¬è©¦)
3. [å›æ­¸æ¸¬è©¦](#å›æ­¸æ¸¬è©¦)
4. [æ€§èƒ½æ¸¬è©¦](#æ€§èƒ½æ¸¬è©¦)
5. [éƒ¨ç½²ç­–ç•¥](#éƒ¨ç½²ç­–ç•¥)
6. [ç›£æ§èˆ‡å›æ»¾](#ç›£æ§èˆ‡å›æ»¾)

---

## å‰ç½®æ¢ä»¶æª¢æŸ¥

### Agent å®Œæˆç‹€æ…‹ç¢ºèª

åœ¨é–‹å§‹æ•´åˆæ¸¬è©¦å‰,ç¢ºèªæ‰€æœ‰ Agent å·²å®Œæˆ:

```bash
# æª¢æŸ¥æ¸…å–®è…³æœ¬
cat > scripts/check-agents-completion.sh << 'SCRIPT'
#!/bin/bash

echo "ğŸ” æª¢æŸ¥ Agent å®Œæˆç‹€æ…‹..."

# Agent A: Config + DB
echo ""
echo "ğŸ“¦ Agent A (Config + DB):"
[ -f "packages/config/src/product-lines/types.ts" ] && echo "  âœ… types.ts" || echo "  âŒ types.ts"
[ -f "packages/config/src/product-lines/registry.ts" ] && echo "  âœ… registry.ts" || echo "  âŒ registry.ts"
[ -f "packages/db/src/migrations/0003_add_product_line.sql" ] && echo "  âœ… migration" || echo "  âŒ migration"

# Agent B: Slack Bot
echo ""
echo "ğŸ’¬ Agent B (Slack Bot):"
[ -f "apps/slack-bot/src/utils/product-line-resolver.ts" ] && echo "  âœ… resolver" || echo "  âŒ resolver"
[ -f "apps/slack-bot/src/utils/form-builder.ts" ] && echo "  âœ… form-builder" || echo "  âŒ form-builder"

# Agent C: MEDDIC Prompts
echo ""
echo "ğŸ“ Agent C (MEDDIC Prompts):"
[ -d "packages/services/prompts/meddic/shared" ] && echo "  âœ… shared/" || echo "  âŒ shared/"
[ -d "packages/services/prompts/meddic/ichef" ] && echo "  âœ… ichef/" || echo "  âŒ ichef/"
[ -d "packages/services/prompts/meddic/beauty" ] && echo "  âœ… beauty/" || echo "  âŒ beauty/"
[ -f "packages/services/src/llm/prompt-loader.ts" ] && echo "  âœ… prompt-loader" || echo "  âŒ prompt-loader"

# Agent D: API + Queue
echo ""
echo "ğŸ”Œ Agent D (API + Queue):"
grep -q "productLine" packages/api/src/routers/conversation.ts && echo "  âœ… API updated" || echo "  âŒ API not updated"
grep -q "productLine" apps/queue-worker/src/index.ts && echo "  âœ… Queue updated" || echo "  âŒ Queue not updated"

# Agent E: Dashboard
echo ""
echo "ğŸ“Š Agent E (Dashboard):"
[ -f "apps/dashboard/src/components/ProductLineSelector.tsx" ] && echo "  âœ… Selector" || echo "  âŒ Selector"
[ -f "packages/db/src/seed/talk-tracks-beauty.ts" ] && echo "  âœ… Beauty talk tracks" || echo "  âŒ Beauty talk tracks"

echo ""
echo "âœ… æª¢æŸ¥å®Œæˆ"
SCRIPT

chmod +x scripts/check-agents-completion.sh
bash scripts/check-agents-completion.sh
```

**é€šéæ¢ä»¶**: æ‰€æœ‰é …ç›®é¡¯ç¤º âœ…

---

## æ•´åˆæ¸¬è©¦

### æ¸¬è©¦ 1: ç«¯åˆ°ç«¯æµç¨‹æ¸¬è©¦ (ç¾æ¥­)

**ç›®æ¨™**: é©—è­‰ç¾æ¥­å®Œæ•´æµç¨‹

**æ¸¬è©¦è…³æœ¬**: `scripts/e2e-test-beauty.ts`

```typescript
import { TRPCClient } from '@Sales_ai_automation_v3/api';
import { SlackClient } from '@slack/web-api';

async function testBeautyE2E() {
  console.log('ğŸ§ª é–‹å§‹ç¾æ¥­ç«¯åˆ°ç«¯æ¸¬è©¦...\n');

  const apiClient = new TRPCClient({ url: process.env.API_URL });
  const slackClient = new SlackClient({ token: process.env.SLACK_BOT_TOKEN });

  // ========== éšæ®µ 1: å»ºç«‹ç¾æ¥­ Opportunity ==========
  console.log('ğŸ“ éšæ®µ 1: å»ºç«‹ç¾æ¥­ Opportunity');
  const opportunity = await apiClient.opportunity.createOpportunity.mutate({
    companyName: 'ç¾éº—æ²™é¾æ¸¬è©¦åº—',
    contactName: 'æ¸¬è©¦åº—é•·',
    productLine: 'beauty',
  });
  console.log(`âœ… Opportunity å»ºç«‹æˆåŠŸ: ${opportunity.id}`);
  console.log(`   product_line: ${opportunity.productLine}`);
  assert(opportunity.productLine === 'beauty', 'ProductLine æ‡‰ç‚º beauty');

  // ========== éšæ®µ 2: Slack Bot è¡¨å–® ==========
  console.log('\nğŸ’¬ éšæ®µ 2: Slack Bot è¡¨å–®ç”Ÿæˆ');
  
  // æ¨¡æ“¬ Slack file_shared äº‹ä»¶ (ç¾æ¥­ Channel)
  const beautyChannelId = process.env.BEAUTY_CHANNEL_ID; // å¾ç’°å¢ƒè®Šæ•¸è®€å–
  
  // æª¢æŸ¥ç”¢å“ç·šè§£æ
  const { resolveProductLine } = await import('@Sales_ai_automation_v3/slack-bot/utils/product-line-resolver');
  const resolvedLine = resolveProductLine(beautyChannelId, process.env);
  console.log(`âœ… Channel è§£æçµæœ: ${resolvedLine}`);
  assert(resolvedLine === 'beauty', 'Channel æ‡‰è§£æç‚º beauty');

  // æª¢æŸ¥è¡¨å–®æ¬„ä½
  const { buildAudioUploadModal } = await import('@Sales_ai_automation_v3/slack-bot/utils/form-builder');
  const modal = buildAudioUploadModal(
    { fileId: 'test', fileName: 'test.mp3', channelId: beautyChannelId },
    'beauty'
  );
  console.log(`âœ… è¡¨å–®ç”ŸæˆæˆåŠŸ`);
  console.log(`   æ¬„ä½æ•¸é‡: ${modal.blocks.length}`);
  
  // é©—è­‰ç¾æ¥­å°ˆå±¬æ¬„ä½
  const hasStoreType = modal.blocks.some(b => b.block_id === 'storeType');
  const hasStaffCount = modal.blocks.some(b => b.block_id === 'staffCount');
  assert(hasStoreType, 'æ‡‰åŒ…å« storeType æ¬„ä½');
  assert(hasStaffCount, 'æ‡‰åŒ…å« staffCount æ¬„ä½');
  console.log(`   âœ… åŒ…å«ç¾æ¥­å°ˆå±¬æ¬„ä½`);

  // ========== éšæ®µ 3: ä¸Šå‚³éŸ³æª” ==========
  console.log('\nğŸµ éšæ®µ 3: ä¸Šå‚³å°è©±éŸ³æª”');
  
  const audioFile = new File(['mock audio data'], 'beauty-conversation.mp3', { type: 'audio/mpeg' });
  const conversation = await apiClient.conversation.uploadConversation.mutate({
    leadId: opportunity.id,
    audioFile,
    salesRep: 'æ¸¬è©¦æ¥­å‹™å“¡',
    conversationDate: new Date().toISOString(),
    productLine: 'beauty',
    // ç¾æ¥­å°ˆå±¬ metadata
    storeType: 'é«®å»Š',
    staffCount: '3-5äºº',
    currentSystem: 'ç´™æœ¬+LINE',
  });
  
  console.log(`âœ… éŸ³æª”ä¸Šå‚³æˆåŠŸ: ${conversation.id}`);
  console.log(`   product_line: ${conversation.productLine}`);
  assert(conversation.productLine === 'beauty', 'Conversation productLine æ‡‰ç‚º beauty');

  // ========== éšæ®µ 4: Queue è™•ç† ==========
  console.log('\nâ³ éšæ®µ 4: ç­‰å¾… Queue è™•ç†...');
  
  // è¼ªè©¢æª¢æŸ¥è™•ç†ç‹€æ…‹
  let attempts = 0;
  let analysis = null;
  while (attempts < 30) { // æœ€å¤šç­‰å¾… 5 åˆ†é˜
    await new Promise(resolve => setTimeout(resolve, 10000)); // ç­‰å¾… 10 ç§’
    
    const conv = await apiClient.conversation.getConversation.query({ id: conversation.id });
    if (conv.status === 'completed' && conv.analysis) {
      analysis = conv.analysis;
      break;
    }
    
    attempts++;
    console.log(`   æª¢æŸ¥ä¸­... (${attempts}/30)`);
  }
  
  if (!analysis) {
    throw new Error('Queue è™•ç†è¶…æ™‚ (5åˆ†é˜)');
  }
  
  console.log(`âœ… åˆ†æå®Œæˆ`);

  // ========== éšæ®µ 5: é©—è­‰åˆ†æçµæœ ==========
  console.log('\nğŸ” éšæ®µ 5: é©—è­‰åˆ†æå“è³ª');
  
  // æª¢æŸ¥æ˜¯å¦ä½¿ç”¨äº†ç¾æ¥­æç¤ºè©
  const metricsText = JSON.stringify(analysis.metrics);
  const hasBeautyKeywords = 
    metricsText.includes('å®¢æˆ¶ç•™å­˜') || 
    metricsText.includes('é ç´„') ||
    metricsText.includes('è¨­è¨ˆå¸«');
  
  console.log(`   ä½¿ç”¨ç¾æ¥­æç¤ºè©: ${hasBeautyKeywords ? 'âœ…' : 'âŒ'}`);
  if (!hasBeautyKeywords) {
    console.warn('   âš ï¸ è­¦å‘Š: åˆ†æçµæœæœªåŒ…å«ç¾æ¥­é—œéµå­—,å¯èƒ½æœªä½¿ç”¨æ­£ç¢ºæç¤ºè©');
  }

  // ========== éšæ®µ 6: Dashboard æŸ¥è©¢ ==========
  console.log('\nğŸ“Š éšæ®µ 6: Dashboard æŸ¥è©¢');
  
  const beautyOpps = await apiClient.opportunity.listOpportunities.query({
    productLine: 'beauty',
  });
  
  console.log(`âœ… æŸ¥è©¢åˆ° ${beautyOpps.length} å€‹ç¾æ¥­ Opportunities`);
  assert(beautyOpps.some(o => o.id === opportunity.id), 'æ‡‰åŒ…å«å‰›å»ºç«‹çš„ Opportunity');

  // æŸ¥è©¢ç¾æ¥­è©±è¡“
  const beautyTalkTracks = await apiClient.talkTrack.listTalkTracks.query({
    productLine: 'beauty',
  });
  
  console.log(`âœ… æŸ¥è©¢åˆ° ${beautyTalkTracks.length} ç­†ç¾æ¥­è©±è¡“`);
  assert(beautyTalkTracks.length >= 20, 'ç¾æ¥­è©±è¡“æ‡‰è‡³å°‘ 20 ç­†');

  console.log('\nâœ… ç¾æ¥­ç«¯åˆ°ç«¯æ¸¬è©¦é€šé! ğŸ‰');
}

// è¼”åŠ©å‡½æ•¸
function assert(condition: boolean, message: string) {
  if (!condition) {
    throw new Error(`âŒ æ–·è¨€å¤±æ•—: ${message}`);
  }
}

testBeautyE2E().catch((error) => {
  console.error('\nâŒ æ¸¬è©¦å¤±æ•—:', error);
  process.exit(1);
});
```

åŸ·è¡Œ:
```bash
bun run scripts/e2e-test-beauty.ts
```

**é€šéæ¢ä»¶**: æ‰€æœ‰éšæ®µé€šé,ç„¡éŒ¯èª¤

---

### æ¸¬è©¦ 2: ç«¯åˆ°ç«¯æµç¨‹æ¸¬è©¦ (iCHEF)

**ç›®æ¨™**: é©—è­‰ iCHEF æµç¨‹ä¸å—å½±éŸ¿

**æ¸¬è©¦è…³æœ¬**: `scripts/e2e-test-ichef.ts`

```typescript
import { TRPCClient } from '@Sales_ai_automation_v3/api';

async function testIchefE2E() {
  console.log('ğŸ§ª é–‹å§‹ iCHEF ç«¯åˆ°ç«¯æ¸¬è©¦ (å‘å¾Œç›¸å®¹æ€§)...\n');

  const apiClient = new TRPCClient({ url: process.env.API_URL });

  // æ¸¬è©¦ 1: ä¸å‚³ productLine (èˆŠçš„èª¿ç”¨æ–¹å¼)
  console.log('ğŸ“ æ¸¬è©¦ 1: å»ºç«‹ Opportunity (ä¸å‚³ productLine)');
  const opp1 = await apiClient.opportunity.createOpportunity.mutate({
    companyName: 'æ¸¬è©¦é¤å»³',
    contactName: 'ç‹åº—é•·',
    // ä¸å‚³ productLine
  });
  console.log(`âœ… Opportunity å»ºç«‹æˆåŠŸ: ${opp1.id}`);
  console.log(`   product_line: ${opp1.productLine} (æ‡‰ç‚º 'ichef')`);
  assert(opp1.productLine === 'ichef', 'ProductLine æ‡‰é è¨­ç‚º ichef');

  // æ¸¬è©¦ 2: ä¸Šå‚³éŸ³æª” (ä¸å‚³ productLine)
  console.log('\nğŸµ æ¸¬è©¦ 2: ä¸Šå‚³éŸ³æª” (ä¸å‚³ productLine)');
  const audioFile = new File(['mock'], 'test.mp3', { type: 'audio/mpeg' });
  const conv1 = await apiClient.conversation.uploadConversation.mutate({
    leadId: opp1.id,
    audioFile,
    salesRep: 'Test',
    conversationDate: new Date().toISOString(),
    // ä¸å‚³ productLine
  });
  console.log(`âœ… éŸ³æª”ä¸Šå‚³æˆåŠŸ: ${conv1.id}`);
  console.log(`   product_line: ${conv1.productLine} (æ‡‰ç‚º 'ichef')`);
  assert(conv1.productLine === 'ichef', 'Conversation productLine æ‡‰é è¨­ç‚º ichef');

  // æ¸¬è©¦ 3: æŸ¥è©¢ç¾æœ‰ iCHEF è³‡æ–™
  console.log('\nğŸ“Š æ¸¬è©¦ 3: æŸ¥è©¢ iCHEF Opportunities');
  const ichefOpps = await apiClient.opportunity.listOpportunities.query({
    productLine: 'ichef',
  });
  console.log(`âœ… æŸ¥è©¢åˆ° ${ichefOpps.length} å€‹ iCHEF Opportunities`);
  assert(ichefOpps.length > 0, 'æ‡‰æœ‰ iCHEF Opportunities');

  // æ¸¬è©¦ 4: æŸ¥è©¢å…¨éƒ¨ (ä¸éæ¿¾)
  console.log('\nğŸ“Š æ¸¬è©¦ 4: æŸ¥è©¢å…¨éƒ¨ Opportunities');
  const allOpps = await apiClient.opportunity.listOpportunities.query({});
  console.log(`âœ… æŸ¥è©¢åˆ° ${allOpps.length} å€‹ Opportunities`);
  assert(allOpps.length >= ichefOpps.length, 'å…¨éƒ¨æ‡‰ >= iCHEF');

  console.log('\nâœ… iCHEF ç«¯åˆ°ç«¯æ¸¬è©¦é€šé (å‘å¾Œç›¸å®¹)! ğŸ‰');
}

function assert(condition: boolean, message: string) {
  if (!condition) {
    throw new Error(`âŒ æ–·è¨€å¤±æ•—: ${message}`);
  }
}

testIchefE2E().catch((error) => {
  console.error('\nâŒ æ¸¬è©¦å¤±æ•—:', error);
  process.exit(1);
});
```

åŸ·è¡Œ:
```bash
bun run scripts/e2e-test-ichef.ts
```

**é€šéæ¢ä»¶**: æ‰€æœ‰æ¸¬è©¦é€šé,è­‰æ˜å‘å¾Œç›¸å®¹

---

## å›æ­¸æ¸¬è©¦

### æ¸¬è©¦ 3: ç¾æœ‰åŠŸèƒ½å›æ­¸æ¸¬è©¦

**ç›®æ¨™**: ç¢ºä¿æ‰€æœ‰ç¾æœ‰åŠŸèƒ½æ­£å¸¸é‹ä½œ

**æ¸¬è©¦è…³æœ¬**: `scripts/regression-test.ts`

```typescript
async function regressionTest() {
  console.log('ğŸ”„ é–‹å§‹å›æ­¸æ¸¬è©¦...\n');

  const apiClient = new TRPCClient({ url: process.env.API_URL });

  // æ¸¬è©¦ 1: Opportunity CRUD
  console.log('ğŸ“ æ¸¬è©¦ Opportunity CRUD');
  const opp = await apiClient.opportunity.createOpportunity.mutate({
    companyName: 'Test',
    contactName: 'Test',
  });
  const retrieved = await apiClient.opportunity.getOpportunity.query({ id: opp.id });
  assert(retrieved.id === opp.id, 'Opportunity æŸ¥è©¢æ‡‰æˆåŠŸ');
  
  const updated = await apiClient.opportunity.updateOpportunity.mutate({
    id: opp.id,
    companyName: 'Updated',
  });
  assert(updated.companyName === 'Updated', 'Opportunity æ›´æ–°æ‡‰æˆåŠŸ');
  console.log('âœ… Opportunity CRUD é€šé');

  // æ¸¬è©¦ 2: Conversation ä¸Šå‚³
  console.log('\nğŸµ æ¸¬è©¦ Conversation ä¸Šå‚³');
  const audioFile = new File(['test'], 'test.mp3');
  const conv = await apiClient.conversation.uploadConversation.mutate({
    leadId: opp.id,
    audioFile,
    salesRep: 'Test',
    conversationDate: new Date().toISOString(),
  });
  assert(conv.id, 'Conversation æ‡‰å»ºç«‹æˆåŠŸ');
  console.log('âœ… Conversation ä¸Šå‚³é€šé');

  // æ¸¬è©¦ 3: è©±è¡“æŸ¥è©¢
  console.log('\nğŸ“š æ¸¬è©¦è©±è¡“æŸ¥è©¢');
  const talkTracks = await apiClient.talkTrack.listTalkTracks.query({});
  assert(talkTracks.length > 0, 'æ‡‰æœ‰è©±è¡“è³‡æ–™');
  console.log(`âœ… è©±è¡“æŸ¥è©¢é€šé (${talkTracks.length} ç­†)`);

  // æ¸¬è©¦ 4: Dashboard çµ±è¨ˆ
  console.log('\nğŸ“Š æ¸¬è©¦ Dashboard çµ±è¨ˆ');
  const stats = await apiClient.dashboard.getStats.query({});
  assert(stats.totalOpportunities >= 0, 'çµ±è¨ˆæ‡‰æ­£å¸¸');
  console.log('âœ… Dashboard çµ±è¨ˆé€šé');

  console.log('\nâœ… æ‰€æœ‰å›æ­¸æ¸¬è©¦é€šé! ğŸ‰');
}

regressionTest().catch((error) => {
  console.error('\nâŒ å›æ­¸æ¸¬è©¦å¤±æ•—:', error);
  process.exit(1);
});
```

åŸ·è¡Œ:
```bash
bun run scripts/regression-test.ts
```

**é€šéæ¢ä»¶**: æ‰€æœ‰ç¾æœ‰åŠŸèƒ½æ­£å¸¸

---

## æ€§èƒ½æ¸¬è©¦

### æ¸¬è©¦ 4: æŸ¥è©¢æ€§èƒ½æ¸¬è©¦

**ç›®æ¨™**: é©—è­‰æ€§èƒ½å¢å¹… < 10%

**æ¸¬è©¦è…³æœ¬**: `scripts/performance-test.ts`

```typescript
import { performance } from 'node:perf_hooks';
import { db } from '@Sales_ai_automation_v3/db';
import { opportunities } from '@Sales_ai_automation_v3/db/schema';
import { eq } from 'drizzle-orm';

async function performanceTest() {
  console.log('âš¡ é–‹å§‹æ€§èƒ½æ¸¬è©¦...\n');

  // Baseline: ç„¡éæ¿¾æŸ¥è©¢
  const baseline = await measureQuery('ç„¡éæ¿¾', async () => {
    return await db.select().from(opportunities).limit(100);
  });

  // æ¸¬è©¦ 1: productLine éæ¿¾ (æœ‰ç´¢å¼•)
  const withFilter = await measureQuery('productLine éæ¿¾', async () => {
    return await db
      .select()
      .from(opportunities)
      .where(eq(opportunities.productLine, 'ichef'))
      .limit(100);
  });

  // è¨ˆç®—å¢å¹…
  const overhead = ((withFilter - baseline) / baseline) * 100;
  console.log(`\nğŸ“Š æ€§èƒ½å¢å¹…: ${overhead.toFixed(2)}%`);

  if (overhead > 10) {
    console.error('âŒ æ€§èƒ½å¢å¹…è¶…é 10%,æœªé€šé!');
    process.exit(1);
  } else {
    console.log('âœ… æ€§èƒ½æ¸¬è©¦é€šé!');
  }
}

async function measureQuery(name: string, queryFn: () => Promise<any>): Promise<number> {
  const iterations = 100;
  const times: number[] = [];

  // é ç†±
  await queryFn();

  // æ¸¬é‡
  for (let i = 0; i < iterations; i++) {
    const start = performance.now();
    await queryFn();
    const end = performance.now();
    times.push(end - start);
  }

  // è¨ˆç®—å¹³å‡å€¼ (å»æ‰æœ€é«˜æœ€ä½)
  times.sort((a, b) => a - b);
  const trimmed = times.slice(10, 90); // å»æ‰ 10% æ¥µç«¯å€¼
  const avg = trimmed.reduce((a, b) => a + b, 0) / trimmed.length;

  console.log(`${name}: ${avg.toFixed(2)}ms (å¹³å‡)`);
  return avg;
}

performanceTest().catch(console.error);
```

åŸ·è¡Œ:
```bash
bun run scripts/performance-test.ts
```

**é€šéæ¨™æº–**: 
- âœ… æŸ¥è©¢æ™‚é–“å¢å¹… < 10%
- âœ… å¹³å‡æŸ¥è©¢æ™‚é–“ < 100ms

---

## éƒ¨ç½²ç­–ç•¥

### åˆ†éšæ®µéƒ¨ç½²è¨ˆç•«

#### éšæ®µ 1: åŸºç¤è¨­æ–½ (Week 1, Day 1-2)

**éƒ¨ç½²å…§å®¹**:
- Database Migration (0003_add_product_line.sql)
- Config æ¨¡çµ„ (ProductLineConfig)

**éƒ¨ç½²æ­¥é©Ÿ**:
```bash
# 1. å‚™ä»½è³‡æ–™åº«
wrangler d1 backup create sales-ai-db

# 2. åŸ·è¡Œ Migration
wrangler d1 migrations apply sales-ai-db

# 3. é©—è­‰ Migration
wrangler d1 execute sales-ai-db --command="SELECT name FROM sqlite_master WHERE type='table' AND name='opportunities';"
# ç¢ºèª product_line æ¬„ä½å­˜åœ¨

# 4. éƒ¨ç½² Config æ¨¡çµ„
cd packages/config
bun run build
bun publish
```

**é©—è­‰**:
```bash
# æª¢æŸ¥ç¾æœ‰è³‡æ–™ product_line æ˜¯å¦ç‚º 'ichef'
wrangler d1 execute sales-ai-db --command="SELECT product_line, COUNT(*) FROM opportunities GROUP BY product_line;"
# é æœŸ: æ‰€æœ‰è³‡æ–™éƒ½æ˜¯ 'ichef'
```

**å½±éŸ¿**: ğŸŸ¢ ç„¡å½±éŸ¿ (åªæ–°å¢æ¬„ä½,æœ‰ DEFAULT å€¼)

**å›æ»¾è¨ˆç•«**: 
```sql
-- å¦‚éœ€å›æ»¾
ALTER TABLE opportunities DROP COLUMN product_line;
ALTER TABLE conversations DROP COLUMN product_line;
```

---

#### éšæ®µ 2: å¾Œç«¯æœå‹™ (Week 1, Day 3-5)

**éƒ¨ç½²å…§å®¹**:
- API Router (uploadConversation, createOpportunity)
- Queue Worker
- Prompts + Orchestrator

**éƒ¨ç½²æ­¥é©Ÿ**:
```bash
# 1. éƒ¨ç½² API
cd packages/api
bun run build
wrangler deploy

# 2. éƒ¨ç½² Queue Worker
cd apps/queue-worker
bun run build
wrangler deploy

# 3. éƒ¨ç½² Services (Prompts)
cd packages/services
bun run scripts/build-prompts.ts
bun run build
bun publish
```

**é©—è­‰**:
```bash
# æ¸¬è©¦ API (ä¸å‚³ productLine)
curl -X POST https://api.example.com/trpc/opportunity.createOpportunity \
  -H "Content-Type: application/json" \
  -d '{"companyName":"Test","contactName":"Test"}'
# é æœŸ: è¿”å› productLine: 'ichef'

# æ¸¬è©¦ API (å‚³å…¥ productLine)
curl -X POST https://api.example.com/trpc/opportunity.createOpportunity \
  -H "Content-Type: application/json" \
  -d '{"companyName":"Test","contactName":"Test","productLine":"beauty"}'
# é æœŸ: è¿”å› productLine: 'beauty'
```

**å½±éŸ¿**: ğŸŸ¢ ç„¡å½±éŸ¿ (å‘å¾Œç›¸å®¹)

**å›æ»¾è¨ˆç•«**: 
```bash
# å›æ»¾åˆ°å‰ä¸€ç‰ˆæœ¬
wrangler deployments list
wrangler rollback <previous-deployment-id>
```

---

#### éšæ®µ 3: Slack Bot (Week 2, Day 1-2)

**éƒ¨ç½²å…§å®¹**:
- Slack Bot (product-line-resolver, form-builder)

**éƒ¨ç½²æ­¥é©Ÿ**:
```bash
# 1. éƒ¨ç½² Slack Bot (å…ˆä¸è¨­å®šç’°å¢ƒè®Šæ•¸)
cd apps/slack-bot
bun run build
wrangler deploy

# 2. æš«æ™‚ä¸è¨­å®š PRODUCT_LINE_CHANNELS
# æ‰€æœ‰ Channel éƒ½æœƒé è¨­ç‚º 'ichef'
```

**é©—è­‰**:
```bash
# åœ¨ä»»æ„ Slack Channel ä¸Šå‚³éŸ³æª”
# æª¢æŸ¥è¡¨å–®æ˜¯å¦æ­£å¸¸ (æ‡‰é¡¯ç¤º iCHEF è¡¨å–®)
# æª¢æŸ¥ DB è¨˜éŒ„ product_line æ˜¯å¦ç‚º 'ichef'
```

**å½±éŸ¿**: ğŸŸ¢ ç„¡å½±éŸ¿ (é è¨­ 'ichef')

---

#### éšæ®µ 4: å•Ÿç”¨ç¾æ¥­ (Week 2, Day 3-5)

**éƒ¨ç½²å…§å®¹**:
- è¨­å®šç¾æ¥­ Channel ç’°å¢ƒè®Šæ•¸
- éƒ¨ç½² Dashboard
- Seed ç¾æ¥­è©±è¡“è³‡æ–™

**éƒ¨ç½²æ­¥é©Ÿ**:
```bash
# 1. è¨­å®šç¾æ¥­ Channel ç’°å¢ƒè®Šæ•¸
wrangler secret put PRODUCT_LINE_CHANNELS
# è¼¸å…¥: {"C123456":"beauty"}
# C123456 æ›¿æ›ç‚ºå¯¦éš›çš„ç¾æ¥­ Channel ID

# 2. Seed ç¾æ¥­è©±è¡“
bun run packages/db/src/seed/seed-talk-tracks.ts

# 3. éƒ¨ç½² Dashboard
cd apps/dashboard
bun run build
wrangler pages deploy dist
```

**é©—è­‰**:
```bash
# åœ¨ç¾æ¥­ Channel ä¸Šå‚³éŸ³æª”
# æª¢æŸ¥è¡¨å–®æ˜¯å¦ç‚ºç¾æ¥­å°ˆå±¬æ¬„ä½
# æª¢æŸ¥ DB è¨˜éŒ„ product_line æ˜¯å¦ç‚º 'beauty'
# æª¢æŸ¥åˆ†ææ˜¯å¦ä½¿ç”¨ç¾æ¥­æç¤ºè©
```

**å½±éŸ¿**: ğŸŸ¢ ç„¡å½±éŸ¿ (åªå½±éŸ¿æ–°è¨­å®šçš„ Channel)

---

## ç›£æ§èˆ‡å›æ»¾

### ç›£æ§æŒ‡æ¨™

**é—œéµæŒ‡æ¨™**:

1. **API éŒ¯èª¤ç‡**
   ```bash
   # æŸ¥çœ‹ API éŒ¯èª¤ log
   wrangler tail packages-api --format json | grep "ERROR"
   ```

2. **Queue è™•ç†æˆåŠŸç‡**
   ```bash
   # æŸ¥çœ‹ Queue Worker log
   wrangler tail apps-queue-worker --format json | grep "status"
   ```

3. **DB æŸ¥è©¢æ™‚é–“**
   ```bash
   # æŸ¥çœ‹æ…¢æŸ¥è©¢
   wrangler d1 execute sales-ai-db --command="SELECT * FROM opportunities WHERE product_line='beauty' LIMIT 1;" --metrics
   ```

4. **ç”¨æˆ¶åé¥‹**
   - Slack Bot æ˜¯å¦æ­£å¸¸å›æ‡‰
   - Dashboard æ˜¯å¦æ­£å¸¸è¼‰å…¥
   - åˆ†æçµæœå“è³ªæ˜¯å¦æ­£å¸¸

**å‘Šè­¦é–¾å€¼**:
- âŒ API éŒ¯èª¤ç‡ > 5%
- âŒ Queue å¤±æ•—ç‡ > 10%
- âŒ DB æŸ¥è©¢æ™‚é–“ > 500ms
- âŒ ç”¨æˆ¶æŠ•è¨´ > 3 ä»¶/å¤©

---

### å›æ»¾è¨ˆç•«

**éšæ®µ 1 å›æ»¾** (Database):
```sql
-- Migration å›æ»¾
ALTER TABLE opportunities DROP COLUMN product_line;
ALTER TABLE conversations DROP COLUMN product_line;
```

**éšæ®µ 2 å›æ»¾** (API + Queue):
```bash
# å›æ»¾åˆ°å‰ä¸€ç‰ˆæœ¬
wrangler rollback <previous-deployment-id>
```

**éšæ®µ 3 å›æ»¾** (Slack Bot):
```bash
# ç§»é™¤ç’°å¢ƒè®Šæ•¸
wrangler secret delete PRODUCT_LINE_CHANNELS

# æˆ–å›æ»¾åˆ°å‰ä¸€ç‰ˆæœ¬
wrangler rollback <previous-deployment-id>
```

**éšæ®µ 4 å›æ»¾** (Dashboard + ç¾æ¥­è³‡æ–™):
```bash
# å›æ»¾ Dashboard
wrangler pages deployment list
wrangler pages deployment rollback <previous-deployment>

# åˆªé™¤ç¾æ¥­è©±è¡“ (å¦‚éœ€è¦)
DELETE FROM talk_tracks WHERE product_line = 'beauty';
```

---

## éƒ¨ç½²å¾Œé©—è­‰

### æœ€çµ‚é©—è­‰æ¸…å–®

```bash
# åŸ·è¡Œå®Œæ•´é©—è­‰è…³æœ¬
cat > scripts/final-verification.sh << 'SCRIPT'
#!/bin/bash

echo "ğŸ” é–‹å§‹æœ€çµ‚é©—è­‰..."

# 1. API å¥åº·æª¢æŸ¥
echo "1ï¸âƒ£ API å¥åº·æª¢æŸ¥"
curl https://api.example.com/health
echo ""

# 2. DB è³‡æ–™å®Œæ•´æ€§
echo "2ï¸âƒ£ DB è³‡æ–™å®Œæ•´æ€§"
wrangler d1 execute sales-ai-db --command="SELECT product_line, COUNT(*) FROM opportunities GROUP BY product_line;"
echo ""

# 3. ç¾æ¥­è©±è¡“è³‡æ–™
echo "3ï¸âƒ£ ç¾æ¥­è©±è¡“è³‡æ–™"
wrangler d1 execute sales-ai-db --command="SELECT COUNT(*) FROM talk_tracks WHERE product_line='beauty';"
echo ""

# 4. Slack Bot ç’°å¢ƒè®Šæ•¸
echo "4ï¸âƒ£ Slack Bot ç’°å¢ƒè®Šæ•¸"
wrangler secret list --name slack-bot | grep PRODUCT_LINE_CHANNELS
echo ""

# 5. Queue è™•ç†ç‹€æ…‹
echo "5ï¸âƒ£ Queue è™•ç†ç‹€æ…‹"
# æ¨é€æ¸¬è©¦è¨Šæ¯
wrangler queues send CONVERSATION_QUEUE '{"test":true}'
echo ""

echo "âœ… é©—è­‰å®Œæˆ"
SCRIPT

chmod +x scripts/final-verification.sh
bash scripts/final-verification.sh
```

---

## å®Œæˆæ¨™æº–

### æ•´åˆæ¸¬è©¦é€šéæ¢ä»¶

- [ ] âœ… ç¾æ¥­ç«¯åˆ°ç«¯æ¸¬è©¦é€šé
- [ ] âœ… iCHEF ç«¯åˆ°ç«¯æ¸¬è©¦é€šé (å‘å¾Œç›¸å®¹)
- [ ] âœ… å›æ­¸æ¸¬è©¦é€šé (æ‰€æœ‰ç¾æœ‰åŠŸèƒ½æ­£å¸¸)
- [ ] âœ… æ€§èƒ½æ¸¬è©¦é€šé (å¢å¹… < 10%)

### éƒ¨ç½²æˆåŠŸæ¢ä»¶

- [ ] âœ… éšæ®µ 1 éƒ¨ç½²æˆåŠŸ (DB + Config)
- [ ] âœ… éšæ®µ 2 éƒ¨ç½²æˆåŠŸ (API + Queue)
- [ ] âœ… éšæ®µ 3 éƒ¨ç½²æˆåŠŸ (Slack Bot)
- [ ] âœ… éšæ®µ 4 éƒ¨ç½²æˆåŠŸ (ç¾æ¥­å•Ÿç”¨)
- [ ] âœ… ç›£æ§æŒ‡æ¨™æ­£å¸¸ (24 å°æ™‚ç„¡å‘Šè­¦)
- [ ] âœ… ç”¨æˆ¶åé¥‹æ­£å¸¸ (ç„¡åš´é‡æŠ•è¨´)

---

## æ•…éšœæ’é™¤

### å•é¡Œ 1: Migration åŸ·è¡Œå¤±æ•—

**éŒ¯èª¤è¨Šæ¯**: `UNIQUE constraint failed`

**è§£æ±ºæ–¹æ³•**:
```bash
# æª¢æŸ¥æ˜¯å¦é‡è¤‡åŸ·è¡Œ
wrangler d1 migrations list sales-ai-db

# å¦‚æœå·²åŸ·è¡Œ,æ‰‹å‹•é©—è­‰æ¬„ä½
wrangler d1 execute sales-ai-db --command="PRAGMA table_info(opportunities);"
```

---

### å•é¡Œ 2: Queue è™•ç†å¤±æ•—

**ç—‡ç‹€**: è¨Šæ¯ä¸æ–· retry

**æ’æŸ¥æ­¥é©Ÿ**:
```bash
# æŸ¥çœ‹ log
wrangler tail apps-queue-worker

# æª¢æŸ¥æ˜¯å¦æ˜¯ productLine ç›¸é—œéŒ¯èª¤
# å¦‚æœæ˜¯,æª¢æŸ¥ fallback é‚è¼¯
```

---

### å•é¡Œ 3: Slack Bot è¡¨å–®ä¸æ­£ç¢º

**ç—‡ç‹€**: ç¾æ¥­ Channel é¡¯ç¤º iCHEF è¡¨å–®

**æ’æŸ¥æ­¥é©Ÿ**:
```bash
# æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
wrangler secret list --name slack-bot

# æª¢æŸ¥ Channel ID æ˜¯å¦æ­£ç¢º
echo $BEAUTY_CHANNEL_ID

# æª¢æŸ¥ resolver é‚è¼¯
# ç¢ºèª JSON æ ¼å¼æ­£ç¢º: {"C123456":"beauty"}
```

---

**æº–å‚™å¥½äº†å—?** é–‹å§‹æ•´åˆæ¸¬è©¦èˆ‡éƒ¨ç½²! ğŸš€
