---
name: security-audit
description: æ·±åº¦å®‰å…¨å¯©è¨ˆã€‚ç•¶è™•ç†ç”¨æˆ¶è¼¸å…¥ã€è³‡æ–™åº«æ“ä½œã€API ç«¯é»ã€èªè­‰æˆæ¬Šã€æˆ–ç”¨æˆ¶è¦æ±‚å®‰å…¨æª¢æŸ¥æ™‚è‡ªå‹•åŸ·è¡Œã€‚æª¢æ¸¬ OWASP Top 10 æ¼æ´ã€SQL Injectionã€XSSã€CSRFã€èªè­‰ç¼ºé™·ç­‰å®‰å…¨å•é¡Œã€‚
allowed-tools:
  - Read
  - Glob
  - Grep
  - Bash(bun x ultracite check)
---

# Security Audit - æ·±åº¦å®‰å…¨å¯©è¨ˆ

## è‡ªå‹•è§¸ç™¼æ™‚æ©Ÿ

Claude æœƒåœ¨ä»¥ä¸‹æƒ…æ³**è‡ªå‹•åŸ·è¡Œ**æ­¤ skillï¼š

| è§¸ç™¼æƒ…å¢ƒ | èªªæ˜ |
|---------|------|
| è™•ç†ç”¨æˆ¶è¼¸å…¥ | ä»»ä½•æ¥æ”¶å¤–éƒ¨è¼¸å…¥çš„ä»£ç¢¼ |
| è³‡æ–™åº«æ“ä½œ | æ–°å¢æˆ–ä¿®æ”¹ SQL æŸ¥è©¢ |
| API ç«¯é» | å»ºç«‹æˆ–ä¿®æ”¹ API routes |
| èªè­‰æˆæ¬Š | æ¶‰åŠç™»å…¥ã€æ¬Šé™æª¢æŸ¥çš„ä»£ç¢¼ |
| æª”æ¡ˆæ“ä½œ | è™•ç†æª”æ¡ˆä¸Šå‚³/ä¸‹è¼‰ |
| ç”¨æˆ¶è¦æ±‚ | ç”¨æˆ¶èªªã€Œå®‰å…¨æª¢æŸ¥ã€ã€ã€Œauditã€ |

## OWASP Top 10 æª¢æŸ¥æ¸…å–®

### 1. A01 - Broken Access Controlï¼ˆå­˜å–æ§åˆ¶å¤±æ•ˆï¼‰

```markdown
â–¡ API ç«¯é»æœ‰æ¬Šé™æª¢æŸ¥
â–¡ ç”¨æˆ¶åªèƒ½å­˜å–è‡ªå·±çš„è³‡æ–™
â–¡ æ•æ„Ÿæ“ä½œéœ€è¦é‡æ–°é©—è­‰
â–¡ CORS è¨­å®šæ­£ç¢º
â–¡ ç›®éŒ„éæ­·é˜²è­·
```

**æª¢æŸ¥æ¨¡å¼ï¼š**
```typescript
// âŒ å±éšªï¼šæ²’æœ‰æ¬Šé™æª¢æŸ¥
router.get("/user/:id", async (c) => {
  return db.query.users.findFirst({ where: eq(users.id, id) });
});

// âœ… å®‰å…¨ï¼šæœ‰æ¬Šé™æª¢æŸ¥
router.get("/user/:id", authMiddleware, async (c) => {
  const currentUser = c.get("user");
  if (currentUser.id !== id && !currentUser.isAdmin) {
    throw new ForbiddenError();
  }
  return db.query.users.findFirst({ where: eq(users.id, id) });
});
```

### 2. A02 - Cryptographic Failuresï¼ˆåŠ å¯†å¤±æ•—ï¼‰

```markdown
â–¡ å¯†ç¢¼ä½¿ç”¨å®‰å…¨é›œæ¹Šï¼ˆbcrypt/argon2ï¼‰
â–¡ æ•æ„Ÿè³‡æ–™å‚³è¼¸ä½¿ç”¨ HTTPS
â–¡ JWT secret è¶³å¤ å¼·åº¦
â–¡ ä¸å„²å­˜æ˜æ–‡å¯†ç¢¼
â–¡ é©ç•¶çš„ session ç®¡ç†
```

### 3. A03 - Injectionï¼ˆæ³¨å…¥æ”»æ“Šï¼‰

```markdown
â–¡ SQL æŸ¥è©¢ä½¿ç”¨åƒæ•¸åŒ–
â–¡ æ²’æœ‰å­—ä¸²æ‹¼æ¥ SQL
â–¡ å‘½ä»¤åŸ·è¡Œæœ‰é©ç•¶è½‰ç¾©
â–¡ æ¨¡æ¿å¼•æ“æœ‰è‡ªå‹•è½‰ç¾©
```

**æª¢æŸ¥æ¨¡å¼ï¼š**
```typescript
// âŒ å±éšªï¼šSQL Injection
const result = await db.execute(
  `SELECT * FROM users WHERE id = '${userId}'`
);

// âœ… å®‰å…¨ï¼šåƒæ•¸åŒ–æŸ¥è©¢
const result = await db.query.users.findFirst({
  where: eq(users.id, userId)
});
```

### 4. A04 - Insecure Designï¼ˆä¸å®‰å…¨è¨­è¨ˆï¼‰

```markdown
â–¡ æ¥­å‹™é‚è¼¯æœ‰é˜²æ¿«ç”¨æ©Ÿåˆ¶
â–¡ Rate limiting å¯¦ä½œ
â–¡ æ•æ„Ÿæ“ä½œæœ‰ç¢ºèªæ­¥é©Ÿ
â–¡ éŒ¯èª¤è¨Šæ¯ä¸æ´©æ¼å…§éƒ¨è³‡è¨Š
```

### 5. A05 - Security Misconfigurationï¼ˆå®‰å…¨è¨­å®šéŒ¯èª¤ï¼‰

```markdown
â–¡ ç”Ÿç”¢ç’°å¢ƒé—œé–‰ debug æ¨¡å¼
â–¡ é è¨­å¸³è™Ÿå¯†ç¢¼å·²è®Šæ›´
â–¡ ä¸å¿…è¦çš„åŠŸèƒ½å·²åœç”¨
â–¡ å®‰å…¨æ¨™é ­å·²è¨­å®šï¼ˆCSP, X-Frame-Optionsï¼‰
â–¡ éŒ¯èª¤è™•ç†ä¸æš´éœ²å †ç–Šè¿½è¹¤
```

### 6. A06 - Vulnerable Componentsï¼ˆæ˜“å—æ”»æ“Šçš„å…ƒä»¶ï¼‰

```markdown
â–¡ ä¾è³´å¥—ä»¶å®šæœŸæ›´æ–°
â–¡ æ²’æœ‰å·²çŸ¥æ¼æ´çš„å¥—ä»¶
â–¡ ä½¿ç”¨ lockfile é–å®šç‰ˆæœ¬
```

**æª¢æŸ¥å‘½ä»¤ï¼š**
```bash
bun audit
```

### 7. A07 - Authentication Failuresï¼ˆèªè­‰å¤±æ•—ï¼‰

```markdown
â–¡ å¯†ç¢¼å¼·åº¦è¦æ±‚
â–¡ ç™»å…¥å¤±æ•—é™åˆ¶
â–¡ Session éæœŸæ©Ÿåˆ¶
â–¡ å®‰å…¨çš„ã€Œå¿˜è¨˜å¯†ç¢¼ã€æµç¨‹
â–¡ MFA æ”¯æ´ï¼ˆå¦‚é©ç”¨ï¼‰
```

### 8. A08 - Data Integrity Failuresï¼ˆè³‡æ–™å®Œæ•´æ€§å¤±æ•—ï¼‰

```markdown
â–¡ ååºåˆ—åŒ–æœ‰é©—è­‰
â–¡ CI/CD pipeline å®‰å…¨
â–¡ å¥—ä»¶ä¾†æºå¯ä¿¡
```

### 9. A09 - Logging Failuresï¼ˆæ—¥èªŒè¨˜éŒ„å¤±æ•—ï¼‰

```markdown
â–¡ ç™»å…¥äº‹ä»¶æœ‰è¨˜éŒ„
â–¡ æ•æ„Ÿæ“ä½œæœ‰ç¨½æ ¸æ—¥èªŒ
â–¡ æ—¥èªŒä¸åŒ…å«æ•æ„Ÿè³‡è¨Š
â–¡ æ—¥èªŒæœ‰é©ç•¶ä¿ç•™æœŸé™
```

### 10. A10 - SSRFï¼ˆä¼ºæœå™¨ç«¯è«‹æ±‚å½é€ ï¼‰

```markdown
â–¡ å¤–éƒ¨ URL è«‹æ±‚æœ‰ç™½åå–®
â–¡ å…§éƒ¨ç¶²è·¯ä½å€è¢«é˜»æ“‹
â–¡ é‡å°å‘æœ‰é©—è­‰
```

## åŸ·è¡Œæµç¨‹

### æ­¥é©Ÿ 1: è­˜åˆ¥å¯©è¨ˆç¯„åœ

æ ¹æ“šè®Šæ›´å…§å®¹æ±ºå®šå¯©è¨ˆé‡é»ï¼š

| è®Šæ›´é¡å‹ | é‡é»æª¢æŸ¥ |
|---------|---------|
| API è·¯ç”± | A01, A03, A07 |
| è³‡æ–™åº«æ“ä½œ | A03, A01 |
| èªè­‰ä»£ç¢¼ | A02, A07 |
| ç”¨æˆ¶è¼¸å…¥è™•ç† | A03, A07 |
| å¤–éƒ¨ API èª¿ç”¨ | A10 |

### æ­¥é©Ÿ 2: éœæ…‹åˆ†æ

æƒæå¸¸è¦‹çš„ä¸å®‰å…¨æ¨¡å¼ï¼š

```bash
# æœå°‹å¯èƒ½çš„ SQL injection
grep -r "execute.*\$\{" --include="*.ts"
grep -r "query.*\+" --include="*.ts"

# æœå°‹ç¡¬ç·¨ç¢¼æ†‘è­‰
grep -r "password\s*=" --include="*.ts"

# æœå°‹ä¸å®‰å…¨çš„ eval
grep -r "eval\(" --include="*.ts"
```

### æ­¥é©Ÿ 3: ä»£ç¢¼å¯©æŸ¥

å°é—œéµå€åŸŸé€²è¡Œæ·±åº¦å¯©æŸ¥ï¼š

- `packages/api/src/routers/` - API ç«¯é»
- `packages/auth/` - èªè­‰é‚è¼¯
- `packages/db/` - è³‡æ–™åº«æ“ä½œ
- `packages/services/` - æ¥­å‹™é‚è¼¯

### æ­¥é©Ÿ 4: è¼¸å‡ºå ±å‘Š

## è¼¸å‡ºæ ¼å¼

```markdown
## ğŸ”’ Security Audit å ±å‘Š

### ğŸ“Š æ‘˜è¦
- **å¯©è¨ˆç¯„åœ**: X å€‹æª”æ¡ˆ
- **ç™¼ç¾å•é¡Œ**: ğŸ”´ åš´é‡ X | ğŸŸ  é«˜ X | ğŸŸ¡ ä¸­ X | ğŸŸ¢ ä½ X
- **å®‰å…¨è©•åˆ†**: X/100

### ğŸ”´ åš´é‡å•é¡Œï¼ˆå¿…é ˆç«‹å³ä¿®å¾©ï¼‰

#### [OWASP-A03] SQL Injection
**æª”æ¡ˆ**: `packages/api/src/routers/search.ts:45`
**æè¿°**: ä½¿ç”¨å­—ä¸²æ‹¼æ¥å»ºæ§‹ SQL æŸ¥è©¢
**å½±éŸ¿**: æ”»æ“Šè€…å¯åŸ·è¡Œä»»æ„ SQL å‘½ä»¤
**ä¿®å¾©å»ºè­°**:
\`\`\`typescript
// âŒ ç•¶å‰ä»£ç¢¼
const result = await db.execute(\`SELECT * FROM users WHERE name LIKE '%\${search}%'\`);

// âœ… ä¿®å¾©å¾Œ
const result = await db.query.users.findMany({
  where: like(users.name, \`%\${search}%\`)
});
\`\`\`

### ğŸŸ  é«˜é¢¨éšªå•é¡Œ

#### [OWASP-A01] ç¼ºå°‘æ¬Šé™æª¢æŸ¥
**æª”æ¡ˆ**: `packages/api/src/routers/opportunity.ts:120`
**æè¿°**: API ç«¯é»æ²’æœ‰é©—è­‰ç”¨æˆ¶æ˜¯å¦æœ‰æ¬Šé™å­˜å–è©²è³‡æº

### ğŸŸ¡ ä¸­é¢¨éšªå•é¡Œ
...

### ğŸŸ¢ ä½é¢¨éšªå•é¡Œ
...

### âœ… å®‰å…¨çš„å¯¦ä½œ
- èªè­‰ä½¿ç”¨ Better-Authï¼ˆå®‰å…¨çš„ session ç®¡ç†ï¼‰
- å¯†ç¢¼ä½¿ç”¨ bcrypt é›œæ¹Š
- CORS è¨­å®šæ­£ç¢º

### ğŸ“ å»ºè­°æ”¹é€²
1. å¯¦ä½œ Rate Limiting
2. æ–°å¢ CSP æ¨™é ­
3. å•Ÿç”¨ç¨½æ ¸æ—¥èªŒ

### âœ… ä¸‹ä¸€æ­¥è¡Œå‹•
1. [ ] ä¿®å¾©åš´é‡å•é¡Œ
2. [ ] ä¿®å¾©é«˜é¢¨éšªå•é¡Œ
3. [ ] åŸ·è¡Œæ¸¬è©¦é©—è­‰
4. [ ] å®‰æ’å®šæœŸå®‰å…¨å¯©è¨ˆ
```

## å°ˆæ¡ˆç‰¹å®šå®‰å…¨è€ƒé‡

### æ­¤å°ˆæ¡ˆçš„å®‰å…¨é‡é»

| å…ƒä»¶ | å®‰å…¨è€ƒé‡ |
|------|---------|
| `packages/auth` | Better-Auth è¨­å®šã€session ç®¡ç† |
| `packages/api` | oRPC è¼¸å…¥é©—è­‰ã€æ¬Šé™æª¢æŸ¥ |
| `packages/db` | Drizzle åƒæ•¸åŒ–æŸ¥è©¢ |
| `apps/slack-bot` | Slack ç°½åé©—è­‰ |
| `packages/services` | API Key ç®¡ç†ã€å¤–éƒ¨æœå‹™èª¿ç”¨ |

### å·²çŸ¥å®‰å…¨æ©Ÿåˆ¶

- **èªè­‰**: Better-Auth with PostgreSQL adapter
- **æˆæ¬Š**: Role-based (admin, sales, viewer)
- **è¼¸å…¥é©—è­‰**: Zod schemas in oRPC
- **ORM**: Drizzle (é˜² SQL injection)

## æ•´åˆçš„å·¥å…·

| å·¥å…· | ç”¨é€” |
|------|------|
| `Read` | è®€å–ä»£ç¢¼å¯©æŸ¥ |
| `Grep` | æœå°‹ä¸å®‰å…¨æ¨¡å¼ |
| `Glob` | æ‰¾å‡ºé—œéµæª”æ¡ˆ |

## ç›¸é—œ Skills

- `/secret-scanner` - æ•æ„Ÿè³‡è¨Šæƒæ
- `/code-review` - ä¸€èˆ¬ä»£ç¢¼å¯©æŸ¥
- `/test` - å®‰å…¨æ¸¬è©¦é©—è­‰
