name = "sales-ai-queue-worker"
main = "src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# ============================================================
# Observability - 啟用日誌追蹤
# ============================================================
[observability]
enabled = true

[vars]
ENVIRONMENT = "production"
SERVER_URL = "https://sales-ai-server.salesaiautomationv3.workers.dev"
WEB_APP_URL = "https://sales-ai-web.pages.dev"

# ============================================================
# Cron Triggers - 排程任務
# ============================================================
[triggers]
crons = [
  "0 0 * * *",     # 每日 08:00 (UTC+8) - 健康報告
  "0 1 * * 1",     # 每週一 09:00 (UTC+8) - 週報
  "0 1 * * *",     # 每日 09:00 (UTC+8) - Todo 提醒
  "0 17 * * *",    # 每日 01:00 (UTC+8) - Voice Tagging 批次處理
]

# ============================================================
# KV Namespaces - 快取層
# ============================================================
# 注意: 使用與 server 相同的 KV namespace
[[kv_namespaces]]
binding = "CACHE_KV"
id = "066c8705db6f4f39955d7050ac12fe03"

# Queue Consumer 配置
[[queues.consumers]]
queue = "transcription-queue"
max_batch_size = 1
max_retries = 3
max_wait_time_ms = 60000
dead_letter_queue = "transcription-dlq"

# ============================================================
# Staging 環境設定 - 部署前驗證用
# ============================================================
# 部署命令: bunx wrangler deploy --env staging
[env.staging]
name = "sales-ai-queue-worker-staging"

[env.staging.vars]
ENVIRONMENT = "staging"
SERVER_URL = "https://sales-ai-server-staging.salesaiautomationv3.workers.dev"
WEB_APP_URL = "https://sales-ai-web-staging.pages.dev"

# Staging KV Namespace
[[env.staging.kv_namespaces]]
binding = "CACHE_KV"
id = "066c8705db6f4f39955d7050ac12fe03"

# Staging Queue Consumer
[[env.staging.queues.consumers]]
queue = "transcription-queue-staging"
max_batch_size = 1
max_retries = 3
max_wait_time_ms = 60000

# ============================================================
# 開發環境設定
# ============================================================
[env.dev]
name = "sales-ai-queue-worker-dev"

[env.dev.vars]
ENVIRONMENT = "development"
SERVER_URL = "http://localhost:3000"
WEB_APP_URL = "http://localhost:5173"

# 開發環境 KV Namespace
[[env.dev.kv_namespaces]]
binding = "CACHE_KV"
id = "066c8705db6f4f39955d7050ac12fe03"
preview_id = "a9add56705b7490dbe8c85ac5306bd64"
